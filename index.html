<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Workout Tracker</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBRiNlnVbNKBjbJFNlwOsm2UqGIOaZppY0",
            authDomain: "workout-app-f4e51.firebaseapp.com",
            projectId: "workout-app-f4e51",
            storageBucket: "workout-app-f4e51.firebasestorage.app",
            messagingSenderId: "354947611339",
            appId: "1:354947611339:web:713c013c83d25e6827794e",
            measurementId: "G-X2DZ2WGVQN"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --surface-elevated: #2c2c2e;
            --card-bg: #1c1c1e;
            --text: #ffffff;
            --text-secondary: #8e8e93;
            --primary: #0a84ff;
            --success: #30d158;
            --separator: #38383a;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            max-width: 100vw;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
        }

        .header {
            position: relative;
            flex-shrink: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--separator);
            padding: 0 20px;
            padding-top: env(safe-area-inset-top);
        }

        .header-content {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 17px;
            font-weight: 400;
            cursor: pointer;
            padding: 8px 0;
        }

        .header-date {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .container {
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
            box-sizing: border-box;
            width: 100%;
        }

        .welcome {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .workout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .workout-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--separator);
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .workout-card:active {
            transform: scale(0.98);
            background: var(--surface-elevated);
        }

        .workout-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .workout-icon {
            color: var(--primary);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .workout-icon svg {
            width: 20px;
            height: 20px;
        }

        .workout-title {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2;
        }

        .workout-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 32px;
        }

        .last-workout {
            font-size: 11px;
            color: var(--success);
            margin-top: 4px;
            margin-left: 32px;
        }

        .section-header {
            font-size: 20px;
            font-weight: 700;
            margin: 32px 0 16px;
            color: var(--text);
        }

        .option-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .option-pill {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 12px 18px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .option-pill:active {
            transform: scale(0.97);
        }

        .option-pill.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .exercise-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            margin-bottom: 16px;
            min-height: 52px;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238e8e93' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .exercise-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Start Workout Overlay */
        .start-workout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .start-workout-content {
            text-align: center;
            max-width: 320px;
        }

        .start-workout-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .start-workout-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .start-workout-btn {
            background: var(--success);
            border: none;
            color: white;
            padding: 18px 48px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            margin-bottom: 16px;
        }

        .start-workout-btn:active {
            transform: scale(0.97);
        }

        .cancel-start-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Workout Header Title */
        .workout-header-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Workout Fixed Header (header + tabs) */
        .workout-fixed-header {
            flex-shrink: 0;
            background: var(--bg);
        }

        .workout-fixed-header .header {
            border-bottom: none;
        }

        /* Workout Section Tabs */
        .workout-tabs {
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background: var(--bg);
            border-bottom: 1px solid var(--separator);
        }

        .workout-tabs::after {
            content: '';
            flex-shrink: 0;
            width: 12px;
        }

        .workout-tabs::-webkit-scrollbar {
            display: none;
        }

        .workout-tab {
            flex-shrink: 0;
            padding: 6px 12px;
            border-radius: 16px;
            background: var(--surface);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .workout-tab.active {
            background: var(--primary);
            color: white;
        }

        .workout-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }

        .workout-section {
            display: none;
        }

        .workout-section.active {
            display: block;
        }

        /* Workout Header Timer */
        .workout-header-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'SF Mono', monospace;
            font-size: 17px;
            font-weight: 600;
            color: var(--success);
        }

        .timer-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Bottom Workout Controls - part of flex layout */
        .workout-bottom-controls {
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: 85px;
            background: var(--bg);
            border-top: 1px solid var(--separator);
        }

        .workout-bottom-buttons {
            display: flex;
            gap: 8px;
        }

        .bottom-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .bottom-btn.cancel {
            background: var(--surface-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--separator);
        }

        .bottom-btn.save {
            background: var(--success);
            color: white;
        }

        /* Deload toggle */
        .deload-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            margin-bottom: 6px;
        }

        .deload-toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .deload-toggle-label .deload-icon {
            flex-shrink: 0;
        }

        .deload-toggle-label.active {
            color: var(--warning);
        }

        .deload-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--surface-elevated);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid var(--separator);
        }

        .deload-toggle.active {
            background: var(--warning);
            border-color: var(--warning);
        }

        .deload-toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .deload-toggle.active .deload-toggle-knob {
            transform: translateX(20px);
        }

        /* Active workout banner */
        .active-workout-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 12px 20px;
            padding-top: calc(12px + env(safe-area-inset-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 150;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .active-workout-banner:active {
            opacity: 0.9;
        }

        .banner-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .banner-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .banner-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .banner-title {
            font-size: 14px;
            font-weight: 700;
        }

        .banner-time {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
        }

        .banner-action {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Adjust screens when banner is showing */
        .has-active-banner .header {
            margin-top: 60px;
        }

        .bottom-btn:active {
            transform: scale(0.97);
        }

        .option-content {
            display: none;
        }

        .option-content.active {
            display: block;
        }

        .exercise-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 4px;
        }

        .exercise-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 4px;
        }

        .exercise-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
            text-align: center;
            width: 100%;
        }

        .exercise-name-select {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            padding: 0 16px;
            text-align: center;
            text-align-last: center;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0 center;
            width: 100%;
            max-width: 100%;
        }

        .exercise-name-select:focus {
            outline: none;
        }

        /* Circuit Preset Selector */
        .circuit-preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--surface);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .circuit-preset-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .circuit-preset-select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            padding: 8px 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .circuit-preset-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Superset Preset Selector - reuses circuit preset styles */
        .superset-preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--surface);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .superset-preset-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .superset-preset-select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            padding: 8px 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .superset-preset-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .exercise-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .exercise-meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-btn {
            background: var(--surface-elevated);
            border: none;
            color: var(--primary);
            width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exercise-specs {
            display: none;
        }

        .set-tracker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Swipeable set row */
        .set-row-container {
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            margin-bottom: 2px;
        }

        .set-row-delete {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background: #ff453a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 24px 1fr 1fr 32px;
            gap: 4px;
            align-items: center;
            background: var(--surface);
            padding: 4px;
            border-radius: 6px;
            position: relative;
            transition: transform 0.2s ease;
            touch-action: pan-y;
        }

        .set-row.swiped {
            transform: translateX(-60px);
        }

        .set-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-align: center;
        }

        .add-set-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px;
            margin-top: 2px;
            background: var(--surface);
            border: 1px dashed var(--separator);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-set-btn:active {
            background: var(--surface-elevated);
            color: var(--success);
        }

        .set-controls {
            display: none;
        }

        .set-control-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            font-weight: 700;
            padding: 0;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .set-control-btn:active {
            background: var(--surface);
            transform: scale(0.95);
        }

        .set-control-btn.remove {
            color: #ff453a;
        }

        .set-control-btn.add {
            color: var(--success);
        }

        .set-check {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: 2px solid var(--separator);
            background: var(--surface-elevated);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: transparent;
            transition: all 0.2s;
        }

        .set-check:active {
            transform: scale(0.95);
        }

        .set-check.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .set-check.resting {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
        }

        /* Rest Timer Overlay */
        .rest-timer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .rest-timer-overlay.active {
            display: flex;
        }

        .rest-timer-display {
            font-size: 96px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .rest-timer-label {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .rest-timer-skip {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            color: var(--text);
            padding: 18px 48px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            min-height: 56px;
        }

        .rest-timer-skip:active {
            background: var(--surface);
            transform: scale(0.97);
        }

        .tracking-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 6px;
            padding: 6px 4px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='8' height='5' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 4px center;
            padding-right: 18px;
            min-height: 30px;
            text-align: center;
        }

        .tracking-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tracking-select.filled {
            border-color: var(--success);
            color: var(--success);
            background-color: rgba(48, 209, 88, 0.1);
        }

        .superset-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--separator);
        }

        .superset-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .superset-arrow {
            text-align: center;
            font-size: 20px;
            color: var(--primary);
            margin: 4px 0;
        }

        .circuit-container {
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--separator);
            overflow: hidden;
        }

        .circuit-header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--surface-elevated);
        }

        .circuit-title {
            font-size: 15px;
            font-weight: 600;
        }

        .circuit-arrow {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .circuit-arrow.open {
            transform: rotate(180deg);
        }

        .circuit-exercises {
            padding: 16px;
            display: none;
        }

        .circuit-exercises.open {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--separator);
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 99;
        }

        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .modal-body {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .modal-close {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        .complete-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: var(--success);
            border: none;
            color: white;
            padding: 16px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(48, 209, 88, 0.3);
            z-index: 50;
        }

        .complete-btn:active {
            transform: scale(0.98);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .month-selectors {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .month-select, .year-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            padding: 8px 12px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .month-select:focus, .year-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .month-nav {
            display: flex;
            gap: 8px;
        }

        .month-nav-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 18px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-nav-btn:active {
            background: var(--surface);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .calendar-fixed-area {
            flex-shrink: 0;
            padding: 10px;
            padding-bottom: 0;
        }

        .calendar-scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            padding-top: 16px;
            padding-bottom: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--separator);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .calendar-day.today {
            background: rgba(10, 132, 255, 0.2);
            border-color: var(--primary);
        }

        .calendar-day.has-workout {
            background: rgba(48, 209, 88, 0.15);
            border-color: var(--success);
        }

        .calendar-day.has-workout.today {
            background: rgba(48, 209, 88, 0.25);
            border-color: var(--success);
        }

        .calendar-day.has-workout .calendar-dot {
            display: block;
        }

        .calendar-day.selected,
        .calendar-day.selected.has-workout,
        .calendar-day.selected.has-workout.today {
            background: var(--primary);
            border-color: var(--primary);
        }

        .calendar-day.selected .calendar-day-number {
            color: white;
            font-weight: 700;
        }

        .calendar-day.selected .calendar-dot {
            background: white;
        }

        .calendar-day.selected .calendar-workout-name {
            color: rgba(255,255,255,0.9);
        }

        .calendar-day-number {
            font-size: 17px;
            font-weight: 600;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 3px;
            margin-top: 3px;
            display: none;
        }

        .calendar-workout-name {
            font-size: 8px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.2;
            margin-top: 2px;
            max-width: 100%;
            padding: 0 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workout-history-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .history-workout {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-stats {
            font-size: 15px;
            color: var(--text-secondary);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive adjustments for larger phones */
        @media (min-width: 430px) {
            .container {
                padding: 16px;
            }

            .workout-sticky-header {
                margin: 0 -16px;
                padding-left: 16px;
                padding-right: 16px;
            }
        }

        /* Workout Sticky Header */
        .workout-sticky-header {
            position: sticky;
            top: 56px;
            z-index: 90;
            background: var(--bg);
            padding-bottom: 16px;
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 8px;
        }

        .workout-sticky-title {
            margin-bottom: 12px;
        }

        .workout-sticky-title .welcome {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .workout-sticky-title .subtitle {
            margin-bottom: 0;
        }

        /* Workout Timer & Controls */
        .workout-controls {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--separator);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 16px;
        }

        .timer-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .timer-time {
            font-size: 36px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: var(--primary);
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .control-btn {
            background: var(--surface-elevated);
            border: 2px solid var(--separator);
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.start {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .control-btn.end {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .control-btn:active:not(:disabled) {
            transform: scale(0.97);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Workout Detail Modal */
        .workout-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .workout-detail-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .workout-detail-content {
            background: var(--surface);
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        .workout-detail-header {
            position: sticky;
            top: 0;
            background: var(--surface);
            padding: 20px;
            border-bottom: 1px solid var(--separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .workout-detail-close {
            background: var(--surface-elevated);
            border: none;
            color: var(--text);
            width: 32px;
            height: 32px;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workout-detail-body {
            padding: 20px;
        }

        .workout-summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--separator);
        }

        .workout-summary-card:hover {
            background: var(--surface-elevated);
            border-color: var(--primary);
        }

        .workout-summary-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>

<!-- Home Screen -->
    <div class="screen active" id="homeScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Workouts</div>
                <div class="header-date" id="currentDate"></div>
            </div>
        </div>

        <div class="container">
            <div class="welcome">Choose Your Workout</div>
            <div class="subtitle">Select a workout to begin</div>

            <div class="workout-grid" id="workoutGrid"></div>
        </div>
    </div>

    <!-- Workout Screen -->
    <div class="screen" id="workoutScreen">
        <div class="workout-fixed-header">
            <div class="header">
                <div class="header-content">
                    <button class="back-btn" onclick="handleWorkoutBack()">← Back</button>
                    <div class="workout-header-title" id="workoutHeaderTitle"></div>
                    <div class="workout-header-timer" id="headerTimer" style="display: none;">
                        <div class="timer-dot"></div>
                        <span id="headerTimerDisplay">0:00</span>
                    </div>
                </div>
            </div>
            <div class="workout-tabs" id="workoutTabs"></div>
        </div>

        <div class="container workout-container" id="workoutContent"></div>

        <div class="workout-bottom-controls" id="workoutBottomControls" style="display: none;">
            <div class="deload-toggle-container">
                <span class="deload-toggle-label" id="deloadLabel">
                    <svg class="deload-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect><line x1="23" y1="10" x2="23" y2="14"></line><line x1="6" y1="10" x2="6" y2="14"></line></svg>
                    Deload Mode
                </span>
                <div class="deload-toggle" id="deloadToggle" onclick="toggleDeload()">
                    <div class="deload-toggle-knob"></div>
                </div>
            </div>
            <div class="workout-bottom-buttons">
                <button class="bottom-btn cancel" onclick="cancelWorkout()">Cancel</button>
                <button class="bottom-btn save" onclick="endWorkoutSession()">End & Save</button>
            </div>
        </div>
    </div>


    <!-- Calendar Screen -->
    <div class="screen" id="calendarScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Calendar</div>
            </div>
        </div>

        <div class="calendar-fixed-area">
            <div class="month-header">
                <div class="month-selectors">
                    <select class="month-select" id="monthSelect" onchange="setMonth(this.value)">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select class="year-select" id="yearSelect" onchange="setYear(this.value)"></select>
                </div>
                <div class="month-nav">
                    <button class="month-nav-btn" onclick="changeMonth(-1)">←</button>
                    <button class="month-nav-btn" onclick="changeMonth(1)">→</button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="calendar-scroll-area" id="dayWorkouts"></div>
    </div>

    <!-- Workout Detail Modal -->
    <div class="workout-detail-modal" id="workoutDetailModal">
        <div class="workout-detail-content">
            <div class="workout-detail-header">
                <div>
                    <div style="font-size: 24px; font-weight: 700;" id="modalWorkoutType"></div>
                    <div style="font-size: 15px; color: var(--text-secondary); margin-top: 4px;" id="modalWorkoutDate"></div>
                </div>
                <button class="workout-detail-close" onclick="closeWorkoutDetailModal()">✕</button>
            </div>
            <div class="workout-detail-body" id="workoutDetailBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Exercise Info Modal -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <div class="modal-header" id="exerciseName"></div>
            <div class="modal-body" id="exerciseInfo"></div>
            <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Rest Timer Overlay -->
    <div class="rest-timer-overlay" id="restTimerOverlay">
        <div class="rest-timer-label">Rest Time</div>
        <div class="rest-timer-display" id="restTimerDisplay">0:00</div>
        <button class="rest-timer-skip" onclick="skipRestTimer()">Skip</button>
    </div>

    <!-- Active Workout Banner -->
    <div class="active-workout-banner" id="activeWorkoutBanner" style="display: none;" onclick="returnToActiveWorkout()">
        <div class="banner-left">
            <div class="banner-dot"></div>
            <div class="banner-info">
                <div class="banner-title" id="bannerWorkoutName"></div>
                <div class="banner-time" id="bannerWorkoutTime">0:00</div>
            </div>
        </div>
        <div class="banner-action">Tap to return →</div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('home')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" onclick="showScreen('calendar')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span class="nav-label">History</span>
        </button>
    </div>

    <script>

    // Workout data structure (same as before but referenced by workout type, not week)
        const WORKOUTS = {
            'Lower Body': {
                title: 'Lower Body',
                duration: '75-90 min',
                focus: 'Squats, jumps, posterior',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Pogo Hops', sets: 3, reps: '30', rest: '60s', notes: 'Low amplitude, rhythm' },
                            { name: 'Lateral Line Hops', sets: 3, reps: '20/side', rest: '60s', notes: 'Side-to-side' },
                            { name: 'Single-Leg Hops', sets: 3, reps: '15/leg', rest: '60s', notes: 'In place' },
                            { name: 'Banded Lateral Hops', sets: 3, reps: '12/side', rest: '60s', notes: 'Band around ankles, explosive' },
                            { name: 'A-Skips', sets: 3, reps: '20m', rest: '60s', notes: 'Sprint mechanics drill' },
                            { name: 'Lateral Skater Hops', sets: 3, reps: '10/side', rest: '60s', notes: 'Stick landings' },
                            { name: 'Lateral Bounds', sets: 3, reps: '10/side', rest: '60s', notes: 'Push off hard' },
                            { name: 'Cone Shuffles', sets: 3, reps: '30s', rest: '60s', notes: 'Quick lateral feet' },
                            { name: 'Carioca Drill', sets: 3, reps: '20 yds', rest: '60s', notes: 'Hip mobility, footwork' },
                            { name: 'Diagonal Bounds', sets: 3, reps: '8/direction', rest: '60s', notes: '45° angles, multi-planar' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Step down, max height' },
                            { name: 'Depth Jumps', sets: 3, reps: '5', rest: '2min', notes: '12-18 inch box, jump max' },
                            { name: 'Hurdle Hops', sets: 3, reps: '5', rest: '2min', notes: 'Continuous, max height' },
                            { name: 'Banded Lateral Jumps', sets: 3, reps: '5/side', rest: '2min', notes: 'Heavy band, max distance' },
                            { name: 'Single-Leg Box Jumps', sets: 3, reps: '4/leg', rest: '2min', notes: 'Advanced, balance focus' },
                            { name: 'Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Max distance, stick 3s' },
                            { name: 'Single-Leg Broad Jump', sets: 3, reps: '4/leg', rest: '2min', notes: 'Balance on landing' },
                            { name: 'Box Jump (Forward)', sets: 3, reps: '5', rest: '2min', notes: 'Jump onto box' },
                            { name: '180° Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Jump, rotate mid-air, land' },
                            { name: 'Banded Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Resistance band for power' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'High Bar Back Squat', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '3min', 
                                notes: 'Add 5 lbs at 4x8',
                                rotations: [
                                    { name: 'High Bar Back Squat', notes: 'Add 5 lbs at 4x8' },
                                    { name: 'Front Squat (Heavy)', notes: 'More quad/core focus' },
                                    { name: 'Safety Bar Squat', notes: 'Upper back friendly' }
                                ]
                            },
                            { 
                                name: 'Romanian Deadlift', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: '3s eccentric',
                                rotations: [
                                    { name: 'Romanian Deadlift', notes: '3s eccentric' },
                                    { name: 'Snatch Grip RDL', notes: 'Upper back emphasis' },
                                    { name: 'Single-Leg RDL', notes: 'Balance + unilateral' }
                                ]
                            },
                            { 
                                name: 'Bulgarian Split Squats', 
                                sets: 3, 
                                reps: '8-10/leg', 
                                rest: '90s', 
                                notes: 'DBs or barbell',
                                rotations: [
                                    { name: 'Bulgarian Split Squats', notes: 'DBs or barbell' },
                                    { name: 'Skater Squats', notes: 'Single leg athletic' },
                                    { name: 'Deficit Reverse Lunges', notes: 'Glute focus' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Accessories',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Leg Extensions', sets: 3, reps: '12-15', rest: '0s', notes: 'Squeeze at top' },
                                        { name: 'Leg Curls', sets: 3, reps: '12-15', rest: '90s', notes: 'Control negative' }
                                    ],
                                    [
                                        { name: 'Leg Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Deep ROM' },
                                        { name: 'Good Mornings', sets: 3, reps: '12-15', rest: '90s', notes: 'Hamstring focus' }
                                    ],
                                    [
                                        { name: 'Walking Lunges (Light)', sets: 3, reps: '12/leg', rest: '0s', notes: 'Burnout sets' },
                                        { name: 'Glute-Ham Raises', sets: 3, reps: '8-12', rest: '90s', notes: 'Eccentric control' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Standing Calf Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Full ROM' },
                                        { name: 'Tibialis Raises', sets: 3, reps: '20', rest: '60s', notes: 'Shin health' }
                                    ],
                                    [
                                        { name: 'Seated Calf Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Soleus focus' },
                                        { name: 'Calf Press on Leg Press', sets: 3, reps: '20', rest: '60s', notes: 'Heavy load' }
                                    ],
                                    [
                                        { name: 'Single-Leg Calf Raise', sets: 3, reps: '12/leg', rest: '0s', notes: 'Balance challenge' },
                                        { name: 'Tibialis Raises', sets: 3, reps: '20', rest: '60s', notes: 'Shin health' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Sled Push', sets: 4, reps: '30m', rest: '90s', notes: 'Heavy, drive through legs' },
                            { name: 'Sled Drag', sets: 4, reps: '30m', rest: '90s', notes: 'Backward, stay low' },
                            { name: 'Prowler Push', sets: 4, reps: '30m', rest: '90s', notes: 'Low handles, explosive' }
                        ]
                    },
                    {
                        title: 'Core Circuit',
                        isCircuit: true,
                        exercises: [
                            {
                                name: 'Core Exercise 1',
                                sets: 3,
                                reps: '45s/12 reps',
                                rest: '0s',
                                notes: 'Anti-extension focus',
                                rotations: [
                                    { name: 'Plank', notes: 'Hold 45-60s, brace core' },
                                    { name: 'Side Plank', notes: '30s each side' },
                                    { name: 'Dead Bugs', notes: '12 reps per side, slow' },
                                    { name: 'Hollow Body Hold', notes: '30-45s, lower back flat' }
                                ]
                            },
                            {
                                name: 'Core Exercise 2',
                                sets: 3,
                                reps: '10-15/40m',
                                rest: '0s',
                                notes: 'Loaded or rotational',
                                rotations: [
                                    { name: 'Farmer Carry', notes: '40m, heavy DBs or KBs' },
                                    { name: 'Russian Twists', notes: '15 per side, weighted' },
                                    { name: 'Bicycle Crunches', notes: '15 per side, controlled' },
                                    { name: 'Suitcase Carry', notes: '40m each side' }
                                ]
                            },
                            {
                                name: 'Core Exercise 3',
                                sets: 3,
                                reps: '10-15',
                                rest: '60s',
                                notes: 'Compression focus',
                                rotations: [
                                    { name: 'Leg Raises', notes: 'Lying or hanging, control descent' },
                                    { name: 'V-Ups', notes: 'Touch toes at top' },
                                    { name: 'Oblique Crunches', notes: '12 per side' },
                                    { name: 'Overhead Carry', notes: '40m, single or double arm' }
                                ]
                            }
                        ]
                    }
                ]
            },
            'Upper Body': {
                title: 'Upper Body',
                duration: '75-85 min',
                focus: 'Press, pull, shoulders',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Med Ball Chest Pass', sets: 3, reps: '8-10', rest: '60s', notes: 'Against wall, quick' },
                            { name: 'Med Ball Overhead Throws', sets: 3, reps: '8-10', rest: '60s', notes: 'Throw-in style' },
                            { name: 'Light DB Punch', sets: 3, reps: '10/arm', rest: '60s', notes: '5-10lb, explosive' },
                            { name: 'Med Ball Rotational Throws', sets: 3, reps: '8/side', rest: '60s', notes: 'Against wall, core rotation' },
                            { name: 'Band Speed Punches', sets: 3, reps: '15/arm', rest: '60s', notes: 'Resistance band, fast tempo' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Plyo Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands leave ground' },
                            { name: 'Med Ball Slams', sets: 3, reps: '6', rest: '2min', notes: 'Heavy ball' },
                            { name: 'Depth Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands on plates' },
                            { name: 'Med Ball Rotational Slams', sets: 3, reps: '5/side', rest: '2min', notes: 'Overhead to side, explosive' },
                            { name: 'Clapping Pull-Ups', sets: 3, reps: '3-5', rest: '2min', notes: 'Advanced, explosive pull' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'Barbell Bench Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '3min', 
                                notes: 'Control descent',
                                rotations: [
                                    { name: 'Barbell Bench Press', notes: 'Control descent' },
                                    { name: 'Close Grip Bench', notes: 'Tricep emphasis' },
                                    { name: 'Pause Bench Press', notes: '2s pause on chest' }
                                ]
                            },
                            { 
                                name: 'Pull-Ups', 
                                sets: 4, 
                                reps: '6-10', 
                                rest: '2min', 
                                notes: 'Add weight if possible',
                                rotations: [
                                    { name: 'Pull-Ups', notes: 'Add weight if possible' },
                                    { name: 'Chin-Ups', notes: 'Bicep emphasis' },
                                    { name: 'Wide Grip Pull-Ups', notes: 'Lat width' }
                                ]
                            },
                            { 
                                name: 'Overhead Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Standing, strict form',
                                rotations: [
                                    { name: 'Overhead Press', notes: 'Standing, strict form' },
                                    { name: 'Landmine Press', notes: 'Shoulder-friendly angle' },
                                    { name: 'DB Overhead Press', notes: 'More ROM, balance' }
                                ]
                            },
                            { 
                                name: 'Barbell Rows', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: 'Pull to sternum',
                                rotations: [
                                    { name: 'Barbell Rows', notes: 'Pull to sternum' },
                                    { name: 'Pendlay Rows', notes: 'Explosive from floor' },
                                    { name: 'Meadows Row', notes: 'Landmine, single arm' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Accessories',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Incline DB Press', sets: 3, reps: '10-12', rest: '0s', notes: 'Upper chest' },
                                        { name: 'Face Pulls', sets: 3, reps: '15-20', rest: '90s', notes: 'External rotation' }
                                    ],
                                    [
                                        { name: 'Cable Flyes', sets: 3, reps: '12-15', rest: '0s', notes: 'Squeeze at peak' },
                                        { name: 'Rear Delt Flyes', sets: 3, reps: '15-20', rest: '90s', notes: 'Light weight' }
                                    ],
                                    [
                                        { name: 'Push-Ups', sets: 3, reps: '15-20', rest: '0s', notes: 'To failure' },
                                        { name: 'Band Pull-Aparts', sets: 3, reps: '20', rest: '90s', notes: 'Rear delts' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Hammer Curls', sets: 3, reps: '10-12', rest: '0s', notes: 'Brachialis focus' },
                                        { name: 'Overhead Tricep Extension', sets: 3, reps: '12-15', rest: '90s', notes: 'Stretch at bottom' }
                                    ],
                                    [
                                        { name: 'Barbell Curls', sets: 3, reps: '10-12', rest: '0s', notes: 'Strict form' },
                                        { name: 'Skull Crushers', sets: 3, reps: '12-15', rest: '90s', notes: 'Control eccentric' }
                                    ],
                                    [
                                        { name: 'Cable Curls', sets: 3, reps: '12-15', rest: '0s', notes: 'Constant tension' },
                                        { name: 'Rope Pushdowns', sets: 3, reps: '15-20', rest: '90s', notes: 'Full extension' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Battle Ropes', sets: 6, reps: '30s', rest: '30s', notes: 'Alternating waves, max effort' },
                            { name: 'Rowing Sprint', sets: 6, reps: '30s', rest: '30s', notes: 'Max effort strokes' },
                            { name: 'Assault Bike Sprint', sets: 6, reps: '30s', rest: '30s', notes: 'All out effort' }
                        ]
                    }
                ]
            },

        'Full Body': {
                title: 'Full Body',
                duration: '75-90 min',
                focus: 'Deadlifts, carries, metabolic',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Pogo Hops', sets: 3, reps: '30', rest: '60s', notes: 'Low amplitude, rhythm' },
                            { name: 'Lateral Line Hops', sets: 3, reps: '20/side', rest: '60s', notes: 'Side-to-side' },
                            { name: 'Single-Leg Hops', sets: 3, reps: '15/leg', rest: '60s', notes: 'In place' },
                            { name: 'Banded Lateral Hops', sets: 3, reps: '12/side', rest: '60s', notes: 'Band around ankles, explosive' },
                            { name: 'A-Skips', sets: 3, reps: '20m', rest: '60s', notes: 'Sprint mechanics drill' },
                            { name: 'Lateral Skater Hops', sets: 3, reps: '10/side', rest: '60s', notes: 'Stick landings' },
                            { name: 'Lateral Bounds', sets: 3, reps: '10/side', rest: '60s', notes: 'Push off hard' },
                            { name: 'Cone Shuffles', sets: 3, reps: '30s', rest: '60s', notes: 'Quick lateral feet' },
                            { name: 'Carioca Drill', sets: 3, reps: '20 yds', rest: '60s', notes: 'Hip mobility, footwork' },
                            { name: 'Diagonal Bounds', sets: 3, reps: '8/direction', rest: '60s', notes: '45° angles, multi-planar' },
                            { name: 'Med Ball Chest Pass', sets: 3, reps: '8-10', rest: '60s', notes: 'Against wall, quick' },
                            { name: 'Med Ball Overhead Throws', sets: 3, reps: '8-10', rest: '60s', notes: 'Throw-in style' },
                            { name: 'Light DB Punch', sets: 3, reps: '10/arm', rest: '60s', notes: '5-10lb, explosive' },
                            { name: 'Med Ball Rotational Throws', sets: 3, reps: '8/side', rest: '60s', notes: 'Against wall, core rotation' },
                            { name: 'Band Speed Punches', sets: 3, reps: '15/arm', rest: '60s', notes: 'Resistance band, fast tempo' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Step down, max height' },
                            { name: 'Depth Jumps', sets: 3, reps: '5', rest: '2min', notes: '12-18 inch box, jump max' },
                            { name: 'Hurdle Hops', sets: 3, reps: '5', rest: '2min', notes: 'Continuous, max height' },
                            { name: 'Banded Lateral Jumps', sets: 3, reps: '5/side', rest: '2min', notes: 'Heavy band, max distance' },
                            { name: 'Single-Leg Box Jumps', sets: 3, reps: '4/leg', rest: '2min', notes: 'Advanced, balance focus' },
                            { name: 'Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Max distance, stick 3s' },
                            { name: 'Single-Leg Broad Jump', sets: 3, reps: '4/leg', rest: '2min', notes: 'Balance on landing' },
                            { name: 'Box Jump (Forward)', sets: 3, reps: '5', rest: '2min', notes: 'Jump onto box' },
                            { name: '180° Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Jump, rotate mid-air, land' },
                            { name: 'Banded Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Resistance band for power' },
                            { name: 'Plyo Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands leave ground' },
                            { name: 'Med Ball Slams', sets: 3, reps: '6', rest: '2min', notes: 'Heavy ball' },
                            { name: 'Depth Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands on plates' },
                            { name: 'Med Ball Rotational Slams', sets: 3, reps: '5/side', rest: '2min', notes: 'Overhead to side, explosive' },
                            { name: 'Clapping Pull-Ups', sets: 3, reps: '3-5', rest: '2min', notes: 'Advanced, explosive pull' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            {
                                name: 'Trap Bar Deadlift', 
                                sets: 4, 
                                reps: '5', 
                                rest: '3min', 
                                notes: 'Explosive',
                                rotations: [
                                    { name: 'Trap Bar Deadlift', notes: 'Explosive' },
                                    { name: 'Conventional Deadlift', notes: 'More posterior chain' },
                                    { name: 'Sumo Deadlift', notes: 'Quad emphasis' }
                                ]
                            },
                            { 
                                name: 'Front Squat', 
                                sets: 3, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Upright torso',
                                rotations: [
                                    { name: 'Front Squat', notes: 'Upright torso' },
                                    { name: 'Goblet Squat (Heavy)', notes: 'Core bracing' },
                                    { name: 'Zercher Squat', notes: 'Unique stimulus' }
                                ]
                            },
                            { 
                                name: 'Single-Arm DB Row', 
                                sets: 3, 
                                reps: '10/arm', 
                                rest: '90s', 
                                notes: 'Anti-rotation',
                                rotations: [
                                    { name: 'Single-Arm DB Row', notes: 'Anti-rotation' },
                                    { name: 'Chest-Supported Row', notes: 'Remove lower back' },
                                    { name: 'T-Bar Row', notes: 'Heavy loading' }
                                ]
                            },
                            { 
                                name: 'Walking Lunges', 
                                sets: 3, 
                                reps: '10/leg', 
                                rest: '90s', 
                                notes: 'DBs or barbell',
                                rotations: [
                                    { name: 'Walking Lunges', notes: 'DBs or barbell' },
                                    { name: 'Reverse Lunges', notes: 'More glute focus' },
                                    { name: 'Step-Ups (Heavy)', notes: 'Explosive, knee height box' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Power Movement',
                        isOptions: true,
                        exercises: [
                            { name: 'Power Clean', sets: 4, reps: '3', rest: '2min', notes: 'Explosive from floor' },
                            { name: 'Hang Clean', sets: 4, reps: '3', rest: '2min', notes: 'From above knee' },
                            { name: 'Clean Pull', sets: 4, reps: '5', rest: '2min', notes: 'Deadlift to shrug jump' },
                            { name: 'Kettlebell Swings (Heavy)', sets: 4, reps: '10', rest: '2min', notes: 'Hip hinge power' },
                            { name: 'Snatch Grip High Pull', sets: 4, reps: '5', rest: '2min', notes: 'Wide grip, explosive pull' }
                        ]
                    },
                    {
                        title: 'Loaded Carries',
                        isOptions: true,
                        exercises: [
                            { name: 'Farmer Carries', sets: 3, reps: '40m', rest: '90s', notes: 'Heavy DBs, tight core' },
                            { name: 'Suitcase Carries', sets: 3, reps: '30m/side', rest: '90s', notes: 'One hand, anti-lateral flexion' },
                            { name: 'Overhead Carries', sets: 3, reps: '30m/arm', rest: '90s', notes: 'KB or DB overhead' },
                            { name: 'Zercher Carries', sets: 3, reps: '40m', rest: '90s', notes: 'Barbell in elbow crooks' },
                            { name: 'Turkish Get-Up', sets: 3, reps: '3/side', rest: '90s', notes: 'Full body stability' }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Row Intervals', sets: 5, reps: '500m', rest: '2min', notes: 'Max effort each interval' },
                            { name: 'Assault Bike Intervals', sets: 8, reps: '20s', rest: '10s', notes: 'All out effort, Tabata style' },
                            { name: 'Sled Drag', sets: 4, reps: '30m', rest: '90s', notes: 'Backward, heavy load' }
                        ]
                    },
                    {
                        title: 'Core Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Heavy Carries + Plank', sets: 3, reps: '', rest: '90s', notes: 'Farmer carry 20m + weighted plank 30s' },
                            { name: 'Anti-Rotation Complex', sets: 3, reps: '10/side', rest: '60s', notes: 'Pallof press, bird dogs, side plank' },
                            { name: 'Explosive Core', sets: 3, reps: '10-15', rest: '60s', notes: 'Med ball slams, mountain climbers, v-ups' },
                            { name: 'Isometric Hold Circuit', sets: 3, reps: '', rest: '60s', notes: 'Hollow hold 20s, plank 30s, dead bug hold 20s/side' }
                        ]
                    }
                ]
            },
            'Upper Volume': {
                title: 'Upper Volume',
                duration: '65-75 min',
                focus: 'Hypertrophy, abs, arms',
                sections: [
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'Push Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Use leg drive',
                                rotations: [
                                    { name: 'Push Press', notes: 'Use leg drive' },
                                    { name: 'Jerk Press', notes: 'More explosive, drop under' },
                                    { name: 'Viking Press (Landmine)', notes: 'Neutral grip, shoulder-friendly' }
                                ]
                            },
                            { 
                                name: 'Weighted Dips', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: 'Chest lean',
                                rotations: [
                                    { name: 'Weighted Dips', notes: 'Chest lean' },
                                    { name: 'Ring Dips', notes: 'More stabilization' },
                                    { name: 'Decline Bench', notes: 'Lower chest emphasis' }
                                ]
                            },
                            { 
                                name: 'Chest-Supported Rows', 
                                sets: 4, 
                                reps: '10-12', 
                                rest: '90s', 
                                notes: 'No momentum',
                                rotations: [
                                    { name: 'Chest-Supported Rows', notes: 'No momentum' },
                                    { name: 'Seal Rows', notes: 'Isolate back' },
                                    { name: 'Inverted Rows', notes: 'Bodyweight variation' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Volume Work',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Incline DB Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Upper chest focus' },
                                        { name: 'Cable Rows', sets: 3, reps: '12-15', rest: '90s', notes: 'Mid-back' }
                                    ],
                                    [
                                        { name: 'Machine Chest Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Constant tension' },
                                        { name: 'Lat Pulldown', sets: 3, reps: '12-15', rest: '90s', notes: 'Wide grip' }
                                    ],
                                    [
                                        { name: 'Decline Push-Ups', sets: 3, reps: '15-20', rest: '0s', notes: 'Feet elevated' },
                                        { name: 'Single-Arm Cable Row', sets: 3, reps: '12/arm', rest: '90s', notes: 'Anti-rotation' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Lateral Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Light, controlled' },
                                        { name: 'Band Pull-Aparts', sets: 3, reps: '20', rest: '60s', notes: 'Rear delts' }
                                    ],
                                    [
                                        { name: 'Cable Upright Rows', sets: 3, reps: '12-15', rest: '0s', notes: 'Wide grip' },
                                        { name: 'Reverse Flyes', sets: 3, reps: '15-20', rest: '60s', notes: 'Rear delts' }
                                    ],
                                    [
                                        { name: 'Front Raises', sets: 3, reps: '12-15', rest: '0s', notes: 'Plate or DBs' },
                                        { name: 'Face Pulls', sets: 3, reps: '15-20', rest: '60s', notes: 'External rotation' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Core Circuit',
                        isCircuit: true,
                        exercises: [
                            { 
                                name: 'Ab Wheel Rollouts', 
                                sets: 3, 
                                reps: '10-12', 
                                rest: '0s', 
                                notes: 'Slow eccentric',
                                rotations: [
                                    { name: 'Ab Wheel Rollouts', notes: 'Slow eccentric' },
                                    { name: 'Dead Bugs', notes: 'Opposite arm/leg' },
                                    { name: 'Toes to Bar', notes: 'Explosive hip flexion' }
                                ]
                            },
                            { 
                                name: 'Pallof Press', 
                                sets: 3, 
                                reps: '12/side', 
                                rest: '0s', 
                                notes: 'Anti-rotation',
                                rotations: [
                                    { name: 'Pallof Press', notes: 'Anti-rotation' },
                                    { name: 'Landmine Rotations', notes: 'Explosive rotation' },
                                    { name: 'Cable Woodchops', notes: 'High to low rotation' }
                                ]
                            },
                            { 
                                name: 'Hanging Leg Raises', 
                                sets: 3, 
                                reps: '10-15', 
                                rest: '60s', 
                                notes: 'Control swing',
                                rotations: [
                                    { name: 'Hanging Leg Raises', notes: 'Control swing' },
                                    { name: 'Decline Sit-Ups', notes: 'Weighted for progression' },
                                    { name: 'Dragon Flags', notes: 'Advanced, full body tension' }
                                ]
                            }
                        ]
                    }
                ]
            },
            'Recovery': {
                title: 'Recovery',
                duration: '40-50 min',
                focus: 'Recovery cardio & mobility',
                sections: [
                    {
                        title: 'Zone 2 Cardio (30-40 min - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Incline Treadmill Walk', sets: 1, reps: '30-40 min', rest: '', notes: '15% incline, 3.0 mph' },
                            { name: 'Stationary Bike', sets: 1, reps: '30-40 min', rest: '', notes: 'Easy pace, conversational' },
                            { name: 'Easy Jog', sets: 1, reps: '30-40 min', rest: '', notes: 'Nose breathing only' },
                            { name: 'Elliptical', sets: 1, reps: '30-40 min', rest: '', notes: 'Low resistance, steady' },
                            { name: 'Rowing (Easy Pace)', sets: 1, reps: '30-40 min', rest: '', notes: 'Focus on form, not speed' },
                            { name: 'Swimming', sets: 1, reps: '30-40 min', rest: '', notes: 'Easy laps, any stroke' },
                            { name: 'Outdoor Walk', sets: 1, reps: '30-40 min', rest: '', notes: 'Hilly terrain preferred' },
                            { name: 'Stair Climber', sets: 1, reps: '30-40 min', rest: '', notes: 'Moderate pace, glute focus' }
                        ]
                    },
                    {
                        title: 'Mobility/Stretching (10 min - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Lower Body Flow', sets: 1, reps: '10 min', rest: '', notes: 'Hip circles, leg swings, 90/90, pigeon, deep squat hold' },
                            { name: 'Upper Body Flow', sets: 1, reps: '10 min', rest: '', notes: 'Shoulder dislocations, wall slides, thoracic rotations, cat-cow' },
                            { name: 'Full Body Yoga Flow', sets: 1, reps: '10 min', rest: '', notes: 'Sun salutations, downward dog, warrior poses, child pose' },
                            { name: 'Foam Rolling Session', sets: 1, reps: '10 min', rest: '', notes: 'Calves, quads, IT band, glutes, upper back' },
                            { name: 'Lower Body Stretching', sets: 1, reps: '10 min', rest: '', notes: 'Hip flexors, hamstrings, glutes, calves' },
                            { name: 'Upper Body Stretching', sets: 1, reps: '10 min', rest: '', notes: 'Shoulders, chest, lats, triceps' },
                            { name: 'Dynamic Mobility', sets: 1, reps: '10 min', rest: '', notes: 'Leg swings, arm circles, hip circles, world greatest stretch' }
                        ]
                    },
                    {
                        title: 'Core Stability (Optional - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Plank Variations', sets: 3, reps: '30-60s', rest: '30s', notes: 'Standard, side, reach-through' },
                            { name: 'Bird Dogs', sets: 3, reps: '10/side', rest: '30s', notes: 'Slow, controlled, no rotation' },
                            { name: 'Dead Bugs', sets: 3, reps: '12/side', rest: '30s', notes: 'Lower back flat on ground' },
                            { name: 'Hanging Core', sets: 3, reps: '10-15', rest: '60s', notes: 'Hanging knee raises or leg raises' },
                            { name: 'Skip Core Today', sets: 0, reps: '', rest: '', notes: 'Just stretch and recover' }
                        ]
                    }
                ]
            },
            'HIIT': {
                title: 'HIIT',
                duration: '20-30 min',
                focus: 'High intensity conditioning',
                sections: [
                    {
                        title: 'HIIT Option',
                        isOptions: true,
                        exercises: [
                            { name: 'Circuit A - Bodyweight HIIT', sets: 5, reps: '40s work/20s rest', rest: '2min between rounds', notes: 'Burpees, Jump Squats, Push-Ups, Mountain Climbers, Kettlebell Swings' },
                            { name: 'Circuit B - Treadmill Sprints', sets: 10, reps: '20-30s sprint', rest: '60-90s walk', notes: '8-12 mph, 1-3% incline. 5 min warm-up, 5 min cool-down' }
                        ]
                    }
                ]
            }
        };

        // Exercise database - comprehensive definitions
        const EXERCISE_DB = {
            // === HIIT CIRCUITS ===
            'Circuit A - Bodyweight HIIT': {
                setup: '40sec work / 20sec rest x 5 rounds. Rest 2 min between rounds. Exercises: Burpees, Jump Squats, Push-Ups, Mountain Climbers, Kettlebell Swings.',
                execution: 'Perform each exercise for 40 seconds with maximum effort, rest 20 seconds, then move to next exercise. Complete all 5 exercises for 1 round. Rest 2 minutes between rounds. Focus on maintaining form even when fatigued.'
            },
            'Circuit B - Treadmill Sprints': {
                setup: 'WARM-UP: 5 min easy jog/walk on treadmill. SPRINT PROTOCOL: 10-12 rounds of sprints. COOL-DOWN: 5 min easy walk. Alternative: 8 x 500m row with 90 sec rest.',
                execution: 'Sprint 20-30 seconds at 8-12 mph with 1-3% incline. Recovery 60-90 seconds walking. Adjust speed based on your fitness level. Focus on maximum effort during sprints, full recovery between.'
            },

            // === EXTENSIVE PLYOS ===
            'Pogo Hops': {
                setup: 'Stand with feet hip-width apart. Arms relaxed at sides. Weight on balls of feet.',
                execution: 'Bounce continuously using ankle stiffness with minimal knee bend. Focus on quick ground contact and rhythm, not height. Keep core tight.'
            },
            'Lateral Line Hops': {
                setup: 'Stand on one side of a line or crack. Feet together, knees soft.',
                execution: 'Hop side-to-side over the line quickly. Stay on balls of feet. Minimize ground contact time. Keep hips square.'
            },
            'Single-Leg Hops': {
                setup: 'Stand on one leg. Other leg bent behind you. Arms ready for balance.',
                execution: 'Hop in place on one foot using ankle spring. Land softly, immediately rebound. Keep knee slightly bent throughout.'
            },
            'Banded Lateral Hops': {
                setup: 'Place mini band around ankles. Athletic stance with tension on band.',
                execution: 'Explosively hop laterally against band resistance. Land softly and immediately hop back. Maintain band tension throughout.'
            },
            'A-Skips': {
                setup: 'Stand tall, arms at 90 degrees. One leg ready to drive.',
                execution: 'Skip forward driving knee high (thigh parallel). Opposite arm drives up. Land on ball of foot. Alternate legs with rhythm.'
            },
            'Lateral Skater Hops': {
                setup: 'Stand on one leg. Other leg behind, arms ready.',
                execution: 'Bound laterally, landing on opposite foot. Swing arms for momentum. Stick landing briefly before bounding back.'
            },
            'Lateral Bounds': {
                setup: 'Athletic stance on one leg. Arms ready to drive.',
                execution: 'Push off explosively sideways. Cover max distance. Land softly on opposite foot. Stabilize, then bound back.'
            },
            'Cone Shuffles': {
                setup: 'Set cones 5-10 feet apart. Athletic stance between them.',
                execution: 'Shuffle quickly side to side, touching each cone. Stay low in athletic position. Quick feet, don\'t cross legs.'
            },
            'Carioca Drill': {
                setup: 'Stand sideways to direction of travel. Arms out for balance.',
                execution: 'Move laterally: trail leg crosses in front, then behind (grapevine pattern). Rotate hips with each step. Stay on balls of feet.'
            },
            'Diagonal Bounds': {
                setup: 'Stand on one leg at 45-degree angle to travel direction.',
                execution: 'Bound diagonally forward, landing on opposite leg. Cover distance and height. Alternate legs in zigzag pattern.'
            },
            'Med Ball Chest Pass': {
                setup: 'Hold med ball at chest. Stand 6-8 feet from wall. Athletic stance.',
                execution: 'Explosively push ball from chest into wall. Catch rebound and immediately repeat. Generate power from chest and arms.'
            },
            'Med Ball Overhead Throws': {
                setup: 'Hold med ball overhead. Face wall or open space. Feet shoulder-width.',
                execution: 'Throw ball overhead like a soccer throw-in. Use core and arms. Follow through completely. Catch and repeat.'
            },
            'Light DB Punch': {
                setup: 'Stand in boxing stance. Light dumbbell (5-10 lbs) in each hand at chin.',
                execution: 'Throw fast punches alternating arms. Rotate torso with each punch. Keep core tight. Speed over power.'
            },
            'Med Ball Rotational Throws': {
                setup: 'Stand sideways to wall. Hold med ball at hip. Feet wider than shoulders.',
                execution: 'Rotate explosively, throwing ball into wall. Generate power from hips and core. Catch and repeat same side, then switch.'
            },
            'Band Speed Punches': {
                setup: 'Anchor resistance band behind you. Hold handles at chest in boxing stance.',
                execution: 'Throw rapid alternating punches against band resistance. Full arm extension. Keep core engaged. Maximum speed.'
            },

            // === INTENSIVE PLYOS ===
            'Box Jumps': {
                setup: 'Face box 12-24" high. Feet hip-width. Arms back ready to swing.',
                execution: 'Swing arms forward and jump onto box explosively. Land softly with bent knees. Step down (don\'t jump). Focus on max height.'
            },
            'Depth Jumps': {
                setup: 'Stand on 12-18" box. Step off (don\'t jump off) edge.',
                execution: 'Land with both feet, immediately jump max height. Minimize ground contact time. This is reactive strength training.'
            },
            'Hurdle Hops': {
                setup: 'Set 3-5 hurdles 3-4 feet apart. Face first hurdle.',
                execution: 'Jump over each hurdle continuously. Land and immediately take off. Drive arms up. Focus on height and quick contacts.'
            },
            'Banded Lateral Jumps': {
                setup: 'Heavy band around waist, anchored to side. Athletic stance.',
                execution: 'Jump laterally against band for max distance. Stick landing. Reset and repeat. Fight the band resistance.'
            },
            'Single-Leg Box Jumps': {
                setup: 'Stand on one leg facing appropriate height box.',
                execution: 'Jump onto box using single leg takeoff. Land on both feet or same leg. Step down. Requires balance and power.'
            },
            'Plyo Push-Ups': {
                setup: 'Push-up position. Hands slightly wider than shoulders.',
                execution: 'Lower into push-up, then explode up so hands leave ground. Land softly and immediately descend into next rep.'
            },
            'Med Ball Slams': {
                setup: 'Hold heavy med ball overhead. Feet shoulder-width. Core tight.',
                execution: 'Slam ball into ground with full force. Use entire body - arms, core, hips. Catch bounce and repeat.'
            },
            'Depth Push-Ups': {
                setup: 'Hands on low plates or blocks. Push-up position.',
                execution: 'Drop hands to floor between plates, immediately push up explosively back onto plates. Reactive upper body power.'
            },
            'Med Ball Rotational Slams': {
                setup: 'Hold med ball overhead, standing with feet wide.',
                execution: 'Slam ball diagonally to outside of foot. Rotate entire torso. Generate power from hips. Alternate sides.'
            },
            'Clapping Pull-Ups': {
                setup: 'Hang from pull-up bar. Overhand grip slightly wider than shoulders.',
                execution: 'Pull explosively, release bar at top, clap, re-grip. Land in controlled hang. Advanced movement - build up slowly.'
            },
            'Broad Jumps': {
                setup: 'Athletic stance. Arms back. Knees bent.',
                execution: 'Swing arms and jump forward for maximum distance. Land softly with bent knees. Stick landing for 3 seconds.'
            },
            'Single-Leg Broad Jump': {
                setup: 'Stand on one leg. Arms ready.',
                execution: 'Jump forward for distance off single leg. Land on both feet or same leg. Stick the landing. Control is key.'
            },
            'Box Jump (Forward)': {
                setup: 'Face box at appropriate height. Athletic stance.',
                execution: 'Jump forward onto box. Land softly in athletic position. Step down. Focus on distance and height combination.'
            },
            '180° Box Jumps': {
                setup: 'Stand sideways to box. Athletic position.',
                execution: 'Jump, rotate 180° mid-air, land facing opposite direction on box. Step down. Requires coordination and power.'
            },
            'Banded Broad Jumps': {
                setup: 'Resistance band around waist, anchored behind. Athletic stance.',
                execution: 'Jump forward against band resistance for max distance. Stick landing. Walk back and repeat.'
            },

            // === MAIN LIFTS - SQUATS ===
            'High Bar Back Squat': {
                setup: 'Bar on upper traps. Feet shoulder-width, toes slightly out. Chest up.',
                execution: 'Brace core hard. Descend by breaking at hips and knees together. Keep chest up, hit below parallel. Drive through whole foot.'
            },
            'Front Squat (Heavy)': {
                setup: 'Bar in front rack position on shoulders. Elbows high. Feet shoulder-width.',
                execution: 'Descend keeping torso very upright. Elbows stay high. Hit depth. Drive up through midfoot. More quad and core intensive.'
            },
            'Front Squat': {
                setup: 'Bar in front rack position on shoulders. Elbows high. Feet shoulder-width.',
                execution: 'Descend keeping torso very upright. Elbows stay high. Hit depth. Drive up through midfoot. More quad and core intensive.'
            },
            'Safety Bar Squat': {
                setup: 'Safety squat bar on traps with handles forward. Feet shoulder-width.',
                execution: 'Brace and descend. Bar wants to pitch you forward - fight to stay upright. Great for upper back and easier on shoulders.'
            },
            'Goblet Squat (Heavy)': {
                setup: 'Hold heavy dumbbell or kettlebell at chest. Elbows tight. Feet shoulder-width.',
                execution: 'Squat deep, keeping weight at chest. Elbows can touch inside of knees at bottom. Drive up. Great for core bracing practice.'
            },
            'Zercher Squat': {
                setup: 'Bar in crook of elbows, arms crossed. Feet shoulder-width or wider.',
                execution: 'Brace core extremely tight. Squat down keeping bar secure. Unique loading position challenges core differently.'
            },

            // === MAIN LIFTS - DEADLIFTS & HINGES ===
            'Trap Bar Deadlift': {
                setup: 'Stand in center of trap bar. Feet hip-width. Grab handles. Chest up.',
                execution: 'Brace core. Drive through feet. Hips and shoulders rise together. Stand tall and squeeze glutes at top.'
            },
            'Conventional Deadlift': {
                setup: 'Bar over mid-foot. Feet hip-width. Grip just outside legs. Chest up, back flat.',
                execution: 'Brace, push floor away. Bar stays close to legs. Hips and shoulders rise together. Lock out with glutes.'
            },
            'Sumo Deadlift': {
                setup: 'Wide stance, toes out. Grip inside legs. Chest up, hips close to bar.',
                execution: 'Push knees out, drive through floor. More quad involvement. Keep chest up. Hips come through at top.'
            },
            'Romanian Deadlift': {
                setup: 'Hold bar at hips. Feet hip-width. Slight knee bend.',
                execution: 'Push hips back, lowering bar along legs. Feel hamstring stretch. Keep back flat. Return by driving hips forward.'
            },
            'Snatch Grip RDL': {
                setup: 'Wide grip on bar (snatch width). Feet hip-width. Slight knee bend.',
                execution: 'Same as RDL but wide grip increases upper back demand. Feel stretch in hamstrings. Keep lats engaged.'
            },
            'Single-Leg RDL': {
                setup: 'Stand on one leg. Light weight in opposite hand or both hands.',
                execution: 'Hinge at hip, free leg extends behind for balance. Lower until hamstring stretch. Return to standing. Great for balance.'
            },
            'Good Mornings': {
                setup: 'Bar on upper back like squat. Feet hip-width. Slight knee bend.',
                execution: 'Hinge at hips, pushing them back. Lower torso until parallel. Keep back flat. Return by driving hips forward.'
            },

            // === MAIN LIFTS - LUNGES & SPLIT STANCE ===
            'Bulgarian Split Squats': {
                setup: 'Rear foot elevated on bench. Front foot 2-3 feet ahead. Dumbbells or barbell.',
                execution: 'Lower until rear knee nearly touches ground. Front knee tracks over toes. Drive through front foot to stand.'
            },
            'Skater Squats': {
                setup: 'Stand on one leg. Other leg behind, not touching ground.',
                execution: 'Squat down on single leg, reaching rear leg back for counterbalance. Touch rear knee to pad if needed. Stand back up.'
            },
            'Deficit Reverse Lunges': {
                setup: 'Stand on 2-4" platform. Dumbbells at sides or barbell.',
                execution: 'Step back into lunge, rear foot goes to floor below platform. Extra depth increases glute stretch. Drive up through front leg.'
            },
            'Walking Lunges': {
                setup: 'Stand with dumbbells at sides or barbell on back.',
                execution: 'Step forward into lunge, back knee nearly touches ground. Push through front foot to bring rear leg forward into next lunge.'
            },
            'Walking Lunges (Light)': {
                setup: 'Light or no weight. Hands at sides or on hips.',
                execution: 'Walk forward in continuous lunge pattern. Focus on form and stretch. Good for burnout sets and conditioning.'
            },
            'Reverse Lunges': {
                setup: 'Stand with weight. Feet hip-width.',
                execution: 'Step backward into lunge. Lower until rear knee nearly touches ground. Drive through front foot to return. More glute emphasis than forward.'
            },
            'Step-Ups (Heavy)': {
                setup: 'Face knee-height box. Hold heavy dumbbells or barbell.',
                execution: 'Step up driving through front leg only - don\'t push off back foot. Stand tall on box. Step down with control.'
            },

            // === MAIN LIFTS - PRESSING ===
            'Barbell Bench Press': {
                setup: 'Lie on bench. Eyes under bar. Feet flat. Slight back arch. Grip slightly wider than shoulders.',
                execution: 'Unrack and lower to mid-chest with control. Elbows at 45°. Touch chest. Press up in slight arc to lockout.'
            },
            'Close Grip Bench': {
                setup: 'Same as bench press but hands shoulder-width apart.',
                execution: 'Lower bar to lower chest/sternum. Elbows stay closer to body. More tricep emphasis. Full lockout.'
            },
            'Pause Bench Press': {
                setup: 'Same as regular bench press setup.',
                execution: 'Lower bar to chest, pause 2-3 seconds with bar touching (no bounce). Press up explosively. Builds strength off chest.'
            },
            'Overhead Press': {
                setup: 'Bar at shoulders, grip just outside shoulder-width. Feet hip-width. Squeeze glutes.',
                execution: 'Press bar straight up, moving head back then forward as bar passes. Lock out overhead. Lower with control.'
            },
            'Landmine Press': {
                setup: 'Hold end of barbell at shoulder. Other end in landmine or corner. Staggered stance.',
                execution: 'Press bar up and forward in arc. Shoulder-friendly angle. Full extension. Lower with control.'
            },
            'DB Overhead Press': {
                setup: 'Dumbbells at shoulders, palms forward or neutral. Seated or standing.',
                execution: 'Press both dumbbells overhead. Greater range of motion than barbell. Control the descent.'
            },
            'Incline DB Press': {
                setup: 'Bench at 30-45°. Dumbbells at chest level. Feet flat.',
                execution: 'Press dumbbells up, bringing them slightly together at top. Lower with control to chest stretch. Upper chest focus.'
            },
            'Push Press': {
                setup: 'Bar at shoulders like overhead press. Feet hip-width.',
                execution: 'Dip slightly at knees, then explosively drive bar overhead using leg power. Lock out. Lower to shoulders.'
            },
            'Jerk Press': {
                setup: 'Bar at shoulders. Feet hip-width.',
                execution: 'Dip and drive bar up, then quickly drop under bar into split or squat. Catch with locked arms. Stand up.'
            },
            'Viking Press (Landmine)': {
                setup: 'Landmine attachment with handles. Stand facing handles at shoulder height.',
                execution: 'Press handles overhead using leg drive if desired. Neutral grip is shoulder-friendly. Full extension.'
            },
            'Weighted Dips': {
                setup: 'On dip bars, weight belt with plates or dumbbell between legs.',
                execution: 'Lower with slight forward lean (chest emphasis) or upright (tricep emphasis). Go until upper arms parallel. Press up to lockout.'
            },
            'Ring Dips': {
                setup: 'Support yourself on gymnastic rings. Arms locked.',
                execution: 'Lower with control - rings want to move out. Requires more stabilization. Press up, turning rings out at top.'
            },
            'Decline Bench': {
                setup: 'On decline bench, feet secured. Bar at lower chest level.',
                execution: 'Lower bar to lower chest. Press up. Emphasizes lower chest. Generally can lift more than flat bench.'
            },
            'Machine Chest Press': {
                setup: 'Adjust seat so handles are at mid-chest. Feet flat.',
                execution: 'Press handles forward to full extension. Control the return. Constant tension throughout range.'
            },
            'Push-Ups': {
                setup: 'Hands slightly wider than shoulders. Body in straight line from head to heels.',
                execution: 'Lower chest to floor, elbows at 45°. Push back up to full extension. Keep core tight throughout.'
            },
            'Decline Push-Ups': {
                setup: 'Feet elevated on bench or box. Hands on floor slightly wider than shoulders.',
                execution: 'Lower chest toward floor. Push back up. Elevation increases difficulty and upper chest emphasis.'
            },

            // === MAIN LIFTS - PULLING ===
            'Pull-Ups': {
                setup: 'Hang from bar, overhand grip slightly wider than shoulders. Dead hang to start.',
                execution: 'Pull up until chin clears bar. Lead with chest. Lower with control to dead hang. Add weight when possible.'
            },
            'Chin-Ups': {
                setup: 'Hang from bar, underhand (supinated) grip shoulder-width.',
                execution: 'Pull up until chin over bar. More bicep involvement than pull-ups. Lower with control.'
            },
            'Wide Grip Pull-Ups': {
                setup: 'Hang from bar, grip 1.5x shoulder width. Overhand.',
                execution: 'Pull up leading with chest. Emphasizes lat width. Lower with control. Harder than standard pull-ups.'
            },
            'Barbell Rows': {
                setup: 'Hinge forward 45°, bar hanging at arm\'s length. Feet hip-width. Overhand or mixed grip.',
                execution: 'Pull bar to lower sternum, squeezing shoulder blades. Lower with control. Keep back flat throughout.'
            },
            'Pendlay Rows': {
                setup: 'Bar on floor. Hinged over with flat back parallel to ground.',
                execution: 'Explosively row bar to chest. Lower to floor, reset, repeat. Each rep starts from dead stop. More explosive.'
            },
            'Meadows Row': {
                setup: 'Landmine setup. Staggered stance perpendicular to bar. Grip end of bar.',
                execution: 'Row bar to hip with elbow flaring out. Great lat stretch at bottom. Squeeze at top. Unique angle.'
            },
            'Single-Arm DB Row': {
                setup: 'One hand and knee on bench. Other foot on floor. Dumbbell hanging.',
                execution: 'Row dumbbell to hip, elbow close to body. Anti-rotation component. Lower with control. Full stretch at bottom.'
            },
            'Chest-Supported Row': {
                setup: 'Lie face down on incline bench. Dumbbells or bar hanging.',
                execution: 'Row weight to chest, squeezing shoulder blades. Removes lower back from equation. Pure back work.'
            },
            'Chest-Supported Rows': {
                setup: 'Lie face down on incline bench. Dumbbells or bar hanging.',
                execution: 'Row weight to chest, squeezing shoulder blades. Removes lower back from equation. Pure back work.'
            },
            'T-Bar Row': {
                setup: 'Straddle T-bar or landmine. Grip handle. Hinged forward.',
                execution: 'Row handle to chest, squeezing back. Allow slight upper body rise. Lower with control. Heavy loading possible.'
            },
            'Seal Rows': {
                setup: 'Lie face down on elevated bench. Arms hang straight down with dumbbells or bar.',
                execution: 'Row weight up squeezing shoulder blades. Complete isolation - no momentum possible. Full stretch at bottom.'
            },
            'Inverted Rows': {
                setup: 'Set bar at hip height. Hang underneath, heels on ground, body straight.',
                execution: 'Pull chest to bar squeezing shoulder blades. Lower with control. Adjust difficulty by changing body angle.'
            },
            'Cable Rows': {
                setup: 'Sit at cable row station. Feet on platform. Grab handle.',
                execution: 'Pull handle to lower chest, squeezing shoulder blades. Let shoulders protract forward on return. Constant tension.'
            },
            'Single-Arm Cable Row': {
                setup: 'Stand or half-kneel at cable machine. Single handle.',
                execution: 'Row handle to side, resisting rotation. Anti-rotation core work plus back. Alternate sides.'
            },
            'Lat Pulldown': {
                setup: 'Sit at pulldown machine. Grip bar wide. Thighs under pad.',
                execution: 'Pull bar to upper chest, leading with elbows. Squeeze lats. Control return. Don\'t lean back excessively.'
            },
            'Face Pulls': {
                setup: 'Cable at face height. Rope attachment. Grip with thumbs toward you.',
                execution: 'Pull rope to face, separating hands and externally rotating shoulders. Squeeze rear delts. Essential for shoulder health.'
            },
            'Rear Delt Flyes': {
                setup: 'Bent over or on incline bench face down. Light dumbbells hanging.',
                execution: 'Raise arms out to sides, leading with elbows. Squeeze shoulder blades. Light weight, high reps.'
            },
            'Band Pull-Aparts': {
                setup: 'Hold band in front at shoulder height. Arms straight, shoulder-width grip.',
                execution: 'Pull band apart by squeezing shoulder blades together. Arms go out to sides. Control return. High rep shoulder health.'
            },
            'Reverse Flyes': {
                setup: 'Bent over or on incline bench face down. Light dumbbells.',
                execution: 'Raise arms to sides targeting rear delts. Keep slight elbow bend. Squeeze at top. Control descent.'
            },

            // === ACCESSORIES - LEGS ===
            'Leg Extensions': {
                setup: 'Sit in leg extension machine. Pad on shins. Adjust back pad.',
                execution: 'Extend legs fully, squeezing quads hard at top. Lower with control. Isolation quad exercise.'
            },
            'Leg Curls': {
                setup: 'Lie face down on leg curl machine. Pad behind ankles.',
                execution: 'Curl heels toward glutes. Squeeze hamstrings. Lower with control. Don\'t let hips rise.'
            },
            'Leg Press': {
                setup: 'Sit in leg press. Feet shoulder-width on platform. Release safeties.',
                execution: 'Lower platform with control until deep stretch. Press through whole foot. Don\'t lock knees at top.'
            },
            'Glute-Ham Raises': {
                setup: 'On GHD machine. Knees on pad. Feet anchored.',
                execution: 'Lower torso by straightening at knees. Use hamstrings to curl back up. Brutal hamstring exercise. Use assist if needed.'
            },
            'Standing Calf Raises': {
                setup: 'Stand on calf raise machine or block. Balls of feet on edge.',
                execution: 'Rise up on toes as high as possible. Full squeeze at top. Lower until heels below platform level for stretch.'
            },
            'Seated Calf Raises': {
                setup: 'Sit in seated calf machine. Knees under pad. Balls of feet on platform.',
                execution: 'Raise heels as high as possible. Hold squeeze. Lower for full stretch. Targets soleus muscle.'
            },
            'Calf Press on Leg Press': {
                setup: 'On leg press with just balls of feet on platform edge.',
                execution: 'Press through toes, extending ankles. Full range of motion. Can use heavy weight.'
            },
            'Single-Leg Calf Raise': {
                setup: 'Stand on one foot on block or step. Hold something for balance.',
                execution: 'Rise up on toes, full squeeze. Lower below platform level. Do all reps on one leg before switching.'
            },
            'Tibialis Raises': {
                setup: 'Sit on edge of bench. Heels on ground, toes up. Or use tib bar.',
                execution: 'Raise toes toward shins. Builds tibialis anterior. Important for shin health and ankle stability.'
            },

            // === ACCESSORIES - ARMS ===
            'Hammer Curls': {
                setup: 'Stand with dumbbells at sides, palms facing body.',
                execution: 'Curl weights up keeping neutral grip. Squeeze brachialis. Lower with control. Builds forearm too.'
            },
            'Overhead Tricep Extension': {
                setup: 'Hold dumbbell overhead with both hands or cable behind head.',
                execution: 'Lower weight behind head by bending elbows. Feel tricep stretch. Press back up to lockout.'
            },
            'Barbell Curls': {
                setup: 'Stand holding barbell with underhand grip. Arms at sides.',
                execution: 'Curl bar up keeping elbows pinned. Squeeze biceps at top. Lower with control. Strict form.'
            },
            'Skull Crushers': {
                setup: 'Lie on bench. Hold bar or EZ bar with arms straight over chest.',
                execution: 'Lower weight toward forehead by bending elbows only. Extend back up. Keep upper arms still.'
            },
            'Cable Curls': {
                setup: 'Face cable machine. Handle at low position. Grab with underhand grip.',
                execution: 'Curl handle up squeezing biceps. Constant cable tension throughout. Lower with control.'
            },
            'Rope Pushdowns': {
                setup: 'Face cable machine. Rope at high position. Grab rope ends.',
                execution: 'Push down extending elbows fully. Spread rope at bottom for extra contraction. Control return.'
            },

            // === ACCESSORIES - SHOULDERS ===
            'Lateral Raises': {
                setup: 'Stand with light dumbbells at sides. Slight bend in elbows.',
                execution: 'Raise arms out to sides until parallel to ground. Lead with elbows. Control descent. Don\'t swing.'
            },
            'Cable Upright Rows': {
                setup: 'Face cable machine. Bar at low position. Grip shoulder-width or wider.',
                execution: 'Pull bar up along body to chest height. Elbows go high and out. Squeeze at top. Lower with control.'
            },
            'Front Raises': {
                setup: 'Stand with dumbbells in front of thighs or plate.',
                execution: 'Raise weight forward to shoulder height. Keep slight elbow bend. Lower with control. Alternate or together.'
            },
            'Cable Flyes': {
                setup: 'Stand between cable machines set at shoulder height. Handle in each hand.',
                execution: 'Bring handles together in front of chest in hugging motion. Squeeze chest. Return with control.'
            },

            // === CORE EXERCISES ===
            'Anti-Extension Circuit': {
                setup: 'Prepare for planks, side planks, and dead bugs.',
                execution: 'Plank 45s (brace core, flat back) → Side plank 30s each side → Dead bugs 12/side (opposite arm/leg extend). No rest between.'
            },
            'Loaded Carries': {
                setup: 'Pick up heavy dumbbells or kettlebells.',
                execution: 'Walk 40m with perfect posture. Includes farmer carry (both hands), overhead carry, suitcase carry (one hand). Crushing core work.'
            },
            'Rotational Core': {
                setup: 'Mat or bench for exercises.',
                execution: 'Russian twists, bicycle crunches, and oblique crunches. 10 reps per side each exercise. Control the rotation.'
            },
            'Compression Circuit': {
                setup: 'Mat for floor exercises.',
                execution: 'Leg raises 10-15, V-ups 10-15, hollow holds 20s. Targets hip flexors and rectus abdominis.'
            },
            'Ab Wheel Rollouts': {
                setup: 'Kneel on mat. Grip ab wheel with both hands.',
                execution: 'Roll wheel forward, extending body. Go as far as you can control. Use abs to pull back. Don\'t let hips sag.'
            },
            'Dead Bugs': {
                setup: 'Lie on back. Arms straight up, knees at 90°.',
                execution: 'Lower opposite arm and leg toward floor while keeping lower back pressed down. Alternate sides with control.'
            },
            'Toes to Bar': {
                setup: 'Hang from pull-up bar. Arms straight.',
                execution: 'Raise legs up to touch bar using core. Control the descent. Requires flexibility and strength.'
            },
            'Pallof Press': {
                setup: 'Cable at chest height. Hold handle at sternum. Stand sideways.',
                execution: 'Press handle straight out, resisting rotation. Hold at extension. Return to chest. Anti-rotation core.'
            },
            'Landmine Rotations': {
                setup: 'Hold end of landmine barbell at chest with straight arms.',
                execution: 'Rotate torso, moving bar in arc from hip to hip. Control the movement. Works obliques dynamically.'
            },
            'Cable Woodchops': {
                setup: 'Cable set high or low. Stand sideways to machine.',
                execution: 'Pull cable diagonally across body (high to low or low to high). Rotate through core. Control return.'
            },
            'Hanging Leg Raises': {
                setup: 'Hang from pull-up bar or captain\'s chair. Arms straight.',
                execution: 'Raise legs until parallel to ground or higher. Control descent - no swinging. Bend knees to make easier.'
            },
            'Decline Sit-Ups': {
                setup: 'Lie on decline bench, feet hooked under pads.',
                execution: 'Sit up fully, can add weight across chest. Lower with control. Decline increases difficulty.'
            },
            'Dragon Flags': {
                setup: 'Lie on bench, grip behind head. Legs straight up.',
                execution: 'Lower entire body as one straight unit. Only shoulders touch bench. Raise back up. Advanced movement.'
            },
            'Plank Variations': {
                setup: 'Standard plank position on elbows.',
                execution: 'Hold front plank, then side planks each direction. Keep body straight. Brace core tight. 30-60s each.'
            },
            'Bird Dogs': {
                setup: 'On hands and knees. Back flat.',
                execution: 'Extend opposite arm and leg straight out. Hold briefly. Return and switch. No rotation in hips or shoulders.'
            },
            'Farmer Carries': {
                setup: 'Stand holding heavy dumbbells or kettlebells at sides.',
                execution: 'Walk with tall posture, shoulders back, core braced. Don\'t let weight pull you to sides.'
            },
            'Suitcase Carries': {
                setup: 'Heavy dumbbell or kettlebell in one hand only.',
                execution: 'Walk without leaning toward or away from weight. Anti-lateral flexion core work. Switch sides.'
            },
            'Overhead Carries': {
                setup: 'Single kettlebell or dumbbell pressed overhead.',
                execution: 'Walk with arm locked out, bicep by ear. Core braced to prevent rib flare. Challenges shoulder stability.'
            },
            'Zercher Carries': {
                setup: 'Barbell in crook of elbows, arms crossed.',
                execution: 'Walk maintaining upright posture. Brutal on core and biceps. Unique carry variation.'
            },
            'Turkish Get-Up': {
                setup: 'Lie on back. Kettlebell pressed up with one arm.',
                execution: 'Stand up through specific sequence while keeping weight overhead. Reverse to return. Full body stability exercise.'
            },
            'Heavy Carries + Plank': {
                setup: 'Heavy dumbbells and mat ready.',
                execution: 'Farmer carry 20m, immediately into weighted plank 30s. Combines dynamic and static core work.'
            },
            'Anti-Rotation Complex': {
                setup: 'Cable machine and mat.',
                execution: 'Pallof press, bird dogs, side plank - 10/side each. All anti-rotation exercises. No rest between.'
            },
            'Explosive Core': {
                setup: 'Med ball and mat.',
                execution: 'Med ball slams 10, mountain climbers 20, v-ups 15. Ballistic core training. Keep rest minimal.'
            },
            'Isometric Hold Circuit': {
                setup: 'Mat for floor work.',
                execution: 'Hollow hold 20s, plank 30s, dead bug hold 20s/side. Static core strength. Breathe through holds.'
            },
            'Plank Circuit': {
                setup: 'Mat for planks.',
                execution: 'Front plank, left side plank, right side plank. 45s each. Keep body straight, core braced.'
            },
            'Anti-Rotation Circuit': {
                setup: 'Cable and mat.',
                execution: 'Pallof press 10/side, bird dogs 10/side, dead bugs 10/side. Anti-rotation focus throughout.'
            },
            'Hanging Core': {
                setup: 'Hang from pull-up bar.',
                execution: 'Hanging knee raises or straight leg raises for 10-15 reps. Control swing. Hits lower abs.'
            },

            // === OLYMPIC LIFTS & POWER ===
            'Power Clean': {
                setup: 'Bar on floor. Feet hip-width. Grip just outside knees. Flat back, chest up.',
                execution: 'Pull bar from floor explosively. When bar reaches hips, jump and shrug. Drop under bar, catching in front rack. Stand up.'
            },
            'Hang Clean': {
                setup: 'Bar at hip height. Slight knee bend. Grip just outside knees.',
                execution: 'Dip slightly at knees, then explosively extend hips and pull. Drop under bar to catch in front rack. Stand.'
            },
            'Clean Pull': {
                setup: 'Bar on floor. Clean grip. Flat back.',
                execution: 'Pull bar like a deadlift, then explosively jump and shrug at top. Don\'t pull with arms. Builds power for cleans.'
            },
            'Kettlebell Swings (Heavy)': {
                setup: 'Straddle heavy kettlebell. Hinge and grip handle. Flat back.',
                execution: 'Hike bell back, then snap hips to drive bell to chest height. Arms are just hooks. All hip power.'
            },
            'Snatch Grip High Pull': {
                setup: 'Wide grip on bar. Feet hip-width. Flat back.',
                execution: 'Pull from floor explosively. At hip contact, shrug and pull elbows high. Bar reaches chest height. Builds snatch power.'
            },

            // === CARDIO & CONDITIONING ===
            'Incline Treadmill Walk': {
                setup: 'Set treadmill to 15% incline. Speed 3.0-3.5 mph.',
                execution: 'Walk maintaining Zone 2 heart rate. Should be able to hold conversation. Pumps blood to legs for recovery.'
            },
            'Incline Treadmill Walk (40min)': {
                setup: 'Set treadmill to 15% incline. Speed 3.0-3.5 mph.',
                execution: 'Walk maintaining Zone 2 heart rate for 40 minutes. Conversational pace. ~275-325 calories burned.'
            },
            'Stationary Bike': {
                setup: 'Adjust seat height. Light resistance.',
                execution: 'Pedal at easy, conversational pace. Zone 2 cardio. Focus on recovery, not intensity.'
            },
            'Stationary Bike (40min)': {
                setup: 'Adjust seat height. Light resistance.',
                execution: 'Pedal at easy, conversational pace for 40 minutes. ~250-300 calories. Active recovery.'
            },
            'Easy Jog': {
                setup: 'Flat terrain. Comfortable shoes.',
                execution: 'Jog at pace where you can nose-breathe only. If you need to mouth-breathe, slow down. Zone 2.'
            },
            'Easy Jog (40min)': {
                setup: 'Flat terrain. Comfortable shoes.',
                execution: 'Jog at conversational pace for 40 minutes. ~300-350 calories. Keep heart rate in Zone 2.'
            },
            'Elliptical': {
                setup: 'Set low resistance. Grip handles lightly.',
                execution: 'Move at steady, sustainable pace. Zone 2 effort. Good low-impact option.'
            },
            'Elliptical (40min)': {
                setup: 'Set low resistance.',
                execution: 'Steady pace for 40 minutes. Low impact cardio. Keep it conversational.'
            },
            'Rowing (Easy Pace)': {
                setup: 'Strap feet in. Grip handle lightly.',
                execution: 'Row with focus on technique, not speed. Drive with legs first, then back, then arms. Zone 2.'
            },
            'Rowing Machine (Easy)': {
                setup: 'Strap feet in. Light grip on handle.',
                execution: 'Steady sustainable pace for duration. Focus on form: legs-back-arms, arms-back-legs. Zone 2 effort.'
            },
            'Swimming': {
                setup: 'Pool with lanes. Any stroke you\'re comfortable with.',
                execution: 'Easy laps at conversational effort. Great full-body recovery cardio. Mix strokes if desired.'
            },
            'Swim': {
                setup: 'Pool with lanes. Any comfortable stroke.',
                execution: 'Easy laps at sustainable pace. Low impact, full body cardio. Great for recovery days.'
            },
            'Outdoor Walk': {
                setup: 'Find route with hills if possible.',
                execution: 'Walk at brisk pace for duration. Hills add intensity without running. Zone 2 effort.'
            },
            'Stair Climber': {
                setup: 'Set moderate pace on stair machine.',
                execution: 'Climb stairs at sustainable pace. Glute emphasis. Don\'t lean heavily on rails.'
            },
            'Bodyweight Circuit': {
                setup: 'Clear space. Set timer for 40s work, 20s rest.',
                execution: 'Cycle through: burpees, jump squats, push-ups, mountain climbers, KB swings. 5 rounds. Maximum effort.'
            },
            'Treadmill Sprints': {
                setup: 'Set treadmill to 8-12 mph, 1-3% incline.',
                execution: 'Sprint 20-30 seconds, then rest 60-90 seconds (stand on rails). Repeat 10 times. All-out effort.'
            },
            'Sled Work': {
                setup: 'Load sled with heavy weight. Clear 40m lane.',
                execution: 'Push sled length of lane. Low, driving steps. Walk back during rest. Brutal conditioning.'
            },
            'Assault Bike': {
                setup: 'Seat height so slight knee bend at bottom.',
                execution: '30 seconds max effort (arms AND legs), 30 seconds easy. Repeat 10 rounds. The bike humbles everyone.'
            },

            // === MOBILITY & RECOVERY ===
            'Lower Body Flow': {
                setup: 'Mat or soft surface. No equipment needed.',
                execution: 'Continuous flow: hip circles, leg swings, 90/90 stretch, pigeon pose, deep squat hold. 10 minutes of movement.'
            },
            'Upper Body Flow': {
                setup: 'Mat and optional band or stick.',
                execution: 'Flow through: shoulder dislocations, wall slides, thoracic rotations, cat-cow. Open up upper body.'
            },
            'Full Body Yoga Flow': {
                setup: 'Yoga mat. Quiet space.',
                execution: 'Sun salutations, downward dog, warrior poses, child\'s pose. Follow breath. 10 minutes of gentle movement.'
            },
            'Foam Rolling Session': {
                setup: 'Foam roller. Mat optional.',
                execution: 'Roll calves, quads, IT band, glutes, upper back. 1-2 minutes per area. Pause on tender spots.'
            },
            'Lower Body Stretching': {
                setup: 'Mat for floor stretches.',
                execution: 'Static stretches for hip flexors, hamstrings, glutes, calves. Hold each 30-60 seconds. Breathe into stretch.'
            },
            'Upper Body Stretching': {
                setup: 'Doorway or wall helpful.',
                execution: 'Static stretches for shoulders, chest, lats, triceps. Hold each 30-60 seconds. Don\'t force it.'
            },
            'Yoga Flow': {
                setup: 'Mat. Comfortable clothes.',
                execution: 'Sun salutations and gentle holds. Follow breath. Focus on mobility, not intensity.'
            },
            'Dynamic Mobility': {
                setup: 'Open space. No equipment.',
                execution: 'Leg swings, arm circles, hip circles, world\'s greatest stretch. Movement-based warmup or cooldown.'
            },

            // === SPORT & RECREATION ===
            'Pickup Soccer': {
                setup: 'Field or gym. Ball. Other players.',
                execution: 'Small-sided games. Focus on fun and movement. Great conditioning that doesn\'t feel like work.'
            },
            'Tennis': {
                setup: 'Court, racket, balls, opponent.',
                execution: 'Singles or doubles. Great lateral movement, hand-eye coordination, and cardio.'
            },
            'MMA Training': {
                setup: 'Heavy bag, gloves, open space.',
                execution: 'Bag work, shadowboxing, basic combinations. Great for conditioning and stress relief.'
            },
            'Basketball': {
                setup: 'Court. Ball. Other players helpful.',
                execution: 'Pickup games or shooting around. Sprinting, jumping, lateral movement. Fun conditioning.'
            },
            'Skip Core Today': {
                setup: 'No setup needed.',
                execution: 'Full recovery option. Just do your cardio and stretching. Sometimes rest is the best choice.'
            },
            'Skip Core': {
                setup: 'No setup needed.',
                execution: 'Rest option for core. Focus on main workout recovery. Listen to your body.'
            },

            // === CORE EXERCISES (Individual) ===
            'Plank': {
                setup: 'Forearms on ground, elbows under shoulders. Body in straight line from head to heels.',
                execution: 'Hold position, bracing core tight. Don\'t let hips sag or pike up. Breathe steadily. 45-60 seconds.'
            },
            'Side Plank': {
                setup: 'Lie on side, forearm on ground, elbow under shoulder. Stack feet or stagger.',
                execution: 'Lift hips to create straight line. Hold without letting hips drop. 30 seconds each side.'
            },
            'Hollow Body Hold': {
                setup: 'Lie on back. Arms overhead, legs straight out.',
                execution: 'Press lower back into floor. Lift shoulders and legs off ground. Hold banana shape. 30-45 seconds.'
            },
            'Farmer Carry': {
                setup: 'Stand holding heavy dumbbells or kettlebells at sides.',
                execution: 'Walk with tall posture, shoulders back, core braced. Don\'t let weights swing. 40m.'
            },
            'Russian Twists': {
                setup: 'Sit with knees bent, feet off ground or anchored. Hold weight at chest.',
                execution: 'Rotate torso side to side, touching weight to ground each side. Control the rotation. 15 per side.'
            },
            'Bicycle Crunches': {
                setup: 'Lie on back, hands behind head. Legs off ground.',
                execution: 'Bring opposite elbow to knee while extending other leg. Alternate sides with control. 15 per side.'
            },
            'Suitcase Carry': {
                setup: 'Heavy dumbbell or kettlebell in one hand only at side.',
                execution: 'Walk without leaning toward or away from weight. Fight the lateral pull. 40m each side.'
            },
            'Leg Raises': {
                setup: 'Lie on back, hands under lower back or at sides. Legs straight.',
                execution: 'Raise legs to vertical, keeping them straight. Lower slowly without arching back. 10-15 reps.'
            },
            'V-Ups': {
                setup: 'Lie flat on back. Arms overhead, legs straight.',
                execution: 'Simultaneously raise arms and legs to touch toes at top. Lower with control. 10-15 reps.'
            },
            'Oblique Crunches': {
                setup: 'Lie on side, knees slightly bent. Bottom arm extended, top hand behind head.',
                execution: 'Crunch up, bringing elbow toward hip. Squeeze obliques at top. 12 per side.'
            },
            'Overhead Carry': {
                setup: 'Press dumbbell or kettlebell overhead. Lock arm, bicep by ear.',
                execution: 'Walk while keeping weight stable overhead. Core braced, no rib flare. 40m each arm.'
            },

            // === HIIT EXERCISES ===
            'Burpees': {
                setup: 'Stand with feet shoulder-width apart.',
                execution: 'Squat down, hands to floor. Jump feet back to plank. Optional push-up. Jump feet to hands. Jump up with arms overhead. Repeat.'
            },
            'Treadmill Sprint': {
                setup: 'Set treadmill to 8-12 mph, 1-3% incline. Stand on rails.',
                execution: 'Step onto belt and sprint for 20-30 seconds. Step back to rails for rest. Maximum effort.'
            },
            'Assault Bike Sprint': {
                setup: 'Adjust seat height. Feet on pedals, hands on handles.',
                execution: 'Go all-out for 30 seconds - push AND pull with arms. Legs driving hard. Watch calories climb.'
            },
            'Sled Push': {
                setup: 'Load sled heavy. Hands on high or low handles. Feet behind sled.',
                execution: 'Drive forward with low, powerful steps. Push for 30-40m. Keep chest up, core braced.'
            },
            'Sled Drag': {
                setup: 'Attach straps to sled. Face away from sled, hold straps at hips or over shoulders.',
                execution: 'Walk backward dragging sled. Stay low, take short powerful steps. Keep tension on straps throughout.'
            },
            'Prowler Push': {
                setup: 'Load prowler. Grip low handles. Body at 45-degree angle to ground.',
                execution: 'Drive forward with explosive leg drive. Keep arms locked, core tight. Sprint for distance.'
            },
            'Rowing Sprint': {
                setup: 'Sit on rower. Feet strapped in. Grip handle with arms extended.',
                execution: 'Drive hard with legs, lean back slightly, pull handle to chest. Max effort strokes. Focus on power per stroke.'
            },
            'Assault Bike Sprint': {
                setup: 'Sit on assault bike. Feet on pedals, hands on handles.',
                execution: 'Go all-out pushing and pulling with arms while driving legs. Maximum effort for the interval duration.'
            },
            'Row Intervals': {
                setup: 'Sit on rower. Set monitor to 500m intervals. Feet strapped, arms extended.',
                execution: 'Row 500m at max sustainable pace. Rest between intervals. Focus on consistent split times across all sets.'
            },
            'Assault Bike Intervals': {
                setup: 'Sit on assault bike. Set timer for work/rest intervals.',
                execution: 'Go all-out for work period, then easy spin or complete rest. Tabata style - max effort each interval.'
            },
            'Jump Squats': {
                setup: 'Stand with feet shoulder-width. Arms ready.',
                execution: 'Squat down, then explode upward into jump. Land softly with bent knees. Immediately descend into next rep.'
            },
            'Mountain Climbers': {
                setup: 'Start in push-up position. Core tight, body straight.',
                execution: 'Drive knees toward chest alternating legs rapidly. Keep hips down. Go fast while maintaining form.'
            },
            'Battle Ropes': {
                setup: 'Hold rope ends. Athletic stance facing anchor point.',
                execution: 'Create alternating waves by raising and lowering arms rapidly. Keep core tight. Full range of motion.'
            },
            'Push-Up Variations': {
                setup: 'Push-up position. Hands slightly wider than shoulders.',
                execution: 'Standard push-ups, or make explosive by pushing hands off ground. Maintain straight body throughout.'
            },
            'KB Swings': {
                setup: 'Stand with feet wider than shoulders. Kettlebell on ground in front.',
                execution: 'Hike KB back, then drive hips forward explosively to swing KB to shoulder height. Control the descent.'
            },
            'Med Ball Slams': {
                setup: 'Hold heavy med ball overhead. Feet shoulder-width.',
                execution: 'Slam ball into ground with full force using entire body. Catch bounce and repeat immediately.'
            },
            'Rowing Sprint': {
                setup: 'Strap feet in rowing machine. Grip handle.',
                execution: 'Row with maximum power and speed. Drive with legs, pull with back, finish with arms. All-out effort.'
            },
            'High Knees': {
                setup: 'Stand tall. Arms ready at sides.',
                execution: 'Run in place, driving knees as high as possible. Pump arms. Fast tempo, stay on balls of feet.'
            },
            'Jumping Lunges': {
                setup: 'Start in lunge position. Arms ready.',
                execution: 'Jump and switch legs in mid-air. Land softly in opposite lunge. Alternate continuously.'
            },
            'Ski Erg Sprint': {
                setup: 'Stand facing ski erg. Grip handles overhead.',
                execution: 'Pull handles down explosively while hinging at hips. Drive with lats and core. Maximum effort pulls.'
            },
            'Sprawls': {
                setup: 'Stand with feet shoulder-width apart.',
                execution: 'Drop to ground, kicking legs back (like burpee without push-up). Jump feet back in and stand. Fast tempo.'
            }
        };

        let workoutLog = {};
        let rotationTracking = {};
        let currentView = 'home';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedCalendarDate = null;
        
        // Workout timer variables
        let workoutStartTime = null;
        let workoutTimer = null;
        let currentWorkoutType = null;
        let isDeloadWorkout = false;

        // Rotation recommendation thresholds (in weeks)
        const ROTATION_THRESHOLDS = {
            plyos: 4,
            mainLifts: 12,
            accessories: 8,
            core: 6
        };

        async function init() {
            await loadData();
            updateHomeScreen();
            updateDate();
            initYearSelect();
            renderCalendar();
        }

        const USER_ID = 'default_user'; // You can add authentication later for multiple users

        async function loadData() {
            try {
                const doc = await db.collection('users').doc(USER_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    workoutLog = data.workoutLog || {};
                    rotationTracking = data.rotationTracking || {};
                    console.log('Data loaded from Firebase');
                    return;
                }
            } catch (e) {
                console.log('Firebase not available, falling back to localStorage:', e);
            }
            // Fallback to localStorage
            const saved = localStorage.getItem('workoutLog');
            if (saved) {
                workoutLog = JSON.parse(saved);
            }
            const savedRotations = localStorage.getItem('rotationTracking');
            if (savedRotations) {
                rotationTracking = JSON.parse(savedRotations);
            }
        }

        async function saveData() {
            try {
                await db.collection('users').doc(USER_ID).set({
                    workoutLog,
                    rotationTracking,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Data saved to Firebase');
            } catch (e) {
                console.log('Firebase not available, falling back to localStorage:', e);
                // Fallback to localStorage
                localStorage.setItem('workoutLog', JSON.stringify(workoutLog));
                localStorage.setItem('rotationTracking', JSON.stringify(rotationTracking));
            }
        }

        // Rest timer variables
        let restTimerInterval = null;
        let restTimeRemaining = 0;
        let currentRestSetId = null;

        function parseRestTime(restString) {
            // Parse rest time like "90s", "2 min", "60-90s"
            const match = restString.match(/(\d+)/);
            if (match) {
                const value = parseInt(match[1]);
                if (restString.includes('min')) {
                    return value * 60;
                }
                return value;
            }
            return 60; // default 60 seconds
        }

        function startRestTimer(setId, restSeconds) {
            currentRestSetId = setId;
            restTimeRemaining = restSeconds;

            const overlay = document.getElementById('restTimerOverlay');
            const display = document.getElementById('restTimerDisplay');

            overlay.classList.add('active');
            updateRestDisplay();

            // Mark the button as resting
            const btn = document.getElementById(setId);
            if (btn) {
                btn.classList.add('resting');
            }

            restTimerInterval = setInterval(() => {
                restTimeRemaining--;
                updateRestDisplay();

                // Update the button countdown
                if (btn) {
                    const mins = Math.floor(restTimeRemaining / 60);
                    const secs = restTimeRemaining % 60;
                    btn.textContent = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : secs;
                }

                if (restTimeRemaining <= 0) {
                    endRestTimer(true);
                }
            }, 1000);
        }

        function updateRestDisplay() {
            const display = document.getElementById('restTimerDisplay');
            const mins = Math.floor(restTimeRemaining / 60);
            const secs = restTimeRemaining % 60;
            display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function endRestTimer(playAlert) {
            clearInterval(restTimerInterval);
            restTimerInterval = null;

            const overlay = document.getElementById('restTimerOverlay');
            overlay.classList.remove('active');

            // Mark the button as checked (not resting anymore)
            if (currentRestSetId) {
                const btn = document.getElementById(currentRestSetId);
                if (btn) {
                    btn.classList.remove('resting');
                    btn.classList.add('checked');
                    btn.textContent = '✓';
                }
            }

            if (playAlert) {
                // Play alert sound and vibrate
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                // Try to play a sound
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not available');
                }
            }

            currentRestSetId = null;
        }

        function skipRestTimer() {
            endRestTimer(false);
        }

        function toggleSetComplete(setId, restString) {
            const btn = document.getElementById(setId);
            if (!btn) return;

            if (btn.classList.contains('checked') || btn.classList.contains('resting')) {
                // Already checked or resting, uncheck it
                if (restTimerInterval && currentRestSetId === setId) {
                    endRestTimer(false);
                }
                btn.classList.remove('checked', 'resting');
                btn.textContent = '';
            } else {
                // Start rest timer
                const restSeconds = parseRestTime(restString);
                startRestTimer(setId, restSeconds);
            }
        }

        function updateDate() {
            const today = new Date();
            const formatted = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('currentDate').textContent = formatted;
            document.getElementById('workoutDate').textContent = formatted;
        }

        const workoutIcons = {
            'Lower Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><path d="M12 8v4"/><path d="M9 12l-3 8"/><path d="M15 12l3 8"/><path d="M7 20h2"/><path d="M15 20h2"/></svg>',
            'Upper Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12"/><path d="M4 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><path d="M20 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><rect x="6" y="9" width="12" height="6" rx="1"/></svg>',
            'Recovery': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12c0-4 4-8 8-8"/><path d="M12 4c4 0 8 4 8 8"/><path d="M12 4v8l4 4"/><circle cx="12" cy="12" r="9"/></svg>',
            'Full Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v4"/><path d="M8 10h8"/><path d="M8 10l-2 10"/><path d="M16 10l2 10"/><path d="M10 14l-1 6"/><path d="M14 14l1 6"/></svg>',
            'Upper Volume': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h1"/><path d="M19 12h1"/><rect x="5" y="8" width="3" height="8" rx="1"/><rect x="16" y="8" width="3" height="8" rx="1"/><rect x="8" y="5" width="8" height="14" rx="1"/></svg>',
            'HIIT': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
        };

        function updateHomeScreen() {
            const grid = document.getElementById('workoutGrid');
            const workoutTypes = [
                { key: 'Lower Body' },
                { key: 'Upper Body' },
                { key: 'Recovery' },
                { key: 'Full Body' },
                { key: 'Upper Volume' },
                { key: 'HIIT' }
            ];

            let html = '';
            workoutTypes.forEach(({ key }) => {
                const workout = WORKOUTS[key];
                const lastWorkout = getLastWorkoutDate(key);
                const icon = workoutIcons[key];
                html += `
                    <div class="workout-card" onclick="startWorkout('${key}')">
                        <div class="workout-card-header">
                            <div class="workout-icon">${icon}</div>
                            <div class="workout-title">${workout.title}</div>
                        </div>
                        <div class="workout-meta">${workout.duration} • ${workout.focus}</div>
                        ${lastWorkout ? `<div class="last-workout">Last: ${lastWorkout}</div>` : ''}
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function getLastWorkoutDate(workoutType) {
            const sessions = Object.keys(workoutLog).filter(key => 
                key.includes('_session_') && key.includes(workoutType)
            );
            if (sessions.length === 0) return null;

            const dates = sessions.map(key => key.split('_')[0]);
            const latestDate = new Date(Math.max(...dates.map(d => new Date(d))));
            const today = new Date();
            const diffDays = Math.floor((today - latestDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return latestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
                btn.classList.remove('active');
                if ((screen === 'home' && idx === 0) || (screen === 'calendar' && idx === 1)) {
                    btn.classList.add('active');
                }
            });

            // Hide workout bottom controls when not on workout screen
            if (screen !== 'workout') {
                hideWorkoutBottomControls();
            }

            // Show/hide active workout banner when not on workout screen
            updateActiveWorkoutBanner(screen);

            currentView = screen;

            if (screen === 'calendar') {
                // Auto-select today's date
                const today = new Date().toISOString().split('T')[0];
                selectedCalendarDate = today;
                renderCalendar();
                showDayWorkouts(today);
            }
        }

        function updateActiveWorkoutBanner(currentScreen) {
            const banner = document.getElementById('activeWorkoutBanner');
            const hasActiveWorkout = workoutStartTime !== null && currentWorkoutType !== null;

            if (hasActiveWorkout && currentScreen !== 'workout') {
                // Show banner on non-workout screens
                banner.style.display = 'flex';
                document.getElementById('bannerWorkoutName').textContent = currentWorkoutType;
                document.getElementById('bannerWorkoutTime').textContent = getElapsedTime();
                document.body.classList.add('has-active-banner');
            } else {
                // Hide banner
                banner.style.display = 'none';
                document.body.classList.remove('has-active-banner');
            }
        }

        function returnToActiveWorkout() {
            if (currentWorkoutType && workoutStartTime) {
                // Return to active workout without restarting
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('workoutScreen').classList.add('active');

                // Hide banner since we're back in workout
                document.getElementById('activeWorkoutBanner').style.display = 'none';
                document.body.classList.remove('has-active-banner');

                // Show header timer
                document.getElementById('headerTimer').style.display = 'flex';
                document.getElementById('headerTimerDisplay').textContent = getElapsedTime();

                // Render content without restarting timer
                renderWorkoutContent(currentWorkoutType);

                // Ensure timer update is running
                if (!workoutTimer) {
                    startTimerUpdate();
                }

                currentView = 'workout';
            }
        }

        function goHome() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('homeScreen').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
            hideWorkoutBottomControls();
            updateActiveWorkoutBanner('home');
            currentView = 'home';
            updateHomeScreen();
        }

        function hideWorkoutBottomControls() {
            const bottomControls = document.getElementById('workoutBottomControls');
            if (bottomControls) {
                bottomControls.style.display = 'none';
            }
        }

        function getExerciseType(sectionTitle) {
            const title = sectionTitle.toLowerCase();
            if (title.includes('plyo')) return 'plyos';
            if (title.includes('main lift')) return 'mainLifts';
            if (title.includes('core') || title.includes('abs')) return 'core';
            if (title.includes('accessor') || title.includes('volume') || title.includes('superset')) return 'accessories';
            return 'accessories';
        }

        function getExerciseDaysSinceReset(workoutType, exerciseName, baseExerciseName) {
            // Get the reset date for this exercise (when another variant completed a cycle)
            const resetKey = `${workoutType}_${baseExerciseName}_resetDate`;
            const resetDate = rotationTracking[resetKey] ? new Date(rotationTracking[resetKey]) : null;

            const workoutDays = Object.keys(workoutLog).filter(key => {
                if (!key.includes(workoutType) || !key.includes(exerciseName) || !key.includes('_1')) {
                    return false;
                }
                // Only count days after the reset date
                if (resetDate) {
                    const dayDate = new Date(key.split('_')[0]);
                    return dayDate >= resetDate;
                }
                return true;
            });

            return new Set(workoutDays.map(key => key.split('_')[0])).size;
        }

        function shouldRecommendRotation(workoutType, exerciseName, exerciseType, baseExerciseName) {
            const uniqueDays = getExerciseDaysSinceReset(workoutType, exerciseName, baseExerciseName);

            const threshold = ROTATION_THRESHOLDS[exerciseType] || 8;
            const daysThreshold = threshold * 2;

            const trackingKey = `${workoutType}_${exerciseName}`;
            if (rotationTracking[trackingKey] && rotationTracking[trackingKey].lastRecommendation) {
                const lastRecDate = new Date(rotationTracking[trackingKey].lastRecommendation);
                const now = new Date();
                const daysSinceRec = Math.floor((now - lastRecDate) / (24 * 60 * 60 * 1000));

                if (daysSinceRec < (daysThreshold * 3.5)) {
                    return false;
                }
            }

            return uniqueDays >= daysThreshold;
        }

        function markRotationRecommended(workoutType, exerciseName) {
            const trackingKey = `${workoutType}_${exerciseName}`;
            if (!rotationTracking[trackingKey]) {
                rotationTracking[trackingKey] = {};
            }
            rotationTracking[trackingKey].lastRecommendation = new Date().toISOString();
            saveData();
        }

        function markCycleCompleted(workoutType, baseExerciseName) {
            // When an exercise completes a full cycle (24 days), reset the counter for all variants
            const resetKey = `${workoutType}_${baseExerciseName}_resetDate`;
            rotationTracking[resetKey] = new Date().toISOString();
            saveData();
        }

        function startWorkoutTimer() {
            if (workoutStartTime) return;
            
            workoutStartTime = new Date();
            startTimerUpdate();
            
            const startBtn = document.getElementById('startBtn');
            const endBtn = document.getElementById('endBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.textContent = 'Started';
            }
            if (endBtn) {
                endBtn.disabled = false;
            }
        }

        function startTimerUpdate() {
            if (workoutTimer) clearInterval(workoutTimer);

            workoutTimer = setInterval(() => {
                if (!workoutStartTime) {
                    clearInterval(workoutTimer);
                    workoutTimer = null;
                    return;
                }

                const elapsed = getElapsedTime();

                // Update header timer
                const headerTimerDisplay = document.getElementById('headerTimerDisplay');
                if (headerTimerDisplay) {
                    headerTimerDisplay.textContent = elapsed;
                }

                // Update banner timer if visible
                const bannerTime = document.getElementById('bannerWorkoutTime');
                if (bannerTime) {
                    bannerTime.textContent = elapsed;
                }
            }, 1000);
        }

        function getElapsedTime() {
            if (!workoutStartTime) return '0:00';
            
            const now = new Date();
            const elapsed = Math.floor((now - workoutStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endWorkoutSession() {
            if (!workoutStartTime || !currentWorkoutType) return;

            const endTime = new Date();
            const durationMs = endTime - workoutStartTime;
            const durationMinutes = Math.round(durationMs / 60000);
            const today = new Date().toISOString().split('T')[0];

            const timestamp = workoutStartTime.getTime();
            const sessionKey = `${today}_session_${timestamp}_${currentWorkoutType}`;
            const exercises = {};
            const setKeysToRemove = [];

            Object.keys(workoutLog).forEach(key => {
                if (key.startsWith(today + '_' + currentWorkoutType)) {
                    const parts = key.split('_');
                    if (parts.length >= 4 && !key.includes('_session_')) {
                        const exerciseName = parts.slice(2, -1).join('_');
                        const setNum = parts[parts.length - 1];

                        if (!exercises[exerciseName]) {
                            exercises[exerciseName] = {};
                        }
                        exercises[exerciseName][`set${setNum}`] = workoutLog[key];

                        // If deload mode, mark this key for removal
                        if (isDeloadWorkout) {
                            setKeysToRemove.push(key);
                        }
                    }
                }
            });

            // Save session info (for calendar) even in deload mode
            workoutLog[sessionKey] = {
                workoutType: currentWorkoutType,
                date: today,
                startTime: workoutStartTime.toISOString(),
                endTime: endTime.toISOString(),
                durationMinutes: durationMinutes,
                exercises: exercises,
                isDeload: isDeloadWorkout
            };

            // If deload mode, remove the individual set logs so they won't pre-fill next workout
            if (isDeloadWorkout) {
                setKeysToRemove.forEach(key => {
                    delete workoutLog[key];
                });
            }

            saveData();

            clearInterval(workoutTimer);
            workoutTimer = null;
            workoutStartTime = null;
            document.getElementById('headerTimer').style.display = 'none';
            hideWorkoutBottomControls();

            const exerciseCount = Object.keys(exercises).length;
            const deloadMsg = isDeloadWorkout ? '\n(Deload - weights not saved for next session)' : '';
            alert(`Workout Complete!\n\n${currentWorkoutType}\nDuration: ${durationMinutes} minutes\nExercises logged: ${exerciseCount}${deloadMsg}\n\nGreat work!`);

            currentWorkoutType = null;
            isDeloadWorkout = false;
            goHome();
        }

        function startWorkout(workoutType) {
            // Check if there's an active workout and it's a different workout
            if (workoutStartTime && currentWorkoutType && currentWorkoutType !== workoutType) {
                if (!confirm(`You have an active "${currentWorkoutType}" workout. Cancel it and start "${workoutType}"?`)) {
                    return;
                }
                // Cancel the current workout
                clearInterval(workoutTimer);
                workoutTimer = null;
                workoutStartTime = null;
                document.getElementById('headerTimer').style.display = 'none';
                hideWorkoutBottomControls();
            }

            currentWorkoutType = workoutType;

            // Reset to first section tab when starting a new workout
            currentSectionIdx = 0;

            // Reset deload mode for new workout
            isDeloadWorkout = false;

            // Show the workout screen
            showScreen('workout');

            // Auto-start the workout timer if not already active
            if (!workoutStartTime) {
                startWorkoutTimer();
            }

            // Show timer in header
            document.getElementById('headerTimer').style.display = 'flex';
            document.getElementById('headerTimerDisplay').textContent = getElapsedTime();

            // Render workout content
            renderWorkoutContent(workoutType);

            // Ensure timer is running
            if (!workoutTimer) {
                startTimerUpdate();
            }
        }

        let currentSectionIdx = 0;

        function renderWorkoutContent(workoutType) {
            const workout = WORKOUTS[workoutType];
            const container = document.getElementById('workoutContent');
            const tabsContainer = document.getElementById('workoutTabs');

            // Set workout name in header (add deload indicator)
            const deloadIndicator = isDeloadWorkout ? ' (Deload)' : '';
            document.getElementById('workoutHeaderTitle').textContent = workout.title + deloadIndicator;

            // Filter sections - skip Finisher in deload mode
            const filteredSections = workout.sections.filter(section => {
                if (isDeloadWorkout && section.title.toLowerCase() === 'finisher') {
                    return false;
                }
                return true;
            });

            // Adjust currentSectionIdx if it's out of bounds
            if (currentSectionIdx >= filteredSections.length) {
                currentSectionIdx = 0;
            }

            // Build tabs (in separate fixed container)
            let tabsHtml = '';
            filteredSections.forEach((section, sectionIdx) => {
                tabsHtml += `<button class="workout-tab ${sectionIdx === currentSectionIdx ? 'active' : ''}" onclick="switchWorkoutSection('${workoutType}', ${sectionIdx})">${section.title}</button>`;
            });
            tabsContainer.innerHTML = tabsHtml;

            // Build section content
            let sectionsHtml = '';
            filteredSections.forEach((section, sectionIdx) => {
                sectionsHtml += `<div class="workout-section ${sectionIdx === currentSectionIdx ? 'active' : ''}" id="workoutSection_${sectionIdx}">`;

                if (section.isOptions) {
                    sectionsHtml += renderOptions(section, workoutType, sectionIdx);
                } else if (section.isSupersets) {
                    sectionsHtml += renderSupersets(section, workoutType, sectionIdx);
                } else if (section.isCircuit) {
                    sectionsHtml += renderCircuit(section, workoutType, sectionIdx);
                } else {
                    section.exercises.forEach(ex => {
                        sectionsHtml += renderExercise(ex, workoutType, section.title);
                    });
                }

                sectionsHtml += '</div>';
            });

            container.innerHTML = sectionsHtml;

            // Show bottom controls and update deload UI
            const bottomControls = document.getElementById('workoutBottomControls');
            if (bottomControls) {
                bottomControls.style.display = 'block';
            }
            updateDeloadUI();
        }

        function switchWorkoutSection(workoutType, sectionIdx) {
            currentSectionIdx = sectionIdx;

            // Update tab active states
            document.querySelectorAll('.workout-tab').forEach((tab, idx) => {
                tab.classList.toggle('active', idx === sectionIdx);
            });

            // Update section visibility
            document.querySelectorAll('.workout-section').forEach((section, idx) => {
                section.classList.toggle('active', idx === sectionIdx);
            });

            // Scroll to top of content
            document.getElementById('workoutContent').scrollTop = 0;
        }

        function cancelWorkout() {
            if (workoutStartTime) {
                if (!confirm('Are you sure you want to cancel this workout? Your progress will not be saved.')) {
                    return;
                }
            }
            clearInterval(workoutTimer);
            workoutTimer = null;
            workoutStartTime = null;
            currentWorkoutType = null;
            isDeloadWorkout = false;
            document.getElementById('headerTimer').style.display = 'none';
            hideWorkoutBottomControls();
            goHome();
        }

        function toggleDeload() {
            isDeloadWorkout = !isDeloadWorkout;
            updateDeloadUI();
            // Re-render workout to apply deload modifications
            if (currentWorkoutType) {
                renderWorkoutContent(currentWorkoutType);
            }
        }

        function updateDeloadUI() {
            const toggle = document.getElementById('deloadToggle');
            const label = document.getElementById('deloadLabel');
            if (toggle && label) {
                toggle.classList.toggle('active', isDeloadWorkout);
                label.classList.toggle('active', isDeloadWorkout);
            }
        }

        function getDeloadSets(originalSets) {
            // Reduce by 1 set, minimum 1
            return isDeloadWorkout ? Math.max(1, originalSets - 1) : originalSets;
        }

        function getDeloadWeight(weight) {
            // Apply 75% and round to nearest 5
            if (!isDeloadWorkout || !weight || weight === 'BW' || weight === '') return weight;
            const numWeight = parseFloat(weight);
            if (isNaN(numWeight)) return weight;
            const deloadWeight = Math.round((numWeight * 0.75) / 5) * 5;
            return Math.max(5, deloadWeight); // Minimum 5 lbs
        }

        function handleWorkoutBack() {
            // Just go back to home - don't cancel the workout
            // The active workout banner will show if a workout is still in progress
            goHome();
        }

        function renderOptions(section, workoutType, sectionIdx) {
            const selectionKey = `${workoutType}_section${sectionIdx}`;
            const selected = workoutLog[selectionKey] || 0;
            const selectedEx = section.exercises[selected];

            // Render the selected exercise with a dropdown in its header
            return renderExerciseWithDropdown(selectedEx, workoutType, section.title, section.exercises, sectionIdx, selected);
        }

        function renderExerciseWithDropdown(ex, workoutType, sectionTitle, allOptions, sectionIdx, selectedIdx) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            // Build dropdown options
            let dropdownOptions = '';
            allOptions.forEach((opt, idx) => {
                dropdownOptions += `<option value="${idx}" ${idx === selectedIdx ? 'selected' : ''}>${opt.name}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectOption('${workoutType}', ${sectionIdx}, this.value)">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} reps</span>
                            <span class="exercise-meta-item">•</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">Reps</option>
                                ${generateRepsOptions(defaultReps)}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function selectOption(workoutType, sectionIdx, optionIdx) {
            workoutLog[`${workoutType}_section${sectionIdx}`] = parseInt(optionIdx);
            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSupersets(section, workoutType, sectionIdx) {
            let html = '';

            // Check if any supersets have options
            const hasOptions = section.supersets.some(s => s.isOptions);

            if (hasOptions) {
                // Build superset preset dropdown
                const presetKey = `${workoutType}_supersetPreset_${section.title.replace(/\s+/g, '_')}`;
                const currentPreset = workoutLog[presetKey] !== undefined ? workoutLog[presetKey] : -1;

                // Get number of options from first superset with options
                const firstWithOptions = section.supersets.find(s => s.isOptions);
                const numPresets = firstWithOptions ? firstWithOptions.options.length : 0;

                // Build preset options - name based on first exercise of each option in first superset
                let presetOptions = '<option value="-1"' + (currentPreset === -1 ? ' selected' : '') + '>Custom</option>';
                for (let i = 0; i < numPresets; i++) {
                    const presetName = getSupersetPresetName(section, i);
                    presetOptions += `<option value="${i}"${currentPreset === i ? ' selected' : ''}>${presetName}</option>`;
                }

                const safeSectionTitle = section.title.replace(/'/g, "\\'");
                html += `
                    <div class="superset-preset-selector">
                        <label class="superset-preset-label">Superset Preset:</label>
                        <select class="superset-preset-select" onchange="selectSupersetPreset('${workoutType}', ${sectionIdx}, '${safeSectionTitle}', this.value)">
                            ${presetOptions}
                        </select>
                    </div>
                `;
            }

            section.supersets.forEach((superset, supersetIdx) => {
                if (superset.isOptions) {
                    const selectionKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}`;
                    const selected = workoutLog[selectionKey] || 0;
                    const selectedPair = superset.options[selected];

                    html += `
                        <div class="superset-container">
                            <div class="superset-badge">SUPERSET ${supersetIdx + 1}</div>
                    `;

                    // Render selected exercises with dropdowns
                    selectedPair.forEach((ex, exIdx) => {
                        html += renderSupersetExerciseWithDropdown(ex, workoutType, section.title, superset.options, sectionIdx, supersetIdx, selected, exIdx);
                        if (exIdx < selectedPair.length - 1) {
                            html += '<div class="superset-arrow">↓</div>';
                        }
                    });

                    html += '</div>';
                } else {
                    html += `
                        <div class="superset-container">
                            <div class="superset-badge">SUPERSET ${supersetIdx + 1}</div>
                    `;
                    superset.forEach((ex, exIdx) => {
                        html += renderSingleExercise(ex, workoutType);
                        if (exIdx < superset.length - 1) {
                            html += '<div class="superset-arrow">↓</div>';
                        }
                    });
                    html += '</div>';
                }
            });

            return html;
        }

        function selectSupersetOption(workoutType, sectionIdx, supersetIdx, optionIdx) {
            workoutLog[`${workoutType}_section${sectionIdx}_superset${supersetIdx}`] = parseInt(optionIdx);

            // Set superset preset to Custom (-1) when individual superset is changed
            const workout = WORKOUTS[workoutType];
            const section = workout?.sections?.[sectionIdx];
            if (section?.isSupersets) {
                const presetKey = `${workoutType}_supersetPreset_${section.title.replace(/\s+/g, '_')}`;
                workoutLog[presetKey] = -1;
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function getSupersetPresetName(section, presetIdx) {
            // Build a name from the first exercise of each superset at this preset index
            const names = [];
            section.supersets.forEach((superset, idx) => {
                if (superset.isOptions && superset.options[presetIdx]) {
                    const firstEx = superset.options[presetIdx][0];
                    if (firstEx) {
                        // Shorten the name if too long
                        let name = firstEx.name;
                        if (name.length > 15) {
                            name = name.substring(0, 12) + '...';
                        }
                        names.push(name);
                    }
                }
            });
            return names.length > 0 ? `Option ${presetIdx + 1}: ${names.join(' / ')}` : `Option ${presetIdx + 1}`;
        }

        function selectSupersetPreset(workoutType, sectionIdx, sectionTitle, presetIdx) {
            presetIdx = parseInt(presetIdx);
            const presetKey = `${workoutType}_supersetPreset_${sectionTitle.replace(/\s+/g, '_')}`;
            workoutLog[presetKey] = presetIdx;

            if (presetIdx >= 0) {
                // Get the workout and section
                const workout = WORKOUTS[workoutType];
                const section = workout?.sections?.[sectionIdx];

                if (section && section.supersets) {
                    // Set all supersets to the preset index
                    section.supersets.forEach((superset, supersetIdx) => {
                        if (superset.isOptions && superset.options.length > presetIdx) {
                            const selectionKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}`;
                            workoutLog[selectionKey] = presetIdx;
                        }
                    });
                }
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSupersetExerciseWithDropdown(ex, workoutType, sectionTitle, allSupersetOptions, sectionIdx, supersetIdx, selectedIdx, exerciseIdxInPair) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            // Build dropdown options showing first exercise of each superset option
            let dropdownOptions = '';
            allSupersetOptions.forEach((opt, idx) => {
                const optExercise = opt[exerciseIdxInPair];
                dropdownOptions += `<option value="${idx}" ${idx === selectedIdx ? 'selected' : ''}>${optExercise.name}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectSupersetOption('${workoutType}', ${sectionIdx}, ${supersetIdx}, this.value)">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} reps</span>
                            <span class="exercise-meta-item">•</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">Reps</option>
                                ${generateRepsOptions(defaultReps)}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function renderCircuit(section, workoutType, sectionIdx) {
            // Build circuit presets based on rotation indices
            const circuitKey = `${workoutType}_circuit_${section.title.replace(/\s+/g, '_')}`;
            const currentPreset = workoutLog[circuitKey] !== undefined ? workoutLog[circuitKey] : -1; // -1 means custom

            // Get the number of rotation options (assume all exercises have same number)
            const numPresets = section.exercises[0]?.rotations?.length || 0;

            // Build preset names from first exercise of each rotation index
            let presetOptions = '<option value="-1"' + (currentPreset === -1 ? ' selected' : '') + '>Custom</option>';
            for (let i = 0; i < numPresets; i++) {
                const shortName = getCircuitPresetName(section, i);
                presetOptions += `<option value="${i}"${currentPreset === i ? ' selected' : ''}>${shortName}</option>`;
            }

            const safeSectionTitle = section.title.replace(/'/g, "\\'");

            let html = `
                <div class="circuit-preset-selector">
                    <label class="circuit-preset-label">Circuit Preset:</label>
                    <select class="circuit-preset-select" onchange="selectCircuitPreset('${workoutType}', '${safeSectionTitle}', this.value)">
                        ${presetOptions}
                    </select>
                </div>
            `;

            // Render circuit exercises individually
            section.exercises.forEach(ex => {
                html += renderExercise(ex, workoutType, section.title);
            });
            return html;
        }

        function getCircuitPresetName(section, presetIdx) {
            // Create a short descriptive name for the preset
            const names = section.exercises.map(ex => {
                const name = ex.rotations?.[presetIdx]?.name || '';
                // Shorten common words
                return name.replace(' Carry', '').replace(' Hold', '').replace(' Crunches', '').replace('Bicycle', 'Bike').replace('Russian ', 'Rus. ');
            });
            return names.join(', ');
        }

        function selectCircuitPreset(workoutType, sectionTitle, presetIdx) {
            presetIdx = parseInt(presetIdx);
            const circuitKey = `${workoutType}_circuit_${sectionTitle.replace(/\s+/g, '_')}`;
            workoutLog[circuitKey] = presetIdx;

            if (presetIdx >= 0) {
                // Get the workout and section
                const workout = WORKOUTS[workoutType];
                const section = workout.sections.find(s => s.title === sectionTitle);

                if (section) {
                    // Set all exercise rotations to the preset index
                    section.exercises.forEach(ex => {
                        if (ex.rotations && ex.rotations.length > presetIdx) {
                            const rotationKey = `${workoutType}_rotation_${ex.name}`;
                            workoutLog[rotationKey] = presetIdx;
                        }
                    });
                }
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderExercise(ex, workoutType, sectionTitle = '') {
            const today = new Date().toISOString().split('T')[0];
            const baseExerciseName = ex.name; // The base exercise name for tracking rotation cycles

            if (ex.rotations && ex.rotations.length > 1) {
                const rotationKey = `${workoutType}_rotation_${ex.name}`;
                const selectedRotation = workoutLog[rotationKey] || 0;
                const currentEx = ex.rotations[selectedRotation];

                const exerciseType = getExerciseType(sectionTitle);
                const uniqueDays = getExerciseDaysSinceReset(workoutType, currentEx.name, baseExerciseName);
                const shouldRotate = shouldRecommendRotation(workoutType, currentEx.name, exerciseType, baseExerciseName);
                const threshold = ROTATION_THRESHOLDS[exerciseType];
                const daysThreshold = threshold * 2;

                // Check if this exercise just completed a cycle (hit 24 days)
                if (uniqueDays >= daysThreshold) {
                    markCycleCompleted(workoutType, baseExerciseName);
                }

                let html = '';

                if (shouldRotate) {
                    html += `
                        <div style="background: linear-gradient(135deg, #ff9f0a 0%, #ff6b35 100%);
                                    color: white;
                                    padding: 12px 16px;
                                    border-radius: 12px;
                                    margin-bottom: 12px;
                                    font-size: 14px;
                                    font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 20px;">⟳</span>
                                <span>Time to Switch It Up!</span>
                            </div>
                            <div style="font-size: 13px; font-weight: 400; opacity: 0.95;">
                                You've done ${currentEx.name} for ${uniqueDays} workout days (${daysThreshold}+ recommended). Try a different variation!
                            </div>
                        </div>
                    `;
                    markRotationRecommended(workoutType, currentEx.name);
                }

                // Render exercise with rotation dropdown in header
                html += renderRotationExerciseWithDropdown(ex, workoutType, sectionTitle, selectedRotation);

                return html;
            } else {
                return renderSingleExercise(ex, workoutType);
            }
        }

        function renderRotationExerciseWithDropdown(ex, workoutType, sectionTitle, selectedRotation) {
            const today = new Date().toISOString().split('T')[0];
            const currentEx = ex.rotations[selectedRotation];
            const safeExName = currentEx.name.replace(/'/g, "\\'");
            const safeBaseExName = ex.name.replace(/'/g, "\\'");
            const lastLog = getLastLog(workoutType, currentEx.name);
            const setCountKey = `${workoutType}_${currentEx.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const baseExerciseName = ex.name;
            const restTime = ex.rest || '60s';

            // Build dropdown options with day counts
            let dropdownOptions = '';
            ex.rotations.forEach((rotation, idx) => {
                const variantUniqueDays = getExerciseDaysSinceReset(workoutType, rotation.name, baseExerciseName);
                const dayLabel = variantUniqueDays > 0 ? ` (${variantUniqueDays}d)` : '';
                dropdownOptions += `<option value="${idx}" ${idx === selectedRotation ? 'selected' : ''}>${rotation.name}${dayLabel}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectRotation('${workoutType}', '${safeBaseExName}', this.value, '${sectionTitle}')">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} reps</span>
                            <span class="exercise-meta-item">•</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${currentEx.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${currentEx.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${currentEx.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">Reps</option>
                                ${generateRepsOptions(defaultReps)}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function selectRotation(workoutType, exerciseName, rotationIdx, sectionTitle) {
            const rotationKey = `${workoutType}_rotation_${exerciseName}`;
            workoutLog[rotationKey] = parseInt(rotationIdx);

            // If this is a circuit section, set preset to Custom (-1)
            const workout = WORKOUTS[workoutType];
            const section = workout?.sections?.find(s => s.title === sectionTitle);
            if (section?.isCircuit) {
                const circuitKey = `${workoutType}_circuit_${sectionTitle.replace(/\s+/g, '_')}`;
                workoutLog[circuitKey] = -1; // Custom
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSingleExercise(ex, workoutType) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <div class="exercise-name">${ex.name}</div>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} reps</span>
                            <span class="exercise-meta-item">•</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">Reps</option>
                                ${generateRepsOptions(defaultReps)}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            // Add set button below all sets
            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function generateWeightOptions(defaultValue) {
            let options = '';
            for (let w = 5; w <= 500; w += 5) {
                options += `<option value="${w}" ${w == defaultValue ? 'selected' : ''}>${w} lbs</option>`;
            }
            return options;
        }

        function generateRepsOptions(defaultValue) {
            let options = '';
            for (let r = 1; r <= 50; r++) {
                options += `<option value="${r}" ${r == defaultValue ? 'selected' : ''}>${r}</option>`;
            }
            return options;
        }

        function addSet(workoutType, exerciseName, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;
            const newSets = currentSets + 1;

            workoutLog[setCountKey] = newSets;
            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        function removeSet(workoutType, exerciseName, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;

            if (currentSets <= 1) return; // Don't go below 1 set

            const newSets = currentSets - 1;
            workoutLog[setCountKey] = newSets;

            // Also remove the logged data for the removed set
            const today = new Date().toISOString().split('T')[0];
            const removedSetKey = `${today}_${workoutType}_${exerciseName}_${currentSets}`;
            delete workoutLog[removedSetKey];

            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        function deleteSet(workoutType, exerciseName, setNum, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;

            if (currentSets <= 1) return; // Don't go below 1 set

            const today = new Date().toISOString().split('T')[0];

            // Shift all sets after the deleted one down by 1
            for (let i = setNum; i < currentSets; i++) {
                const currentKey = `${today}_${workoutType}_${exerciseName}_${i + 1}`;
                const newKey = `${today}_${workoutType}_${exerciseName}_${i}`;
                if (workoutLog[currentKey]) {
                    workoutLog[newKey] = workoutLog[currentKey];
                } else {
                    delete workoutLog[newKey];
                }
            }

            // Remove the last set key
            const lastSetKey = `${today}_${workoutType}_${exerciseName}_${currentSets}`;
            delete workoutLog[lastSetKey];

            // Update set count
            workoutLog[setCountKey] = currentSets - 1;
            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        // Touch handlers for swipe-to-delete
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;

        function handleSetTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchCurrentX = touchStartX;
            isSwiping = true;
        }

        function handleSetTouchMove(event, rowId) {
            if (!isSwiping) return;
            touchCurrentX = event.touches[0].clientX;
            const diff = touchStartX - touchCurrentX;
            const row = document.getElementById(rowId);

            if (diff > 0) {
                // Swiping left
                const translateX = Math.min(diff, 80);
                row.style.transform = `translateX(-${translateX}px)`;
                row.style.transition = 'none';
            } else {
                // Swiping right (to close)
                row.style.transform = 'translateX(0)';
            }
        }

        function handleSetTouchEnd(event, rowId) {
            if (!isSwiping) return;
            isSwiping = false;
            const diff = touchStartX - touchCurrentX;
            const row = document.getElementById(rowId);

            row.style.transition = 'transform 0.2s ease';

            if (diff > 40) {
                // Swiped enough to show delete
                row.classList.add('swiped');
                row.style.transform = 'translateX(-80px)';
            } else {
                // Not enough swipe, snap back
                row.classList.remove('swiped');
                row.style.transform = 'translateX(0)';
            }
        }

        // Close any open swipe actions when tapping elsewhere
        document.addEventListener('touchstart', function(event) {
            if (!event.target.closest('.set-row') && !event.target.closest('.set-row-delete')) {
                document.querySelectorAll('.set-row.swiped').forEach(row => {
                    row.classList.remove('swiped');
                    row.style.transform = 'translateX(0)';
                });
            }
        });

        function getLastLog(workoutType, exerciseName) {
            const today = new Date().toISOString().split('T')[0];
            // Filter for set logs (format: date_workoutType_exerciseName_setNum)
            // Must match exact workout type to be workout-specific
            const keys = Object.keys(workoutLog).filter(key => {
                // Check if key starts with a date pattern and matches the exact format
                const dateMatch = key.match(/^(\d{4}-\d{2}-\d{2})_(.+)_(\d+)$/);
                if (!dateMatch) return false;

                const [, date, middle, setNum] = dateMatch;
                // The middle part should be "workoutType_exerciseName"
                const expectedPrefix = `${workoutType}_${exerciseName}`;
                return middle === expectedPrefix && date !== today;
            }).sort().reverse();

            if (keys.length === 0) return null;

            const lastDate = keys[0].split('_')[0];
            const lastSets = {};
            let maxSetNum = 0;

            keys.forEach(key => {
                if (key.startsWith(lastDate)) {
                    const setNum = parseInt(key.split('_').pop());
                    if (!isNaN(setNum)) {
                        lastSets[`set${setNum}`] = workoutLog[key];
                        if (setNum > maxSetNum) maxSetNum = setNum;
                    }
                }
            });

            lastSets.setCount = maxSetNum;
            return lastSets;
        }

        function logSet(workoutType, exerciseName, setNum, field, value) {
            const today = new Date().toISOString().split('T')[0];
            const logKey = `${today}_${workoutType}_${exerciseName}_${setNum}`;
            
            if (!workoutLog[logKey]) {
                workoutLog[logKey] = { weight: '', reps: '' };
            }
            workoutLog[logKey][field] = value;
            
            const historyKey = `${today}_${workoutType}`;
            if (!workoutLog[historyKey]) {
                workoutLog[historyKey] = { date: today, type: workoutType, exercises: {} };
            }
            if (!workoutLog[historyKey].exercises[exerciseName]) {
                workoutLog[historyKey].exercises[exerciseName] = {};
            }
            workoutLog[historyKey].exercises[exerciseName][`set${setNum}`] = workoutLog[logKey];

            saveData();

            const selects = document.querySelectorAll('.tracking-select');
            selects.forEach(s => {
                if (s.value) s.classList.add('filled');
            });
        }

        function showExerciseInfo(exerciseName) {
            const info = EXERCISE_DB[exerciseName];
            document.getElementById('exerciseName').textContent = exerciseName;
            if (info) {
                document.getElementById('exerciseInfo').innerHTML = `
                    <p><strong>Setup:</strong> ${info.setup}</p>
                    <p><strong>Execution:</strong> ${info.execution}</p>
                `;
            } else {
                // Generate a generic description based on exercise name
                const genericInfo = generateExerciseInfo(exerciseName);
                document.getElementById('exerciseInfo').innerHTML = `
                    <p><strong>Setup:</strong> ${genericInfo.setup}</p>
                    <p><strong>Execution:</strong> ${genericInfo.execution}</p>
                `;
            }
            document.getElementById('exerciseModal').classList.add('active');
        }

        function generateExerciseInfo(exerciseName) {
            const name = exerciseName.toLowerCase();

            // Common exercise patterns
            if (name.includes('squat')) {
                return {
                    setup: 'Position feet shoulder-width apart. Brace your core and maintain a neutral spine.',
                    execution: 'Descend by pushing hips back and bending knees. Keep chest up and knees tracking over toes. Drive through feet to return to standing.'
                };
            } else if (name.includes('deadlift') || name.includes('rdl')) {
                return {
                    setup: 'Stand with feet hip-width apart. Grip the bar just outside your legs. Shoulders back, chest up.',
                    execution: 'Hinge at hips while maintaining flat back. Drive through heels and extend hips to stand. Control the descent.'
                };
            } else if (name.includes('press') || name.includes('bench')) {
                return {
                    setup: 'Set up with stable base. Grip the weight firmly. Engage core and set shoulders.',
                    execution: 'Control the weight down, then press up powerfully. Maintain proper elbow position throughout.'
                };
            } else if (name.includes('row')) {
                return {
                    setup: 'Hinge forward with flat back. Grip the weight with arms extended.',
                    execution: 'Pull weight toward torso, squeezing shoulder blades. Lower with control. Avoid momentum.'
                };
            } else if (name.includes('curl')) {
                return {
                    setup: 'Stand tall with weight at sides. Elbows close to body.',
                    execution: 'Curl weight up by bending elbows. Squeeze at top. Lower with control. Avoid swinging.'
                };
            } else if (name.includes('extension') || name.includes('pushdown')) {
                return {
                    setup: 'Set up with stable stance. Grip firmly with proper hand position.',
                    execution: 'Extend through full range of motion. Control the negative. Keep tension on target muscle.'
                };
            } else if (name.includes('lunge') || name.includes('split')) {
                return {
                    setup: 'Stand tall with feet hip-width apart. Core engaged.',
                    execution: 'Step into lunge position. Lower until rear knee nearly touches ground. Drive through front foot to return.'
                };
            } else if (name.includes('pull-up') || name.includes('chin')) {
                return {
                    setup: 'Grip bar with chosen hand position. Hang with arms fully extended.',
                    execution: 'Pull body up until chin clears bar. Lower with control. Avoid swinging.'
                };
            } else if (name.includes('jump') || name.includes('hop') || name.includes('bound')) {
                return {
                    setup: 'Athletic stance with soft knees. Arms ready to drive.',
                    execution: 'Explode upward/forward with full extension. Land softly with bent knees. Reset and repeat.'
                };
            } else if (name.includes('plank') || name.includes('hold')) {
                return {
                    setup: 'Set up in position with core engaged. Maintain neutral spine alignment.',
                    execution: 'Hold position while breathing steadily. Avoid sagging or piking. Focus on tension throughout core.'
                };
            } else if (name.includes('raise') || name.includes('fly')) {
                return {
                    setup: 'Position body appropriately for the movement. Light grip on weight.',
                    execution: 'Raise weight through controlled arc. Pause at top. Lower with control. Maintain slight elbow bend.'
                };
            } else if (name.includes('calf')) {
                return {
                    setup: 'Position feet on edge of platform. Hold support for balance if needed.',
                    execution: 'Rise onto toes through full range. Squeeze at top. Lower slowly below platform level. Full stretch at bottom.'
                };
            } else if (name.includes('carry') || name.includes('walk')) {
                return {
                    setup: 'Pick up weight with proper deadlift form. Stand tall with shoulders back.',
                    execution: 'Walk with controlled steps. Maintain upright posture. Breathe steadily. Keep core braced throughout.'
                };
            } else if (name.includes('med ball') || name.includes('slam')) {
                return {
                    setup: 'Hold med ball at chest or overhead. Athletic stance.',
                    execution: 'Generate power from hips and core. Release or slam with full body effort. Reset and repeat.'
                };
            } else if (name.includes('circuit') || name.includes('combo')) {
                return {
                    setup: 'Prepare all equipment needed. Plan transitions between exercises.',
                    execution: 'Perform each exercise with good form. Minimize rest between movements. Complete all rounds as prescribed.'
                };
            } else {
                return {
                    setup: 'Set up in proper starting position. Engage core and maintain good posture.',
                    execution: 'Perform the movement with controlled tempo. Focus on mind-muscle connection. Complete all reps with good form.'
                };
            }
        }

        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        let deleteClickCount = 0;
        let deleteClickTimer = null;
        
        window.deleteCurrentWorkout = function() {
            console.log('Delete button clicked!');
            const container = document.getElementById('dayWorkouts');
            const dateStr = container.getAttribute('data-current-date');
            const sessionKey = container.getAttribute('data-current-session');
            
            if (!dateStr || !sessionKey) {
                alert('Error: Cannot find workout to delete.');
                return;
            }
            
            deleteClickCount++;
            
            if (deleteClickCount === 1) {
                const btn = event.target;
                btn.textContent = '⚠️ Click Again to Confirm';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';
                
                deleteClickTimer = setTimeout(() => {
                    btn.textContent = '✕ Delete';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    deleteClickCount = 0;
                }, 3000);
            } else if (deleteClickCount === 2) {
                clearTimeout(deleteClickTimer);
                deleteClickCount = 0;
                console.log('Deleting workout...');
                deleteWorkout(dateStr, sessionKey);
            }
        };

        function clearAllData() {
            if (confirm('⚠️ DELETE ALL WORKOUTS?\n\nThis will permanently delete:\n- All workout sessions\n- All exercise logs\n- All rotation tracking\n\nThis CANNOT be undone!\n\nAre you absolutely sure?')) {
                localStorage.clear();
                workoutLog = {};
                rotationTracking = {};
                workoutSessions = {};
                currentSession = null;
                workoutStartTime = null;
                currentWorkoutType = null;
                alert('✓ All workout data has been deleted.');
                location.reload();
            }
        }

        // Data clearing code removed - using server-based storage now

        function deleteWorkout(dateStr, sessionKey) {
            console.log('deleteWorkout called with:', dateStr, sessionKey);
            
            const session = workoutLog[sessionKey];
            console.log('Session data:', session);
            
            if (!session) {
                alert('Workout not found');
                console.log('Session not found in workoutLog');
                return;
            }
            
            const workoutType = session.workoutType;
            console.log('Workout type:', workoutType);
            
            const keysToDelete = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_')
            );
            console.log('Deleting ALL keys for date:', keysToDelete);
            keysToDelete.forEach(key => delete workoutLog[key]);
            
            saveData();
            console.log('Data saved');
            
            const remainingKeys = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_')
            );
            console.log('Remaining keys for date (should be empty):', remainingKeys);
            
            selectedCalendarDate = null;
            
            renderCalendar();
            document.getElementById('dayWorkouts').innerHTML = '<div style="color: var(--success); text-align: center; padding: 20px; font-size: 18px; font-weight: 600;">✓ Workout Deleted</div>';
            
            setTimeout(() => {
                document.getElementById('dayWorkouts').innerHTML = '';
            }, 2000);
        }

        function initYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYearNow = new Date().getFullYear();
            let html = '';
            for (let year = currentYearNow - 5; year <= currentYearNow + 5; year++) {
                html += `<option value="${year}">${year}</option>`;
            }
            yearSelect.innerHTML = html;
        }

        function updateMonthYearSelects() {
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
        }

        function setMonth(month) {
            currentMonth = parseInt(month);
            renderCalendar();
        }

        function setYear(year) {
            currentYear = parseInt(year);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            updateMonthYearSelects();

            let html = '';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }

            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayWorkouts = getDayWorkoutNames(dateStr);
                const hasWorkout = dayWorkouts.length > 0;
                const isToday = date.toDateString() === today.toDateString();
                const isSelected = selectedCalendarDate === dateStr;

                html += `
                    <div class="calendar-day ${hasWorkout ? 'has-workout' : ''} ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="selectCalendarDay('${dateStr}')">
                        <div class="calendar-day-number">${day}</div>
                        ${hasWorkout ? '<div class="calendar-dot"></div>' : ''}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function getDayWorkoutNames(dateStr) {
            const workoutNames = [];
            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_') && key.startsWith(dateStr)) {
                    const session = workoutLog[key];
                    if (session && session.workoutType && !workoutNames.includes(session.workoutType)) {
                        workoutNames.push(session.workoutType);
                    }
                }
            });
            return workoutNames;
        }

        function selectCalendarDay(dateStr) {
            selectedCalendarDate = dateStr;
            renderCalendar();
            showDayWorkouts(dateStr);
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function showDayWorkouts(dateStr) {
            const container = document.getElementById('dayWorkouts');
            
            const sessionKeys = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_session_')
            );
            
            if (sessionKeys.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No workouts on this day</div>';
                return;
            }
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            let html = `<div class="section-header">Workouts on ${formatted}</div>`;
            
            sessionKeys.sort((a, b) => {
                const timeA = parseInt(a.split('_session_')[1].split('_')[0]);
                const timeB = parseInt(b.split('_session_')[1].split('_')[0]);
                return timeB - timeA;
            });
            
            sessionKeys.forEach((sessionKey, index) => {
                const session = workoutLog[sessionKey];
                if (!session) return;

                const exerciseCount = Object.keys(session.exercises || {}).length;
                const startTime = new Date(session.startTime);
                const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const safeSessionKey = sessionKey.replace(/'/g, "\\'");

                html += `
                    <div class="workout-summary-card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1; cursor: pointer;" onclick="openWorkoutDetailModal('${dateStr}', '${safeSessionKey}')">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${session.workoutType}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    ${timeStr} • ${exerciseCount} exercises • ${session.durationMinutes}m
                                </div>
                            </div>
                            <button onclick="deleteSingleWorkout('${safeSessionKey}', '${dateStr}'); event.stopPropagation();"
                                    id="delete_${index}"
                                    style="background: rgba(255, 59, 48, 0.15);
                                           border: 1px solid #ff3b30;
                                           color: #ff3b30;
                                           border-radius: 8px;
                                           padding: 8px 12px;
                                           font-size: 13px;
                                           font-weight: 600;
                                           cursor: pointer;
                                           margin-left: 12px;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        let singleDeleteState = {};

        function deleteSingleWorkout(sessionKey, dateStr) {
            if (!singleDeleteState[sessionKey]) {
                singleDeleteState[sessionKey] = { clicks: 0, timer: null };
            }

            singleDeleteState[sessionKey].clicks++;
            const btn = event.target;

            if (singleDeleteState[sessionKey].clicks === 1) {
                btn.textContent = 'Confirm';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';

                singleDeleteState[sessionKey].timer = setTimeout(() => {
                    btn.textContent = 'Delete';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    singleDeleteState[sessionKey].clicks = 0;
                }, 3000);
            } else if (singleDeleteState[sessionKey].clicks === 2) {
                clearTimeout(singleDeleteState[sessionKey].timer);
                singleDeleteState[sessionKey].clicks = 0;

                // Delete the session
                delete workoutLog[sessionKey];
                saveData();

                renderCalendar();
                showDayWorkouts(dateStr);
            }
        }

        function openWorkoutDetailModal(dateStr, sessionKey) {
            const session = workoutLog[sessionKey];
            if (!session) return;
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const startTime = new Date(session.startTime);
            const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            document.getElementById('modalWorkoutType').textContent = session.workoutType;
            document.getElementById('modalWorkoutDate').textContent = formatted + ' • ' + timeStr + ' • ' + session.durationMinutes + 'm';
            
            let html = '';
            const exercises = session.exercises || {};
            
            if (Object.keys(exercises).length > 0) {
                Object.entries(exercises).forEach(([exerciseName, sets]) => {
                    html += `
                        <div style="margin-bottom: 24px; background: var(--card-bg); border-radius: 12px; padding: 16px;">
                            <div style="font-weight: 600; font-size: 17px; margin-bottom: 12px;">${exerciseName}</div>
                    `;
                    
                    Object.entries(sets).forEach(([setKey, data]) => {
                        if (data && data.weight && data.reps) {
                            const setNum = setKey.replace('set', '');
                            html += `
                                <div style="display: flex; gap: 12px; font-size: 15px; color: var(--text-secondary); margin-bottom: 8px;">
                                    <span style="width: 60px; color: var(--text);">Set ${setNum}</span>
                                    <span style="color: var(--primary); font-weight: 600;">${data.weight}${data.weight === 'BW' ? '' : ' lbs'}</span>
                                    <span>×</span>
                                    <span style="color: var(--primary); font-weight: 600;">${data.reps} reps</span>
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                });
                
                html += `
                    <button onclick="deleteWorkoutFromModal('${sessionKey}', '${dateStr}')"
                            id="modalDeleteBtn"
                            style="width: 100%;
                                   background: rgba(255, 59, 48, 0.15);
                                   border: 1px solid #ff3b30;
                                   color: #ff3b30;
                                   border-radius: 12px;
                                   padding: 14px;
                                   font-size: 15px;
                                   font-weight: 600;
                                   cursor: pointer;
                                   margin-top: 8px;">
                        Delete This Workout
                    </button>
                `;
            } else {
                html = '<div style="color: var(--text-secondary); text-align: center; padding: 40px;">No exercise data logged</div>';
            }
            
            document.getElementById('workoutDetailBody').innerHTML = html;
            
            document.getElementById('workoutDetailModal').classList.add('active');
        }

        let modalDeleteClicks = 0;
        let modalDeleteTimer = null;

        function deleteWorkoutFromModal(sessionKey, dateStr) {
            modalDeleteClicks++;
            const btn = document.getElementById('modalDeleteBtn');

            if (modalDeleteClicks === 1) {
                btn.textContent = 'Confirm Delete';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';

                modalDeleteTimer = setTimeout(() => {
                    btn.textContent = 'Delete This Workout';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    modalDeleteClicks = 0;
                }, 3000);
            } else if (modalDeleteClicks === 2) {
                clearTimeout(modalDeleteTimer);
                modalDeleteClicks = 0;

                const session = workoutLog[sessionKey];
                if (!session) return;

                const workoutType = session.workoutType;

                // Delete related exercise data
                const keysToDelete = Object.keys(workoutLog).filter(key =>
                    key.startsWith(dateStr + '_' + workoutType + '_') && !key.includes('_session_')
                );
                keysToDelete.forEach(key => delete workoutLog[key]);

                // Delete the session
                delete workoutLog[sessionKey];

                saveData();

                closeWorkoutDetailModal();
                showDayWorkouts(dateStr);
                renderCalendar();
            }
        }

        function closeWorkoutDetailModal() {
            document.getElementById('workoutDetailModal').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('workoutDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWorkoutDetailModal();
                }
            });
        });

        document.getElementById('exerciseModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        init();
    </script>
</body>
</html>