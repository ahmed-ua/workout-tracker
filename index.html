<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Workout Tracker</title>
    <!-- Capacitor -->
    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBRiNlnVbNKBjbJFNlwOsm2UqGIOaZppY0",
            authDomain: "workout-app-f4e51.firebaseapp.com",
            projectId: "workout-app-f4e51",
            storageBucket: "workout-app-f4e51.firebasestorage.app",
            messagingSenderId: "354947611339",
            appId: "1:354947611339:web:713c013c83d25e6827794e",
            measurementId: "G-X2DZ2WGVQN"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --surface-elevated: #2c2c2e;
            --card-bg: #1c1c1e;
            --text: #ffffff;
            --text-secondary: #8e8e93;
            --primary: #0a84ff;
            --success: #30d158;
            --separator: #38383a;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            max-width: 100vw;
            height: 100%;
            position: fixed;
            touch-action: pan-x pan-y;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
        }

        .header {
            position: relative;
            flex-shrink: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--separator);
            padding: 0 20px;
            padding-top: max(env(safe-area-inset-top), 20px);
        }

        .header-content {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 17px;
            font-weight: 400;
            cursor: pointer;
            padding: 8px 0;
        }

        .header-date {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: var(--primary);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn svg {
            width: 22px;
            height: 22px;
        }

        .save-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-btn:active {
            opacity: 0.8;
        }

        /* Manage Workouts Screen Styles */
        .manage-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 0;
        }

        .manage-workout-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .manage-workout-info {
            flex: 1;
        }

        .manage-workout-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .manage-workout-badge {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .manage-workout-actions {
            display: flex;
            gap: 8px;
        }

        .workout-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .workout-badge.custom {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }

        .workout-badge.modified {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
        }

        .manage-btn {
            background: var(--surface-elevated);
            border: none;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .manage-btn.primary {
            background: var(--primary);
            color: white;
        }

        .manage-btn.danger {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        .manage-btn.reset {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .manage-btn.hide {
            background: rgba(142, 142, 147, 0.2);
            color: #8e8e93;
        }

        .manage-btn.show {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .workout-badge.hidden {
            background: rgba(142, 142, 147, 0.2);
            color: #8e8e93;
        }

        .manage-workout-item.hidden-workout {
            opacity: 0.6;
        }

        .create-workout-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }

        .manage-exercises-btn {
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Editor Form Styles */
        .editor-form {
            padding: 16px;
        }

        .editor-field {
            margin-bottom: 16px;
        }

        .editor-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        .editor-input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--separator);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 16px;
            color: var(--text);
            box-sizing: border-box;
        }

        .editor-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .editor-textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--separator);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 16px;
            color: var(--text);
            box-sizing: border-box;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .icon-picker-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid var(--separator);
            border-radius: 10px;
            padding: 12px 14px;
            cursor: pointer;
        }

        .icon-picker-preview:active {
            background: var(--surface-elevated);
        }

        .icon-picker-current {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .icon-picker-preview span {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .icon-picker-item {
            width: 100%;
            aspect-ratio: 1;
            background: var(--surface);
            border: 2px solid var(--separator);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
        }

        .icon-picker-item:active {
            background: var(--surface-elevated);
        }

        .icon-picker-item.selected {
            border-color: var(--primary);
            background: rgba(10, 132, 255, 0.15);
        }

        .editor-select {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--separator);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 16px;
            color: var(--text);
            box-sizing: border-box;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238e8e93' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }

        .section-list-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-drag-handle {
            color: var(--text-secondary);
            cursor: grab;
        }

        .section-list-info {
            flex: 1;
        }

        .section-list-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .section-list-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .section-list-actions {
            display: flex;
            gap: 8px;
        }

        .add-section-btn {
            background: var(--surface);
            border: 2px dashed var(--separator);
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            color: var(--text-secondary);
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-section-btn:active {
            background: var(--surface-elevated);
        }

        /* Exercise List in Editor */
        .exercise-list-item {
            background: var(--surface);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exercise-list-info {
            flex: 1;
        }

        .exercise-list-name {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .exercise-list-details {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .exercise-list-rotations {
            font-size: 12px;
            color: var(--primary);
            margin-top: 2px;
        }

        /* Modal Styles for Editor */
        .editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 200;
            padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
        }

        .editor-modal.active {
            display: flex;
        }

        .editor-modal-content {
            background: var(--bg);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .editor-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--separator);
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }

        .editor-modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .editor-modal-close {
            background: var(--surface);
            border: none;
            color: var(--text);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-modal-body {
            padding: 16px;
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Exercise Picker */
        .exercise-picker-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .exercise-picker-filters .editor-select {
            flex: 1;
        }

        .exercise-picker-search {
            flex: 2;
        }

        .exercise-picker-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--separator);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .exercise-picker-item {
            padding: 12px 14px;
            border-bottom: 1px solid var(--separator);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .exercise-picker-item:last-child {
            border-bottom: none;
        }

        .exercise-picker-item.selected {
            background: rgba(10, 132, 255, 0.15);
        }

        .exercise-picker-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--separator);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exercise-picker-item.selected .exercise-picker-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .exercise-picker-item.selected .exercise-picker-checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        .exercise-picker-name {
            flex: 1;
            font-size: 15px;
        }

        .selected-count {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        /* Rotation List */
        .rotation-filter {
            margin-bottom: 12px;
        }

        .rotation-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--separator);
            border-radius: 10px;
        }

        .rotation-checkbox {
            padding: 10px 14px;
            border-bottom: 1px solid var(--separator);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .rotation-checkbox:last-child {
            border-bottom: none;
        }

        .rotation-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .rotation-checkbox span {
            font-size: 14px;
        }

        .rotation-checkbox input:disabled + span {
            color: var(--text-secondary);
        }

        /* Rotation Category Groups */
        .rotation-category-group {
            margin-bottom: 16px;
            border: 1px solid var(--separator);
            border-radius: 10px;
            overflow: hidden;
        }

        .rotation-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--surface-elevated);
            border-bottom: 1px solid var(--separator);
        }

        .rotation-category-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .remove-category-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .remove-category-btn:hover {
            color: #FF453A;
        }

        .rotation-category-group .rotation-list {
            max-height: 200px;
            border: none;
            border-radius: 0;
        }

        .add-category-btn {
            background: var(--surface);
            border: 1px dashed var(--separator);
            color: var(--primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
        }

        .add-category-btn:active {
            background: var(--surface-elevated);
        }

        .add-category-dropdown {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            align-items: center;
        }

        .add-category-dropdown .editor-select {
            flex: 1;
        }

        .add-category-confirm,
        .add-category-cancel {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .add-category-confirm {
            background: var(--primary);
            color: white;
        }

        .add-category-cancel {
            background: var(--surface);
            color: var(--text);
        }

        /* Type description */
        .type-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            font-style: italic;
        }

        /* Editor Row Layout */
        .editor-row {
            display: flex;
            gap: 12px;
        }

        .editor-field.half {
            flex: 1;
        }

        /* Editor Modal Footer */
        .editor-modal-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--separator);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .editor-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .editor-btn.cancel {
            background: var(--surface);
            color: var(--text);
        }

        .editor-btn.save {
            background: var(--primary);
            color: white;
        }

        .editor-btn:active {
            opacity: 0.8;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 24px 16px;
            font-size: 14px;
        }

        /* Superset Editor */
        .superset-exercise-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
        }

        .superset-exercise-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .superset-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 0;
        }

        .superset-divider span {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            background: var(--background);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .superset-item {
            border-left: 3px solid var(--primary);
        }

        /* Editor screens scrolling - ensure content scrolls above bottom nav */
        #manageScreen .container,
        #workoutEditorScreen .container,
        #sectionEditorScreen .container,
        #exerciseBankScreen .container {
            padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
        }

        #homeScreen .container,
        #workoutsPageScreen .container {
            padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
        }

        /* Monthly Counter Widget */
        .monthly-counter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .month-counter-item {
            background: var(--surface-elevated);
            border-radius: 8px;
            padding: 10px 8px;
            text-align: center;
        }

        .month-counter-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .month-counter-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .month-counter-weeks {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .month-counter-item.current {
            background: rgba(10, 132, 255, 0.15);
            border: 1px solid var(--primary);
        }

        .month-counter-item.current .month-counter-value {
            color: var(--primary);
        }

        /* Streak Widget */
        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 0;
        }

        .streak-number {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }

        .streak-info {
            text-align: left;
        }

        .streak-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .streak-record {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Total Workouts Widget */
        .total-workouts-display {
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
        }

        .total-stat {
            text-align: center;
        }

        .total-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
        }

        .total-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Recent PRs Widget */
        .recent-prs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pr-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface-elevated);
            border-radius: 8px;
            padding: 10px 12px;
        }

        .pr-trophy {
            color: #FFD700;
            font-size: 20px;
        }

        .pr-details {
            flex: 1;
        }

        .pr-exercise {
            font-size: 14px;
            font-weight: 600;
        }

        .pr-value {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pr-date {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Muscle Balance Widget */
        .muscle-balance-display {
            padding: 8px 0;
        }

        .muscle-balance-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .muscle-balance-label {
            width: 90px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .muscle-balance-bar-bg {
            flex: 1;
            height: 8px;
            background: var(--surface-elevated);
            border-radius: 4px;
            overflow: hidden;
        }

        .muscle-balance-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .muscle-balance-bar.low {
            background: #ff3b30;
        }

        .muscle-balance-bar.medium {
            background: #ff9500;
        }

        .muscle-balance-bar.good {
            background: var(--success);
        }

        .muscle-balance-count {
            width: 30px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
        }

        /* Rest Days Widget */
        .rest-days-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 0;
        }

        .rest-days-number {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
        }

        .rest-days-number.recovered {
            color: var(--success);
        }

        .rest-days-number.warning {
            color: #ff9500;
        }

        .rest-days-number.overdue {
            color: #ff3b30;
        }

        .rest-days-info {
            text-align: left;
        }

        .rest-days-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .rest-days-status {
            font-size: 12px;
            margin-top: 4px;
        }

        .rest-days-status.recovered {
            color: var(--success);
        }

        .rest-days-status.warning {
            color: #ff9500;
        }

        .rest-days-status.overdue {
            color: #ff3b30;
        }

        /* Volume Tracker Widget */
        .volume-tracker-display {
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
        }

        .volume-stat {
            text-align: center;
        }

        .volume-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .volume-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .volume-change {
            font-size: 11px;
            margin-top: 2px;
        }

        .volume-change.positive {
            color: var(--success);
        }

        .volume-change.negative {
            color: #ff3b30;
        }

        #exercisesScreen .container {
            padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
            padding-top: 0;
        }

        /* Exercises Tab Styles */
        .exercises-sticky-header {
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 16px 0 8px 0;
            z-index: 10;
            margin: 0 -16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        .exercises-search-container {
            position: relative;
            margin-bottom: 12px;
        }

        .exercises-search-input {
            width: 100%;
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 12px 16px 12px 44px;
            font-size: 16px;
            color: var(--text);
            -webkit-appearance: none;
        }

        .exercises-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .exercises-search-input::placeholder {
            color: var(--text-secondary);
        }

        .exercises-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .exercises-category-filter {
            margin-bottom: 16px;
        }

        .exercises-category-select {
            width: 100%;
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            color: var(--text);
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .exercises-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .exercise-list-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-list-info {
            flex: 1;
        }

        .exercise-list-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .exercise-list-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .exercise-list-badge {
            font-size: 10px;
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .exercise-list-actions {
            display: flex;
            gap: 8px;
        }

        .exercise-info-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            padding: 8px;
            cursor: pointer;
        }

        .add-exercise-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            margin-top: 16px;
        }

        /* Edit Home Button */
        .edit-home-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-home-btn.active {
            color: var(--success);
        }

        /* Widget System */
        .widget {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.2s ease;
        }

        .widget.edit-mode {
            border: 1px solid var(--primary);
            background: rgba(10, 132, 255, 0.05);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .widget-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-reorder-btns {
            display: none;
            flex-direction: column;
            gap: 2px;
        }

        .widget.edit-mode .widget-reorder-btns {
            display: flex;
        }

        .widget-reorder-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            color: var(--text-secondary);
            width: 28px;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .widget-reorder-btn:active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .widget-reorder-btn svg {
            width: 14px;
            height: 14px;
        }

        .widget-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .widget-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-settings-btn:active {
            opacity: 0.6;
        }

        .widget-remove-btn {
            background: none;
            border: none;
            color: #ff3b30;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.15s;
        }

        .widget-remove-btn:active {
            background: rgba(255, 59, 48, 0.15);
        }

        .widget-remove-btn svg {
            width: 18px;
            height: 18px;
        }

        .widget.edit-mode .widget-remove-btn {
            display: flex;
        }

        .add-widget-btn {
            background: var(--surface-elevated);
            border: 2px dashed var(--separator);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .add-widget-btn.visible {
            display: flex;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: calc(100vh - 40px - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--separator);
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        /* Exercise Editor Sheet - Full screen style */
        #exerciseEditorModal.modal {
            padding: 0;
            background: transparent;
        }

        #exerciseEditorModal .exercise-editor-sheet {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
        }

        .exercise-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            background: var(--surface);
            border-bottom: 1px solid var(--separator);
            flex-shrink: 0;
            position: relative;
        }

        .exercise-editor-header h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .exercise-editor-cancel,
        .exercise-editor-save {
            background: none;
            border: none;
            font-size: 17px;
            cursor: pointer;
            padding: 8px 0;
            min-width: 60px;
            z-index: 1;
        }

        .exercise-editor-cancel {
            color: var(--accent);
            text-align: left;
        }

        .exercise-editor-save {
            color: var(--accent);
            font-weight: 600;
            text-align: right;
        }

        .exercise-editor-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        .exercise-editor-field {
            margin-bottom: 24px;
        }

        .exercise-editor-field label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .exercise-editor-field input,
        .exercise-editor-field select,
        .exercise-editor-field textarea {
            width: 100%;
            background: var(--surface-elevated);
            color: var(--text);
            border: 1px solid var(--separator);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 16px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
            opacity: 1;
        }

        .exercise-editor-field select {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .exercise-editor-field input:focus,
        .exercise-editor-field select:focus,
        .exercise-editor-field textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .exercise-editor-field input.readonly {
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .exercise-editor-field select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238e8e93' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        .exercise-editor-field textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            line-height: 1.5;
        }

        .exercise-editor-static {
            color: var(--text);
            font-size: 16px;
            padding: 14px 0;
        }

        .exercise-editor-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .exercise-editor-reset {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: #ff9500;
            border: 1px solid #ff9500;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .widget-option {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .widget-option:hover {
            background: var(--surface-elevated);
        }

        .widget-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .widget-option-info {
            flex: 1;
        }

        .widget-option-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .widget-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Exercise Progress Widget */
        .exercise-progress-widget {
            padding: 16px;
        }

        .exercise-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .exercise-progress-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
        }

        .exercise-progress-select-btn {
            background: var(--primary);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .exercise-progress-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .progress-stat {
            flex: 1;
            text-align: center;
            background: var(--surface-elevated);
            padding: 12px;
            border-radius: 10px;
        }

        .progress-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .progress-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .progress-stat-value.estimated {
            color: var(--primary);
        }

        .exercise-progress-chart {
            height: 120px;
            margin-top: 12px;
        }

        .progress-search-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .progress-search-input::placeholder {
            color: var(--text-secondary);
        }

        .exercise-progress-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .exercise-progress-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 6px;
            background: var(--surface-elevated);
        }

        .exercise-progress-item:hover,
        .exercise-progress-item:active {
            background: var(--card-bg);
        }

        .exercise-progress-item-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
        }

        .exercise-progress-item-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .no-data-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 14px;
        }

        .exercise-defaults {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .exercise-defaults .editor-field {
            flex: 1;
            margin-bottom: 0;
        }

        .container {
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
            box-sizing: border-box;
            width: 100%;
        }

        .welcome {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .workout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .workout-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--separator);
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .workout-card:active {
            transform: scale(0.98);
            background: var(--surface-elevated);
        }

        .workout-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            min-width: 0;
            overflow: hidden;
        }

        .workout-card-title-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
            flex: 1;
            overflow: hidden;
        }

        .card-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .card-badge.custom {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }

        .card-badge.modified {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
        }

        /* Home Screen Section Headers */
        .home-section {
            margin-top: 28px;
        }

        .home-section:first-child {
            margin-top: 0;
        }

        .home-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .home-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Weekly Activity Tracker */
        .weekly-tracker {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 14px 16px;
        }

        .week-days {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-circle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .day-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #48484a;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .day-indicator.completed {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .day-indicator.completed svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .day-indicator.today:not(.completed) {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Weight Tracker */
        .weight-tracker {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-top: 16px;
        }

        .weight-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .weight-input {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 16px;
            color: var(--text);
            -webkit-appearance: none;
        }

        .weight-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .weight-unit {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .weight-submit {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .weight-today {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(10, 132, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .weight-today span {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .weight-edit-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .weight-chart-container {
            height: 150px;
            margin-bottom: 12px;
        }

        .weight-chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .weight-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .weight-stat {
            text-align: center;
        }

        .weight-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .weight-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .weight-stat-value.positive {
            color: var(--success);
        }

        .weight-stat-value.negative {
            color: var(--danger);
        }

        .workout-icon {
            color: var(--primary);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .workout-icon svg {
            width: 20px;
            height: 20px;
        }

        .workout-title {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
        }

        .workout-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 32px;
        }

        .last-workout {
            font-size: 11px;
            color: var(--success);
            margin-top: 4px;
            margin-left: 32px;
        }

        .section-header {
            font-size: 20px;
            font-weight: 700;
            margin: 32px 0 16px;
            color: var(--text);
        }

        .option-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .option-pill {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 12px 18px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .option-pill:active {
            transform: scale(0.97);
        }

        .option-pill.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .exercise-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            margin-bottom: 16px;
            min-height: 52px;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238e8e93' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .exercise-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Start Workout Overlay */
        .start-workout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .start-workout-content {
            text-align: center;
            max-width: 320px;
        }

        .start-workout-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .start-workout-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .start-workout-btn {
            background: var(--success);
            border: none;
            color: white;
            padding: 18px 48px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            margin-bottom: 16px;
        }

        .start-workout-btn:active {
            transform: scale(0.97);
        }

        .cancel-start-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Workout Header Title */
        .workout-header-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Workout Fixed Header (header + tabs) */
        .workout-fixed-header {
            flex-shrink: 0;
            background: var(--bg);
        }

        .workout-fixed-header .header {
            border-bottom: none;
        }

        /* Workout Section Tabs */
        .workout-tabs {
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background: var(--bg);
            border-bottom: 1px solid var(--separator);
        }

        .workout-tabs::after {
            content: '';
            flex-shrink: 0;
            width: 12px;
        }

        .workout-tabs::-webkit-scrollbar {
            display: none;
        }

        .workout-tab {
            flex-shrink: 0;
            padding: 6px 12px;
            border-radius: 16px;
            background: var(--surface);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .workout-tab.active {
            background: var(--primary);
            color: white;
        }

        .workout-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }

        .workout-section {
            display: none;
        }

        .workout-section.active {
            display: block;
        }

        /* Workout Header Timer */
        .workout-header-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'SF Mono', monospace;
            font-size: 17px;
            font-weight: 600;
            color: var(--success);
        }

        .timer-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Bottom Workout Controls - part of flex layout */
        .workout-bottom-controls {
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
            background: var(--bg);
            border-top: 1px solid var(--separator);
        }

        .workout-bottom-buttons {
            display: flex;
            gap: 8px;
        }

        .bottom-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .bottom-btn.cancel {
            background: var(--surface-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--separator);
        }

        .bottom-btn.save {
            background: var(--success);
            color: white;
        }

        /* Deload toggle */
        .deload-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            margin-bottom: 6px;
        }

        .deload-toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .deload-toggle-label .deload-icon {
            flex-shrink: 0;
        }

        .deload-toggle-label.active {
            color: var(--warning);
        }

        .deload-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--surface-elevated);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid var(--separator);
        }

        .deload-toggle.active {
            background: var(--warning);
            border-color: var(--warning);
        }

        .deload-toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .deload-toggle.active .deload-toggle-knob {
            transform: translateX(20px);
        }

        /* Active workout banner */
        .active-workout-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 8px 16px;
            padding-top: calc(8px + env(safe-area-inset-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 150;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .active-workout-banner:active {
            opacity: 0.9;
        }

        .banner-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .banner-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .banner-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        .banner-title {
            font-size: 13px;
            font-weight: 700;
        }

        .banner-time {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
        }

        .banner-action {
            font-size: 12px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Adjust screens when banner is showing */
        .has-active-banner .header {
            margin-top: 45px;
        }

        .bottom-btn:active {
            transform: scale(0.97);
        }

        .option-content {
            display: none;
        }

        .option-content.active {
            display: block;
        }

        .exercise-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 4px;
        }

        .exercise-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 4px;
        }

        .exercise-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
            text-align: center;
            width: 100%;
        }

        .exercise-name-select {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            padding: 0 16px;
            text-align: center;
            text-align-last: center;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0 center;
            width: 100%;
            max-width: 100%;
        }

        .exercise-name-select:focus {
            outline: none;
        }

        /* Circuit Preset Selector */
        .circuit-preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--surface);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .circuit-preset-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .circuit-preset-select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            padding: 8px 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .circuit-preset-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Superset Preset Selector - reuses circuit preset styles */
        .superset-preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--surface);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .superset-preset-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .superset-preset-select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            padding: 8px 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .superset-preset-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .exercise-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .exercise-meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-btn {
            background: var(--surface-elevated);
            border: none;
            color: var(--primary);
            width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exercise-specs {
            display: none;
        }

        .set-tracker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Swipeable set row */
        .set-row-container {
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            margin-bottom: 2px;
        }

        .set-row-delete {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background: #ff453a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 24px 1fr 1fr 32px;
            gap: 4px;
            align-items: center;
            background: var(--surface);
            padding: 4px;
            border-radius: 6px;
            position: relative;
            transition: transform 0.2s ease;
            touch-action: pan-y;
        }

        .set-row.swiped {
            transform: translateX(-60px);
        }

        .set-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-align: center;
        }

        .add-set-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px;
            margin-top: 2px;
            background: var(--surface);
            border: 1px dashed var(--separator);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-set-btn:active {
            background: var(--surface-elevated);
            color: var(--success);
        }

        .set-controls {
            display: none;
        }

        .set-control-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            font-weight: 700;
            padding: 0;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .set-control-btn:active {
            background: var(--surface);
            transform: scale(0.95);
        }

        .set-control-btn.remove {
            color: #ff453a;
        }

        .set-control-btn.add {
            color: var(--success);
        }

        .set-check {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: 2px solid var(--separator);
            background: var(--surface-elevated);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: transparent;
            transition: all 0.2s;
        }

        .set-check:active {
            transform: scale(0.95);
        }

        .set-check.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .set-check.resting {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
        }

        /* Rest Timer Overlay */
        .rest-timer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .rest-timer-overlay.active {
            display: flex;
        }

        .rest-timer-display {
            font-size: 96px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .rest-timer-label {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .rest-timer-skip {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            color: var(--text);
            padding: 18px 48px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            min-height: 56px;
        }

        .rest-timer-skip:active {
            background: var(--surface);
            transform: scale(0.97);
        }

        .tracking-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 6px;
            padding: 6px 4px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='8' height='5' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 4px center;
            padding-right: 18px;
            min-height: 30px;
            text-align: center;
        }

        .tracking-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tracking-select.filled {
            border-color: var(--success);
            color: var(--success);
            background-color: rgba(48, 209, 88, 0.1);
        }

        .superset-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--separator);
        }

        .superset-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .superset-arrow {
            text-align: center;
            font-size: 20px;
            color: var(--primary);
            margin: 4px 0;
        }

        .circuit-container {
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--separator);
            overflow: hidden;
        }

        .circuit-header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--surface-elevated);
        }

        .circuit-title {
            font-size: 15px;
            font-weight: 600;
        }

        .circuit-arrow {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .circuit-arrow.open {
            transform: rotate(180deg);
        }

        .circuit-exercises {
            padding: 16px;
            display: none;
        }

        .circuit-exercises.open {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--separator);
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 99;
        }

        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .modal-body {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .modal-close {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        .complete-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: var(--success);
            border: none;
            color: white;
            padding: 16px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(48, 209, 88, 0.3);
            z-index: 50;
        }

        .complete-btn:active {
            transform: scale(0.98);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 8px;
        }

        .month-selectors {
            display: flex;
            gap: 6px;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .month-select, .year-select {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            padding: 8px 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238e8e93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }

        .year-select {
            min-width: 75px;
        }

        .month-select:focus, .year-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .month-nav {
            display: flex;
            gap: 8px;
        }

        .month-nav-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--separator);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 18px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-nav-btn:active {
            background: var(--surface);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .calendar-fixed-area {
            flex-shrink: 0;
            padding: 10px;
            padding-bottom: 0;
        }

        .calendar-scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            padding-top: 16px;
            padding-bottom: 80px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--separator);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .calendar-day.today {
            background: rgba(10, 132, 255, 0.2);
            border-color: var(--primary);
        }

        .calendar-day.has-workout {
            background: rgba(48, 209, 88, 0.15);
            border-color: var(--success);
        }

        .calendar-day.has-workout.today {
            background: rgba(48, 209, 88, 0.25);
            border-color: var(--success);
        }

        .calendar-day.has-workout .calendar-dot {
            display: block;
        }

        .calendar-day.selected,
        .calendar-day.selected.has-workout,
        .calendar-day.selected.has-workout.today {
            background: var(--primary);
            border-color: var(--primary);
        }

        .calendar-day.selected .calendar-day-number {
            color: white;
            font-weight: 700;
        }

        .calendar-day.selected .calendar-dot {
            background: white;
        }

        .calendar-day.selected .calendar-workout-name {
            color: rgba(255,255,255,0.9);
        }

        .calendar-day-number {
            font-size: 17px;
            font-weight: 600;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 3px;
            margin-top: 3px;
            display: none;
        }

        .calendar-workout-name {
            font-size: 8px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.2;
            margin-top: 2px;
            max-width: 100%;
            padding: 0 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workout-history-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .history-workout {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-stats {
            font-size: 15px;
            color: var(--text-secondary);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive adjustments for larger phones */
        @media (min-width: 430px) {
            .container {
                padding: 16px;
            }

            .workout-sticky-header {
                margin: 0 -16px;
                padding-left: 16px;
                padding-right: 16px;
            }
        }

        /* Workout Sticky Header */
        .workout-sticky-header {
            position: sticky;
            top: 56px;
            z-index: 90;
            background: var(--bg);
            padding-bottom: 16px;
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 8px;
        }

        .workout-sticky-title {
            margin-bottom: 12px;
        }

        .workout-sticky-title .welcome {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .workout-sticky-title .subtitle {
            margin-bottom: 0;
        }

        /* Workout Timer & Controls */
        .workout-controls {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--separator);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 16px;
        }

        .timer-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .timer-time {
            font-size: 36px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: var(--primary);
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .control-btn {
            background: var(--surface-elevated);
            border: 2px solid var(--separator);
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.start {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .control-btn.end {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .control-btn:active:not(:disabled) {
            transform: scale(0.97);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Workout Detail Modal */
        .workout-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .workout-detail-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .workout-detail-content {
            background: var(--surface);
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        .workout-detail-header {
            position: sticky;
            top: 0;
            background: var(--surface);
            padding: 20px;
            border-bottom: 1px solid var(--separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .workout-detail-close {
            background: var(--surface-elevated);
            border: none;
            color: var(--text);
            width: 32px;
            height: 32px;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workout-detail-body {
            padding: 20px;
        }

        .workout-summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--separator);
        }

        .workout-summary-card:hover {
            background: var(--surface-elevated);
            border-color: var(--primary);
        }

        .workout-summary-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>

<!-- Home Screen -->
    <div class="screen active" id="homeScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Home</div>
                <div class="header-right">
                    <div class="header-date" id="currentDate"></div>
                    <button class="edit-home-btn" id="editHomeBtn" onclick="toggleHomeEditMode()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="container" id="homeWidgetsContainer">
            <!-- Dynamically populated by renderHomeWidgets() -->
        </div>
    </div>

    <!-- Add Widget Modal -->
    <div class="modal" id="addWidgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Widget</h3>
                <button class="modal-close" onclick="closeAddWidgetModal()">&times;</button>
            </div>
            <div class="modal-body" id="addWidgetList">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Exercise Progress Config Modal -->
    <div class="modal" id="exerciseProgressModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3>Select Exercise</h3>
                <button class="modal-close" onclick="closeExerciseProgressModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 12px;">
                <input type="text" class="progress-search-input" id="progressExerciseSearch" placeholder="Search..." oninput="filterProgressExercises()">
                <div class="exercise-progress-list" id="progressExerciseList">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Workouts Page Screen (separate tab with widget system) -->
    <div class="screen" id="workoutsPageScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Workouts</div>
                <div class="header-right">
                    <div class="header-date" id="workoutsPageDate"></div>
                    <button class="edit-home-btn" id="editWorkoutsBtn" onclick="toggleWorkoutsEditMode()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="container" id="workoutsPageWidgetsContainer">
            <!-- Dynamically populated by renderWorkoutsPageWidgets() -->
        </div>
    </div>

    <!-- Add Workouts Widget Modal -->
    <div class="modal" id="addWorkoutsWidgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Widget</h3>
                <button class="modal-close" onclick="closeAddWorkoutsWidgetModal()">&times;</button>
            </div>
            <div class="modal-body" id="addWorkoutsWidgetList">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Workout Screen -->
    <div class="screen" id="workoutScreen">
        <div class="workout-fixed-header">
            <div class="header">
                <div class="header-content">
                    <button class="back-btn" onclick="handleWorkoutBack()">â† Back</button>
                    <div class="workout-header-title" id="workoutHeaderTitle"></div>
                    <div class="workout-header-timer" id="headerTimer" style="display: none;">
                        <div class="timer-dot"></div>
                        <span id="headerTimerDisplay">0:00</span>
                    </div>
                </div>
            </div>
            <div class="workout-tabs" id="workoutTabs"></div>
        </div>

        <div class="container workout-container" id="workoutContent"></div>

        <div class="workout-bottom-controls" id="workoutBottomControls" style="display: none;">
            <div class="deload-toggle-container">
                <span class="deload-toggle-label" id="deloadLabel">
                    <svg class="deload-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect><line x1="23" y1="10" x2="23" y2="14"></line><line x1="6" y1="10" x2="6" y2="14"></line></svg>
                    Deload Mode
                </span>
                <div class="deload-toggle" id="deloadToggle" onclick="toggleDeload()">
                    <div class="deload-toggle-knob"></div>
                </div>
            </div>
            <div class="workout-bottom-buttons">
                <button class="bottom-btn cancel" onclick="cancelWorkout()">Cancel</button>
                <button class="bottom-btn save" onclick="endWorkoutSession()">End & Save</button>
            </div>
        </div>
    </div>


    <!-- Calendar Screen -->
    <div class="screen" id="calendarScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Calendar</div>
            </div>
        </div>

        <div class="calendar-fixed-area">
            <div class="month-header">
                <div class="month-selectors">
                    <select class="month-select" id="monthSelect" onchange="setMonth(this.value)">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select class="year-select" id="yearSelect" onchange="setYear(this.value)"></select>
                </div>
                <div class="month-nav">
                    <button class="month-nav-btn" onclick="changeMonth(-1)">â†</button>
                    <button class="month-nav-btn" onclick="changeMonth(1)">â†’</button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="calendar-scroll-area" id="dayWorkouts"></div>
    </div>

    <!-- Exercises Tab Screen -->
    <div class="screen" id="exercisesScreen">
        <div class="header">
            <div class="header-content">
                <div class="logo">Exercises</div>
            </div>
        </div>
        <div class="container">
            <div class="exercises-sticky-header">
                <div class="exercises-search-container">
                    <input type="text" class="exercises-search-input" id="exercisesSearchInput" placeholder="Search exercises..." oninput="filterExercisesTab()">
                    <svg class="exercises-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <div class="exercises-category-filter">
                    <select class="exercises-category-select" id="exercisesCategorySelect" onchange="filterExercisesTab()">
                        <option value="All">All Categories</option>
                    </select>
                </div>
            </div>
            <div class="exercises-list" id="exercisesTabList">
                <!-- Populated by renderExercisesTab() -->
            </div>
            <button class="add-exercise-btn" onclick="showAddCustomExerciseModal()">+ Add Custom Exercise</button>
        </div>
    </div>

    <!-- Manage Workouts Screen -->
    <div class="screen" id="manageScreen">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showScreen('home')">â† Back</button>
                <div class="logo">Manage Workouts</div>
            </div>
        </div>
        <div class="container" id="manageContent">
            <!-- Populated by renderManageWorkouts() -->
        </div>
    </div>

    <!-- Workout Editor Screen -->
    <div class="screen" id="workoutEditorScreen">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="cancelWorkoutEditor()">â† Cancel</button>
                <div class="logo" id="workoutEditorTitle">Edit Workout</div>
                <button class="save-btn" onclick="saveWorkoutEditor()">Save</button>
            </div>
        </div>
        <div class="container" id="workoutEditorContent">
            <!-- Populated by renderWorkoutEditor() -->
        </div>
    </div>

    <!-- Section Editor Screen -->
    <div class="screen" id="sectionEditorScreen">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="cancelSectionEditor()">â† Cancel</button>
                <div class="logo" id="sectionEditorTitle">Edit Section</div>
                <button class="save-btn" onclick="saveSectionEditor()">Save</button>
            </div>
        </div>
        <div class="container" id="sectionEditorContent">
            <!-- Populated by renderSectionEditor() -->
        </div>
    </div>

    <!-- Exercise Editor Modal -->
    <div class="editor-modal" id="exerciseEditorModal">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <span id="exerciseEditorTitle">Edit Exercise</span>
                <button class="editor-modal-close" onclick="closeExerciseEditor()">âœ•</button>
            </div>
            <div class="editor-modal-body" id="exerciseEditorBody">
                <!-- Populated by openExerciseEditor() -->
            </div>
            <div class="editor-modal-footer">
                <button class="editor-btn cancel" onclick="closeExerciseEditor()">Cancel</button>
                <button class="editor-btn save" onclick="saveExerciseEditor()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div class="editor-modal" id="addExerciseModal">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <span>Add Exercise</span>
                <button class="editor-modal-close" onclick="closeAddExerciseModal()">âœ•</button>
            </div>
            <div class="editor-modal-body" id="addExerciseBody">
                <!-- Populated by openAddExerciseModal() -->
            </div>
            <div class="editor-modal-footer">
                <button class="editor-btn cancel" onclick="closeAddExerciseModal()">Cancel</button>
                <button class="editor-btn save" onclick="confirmAddExercise()">Add</button>
            </div>
        </div>
    </div>

    <!-- Exercise Bank Screen -->
    <div class="screen" id="exerciseBankScreen">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showScreen('manage')">â† Back</button>
                <div class="logo">Exercise Bank</div>
            </div>
        </div>
        <div class="container" id="exerciseBankContent">
            <!-- Populated by renderExerciseBank() -->
        </div>
    </div>

    <!-- Superset Editor Modal -->
    <div class="editor-modal" id="supersetEditorModal">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <span id="supersetEditorTitle">Edit Superset</span>
                <button class="editor-modal-close" onclick="closeSupersetEditor()">âœ•</button>
            </div>
            <div class="editor-modal-body" id="supersetEditorBody">
                <!-- Populated by openSupersetEditor() -->
            </div>
            <div class="editor-modal-footer">
                <button class="editor-btn cancel" onclick="closeSupersetEditor()">Cancel</button>
                <button class="editor-btn save" onclick="saveSupersetEditor()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Custom Exercise Modal -->
    <div class="editor-modal" id="customExerciseModal">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <span id="customExerciseTitle">Add Custom Exercise</span>
                <button class="editor-modal-close" onclick="closeCustomExerciseModal()">âœ•</button>
            </div>
            <div class="editor-modal-body" id="customExerciseBody">
                <!-- Populated by openCustomExerciseModal() -->
            </div>
            <div class="editor-modal-footer">
                <button class="editor-btn cancel" onclick="closeCustomExerciseModal()">Cancel</button>
                <button class="editor-btn save" onclick="saveCustomExercise()">Save</button>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div class="workout-detail-modal" id="workoutDetailModal">
        <div class="workout-detail-content">
            <div class="workout-detail-header">
                <div>
                    <div style="font-size: 24px; font-weight: 700;" id="modalWorkoutType"></div>
                    <div style="font-size: 15px; color: var(--text-secondary); margin-top: 4px;" id="modalWorkoutDate"></div>
                </div>
                <button class="workout-detail-close" onclick="closeWorkoutDetailModal()">âœ•</button>
            </div>
            <div class="workout-detail-body" id="workoutDetailBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Exercise Info Modal -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <div class="modal-header" id="exerciseName"></div>
            <div class="modal-body" id="exerciseInfo"></div>
            <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Rest Timer Overlay -->
    <div class="rest-timer-overlay" id="restTimerOverlay">
        <div class="rest-timer-label">Rest Time</div>
        <div class="rest-timer-display" id="restTimerDisplay">0:00</div>
        <button class="rest-timer-skip" onclick="skipRestTimer()">Skip</button>
    </div>

    <!-- Active Workout Banner -->
    <div class="active-workout-banner" id="activeWorkoutBanner" style="display: none;" onclick="returnToActiveWorkout()">
        <div class="banner-left">
            <div class="banner-dot"></div>
            <div class="banner-info">
                <div class="banner-title" id="bannerWorkoutName"></div>
                <div class="banner-time" id="bannerWorkoutTime">0:00</div>
            </div>
        </div>
        <div class="banner-action">Tap to return â†’</div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('home')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" onclick="showScreen('workoutsPage'); renderWorkoutsPageWidgets();">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 6.5a2 2 0 0 1 3 0v11a2 2 0 0 1-3 0V15H5a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h1.5V6.5z"/><path d="M17.5 6.5a2 2 0 0 0-3 0v11a2 2 0 0 0 3 0V15H19a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-1.5V6.5z"/><line x1="9.5" y1="12" x2="14.5" y2="12"/></svg>
            <span class="nav-label">Workouts</span>
        </button>
        <button class="nav-btn" onclick="showScreen('calendar')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span class="nav-label">History</span>
        </button>
        <button class="nav-btn" onclick="showScreen('exercises'); renderExercisesTab();">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
            <span class="nav-label">Exercises</span>
        </button>
    </div>

    <script>

    // Workout data structure (same as before but referenced by workout type, not week)
        const WORKOUTS = {
            'Lower Body': {
                title: 'Lower Body',
                duration: '75-90 min',
                focus: 'Squats, jumps, posterior',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Pogo Hops', sets: 3, reps: '30', rest: '60s', notes: 'Low amplitude, rhythm' },
                            { name: 'Lateral Line Hops', sets: 3, reps: '20/side', rest: '60s', notes: 'Side-to-side' },
                            { name: 'Single-Leg Hops', sets: 3, reps: '15/leg', rest: '60s', notes: 'In place' },
                            { name: 'Banded Lateral Hops', sets: 3, reps: '12/side', rest: '60s', notes: 'Band around ankles, explosive' },
                            { name: 'A-Skips', sets: 3, reps: '20m', rest: '60s', notes: 'Sprint mechanics drill' },
                            { name: 'Lateral Skater Hops', sets: 3, reps: '10/side', rest: '60s', notes: 'Stick landings' },
                            { name: 'Lateral Bounds', sets: 3, reps: '10/side', rest: '60s', notes: 'Push off hard' },
                            { name: 'Cone Shuffles', sets: 3, reps: '30s', rest: '60s', notes: 'Quick lateral feet' },
                            { name: 'Carioca Drill', sets: 3, reps: '20 yds', rest: '60s', notes: 'Hip mobility, footwork' },
                            { name: 'Diagonal Bounds', sets: 3, reps: '8/direction', rest: '60s', notes: '45Â° angles, multi-planar' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Step down, max height' },
                            { name: 'Depth Jumps', sets: 3, reps: '5', rest: '2min', notes: '12-18 inch box, jump max' },
                            { name: 'Hurdle Hops', sets: 3, reps: '5', rest: '2min', notes: 'Continuous, max height' },
                            { name: 'Banded Lateral Jumps', sets: 3, reps: '5/side', rest: '2min', notes: 'Heavy band, max distance' },
                            { name: 'Single-Leg Box Jumps', sets: 3, reps: '4/leg', rest: '2min', notes: 'Advanced, balance focus' },
                            { name: 'Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Max distance, stick 3s' },
                            { name: 'Single-Leg Broad Jump', sets: 3, reps: '4/leg', rest: '2min', notes: 'Balance on landing' },
                            { name: 'Box Jump (Forward)', sets: 3, reps: '5', rest: '2min', notes: 'Jump onto box' },
                            { name: '180Â° Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Jump, rotate mid-air, land' },
                            { name: 'Banded Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Resistance band for power' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'High Bar Back Squat', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '3min', 
                                notes: 'Add 5 lbs at 4x8',
                                rotations: [
                                    { name: 'High Bar Back Squat', notes: 'Add 5 lbs at 4x8' },
                                    { name: 'Front Squat (Heavy)', notes: 'More quad/core focus' },
                                    { name: 'Safety Bar Squat', notes: 'Upper back friendly' }
                                ]
                            },
                            { 
                                name: 'Romanian Deadlift', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: '3s eccentric',
                                rotations: [
                                    { name: 'Romanian Deadlift', notes: '3s eccentric' },
                                    { name: 'Snatch Grip RDL', notes: 'Upper back emphasis' },
                                    { name: 'Single-Leg RDL', notes: 'Balance + unilateral' }
                                ]
                            },
                            { 
                                name: 'Bulgarian Split Squats', 
                                sets: 3, 
                                reps: '8-10/leg', 
                                rest: '90s', 
                                notes: 'DBs or barbell',
                                rotations: [
                                    { name: 'Bulgarian Split Squats', notes: 'DBs or barbell' },
                                    { name: 'Skater Squats', notes: 'Single leg athletic' },
                                    { name: 'Deficit Reverse Lunges', notes: 'Glute focus' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Accessories',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Leg Extensions', sets: 3, reps: '12-15', rest: '0s', notes: 'Squeeze at top' },
                                        { name: 'Leg Curls', sets: 3, reps: '12-15', rest: '90s', notes: 'Control negative' }
                                    ],
                                    [
                                        { name: 'Leg Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Deep ROM' },
                                        { name: 'Good Mornings', sets: 3, reps: '12-15', rest: '90s', notes: 'Hamstring focus' }
                                    ],
                                    [
                                        { name: 'Walking Lunges (Light)', sets: 3, reps: '12/leg', rest: '0s', notes: 'Burnout sets' },
                                        { name: 'Glute-Ham Raises', sets: 3, reps: '8-12', rest: '90s', notes: 'Eccentric control' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Standing Calf Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Full ROM' },
                                        { name: 'Tibialis Raises', sets: 3, reps: '20', rest: '60s', notes: 'Shin health' }
                                    ],
                                    [
                                        { name: 'Seated Calf Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Soleus focus' },
                                        { name: 'Calf Press on Leg Press', sets: 3, reps: '20', rest: '60s', notes: 'Heavy load' }
                                    ],
                                    [
                                        { name: 'Single-Leg Calf Raise', sets: 3, reps: '12/leg', rest: '0s', notes: 'Balance challenge' },
                                        { name: 'Tibialis Raises', sets: 3, reps: '20', rest: '60s', notes: 'Shin health' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Sled Push', sets: 4, reps: '30m', rest: '90s', notes: 'Heavy, drive through legs' },
                            { name: 'Sled Drag', sets: 4, reps: '30m', rest: '90s', notes: 'Backward, stay low' },
                            { name: 'Prowler Push', sets: 4, reps: '30m', rest: '90s', notes: 'Low handles, explosive' }
                        ]
                    },
                    {
                        title: 'Core Circuit',
                        isCircuit: true,
                        exercises: [
                            {
                                name: 'Core Exercise 1',
                                sets: 3,
                                reps: '45s/12 reps',
                                rest: '0s',
                                notes: 'Anti-extension focus',
                                rotations: [
                                    { name: 'Plank', notes: 'Hold 45-60s, brace core' },
                                    { name: 'Side Plank', notes: '30s each side' },
                                    { name: 'Dead Bugs', notes: '12 reps per side, slow' },
                                    { name: 'Hollow Body Hold', notes: '30-45s, lower back flat' }
                                ]
                            },
                            {
                                name: 'Core Exercise 2',
                                sets: 3,
                                reps: '10-15/40m',
                                rest: '0s',
                                notes: 'Loaded or rotational',
                                rotations: [
                                    { name: 'Farmer Carry', notes: '40m, heavy DBs or KBs' },
                                    { name: 'Russian Twists', notes: '15 per side, weighted' },
                                    { name: 'Bicycle Crunches', notes: '15 per side, controlled' },
                                    { name: 'Suitcase Carry', notes: '40m each side' }
                                ]
                            },
                            {
                                name: 'Core Exercise 3',
                                sets: 3,
                                reps: '10-15',
                                rest: '60s',
                                notes: 'Compression focus',
                                rotations: [
                                    { name: 'Leg Raises', notes: 'Lying or hanging, control descent' },
                                    { name: 'V-Ups', notes: 'Touch toes at top' },
                                    { name: 'Oblique Crunches', notes: '12 per side' },
                                    { name: 'Overhead Carry', notes: '40m, single or double arm' }
                                ]
                            }
                        ]
                    }
                ]
            },
            'Upper Body': {
                title: 'Upper Body',
                duration: '75-85 min',
                focus: 'Press, pull, shoulders',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Med Ball Chest Pass', sets: 3, reps: '8-10', rest: '60s', notes: 'Against wall, quick' },
                            { name: 'Med Ball Overhead Throws', sets: 3, reps: '8-10', rest: '60s', notes: 'Throw-in style' },
                            { name: 'Light DB Punch', sets: 3, reps: '10/arm', rest: '60s', notes: '5-10lb, explosive' },
                            { name: 'Med Ball Rotational Throws', sets: 3, reps: '8/side', rest: '60s', notes: 'Against wall, core rotation' },
                            { name: 'Band Speed Punches', sets: 3, reps: '15/arm', rest: '60s', notes: 'Resistance band, fast tempo' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Plyo Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands leave ground' },
                            { name: 'Med Ball Slams', sets: 3, reps: '6', rest: '2min', notes: 'Heavy ball' },
                            { name: 'Depth Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands on plates' },
                            { name: 'Med Ball Rotational Slams', sets: 3, reps: '5/side', rest: '2min', notes: 'Overhead to side, explosive' },
                            { name: 'Clapping Pull-Ups', sets: 3, reps: '3-5', rest: '2min', notes: 'Advanced, explosive pull' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'Barbell Bench Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '3min', 
                                notes: 'Control descent',
                                rotations: [
                                    { name: 'Barbell Bench Press', notes: 'Control descent' },
                                    { name: 'Close Grip Bench', notes: 'Tricep emphasis' },
                                    { name: 'Pause Bench Press', notes: '2s pause on chest' }
                                ]
                            },
                            { 
                                name: 'Pull-Ups', 
                                sets: 4, 
                                reps: '6-10', 
                                rest: '2min', 
                                notes: 'Add weight if possible',
                                rotations: [
                                    { name: 'Pull-Ups', notes: 'Add weight if possible' },
                                    { name: 'Chin-Ups', notes: 'Bicep emphasis' },
                                    { name: 'Wide Grip Pull-Ups', notes: 'Lat width' }
                                ]
                            },
                            { 
                                name: 'Overhead Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Standing, strict form',
                                rotations: [
                                    { name: 'Overhead Press', notes: 'Standing, strict form' },
                                    { name: 'Landmine Press', notes: 'Shoulder-friendly angle' },
                                    { name: 'DB Overhead Press', notes: 'More ROM, balance' }
                                ]
                            },
                            { 
                                name: 'Barbell Rows', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: 'Pull to sternum',
                                rotations: [
                                    { name: 'Barbell Rows', notes: 'Pull to sternum' },
                                    { name: 'Pendlay Rows', notes: 'Explosive from floor' },
                                    { name: 'Meadows Row', notes: 'Landmine, single arm' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Accessories',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Incline DB Press', sets: 3, reps: '10-12', rest: '0s', notes: 'Upper chest' },
                                        { name: 'Face Pulls', sets: 3, reps: '15-20', rest: '90s', notes: 'External rotation' }
                                    ],
                                    [
                                        { name: 'Cable Flyes', sets: 3, reps: '12-15', rest: '0s', notes: 'Squeeze at peak' },
                                        { name: 'Rear Delt Flyes', sets: 3, reps: '15-20', rest: '90s', notes: 'Light weight' }
                                    ],
                                    [
                                        { name: 'Push-Ups', sets: 3, reps: '15-20', rest: '0s', notes: 'To failure' },
                                        { name: 'Band Pull-Aparts', sets: 3, reps: '20', rest: '90s', notes: 'Rear delts' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Hammer Curls', sets: 3, reps: '10-12', rest: '0s', notes: 'Brachialis focus' },
                                        { name: 'Overhead Tricep Extension', sets: 3, reps: '12-15', rest: '90s', notes: 'Stretch at bottom' }
                                    ],
                                    [
                                        { name: 'Barbell Curls', sets: 3, reps: '10-12', rest: '0s', notes: 'Strict form' },
                                        { name: 'Skull Crushers', sets: 3, reps: '12-15', rest: '90s', notes: 'Control eccentric' }
                                    ],
                                    [
                                        { name: 'Cable Curls', sets: 3, reps: '12-15', rest: '0s', notes: 'Constant tension' },
                                        { name: 'Rope Pushdowns', sets: 3, reps: '15-20', rest: '90s', notes: 'Full extension' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Battle Ropes', sets: 6, reps: '30s', rest: '30s', notes: 'Alternating waves, max effort' },
                            { name: 'Rowing Sprint', sets: 6, reps: '30s', rest: '30s', notes: 'Max effort strokes' },
                            { name: 'Assault Bike Sprint', sets: 6, reps: '30s', rest: '30s', notes: 'All out effort' }
                        ]
                    }
                ]
            },

        'Full Body': {
                title: 'Full Body',
                duration: '75-90 min',
                focus: 'Deadlifts, carries, metabolic',
                sections: [
                    {
                        title: 'Extensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Pogo Hops', sets: 3, reps: '30', rest: '60s', notes: 'Low amplitude, rhythm' },
                            { name: 'Lateral Line Hops', sets: 3, reps: '20/side', rest: '60s', notes: 'Side-to-side' },
                            { name: 'Single-Leg Hops', sets: 3, reps: '15/leg', rest: '60s', notes: 'In place' },
                            { name: 'Banded Lateral Hops', sets: 3, reps: '12/side', rest: '60s', notes: 'Band around ankles, explosive' },
                            { name: 'A-Skips', sets: 3, reps: '20m', rest: '60s', notes: 'Sprint mechanics drill' },
                            { name: 'Lateral Skater Hops', sets: 3, reps: '10/side', rest: '60s', notes: 'Stick landings' },
                            { name: 'Lateral Bounds', sets: 3, reps: '10/side', rest: '60s', notes: 'Push off hard' },
                            { name: 'Cone Shuffles', sets: 3, reps: '30s', rest: '60s', notes: 'Quick lateral feet' },
                            { name: 'Carioca Drill', sets: 3, reps: '20 yds', rest: '60s', notes: 'Hip mobility, footwork' },
                            { name: 'Diagonal Bounds', sets: 3, reps: '8/direction', rest: '60s', notes: '45Â° angles, multi-planar' },
                            { name: 'Med Ball Chest Pass', sets: 3, reps: '8-10', rest: '60s', notes: 'Against wall, quick' },
                            { name: 'Med Ball Overhead Throws', sets: 3, reps: '8-10', rest: '60s', notes: 'Throw-in style' },
                            { name: 'Light DB Punch', sets: 3, reps: '10/arm', rest: '60s', notes: '5-10lb, explosive' },
                            { name: 'Med Ball Rotational Throws', sets: 3, reps: '8/side', rest: '60s', notes: 'Against wall, core rotation' },
                            { name: 'Band Speed Punches', sets: 3, reps: '15/arm', rest: '60s', notes: 'Resistance band, fast tempo' }
                        ]
                    },
                    {
                        title: 'Intensive Plyo',
                        isOptions: true,
                        exercises: [
                            { name: 'Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Step down, max height' },
                            { name: 'Depth Jumps', sets: 3, reps: '5', rest: '2min', notes: '12-18 inch box, jump max' },
                            { name: 'Hurdle Hops', sets: 3, reps: '5', rest: '2min', notes: 'Continuous, max height' },
                            { name: 'Banded Lateral Jumps', sets: 3, reps: '5/side', rest: '2min', notes: 'Heavy band, max distance' },
                            { name: 'Single-Leg Box Jumps', sets: 3, reps: '4/leg', rest: '2min', notes: 'Advanced, balance focus' },
                            { name: 'Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Max distance, stick 3s' },
                            { name: 'Single-Leg Broad Jump', sets: 3, reps: '4/leg', rest: '2min', notes: 'Balance on landing' },
                            { name: 'Box Jump (Forward)', sets: 3, reps: '5', rest: '2min', notes: 'Jump onto box' },
                            { name: '180Â° Box Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Jump, rotate mid-air, land' },
                            { name: 'Banded Broad Jumps', sets: 3, reps: '5', rest: '2min', notes: 'Resistance band for power' },
                            { name: 'Plyo Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands leave ground' },
                            { name: 'Med Ball Slams', sets: 3, reps: '6', rest: '2min', notes: 'Heavy ball' },
                            { name: 'Depth Push-Ups', sets: 3, reps: '5', rest: '2min', notes: 'Hands on plates' },
                            { name: 'Med Ball Rotational Slams', sets: 3, reps: '5/side', rest: '2min', notes: 'Overhead to side, explosive' },
                            { name: 'Clapping Pull-Ups', sets: 3, reps: '3-5', rest: '2min', notes: 'Advanced, explosive pull' }
                        ]
                    },
                    {
                        title: 'Main Lifts',
                        exercises: [
                            {
                                name: 'Trap Bar Deadlift', 
                                sets: 4, 
                                reps: '5', 
                                rest: '3min', 
                                notes: 'Explosive',
                                rotations: [
                                    { name: 'Trap Bar Deadlift', notes: 'Explosive' },
                                    { name: 'Conventional Deadlift', notes: 'More posterior chain' },
                                    { name: 'Sumo Deadlift', notes: 'Quad emphasis' }
                                ]
                            },
                            { 
                                name: 'Front Squat', 
                                sets: 3, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Upright torso',
                                rotations: [
                                    { name: 'Front Squat', notes: 'Upright torso' },
                                    { name: 'Goblet Squat (Heavy)', notes: 'Core bracing' },
                                    { name: 'Zercher Squat', notes: 'Unique stimulus' }
                                ]
                            },
                            { 
                                name: 'Single-Arm DB Row', 
                                sets: 3, 
                                reps: '10/arm', 
                                rest: '90s', 
                                notes: 'Anti-rotation',
                                rotations: [
                                    { name: 'Single-Arm DB Row', notes: 'Anti-rotation' },
                                    { name: 'Chest-Supported Row', notes: 'Remove lower back' },
                                    { name: 'T-Bar Row', notes: 'Heavy loading' }
                                ]
                            },
                            { 
                                name: 'Walking Lunges', 
                                sets: 3, 
                                reps: '10/leg', 
                                rest: '90s', 
                                notes: 'DBs or barbell',
                                rotations: [
                                    { name: 'Walking Lunges', notes: 'DBs or barbell' },
                                    { name: 'Reverse Lunges', notes: 'More glute focus' },
                                    { name: 'Step-Ups (Heavy)', notes: 'Explosive, knee height box' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Power Movement',
                        isOptions: true,
                        exercises: [
                            { name: 'Power Clean', sets: 4, reps: '3', rest: '2min', notes: 'Explosive from floor' },
                            { name: 'Hang Clean', sets: 4, reps: '3', rest: '2min', notes: 'From above knee' },
                            { name: 'Clean Pull', sets: 4, reps: '5', rest: '2min', notes: 'Deadlift to shrug jump' },
                            { name: 'Kettlebell Swings (Heavy)', sets: 4, reps: '10', rest: '2min', notes: 'Hip hinge power' },
                            { name: 'Snatch Grip High Pull', sets: 4, reps: '5', rest: '2min', notes: 'Wide grip, explosive pull' }
                        ]
                    },
                    {
                        title: 'Loaded Carries',
                        isOptions: true,
                        exercises: [
                            { name: 'Farmer Carries', sets: 3, reps: '40m', rest: '90s', notes: 'Heavy DBs, tight core' },
                            { name: 'Suitcase Carries', sets: 3, reps: '30m/side', rest: '90s', notes: 'One hand, anti-lateral flexion' },
                            { name: 'Overhead Carries', sets: 3, reps: '30m/arm', rest: '90s', notes: 'KB or DB overhead' },
                            { name: 'Zercher Carries', sets: 3, reps: '40m', rest: '90s', notes: 'Barbell in elbow crooks' },
                            { name: 'Turkish Get-Up', sets: 3, reps: '3/side', rest: '90s', notes: 'Full body stability' }
                        ]
                    },
                    {
                        title: 'Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Row Intervals', sets: 5, reps: '500m', rest: '2min', notes: 'Max effort each interval' },
                            { name: 'Assault Bike Intervals', sets: 8, reps: '20s', rest: '10s', notes: 'All out effort, Tabata style' },
                            { name: 'Sled Drag', sets: 4, reps: '30m', rest: '90s', notes: 'Backward, heavy load' }
                        ]
                    },
                    {
                        title: 'Core Finisher',
                        isOptions: true,
                        exercises: [
                            { name: 'Heavy Carries + Plank', sets: 3, reps: '', rest: '90s', notes: 'Farmer carry 20m + weighted plank 30s' },
                            { name: 'Anti-Rotation Complex', sets: 3, reps: '10/side', rest: '60s', notes: 'Pallof press, bird dogs, side plank' },
                            { name: 'Explosive Core', sets: 3, reps: '10-15', rest: '60s', notes: 'Med ball slams, mountain climbers, v-ups' },
                            { name: 'Isometric Hold Circuit', sets: 3, reps: '', rest: '60s', notes: 'Hollow hold 20s, plank 30s, dead bug hold 20s/side' }
                        ]
                    }
                ]
            },
            'Upper Volume': {
                title: 'Upper Volume',
                duration: '65-75 min',
                focus: 'Hypertrophy, abs, arms',
                sections: [
                    {
                        title: 'Main Lifts',
                        exercises: [
                            { 
                                name: 'Push Press', 
                                sets: 4, 
                                reps: '6-8', 
                                rest: '2min', 
                                notes: 'Use leg drive',
                                rotations: [
                                    { name: 'Push Press', notes: 'Use leg drive' },
                                    { name: 'Jerk Press', notes: 'More explosive, drop under' },
                                    { name: 'Viking Press (Landmine)', notes: 'Neutral grip, shoulder-friendly' }
                                ]
                            },
                            { 
                                name: 'Weighted Dips', 
                                sets: 3, 
                                reps: '8-10', 
                                rest: '2min', 
                                notes: 'Chest lean',
                                rotations: [
                                    { name: 'Weighted Dips', notes: 'Chest lean' },
                                    { name: 'Ring Dips', notes: 'More stabilization' },
                                    { name: 'Decline Bench', notes: 'Lower chest emphasis' }
                                ]
                            },
                            { 
                                name: 'Chest-Supported Rows', 
                                sets: 4, 
                                reps: '10-12', 
                                rest: '90s', 
                                notes: 'No momentum',
                                rotations: [
                                    { name: 'Chest-Supported Rows', notes: 'No momentum' },
                                    { name: 'Seal Rows', notes: 'Isolate back' },
                                    { name: 'Inverted Rows', notes: 'Bodyweight variation' }
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Volume Work',
                        isSupersets: true,
                        supersets: [
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Incline DB Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Upper chest focus' },
                                        { name: 'Cable Rows', sets: 3, reps: '12-15', rest: '90s', notes: 'Mid-back' }
                                    ],
                                    [
                                        { name: 'Machine Chest Press', sets: 3, reps: '12-15', rest: '0s', notes: 'Constant tension' },
                                        { name: 'Lat Pulldown', sets: 3, reps: '12-15', rest: '90s', notes: 'Wide grip' }
                                    ],
                                    [
                                        { name: 'Decline Push-Ups', sets: 3, reps: '15-20', rest: '0s', notes: 'Feet elevated' },
                                        { name: 'Single-Arm Cable Row', sets: 3, reps: '12/arm', rest: '90s', notes: 'Anti-rotation' }
                                    ]
                                ]
                            },
                            {
                                isOptions: true,
                                options: [
                                    [
                                        { name: 'Lateral Raises', sets: 3, reps: '15-20', rest: '0s', notes: 'Light, controlled' },
                                        { name: 'Band Pull-Aparts', sets: 3, reps: '20', rest: '60s', notes: 'Rear delts' }
                                    ],
                                    [
                                        { name: 'Cable Upright Rows', sets: 3, reps: '12-15', rest: '0s', notes: 'Wide grip' },
                                        { name: 'Reverse Flyes', sets: 3, reps: '15-20', rest: '60s', notes: 'Rear delts' }
                                    ],
                                    [
                                        { name: 'Front Raises', sets: 3, reps: '12-15', rest: '0s', notes: 'Plate or DBs' },
                                        { name: 'Face Pulls', sets: 3, reps: '15-20', rest: '60s', notes: 'External rotation' }
                                    ]
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Core Circuit',
                        isCircuit: true,
                        exercises: [
                            { 
                                name: 'Ab Wheel Rollouts', 
                                sets: 3, 
                                reps: '10-12', 
                                rest: '0s', 
                                notes: 'Slow eccentric',
                                rotations: [
                                    { name: 'Ab Wheel Rollouts', notes: 'Slow eccentric' },
                                    { name: 'Dead Bugs', notes: 'Opposite arm/leg' },
                                    { name: 'Toes to Bar', notes: 'Explosive hip flexion' }
                                ]
                            },
                            { 
                                name: 'Pallof Press', 
                                sets: 3, 
                                reps: '12/side', 
                                rest: '0s', 
                                notes: 'Anti-rotation',
                                rotations: [
                                    { name: 'Pallof Press', notes: 'Anti-rotation' },
                                    { name: 'Landmine Rotations', notes: 'Explosive rotation' },
                                    { name: 'Cable Woodchops', notes: 'High to low rotation' }
                                ]
                            },
                            { 
                                name: 'Hanging Leg Raises', 
                                sets: 3, 
                                reps: '10-15', 
                                rest: '60s', 
                                notes: 'Control swing',
                                rotations: [
                                    { name: 'Hanging Leg Raises', notes: 'Control swing' },
                                    { name: 'Decline Sit-Ups', notes: 'Weighted for progression' },
                                    { name: 'Dragon Flags', notes: 'Advanced, full body tension' }
                                ]
                            }
                        ]
                    }
                ]
            },
            'Recovery': {
                title: 'Recovery',
                duration: '40-50 min',
                focus: 'Recovery cardio & mobility',
                sections: [
                    {
                        title: 'Zone 2 Cardio (30-40 min - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Incline Treadmill Walk', sets: 1, reps: '30-40 min', rest: '', notes: '15% incline, 3.0 mph' },
                            { name: 'Stationary Bike', sets: 1, reps: '30-40 min', rest: '', notes: 'Easy pace, conversational' },
                            { name: 'Easy Jog', sets: 1, reps: '30-40 min', rest: '', notes: 'Nose breathing only' },
                            { name: 'Elliptical', sets: 1, reps: '30-40 min', rest: '', notes: 'Low resistance, steady' },
                            { name: 'Rowing (Easy Pace)', sets: 1, reps: '30-40 min', rest: '', notes: 'Focus on form, not speed' },
                            { name: 'Swimming', sets: 1, reps: '30-40 min', rest: '', notes: 'Easy laps, any stroke' },
                            { name: 'Outdoor Walk', sets: 1, reps: '30-40 min', rest: '', notes: 'Hilly terrain preferred' },
                            { name: 'Stair Climber', sets: 1, reps: '30-40 min', rest: '', notes: 'Moderate pace, glute focus' }
                        ]
                    },
                    {
                        title: 'Mobility/Stretching (10 min - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Lower Body Flow', sets: 1, reps: '10 min', rest: '', notes: 'Hip circles, leg swings, 90/90, pigeon, deep squat hold' },
                            { name: 'Upper Body Flow', sets: 1, reps: '10 min', rest: '', notes: 'Shoulder dislocations, wall slides, thoracic rotations, cat-cow' },
                            { name: 'Full Body Yoga Flow', sets: 1, reps: '10 min', rest: '', notes: 'Sun salutations, downward dog, warrior poses, child pose' },
                            { name: 'Foam Rolling Session', sets: 1, reps: '10 min', rest: '', notes: 'Calves, quads, IT band, glutes, upper back' },
                            { name: 'Lower Body Stretching', sets: 1, reps: '10 min', rest: '', notes: 'Hip flexors, hamstrings, glutes, calves' },
                            { name: 'Upper Body Stretching', sets: 1, reps: '10 min', rest: '', notes: 'Shoulders, chest, lats, triceps' },
                            { name: 'Dynamic Mobility', sets: 1, reps: '10 min', rest: '', notes: 'Leg swings, arm circles, hip circles, world greatest stretch' }
                        ]
                    },
                    {
                        title: 'Core Stability (Optional - Pick One)',
                        isOptions: true,
                        exercises: [
                            { name: 'Plank Variations', sets: 3, reps: '30-60s', rest: '30s', notes: 'Standard, side, reach-through' },
                            { name: 'Bird Dogs', sets: 3, reps: '10/side', rest: '30s', notes: 'Slow, controlled, no rotation' },
                            { name: 'Dead Bugs', sets: 3, reps: '12/side', rest: '30s', notes: 'Lower back flat on ground' },
                            { name: 'Hanging Core', sets: 3, reps: '10-15', rest: '60s', notes: 'Hanging knee raises or leg raises' },
                            { name: 'Skip Core Today', sets: 0, reps: '', rest: '', notes: 'Just stretch and recover' }
                        ]
                    }
                ]
            },
            'HIIT': {
                title: 'HIIT',
                duration: '20-30 min',
                focus: 'High intensity conditioning',
                sections: [
                    {
                        title: 'HIIT Option',
                        isOptions: true,
                        exercises: [
                            { name: 'Circuit A - Bodyweight HIIT', sets: 5, reps: '40s work/20s rest', rest: '2min between rounds', notes: 'Burpees, Jump Squats, Push-Ups, Mountain Climbers, Kettlebell Swings' },
                            { name: 'Circuit B - Treadmill Sprints', sets: 10, reps: '20-30s sprint', rest: '60-90s walk', notes: '8-12 mph, 1-3% incline. 5 min warm-up, 5 min cool-down' }
                        ]
                    }
                ]
            }
        };

        // Exercise database - comprehensive definitions
        // Measurement types for exercises
        const MEASURE_TYPES = {
            REPS: 'reps',      // Count-based (10 reps, 8-12 reps)
            TIME: 'time',      // Duration-based (30s, 45s, 1min)
            DISTANCE: 'distance' // Distance-based (40m, 20 yds)
        };

        // Time-based exercises (holds, steady cardio, etc.)
        const TIME_BASED_EXERCISES = [
            // Planks and holds
            'Plank', 'Side Plank', 'Hollow Body Hold', 'Plank Variations', 'Plank Circuit',
            'RKC Plank', 'Long Lever Plank', 'Body Saw Plank', 'Copenhagen Plank', 'Reverse Plank',
            'Weighted Plank', 'Hanging L-Sit', 'Dead Bug Hold', 'Isometric Hold Circuit',
            'Hanging Core', 'Hanging Knee Raises', 'Hanging Leg Raises',
            // Cardio machines - steady state
            'Incline Treadmill Walk', 'Incline Treadmill Walk (40min)', 'Stationary Bike',
            'Stationary Bike (40min)', 'Easy Jog', 'Easy Jog (40min)', 'Elliptical',
            'Elliptical (40min)', 'Rowing (Easy Pace)', 'Rowing Machine (Easy)', 'Swimming', 'Swim',
            'Outdoor Walk', 'Stair Climber', 'Running', 'Hiking', 'Cycling Outdoors',
            'Light Walking', 'Treadmill Jog', 'Active Recovery', 'Spin Bike',
            'Treadmill', 'Elliptical Machine', 'Stair Stepper', 'Rowing Machine',
            'Recumbent Bike', 'Airdyne Bike', 'Echo Bike', 'Versa Climber', 'Jacob\'s Ladder',
            'Assault Bike', 'Assault Bike Sprint',
            // Mobility flows
            'Lower Body Flow', 'Upper Body Flow', 'Full Body Yoga Flow', 'Yoga Flow',
            'Dynamic Mobility', 'Morning Mobility', 'Pre-Workout Mobility', 'Post-Workout Mobility',
            'Hip Flow', 'Foam Rolling Session', 'Full Body Stretching', 'Lower Body Stretching',
            'Upper Body Stretching', 'Self-Massage', 'Breathing Work',
            // Intervals and circuits (time-based)
            'Cone Shuffles', 'Light DB Punch', 'Band Speed Punches', 'Shadow Boxing', 'Heavy Bag Work',
            'Boxing Rounds', 'Battle Ropes', 'Tabata', 'Jump Rope', 'Double Unders',
            'Circuit A - Bodyweight HIIT', 'Circuit B - Treadmill Sprints',
            'Anti-Extension Circuit', 'Rotational Core', 'Compression Circuit',
            'Anti-Rotation Circuit', 'Anti-Rotation Complex', 'Explosive Core',
            'HIIT Cycling', 'Bike Intervals', 'Ski Erg Intervals', 'Treadmill Intervals',
            'Assault Bike Intervals', 'Speed Bag', 'Rowing Sprint', 'Row Intervals',
            // Holds
            'Farmer Holds', 'Dead Hangs', 'Towel Hangs', 'Plate Pinch'
        ];

        // Distance-based exercises (carries, sprints, drills)
        const DISTANCE_BASED_EXERCISES = [
            'Farmer Carry', 'Farmer Carries', 'Suitcase Carry', 'Suitcase Carries',
            'Overhead Carry', 'Overhead Carries', 'Zercher Carries', 'Cross-Body Carry',
            'Bottoms-Up Carry', 'Waiter Walk', 'Loaded Carries', 'Heavy Carries + Plank',
            'A-Skips', 'B-Skips', 'Carioca Drill', 'Walking Lunges', 'Walking Lunges (Light)',
            'Sled Push', 'Sled Drag', 'Sled Work', 'Prowler Push', 'Prowler Sprint',
            'Reverse Sled Drag', 'Lateral Sled Drag', 'Bear Crawls', 'Toe Walks', 'Heel Walks',
            'Hill Sprints', 'Sprint Training', 'Treadmill Sprint', 'Treadmill Sprints'
        ];

        // Get the measure type for an exercise (checks custom overrides first)
        function getExerciseMeasureType(exerciseName) {
            // Check custom exercise overrides first
            if (customExercises[exerciseName] && customExercises[exerciseName].measureType) {
                return customExercises[exerciseName].measureType;
            }
            // Check if exercise has explicit measureType in EXERCISE_DB
            const exercise = EXERCISE_DB[exerciseName];
            if (exercise && exercise.measureType) {
                return exercise.measureType;
            }
            // Use predefined lists
            if (TIME_BASED_EXERCISES.includes(exerciseName)) {
                return 'time';
            }
            if (DISTANCE_BASED_EXERCISES.includes(exerciseName)) {
                return 'distance';
            }
            // Default to reps
            return 'reps';
        }

        // Save custom measure type override for an exercise
        function setExerciseMeasureType(exerciseName, measureType) {
            if (!customExercises[exerciseName]) {
                customExercises[exerciseName] = {};
            }
            customExercises[exerciseName].measureType = measureType;
            saveData();
        }

        // Get display name for an exercise (returns custom name if set, otherwise original)
        function getExerciseDisplayName(exerciseName) {
            if (customExercises[exerciseName] && customExercises[exerciseName].displayName) {
                return customExercises[exerciseName].displayName;
            }
            return exerciseName;
        }

        const EXERCISE_DB = {
            // === HIIT CIRCUITS ===
            'Circuit A - Bodyweight HIIT': {
                setup: '40sec work / 20sec rest x 5 rounds. Rest 2 min between rounds. Exercises: Burpees, Jump Squats, Push-Ups, Mountain Climbers, Kettlebell Swings.',
                execution: 'Perform each exercise for 40 seconds with maximum effort, rest 20 seconds, then move to next exercise. Complete all 5 exercises for 1 round. Rest 2 minutes between rounds. Focus on maintaining form even when fatigued.',
                measureType: 'time'
            },
            'Circuit B - Treadmill Sprints': {
                setup: 'WARM-UP: 5 min easy jog/walk on treadmill. SPRINT PROTOCOL: 10-12 rounds of sprints. COOL-DOWN: 5 min easy walk. Alternative: 8 x 500m row with 90 sec rest.',
                execution: 'Sprint 20-30 seconds at 8-12 mph with 1-3% incline. Recovery 60-90 seconds walking. Adjust speed based on your fitness level. Focus on maximum effort during sprints, full recovery between.',
                measureType: 'time'
            },

            // === EXTENSIVE PLYOS ===
            'Pogo Hops': {
                setup: 'Stand with feet hip-width apart. Arms relaxed at sides. Weight on balls of feet.',
                execution: 'Bounce continuously using ankle stiffness with minimal knee bend. Focus on quick ground contact and rhythm, not height. Keep core tight.',
                measureType: 'reps'
            },
            'Lateral Line Hops': {
                setup: 'Stand on one side of a line or crack. Feet together, knees soft.',
                execution: 'Hop side-to-side over the line quickly. Stay on balls of feet. Minimize ground contact time. Keep hips square.',
                measureType: 'reps'
            },
            'Single-Leg Hops': {
                setup: 'Stand on one leg. Other leg bent behind you. Arms ready for balance.',
                execution: 'Hop in place on one foot using ankle spring. Land softly, immediately rebound. Keep knee slightly bent throughout.',
                measureType: 'reps'
            },
            'Banded Lateral Hops': {
                setup: 'Place mini band around ankles. Athletic stance with tension on band.',
                execution: 'Explosively hop laterally against band resistance. Land softly and immediately hop back. Maintain band tension throughout.',
                measureType: 'reps'
            },
            'A-Skips': {
                setup: 'Stand tall, arms at 90 degrees. One leg ready to drive.',
                execution: 'Skip forward driving knee high (thigh parallel). Opposite arm drives up. Land on ball of foot. Alternate legs with rhythm.',
                measureType: 'distance'
            },
            'Lateral Skater Hops': {
                setup: 'Stand on one leg. Other leg behind, arms ready.',
                execution: 'Bound laterally, landing on opposite foot. Swing arms for momentum. Stick landing briefly before bounding back.',
                measureType: 'reps'
            },
            'Lateral Bounds': {
                setup: 'Athletic stance on one leg. Arms ready to drive.',
                execution: 'Push off explosively sideways. Cover max distance. Land softly on opposite foot. Stabilize, then bound back.',
                measureType: 'reps'
            },
            'Cone Shuffles': {
                setup: 'Set cones 5-10 feet apart. Athletic stance between them.',
                execution: 'Shuffle quickly side to side, touching each cone. Stay low in athletic position. Quick feet, don\'t cross legs.',
                measureType: 'time'
            },
            'Carioca Drill': {
                setup: 'Stand sideways to direction of travel. Arms out for balance.',
                execution: 'Move laterally: trail leg crosses in front, then behind (grapevine pattern). Rotate hips with each step. Stay on balls of feet.',
                measureType: 'distance'
            },
            'Diagonal Bounds': {
                setup: 'Stand on one leg at 45-degree angle to travel direction.',
                execution: 'Bound diagonally forward, landing on opposite leg. Cover distance and height. Alternate legs in zigzag pattern.',
                measureType: 'reps'
            },
            'Med Ball Chest Pass': {
                setup: 'Hold med ball at chest. Stand 6-8 feet from wall. Athletic stance.',
                execution: 'Explosively push ball from chest into wall. Catch rebound and immediately repeat. Generate power from chest and arms.',
                measureType: 'reps'
            },
            'Med Ball Overhead Throws': {
                setup: 'Hold med ball overhead. Face wall or open space. Feet shoulder-width.',
                execution: 'Throw ball overhead like a soccer throw-in. Use core and arms. Follow through completely. Catch and repeat.',
                measureType: 'reps'
            },
            'Light DB Punch': {
                setup: 'Stand in boxing stance. Light dumbbell (5-10 lbs) in each hand at chin.',
                execution: 'Throw fast punches alternating arms. Rotate torso with each punch. Keep core tight. Speed over power.',
                measureType: 'time'
            },
            'Med Ball Rotational Throws': {
                setup: 'Stand sideways to wall. Hold med ball at hip. Feet wider than shoulders.',
                execution: 'Rotate explosively, throwing ball into wall. Generate power from hips and core. Catch and repeat same side, then switch.',
                measureType: 'reps'
            },
            'Band Speed Punches': {
                setup: 'Anchor resistance band behind you. Hold handles at chest in boxing stance.',
                execution: 'Throw rapid alternating punches against band resistance. Full arm extension. Keep core engaged. Maximum speed.',
                measureType: 'time'
            },

            // === INTENSIVE PLYOS ===
            'Box Jumps': {
                setup: 'Face box 12-24" high. Feet hip-width. Arms back ready to swing.',
                execution: 'Swing arms forward and jump onto box explosively. Land softly with bent knees. Step down (don\'t jump). Focus on max height.',
                measureType: 'reps'
            },
            'Depth Jumps': {
                setup: 'Stand on 12-18" box. Step off (don\'t jump off) edge.',
                execution: 'Land with both feet, immediately jump max height. Minimize ground contact time. This is reactive strength training.',
                measureType: 'reps'
            },
            'Hurdle Hops': {
                setup: 'Set 3-5 hurdles 3-4 feet apart. Face first hurdle.',
                execution: 'Jump over each hurdle continuously. Land and immediately take off. Drive arms up. Focus on height and quick contacts.',
                measureType: 'reps'
            },
            'Banded Lateral Jumps': {
                setup: 'Heavy band around waist, anchored to side. Athletic stance.',
                execution: 'Jump laterally against band for max distance. Stick landing. Reset and repeat. Fight the band resistance.',
                measureType: 'reps'
            },
            'Single-Leg Box Jumps': {
                setup: 'Stand on one leg facing appropriate height box.',
                execution: 'Jump onto box using single leg takeoff. Land on both feet or same leg. Step down. Requires balance and power.',
                measureType: 'reps'
            },
            'Plyo Push-Ups': {
                setup: 'Push-up position. Hands slightly wider than shoulders.',
                execution: 'Lower into push-up, then explode up so hands leave ground. Land softly and immediately descend into next rep.',
                measureType: 'reps'
            },
            'Med Ball Slams': {
                setup: 'Hold heavy med ball overhead. Feet shoulder-width. Core tight.',
                execution: 'Slam ball into ground with full force. Use entire body - arms, core, hips. Catch bounce and repeat.',
                measureType: 'reps'
            },
            'Depth Push-Ups': {
                setup: 'Hands on low plates or blocks. Push-up position.',
                execution: 'Drop hands to floor between plates, immediately push up explosively back onto plates. Reactive upper body power.',
                measureType: 'reps'
            },
            'Med Ball Rotational Slams': {
                setup: 'Hold med ball overhead, standing with feet wide.',
                execution: 'Slam ball diagonally to outside of foot. Rotate entire torso. Generate power from hips. Alternate sides.',
                measureType: 'reps'
            },
            'Clapping Pull-Ups': {
                setup: 'Hang from pull-up bar. Overhand grip slightly wider than shoulders.',
                execution: 'Pull explosively, release bar at top, clap, re-grip. Land in controlled hang. Advanced movement - build up slowly.',
                measureType: 'reps'
            },
            'Broad Jumps': {
                setup: 'Athletic stance. Arms back. Knees bent.',
                execution: 'Swing arms and jump forward for maximum distance. Land softly with bent knees. Stick landing for 3 seconds.',
                measureType: 'reps'
            },
            'Single-Leg Broad Jump': {
                setup: 'Stand on one leg. Arms ready.',
                execution: 'Jump forward for distance off single leg. Land on both feet or same leg. Stick the landing. Control is key.',
                measureType: 'reps'
            },
            'Box Jump (Forward)': {
                setup: 'Face box at appropriate height. Athletic stance.',
                execution: 'Jump forward onto box. Land softly in athletic position. Step down. Focus on distance and height combination.',
                measureType: 'reps'
            },
            '180Â° Box Jumps': {
                setup: 'Stand sideways to box. Athletic position.',
                execution: 'Jump, rotate 180Â° mid-air, land facing opposite direction on box. Step down. Requires coordination and power.',
                measureType: 'reps'
            },
            'Banded Broad Jumps': {
                setup: 'Resistance band around waist, anchored behind. Athletic stance.',
                execution: 'Jump forward against band resistance for max distance. Stick landing. Walk back and repeat.',
                measureType: 'reps'
            },

            // === MAIN LIFTS - SQUATS ===
            'High Bar Back Squat': {
                setup: 'Bar on upper traps. Feet shoulder-width, toes slightly out. Chest up.',
                execution: 'Brace core hard. Descend by breaking at hips and knees together. Keep chest up, hit below parallel. Drive through whole foot.'
            },
            'Front Squat (Heavy)': {
                setup: 'Bar in front rack position on shoulders. Elbows high. Feet shoulder-width.',
                execution: 'Descend keeping torso very upright. Elbows stay high. Hit depth. Drive up through midfoot. More quad and core intensive.'
            },
            'Front Squat': {
                setup: 'Bar in front rack position on shoulders. Elbows high. Feet shoulder-width.',
                execution: 'Descend keeping torso very upright. Elbows stay high. Hit depth. Drive up through midfoot. More quad and core intensive.'
            },
            'Safety Bar Squat': {
                setup: 'Safety squat bar on traps with handles forward. Feet shoulder-width.',
                execution: 'Brace and descend. Bar wants to pitch you forward - fight to stay upright. Great for upper back and easier on shoulders.'
            },
            'Goblet Squat (Heavy)': {
                setup: 'Hold heavy dumbbell or kettlebell at chest. Elbows tight. Feet shoulder-width.',
                execution: 'Squat deep, keeping weight at chest. Elbows can touch inside of knees at bottom. Drive up. Great for core bracing practice.'
            },
            'Zercher Squat': {
                setup: 'Bar in crook of elbows, arms crossed. Feet shoulder-width or wider.',
                execution: 'Brace core extremely tight. Squat down keeping bar secure. Unique loading position challenges core differently.'
            },

            // === MAIN LIFTS - DEADLIFTS & HINGES ===
            'Trap Bar Deadlift': {
                setup: 'Stand in center of trap bar. Feet hip-width. Grab handles. Chest up.',
                execution: 'Brace core. Drive through feet. Hips and shoulders rise together. Stand tall and squeeze glutes at top.'
            },
            'Conventional Deadlift': {
                setup: 'Bar over mid-foot. Feet hip-width. Grip just outside legs. Chest up, back flat.',
                execution: 'Brace, push floor away. Bar stays close to legs. Hips and shoulders rise together. Lock out with glutes.'
            },
            'Sumo Deadlift': {
                setup: 'Wide stance, toes out. Grip inside legs. Chest up, hips close to bar.',
                execution: 'Push knees out, drive through floor. More quad involvement. Keep chest up. Hips come through at top.'
            },
            'Romanian Deadlift': {
                setup: 'Hold bar at hips. Feet hip-width. Slight knee bend.',
                execution: 'Push hips back, lowering bar along legs. Feel hamstring stretch. Keep back flat. Return by driving hips forward.'
            },
            'Snatch Grip RDL': {
                setup: 'Wide grip on bar (snatch width). Feet hip-width. Slight knee bend.',
                execution: 'Same as RDL but wide grip increases upper back demand. Feel stretch in hamstrings. Keep lats engaged.'
            },
            'Single-Leg RDL': {
                setup: 'Stand on one leg. Light weight in opposite hand or both hands.',
                execution: 'Hinge at hip, free leg extends behind for balance. Lower until hamstring stretch. Return to standing. Great for balance.'
            },
            'Good Mornings': {
                setup: 'Bar on upper back like squat. Feet hip-width. Slight knee bend.',
                execution: 'Hinge at hips, pushing them back. Lower torso until parallel. Keep back flat. Return by driving hips forward.'
            },

            // === MAIN LIFTS - LUNGES & SPLIT STANCE ===
            'Bulgarian Split Squats': {
                setup: 'Rear foot elevated on bench. Front foot 2-3 feet ahead. Dumbbells or barbell.',
                execution: 'Lower until rear knee nearly touches ground. Front knee tracks over toes. Drive through front foot to stand.'
            },
            'Skater Squats': {
                setup: 'Stand on one leg. Other leg behind, not touching ground.',
                execution: 'Squat down on single leg, reaching rear leg back for counterbalance. Touch rear knee to pad if needed. Stand back up.'
            },
            'Deficit Reverse Lunges': {
                setup: 'Stand on 2-4" platform. Dumbbells at sides or barbell.',
                execution: 'Step back into lunge, rear foot goes to floor below platform. Extra depth increases glute stretch. Drive up through front leg.'
            },
            'Walking Lunges': {
                setup: 'Stand with dumbbells at sides or barbell on back.',
                execution: 'Step forward into lunge, back knee nearly touches ground. Push through front foot to bring rear leg forward into next lunge.'
            },
            'Walking Lunges (Light)': {
                setup: 'Light or no weight. Hands at sides or on hips.',
                execution: 'Walk forward in continuous lunge pattern. Focus on form and stretch. Good for burnout sets and conditioning.'
            },
            'Reverse Lunges': {
                setup: 'Stand with weight. Feet hip-width.',
                execution: 'Step backward into lunge. Lower until rear knee nearly touches ground. Drive through front foot to return. More glute emphasis than forward.'
            },
            'Step-Ups (Heavy)': {
                setup: 'Face knee-height box. Hold heavy dumbbells or barbell.',
                execution: 'Step up driving through front leg only - don\'t push off back foot. Stand tall on box. Step down with control.'
            },

            // === MAIN LIFTS - PRESSING ===
            'Barbell Bench Press': {
                setup: 'Lie on bench. Eyes under bar. Feet flat. Slight back arch. Grip slightly wider than shoulders.',
                execution: 'Unrack and lower to mid-chest with control. Elbows at 45Â°. Touch chest. Press up in slight arc to lockout.'
            },
            'Close Grip Bench': {
                setup: 'Same as bench press but hands shoulder-width apart.',
                execution: 'Lower bar to lower chest/sternum. Elbows stay closer to body. More tricep emphasis. Full lockout.'
            },
            'Pause Bench Press': {
                setup: 'Same as regular bench press setup.',
                execution: 'Lower bar to chest, pause 2-3 seconds with bar touching (no bounce). Press up explosively. Builds strength off chest.'
            },
            'Overhead Press': {
                setup: 'Bar at shoulders, grip just outside shoulder-width. Feet hip-width. Squeeze glutes.',
                execution: 'Press bar straight up, moving head back then forward as bar passes. Lock out overhead. Lower with control.'
            },
            'Landmine Press': {
                setup: 'Hold end of barbell at shoulder. Other end in landmine or corner. Staggered stance.',
                execution: 'Press bar up and forward in arc. Shoulder-friendly angle. Full extension. Lower with control.'
            },
            'DB Overhead Press': {
                setup: 'Dumbbells at shoulders, palms forward or neutral. Seated or standing.',
                execution: 'Press both dumbbells overhead. Greater range of motion than barbell. Control the descent.'
            },
            'Incline DB Press': {
                setup: 'Bench at 30-45Â°. Dumbbells at chest level. Feet flat.',
                execution: 'Press dumbbells up, bringing them slightly together at top. Lower with control to chest stretch. Upper chest focus.'
            },
            'Push Press': {
                setup: 'Bar at shoulders like overhead press. Feet hip-width.',
                execution: 'Dip slightly at knees, then explosively drive bar overhead using leg power. Lock out. Lower to shoulders.'
            },
            'Jerk Press': {
                setup: 'Bar at shoulders. Feet hip-width.',
                execution: 'Dip and drive bar up, then quickly drop under bar into split or squat. Catch with locked arms. Stand up.'
            },
            'Viking Press (Landmine)': {
                setup: 'Landmine attachment with handles. Stand facing handles at shoulder height.',
                execution: 'Press handles overhead using leg drive if desired. Neutral grip is shoulder-friendly. Full extension.'
            },
            'Weighted Dips': {
                setup: 'On dip bars, weight belt with plates or dumbbell between legs.',
                execution: 'Lower with slight forward lean (chest emphasis) or upright (tricep emphasis). Go until upper arms parallel. Press up to lockout.'
            },
            'Ring Dips': {
                setup: 'Support yourself on gymnastic rings. Arms locked.',
                execution: 'Lower with control - rings want to move out. Requires more stabilization. Press up, turning rings out at top.'
            },
            'Decline Bench': {
                setup: 'On decline bench, feet secured. Bar at lower chest level.',
                execution: 'Lower bar to lower chest. Press up. Emphasizes lower chest. Generally can lift more than flat bench.'
            },
            'Machine Chest Press': {
                setup: 'Adjust seat so handles are at mid-chest. Feet flat.',
                execution: 'Press handles forward to full extension. Control the return. Constant tension throughout range.'
            },
            'Push-Ups': {
                setup: 'Hands slightly wider than shoulders. Body in straight line from head to heels.',
                execution: 'Lower chest to floor, elbows at 45Â°. Push back up to full extension. Keep core tight throughout.'
            },
            'Decline Push-Ups': {
                setup: 'Feet elevated on bench or box. Hands on floor slightly wider than shoulders.',
                execution: 'Lower chest toward floor. Push back up. Elevation increases difficulty and upper chest emphasis.'
            },

            // === MAIN LIFTS - PULLING ===
            'Pull-Ups': {
                setup: 'Hang from bar, overhand grip slightly wider than shoulders. Dead hang to start.',
                execution: 'Pull up until chin clears bar. Lead with chest. Lower with control to dead hang. Add weight when possible.'
            },
            'Chin-Ups': {
                setup: 'Hang from bar, underhand (supinated) grip shoulder-width.',
                execution: 'Pull up until chin over bar. More bicep involvement than pull-ups. Lower with control.'
            },
            'Wide Grip Pull-Ups': {
                setup: 'Hang from bar, grip 1.5x shoulder width. Overhand.',
                execution: 'Pull up leading with chest. Emphasizes lat width. Lower with control. Harder than standard pull-ups.'
            },
            'Barbell Rows': {
                setup: 'Hinge forward 45Â°, bar hanging at arm\'s length. Feet hip-width. Overhand or mixed grip.',
                execution: 'Pull bar to lower sternum, squeezing shoulder blades. Lower with control. Keep back flat throughout.'
            },
            'Pendlay Rows': {
                setup: 'Bar on floor. Hinged over with flat back parallel to ground.',
                execution: 'Explosively row bar to chest. Lower to floor, reset, repeat. Each rep starts from dead stop. More explosive.'
            },
            'Meadows Row': {
                setup: 'Landmine setup. Staggered stance perpendicular to bar. Grip end of bar.',
                execution: 'Row bar to hip with elbow flaring out. Great lat stretch at bottom. Squeeze at top. Unique angle.'
            },
            'Single-Arm DB Row': {
                setup: 'One hand and knee on bench. Other foot on floor. Dumbbell hanging.',
                execution: 'Row dumbbell to hip, elbow close to body. Anti-rotation component. Lower with control. Full stretch at bottom.'
            },
            'Chest-Supported Row': {
                setup: 'Lie face down on incline bench. Dumbbells or bar hanging.',
                execution: 'Row weight to chest, squeezing shoulder blades. Removes lower back from equation. Pure back work.'
            },
            'Chest-Supported Rows': {
                setup: 'Lie face down on incline bench. Dumbbells or bar hanging.',
                execution: 'Row weight to chest, squeezing shoulder blades. Removes lower back from equation. Pure back work.'
            },
            'T-Bar Row': {
                setup: 'Straddle T-bar or landmine. Grip handle. Hinged forward.',
                execution: 'Row handle to chest, squeezing back. Allow slight upper body rise. Lower with control. Heavy loading possible.'
            },
            'Seal Rows': {
                setup: 'Lie face down on elevated bench. Arms hang straight down with dumbbells or bar.',
                execution: 'Row weight up squeezing shoulder blades. Complete isolation - no momentum possible. Full stretch at bottom.'
            },
            'Inverted Rows': {
                setup: 'Set bar at hip height. Hang underneath, heels on ground, body straight.',
                execution: 'Pull chest to bar squeezing shoulder blades. Lower with control. Adjust difficulty by changing body angle.'
            },
            'Cable Rows': {
                setup: 'Sit at cable row station. Feet on platform. Grab handle.',
                execution: 'Pull handle to lower chest, squeezing shoulder blades. Let shoulders protract forward on return. Constant tension.'
            },
            'Single-Arm Cable Row': {
                setup: 'Stand or half-kneel at cable machine. Single handle.',
                execution: 'Row handle to side, resisting rotation. Anti-rotation core work plus back. Alternate sides.'
            },
            'Lat Pulldown': {
                setup: 'Sit at pulldown machine. Grip bar wide. Thighs under pad.',
                execution: 'Pull bar to upper chest, leading with elbows. Squeeze lats. Control return. Don\'t lean back excessively.'
            },
            'Face Pulls': {
                setup: 'Cable at face height. Rope attachment. Grip with thumbs toward you.',
                execution: 'Pull rope to face, separating hands and externally rotating shoulders. Squeeze rear delts. Essential for shoulder health.'
            },
            'Rear Delt Flyes': {
                setup: 'Bent over or on incline bench face down. Light dumbbells hanging.',
                execution: 'Raise arms out to sides, leading with elbows. Squeeze shoulder blades. Light weight, high reps.'
            },
            'Band Pull-Aparts': {
                setup: 'Hold band in front at shoulder height. Arms straight, shoulder-width grip.',
                execution: 'Pull band apart by squeezing shoulder blades together. Arms go out to sides. Control return. High rep shoulder health.'
            },
            'Reverse Flyes': {
                setup: 'Bent over or on incline bench face down. Light dumbbells.',
                execution: 'Raise arms to sides targeting rear delts. Keep slight elbow bend. Squeeze at top. Control descent.'
            },

            // === ACCESSORIES - LEGS ===
            'Leg Extensions': {
                setup: 'Sit in leg extension machine. Pad on shins. Adjust back pad.',
                execution: 'Extend legs fully, squeezing quads hard at top. Lower with control. Isolation quad exercise.'
            },
            'Leg Curls': {
                setup: 'Lie face down on leg curl machine. Pad behind ankles.',
                execution: 'Curl heels toward glutes. Squeeze hamstrings. Lower with control. Don\'t let hips rise.'
            },
            'Leg Press': {
                setup: 'Sit in leg press. Feet shoulder-width on platform. Release safeties.',
                execution: 'Lower platform with control until deep stretch. Press through whole foot. Don\'t lock knees at top.'
            },
            'Glute-Ham Raises': {
                setup: 'On GHD machine. Knees on pad. Feet anchored.',
                execution: 'Lower torso by straightening at knees. Use hamstrings to curl back up. Brutal hamstring exercise. Use assist if needed.'
            },
            'Standing Calf Raises': {
                setup: 'Stand on calf raise machine or block. Balls of feet on edge.',
                execution: 'Rise up on toes as high as possible. Full squeeze at top. Lower until heels below platform level for stretch.'
            },
            'Seated Calf Raises': {
                setup: 'Sit in seated calf machine. Knees under pad. Balls of feet on platform.',
                execution: 'Raise heels as high as possible. Hold squeeze. Lower for full stretch. Targets soleus muscle.'
            },
            'Calf Press on Leg Press': {
                setup: 'On leg press with just balls of feet on platform edge.',
                execution: 'Press through toes, extending ankles. Full range of motion. Can use heavy weight.'
            },
            'Single-Leg Calf Raise': {
                setup: 'Stand on one foot on block or step. Hold something for balance.',
                execution: 'Rise up on toes, full squeeze. Lower below platform level. Do all reps on one leg before switching.'
            },
            'Tibialis Raises': {
                setup: 'Sit on edge of bench. Heels on ground, toes up. Or use tib bar.',
                execution: 'Raise toes toward shins. Builds tibialis anterior. Important for shin health and ankle stability.'
            },

            // === ACCESSORIES - ARMS ===
            'Hammer Curls': {
                setup: 'Stand with dumbbells at sides, palms facing body.',
                execution: 'Curl weights up keeping neutral grip. Squeeze brachialis. Lower with control. Builds forearm too.'
            },
            'Overhead Tricep Extension': {
                setup: 'Hold dumbbell overhead with both hands or cable behind head.',
                execution: 'Lower weight behind head by bending elbows. Feel tricep stretch. Press back up to lockout.'
            },
            'Barbell Curls': {
                setup: 'Stand holding barbell with underhand grip. Arms at sides.',
                execution: 'Curl bar up keeping elbows pinned. Squeeze biceps at top. Lower with control. Strict form.'
            },
            'Skull Crushers': {
                setup: 'Lie on bench. Hold bar or EZ bar with arms straight over chest.',
                execution: 'Lower weight toward forehead by bending elbows only. Extend back up. Keep upper arms still.'
            },
            'Cable Curls': {
                setup: 'Face cable machine. Handle at low position. Grab with underhand grip.',
                execution: 'Curl handle up squeezing biceps. Constant cable tension throughout. Lower with control.'
            },
            'Rope Pushdowns': {
                setup: 'Face cable machine. Rope at high position. Grab rope ends.',
                execution: 'Push down extending elbows fully. Spread rope at bottom for extra contraction. Control return.'
            },

            // === ACCESSORIES - SHOULDERS ===
            'Lateral Raises': {
                setup: 'Stand with light dumbbells at sides. Slight bend in elbows.',
                execution: 'Raise arms out to sides until parallel to ground. Lead with elbows. Control descent. Don\'t swing.'
            },
            'Cable Upright Rows': {
                setup: 'Face cable machine. Bar at low position. Grip shoulder-width or wider.',
                execution: 'Pull bar up along body to chest height. Elbows go high and out. Squeeze at top. Lower with control.'
            },
            'Front Raises': {
                setup: 'Stand with dumbbells in front of thighs or plate.',
                execution: 'Raise weight forward to shoulder height. Keep slight elbow bend. Lower with control. Alternate or together.'
            },
            'Cable Flyes': {
                setup: 'Stand between cable machines set at shoulder height. Handle in each hand.',
                execution: 'Bring handles together in front of chest in hugging motion. Squeeze chest. Return with control.'
            },

            // === CORE EXERCISES ===
            'Anti-Extension Circuit': {
                setup: 'Prepare for planks, side planks, and dead bugs.',
                execution: 'Plank 45s (brace core, flat back) â†’ Side plank 30s each side â†’ Dead bugs 12/side (opposite arm/leg extend). No rest between.'
            },
            'Loaded Carries': {
                setup: 'Pick up heavy dumbbells or kettlebells.',
                execution: 'Walk 40m with perfect posture. Includes farmer carry (both hands), overhead carry, suitcase carry (one hand). Crushing core work.'
            },
            'Rotational Core': {
                setup: 'Mat or bench for exercises.',
                execution: 'Russian twists, bicycle crunches, and oblique crunches. 10 reps per side each exercise. Control the rotation.'
            },
            'Compression Circuit': {
                setup: 'Mat for floor exercises.',
                execution: 'Leg raises 10-15, V-ups 10-15, hollow holds 20s. Targets hip flexors and rectus abdominis.'
            },
            'Ab Wheel Rollouts': {
                setup: 'Kneel on mat. Grip ab wheel with both hands.',
                execution: 'Roll wheel forward, extending body. Go as far as you can control. Use abs to pull back. Don\'t let hips sag.'
            },
            'Dead Bugs': {
                setup: 'Lie on back. Arms straight up, knees at 90Â°.',
                execution: 'Lower opposite arm and leg toward floor while keeping lower back pressed down. Alternate sides with control.'
            },
            'Toes to Bar': {
                setup: 'Hang from pull-up bar. Arms straight.',
                execution: 'Raise legs up to touch bar using core. Control the descent. Requires flexibility and strength.'
            },
            'Pallof Press': {
                setup: 'Cable at chest height. Hold handle at sternum. Stand sideways.',
                execution: 'Press handle straight out, resisting rotation. Hold at extension. Return to chest. Anti-rotation core.'
            },
            'Landmine Rotations': {
                setup: 'Hold end of landmine barbell at chest with straight arms.',
                execution: 'Rotate torso, moving bar in arc from hip to hip. Control the movement. Works obliques dynamically.'
            },
            'Cable Woodchops': {
                setup: 'Cable set high or low. Stand sideways to machine.',
                execution: 'Pull cable diagonally across body (high to low or low to high). Rotate through core. Control return.'
            },
            'Hanging Leg Raises': {
                setup: 'Hang from pull-up bar or captain\'s chair. Arms straight.',
                execution: 'Raise legs until parallel to ground or higher. Control descent - no swinging. Bend knees to make easier.'
            },
            'Decline Sit-Ups': {
                setup: 'Lie on decline bench, feet hooked under pads.',
                execution: 'Sit up fully, can add weight across chest. Lower with control. Decline increases difficulty.'
            },
            'Dragon Flags': {
                setup: 'Lie on bench, grip behind head. Legs straight up.',
                execution: 'Lower entire body as one straight unit. Only shoulders touch bench. Raise back up. Advanced movement.'
            },
            'Plank Variations': {
                setup: 'Standard plank position on elbows.',
                execution: 'Hold front plank, then side planks each direction. Keep body straight. Brace core tight. 30-60s each.'
            },
            'Bird Dogs': {
                setup: 'On hands and knees. Back flat.',
                execution: 'Extend opposite arm and leg straight out. Hold briefly. Return and switch. No rotation in hips or shoulders.'
            },
            'Farmer Carries': {
                setup: 'Stand holding heavy dumbbells or kettlebells at sides.',
                execution: 'Walk with tall posture, shoulders back, core braced. Don\'t let weight pull you to sides.'
            },
            'Suitcase Carries': {
                setup: 'Heavy dumbbell or kettlebell in one hand only.',
                execution: 'Walk without leaning toward or away from weight. Anti-lateral flexion core work. Switch sides.'
            },
            'Overhead Carries': {
                setup: 'Single kettlebell or dumbbell pressed overhead.',
                execution: 'Walk with arm locked out, bicep by ear. Core braced to prevent rib flare. Challenges shoulder stability.'
            },
            'Zercher Carries': {
                setup: 'Barbell in crook of elbows, arms crossed.',
                execution: 'Walk maintaining upright posture. Brutal on core and biceps. Unique carry variation.'
            },
            'Turkish Get-Up': {
                setup: 'Lie on back. Kettlebell pressed up with one arm.',
                execution: 'Stand up through specific sequence while keeping weight overhead. Reverse to return. Full body stability exercise.'
            },
            'Heavy Carries + Plank': {
                setup: 'Heavy dumbbells and mat ready.',
                execution: 'Farmer carry 20m, immediately into weighted plank 30s. Combines dynamic and static core work.'
            },
            'Anti-Rotation Complex': {
                setup: 'Cable machine and mat.',
                execution: 'Pallof press, bird dogs, side plank - 10/side each. All anti-rotation exercises. No rest between.'
            },
            'Explosive Core': {
                setup: 'Med ball and mat.',
                execution: 'Med ball slams 10, mountain climbers 20, v-ups 15. Ballistic core training. Keep rest minimal.'
            },
            'Isometric Hold Circuit': {
                setup: 'Mat for floor work.',
                execution: 'Hollow hold 20s, plank 30s, dead bug hold 20s/side. Static core strength. Breathe through holds.'
            },
            'Plank Circuit': {
                setup: 'Mat for planks.',
                execution: 'Front plank, left side plank, right side plank. 45s each. Keep body straight, core braced.'
            },
            'Anti-Rotation Circuit': {
                setup: 'Cable and mat.',
                execution: 'Pallof press 10/side, bird dogs 10/side, dead bugs 10/side. Anti-rotation focus throughout.'
            },
            'Hanging Core': {
                setup: 'Hang from pull-up bar.',
                execution: 'Hanging knee raises or straight leg raises for 10-15 reps. Control swing. Hits lower abs.'
            },

            // === OLYMPIC LIFTS & POWER ===
            'Power Clean': {
                setup: 'Bar on floor. Feet hip-width. Grip just outside knees. Flat back, chest up.',
                execution: 'Pull bar from floor explosively. When bar reaches hips, jump and shrug. Drop under bar, catching in front rack. Stand up.'
            },
            'Hang Clean': {
                setup: 'Bar at hip height. Slight knee bend. Grip just outside knees.',
                execution: 'Dip slightly at knees, then explosively extend hips and pull. Drop under bar to catch in front rack. Stand.'
            },
            'Clean Pull': {
                setup: 'Bar on floor. Clean grip. Flat back.',
                execution: 'Pull bar like a deadlift, then explosively jump and shrug at top. Don\'t pull with arms. Builds power for cleans.'
            },
            'Kettlebell Swings (Heavy)': {
                setup: 'Straddle heavy kettlebell. Hinge and grip handle. Flat back.',
                execution: 'Hike bell back, then snap hips to drive bell to chest height. Arms are just hooks. All hip power.'
            },
            'Snatch Grip High Pull': {
                setup: 'Wide grip on bar. Feet hip-width. Flat back.',
                execution: 'Pull from floor explosively. At hip contact, shrug and pull elbows high. Bar reaches chest height. Builds snatch power.'
            },

            // === CARDIO & CONDITIONING ===
            'Incline Treadmill Walk': {
                setup: 'Set treadmill to 15% incline. Speed 3.0-3.5 mph.',
                execution: 'Walk maintaining Zone 2 heart rate. Should be able to hold conversation. Pumps blood to legs for recovery.'
            },
            'Incline Treadmill Walk (40min)': {
                setup: 'Set treadmill to 15% incline. Speed 3.0-3.5 mph.',
                execution: 'Walk maintaining Zone 2 heart rate for 40 minutes. Conversational pace. ~275-325 calories burned.'
            },
            'Stationary Bike': {
                setup: 'Adjust seat height. Light resistance.',
                execution: 'Pedal at easy, conversational pace. Zone 2 cardio. Focus on recovery, not intensity.'
            },
            'Stationary Bike (40min)': {
                setup: 'Adjust seat height. Light resistance.',
                execution: 'Pedal at easy, conversational pace for 40 minutes. ~250-300 calories. Active recovery.'
            },
            'Easy Jog': {
                setup: 'Flat terrain. Comfortable shoes.',
                execution: 'Jog at pace where you can nose-breathe only. If you need to mouth-breathe, slow down. Zone 2.'
            },
            'Easy Jog (40min)': {
                setup: 'Flat terrain. Comfortable shoes.',
                execution: 'Jog at conversational pace for 40 minutes. ~300-350 calories. Keep heart rate in Zone 2.'
            },
            'Elliptical': {
                setup: 'Set low resistance. Grip handles lightly.',
                execution: 'Move at steady, sustainable pace. Zone 2 effort. Good low-impact option.'
            },
            'Elliptical (40min)': {
                setup: 'Set low resistance.',
                execution: 'Steady pace for 40 minutes. Low impact cardio. Keep it conversational.'
            },
            'Rowing (Easy Pace)': {
                setup: 'Strap feet in. Grip handle lightly.',
                execution: 'Row with focus on technique, not speed. Drive with legs first, then back, then arms. Zone 2.'
            },
            'Rowing Machine (Easy)': {
                setup: 'Strap feet in. Light grip on handle.',
                execution: 'Steady sustainable pace for duration. Focus on form: legs-back-arms, arms-back-legs. Zone 2 effort.'
            },
            'Swimming': {
                setup: 'Pool with lanes. Any stroke you\'re comfortable with.',
                execution: 'Easy laps at conversational effort. Great full-body recovery cardio. Mix strokes if desired.'
            },
            'Swim': {
                setup: 'Pool with lanes. Any comfortable stroke.',
                execution: 'Easy laps at sustainable pace. Low impact, full body cardio. Great for recovery days.'
            },
            'Outdoor Walk': {
                setup: 'Find route with hills if possible.',
                execution: 'Walk at brisk pace for duration. Hills add intensity without running. Zone 2 effort.'
            },
            'Stair Climber': {
                setup: 'Set moderate pace on stair machine.',
                execution: 'Climb stairs at sustainable pace. Glute emphasis. Don\'t lean heavily on rails.'
            },
            'Bodyweight Circuit': {
                setup: 'Clear space. Set timer for 40s work, 20s rest.',
                execution: 'Cycle through: burpees, jump squats, push-ups, mountain climbers, KB swings. 5 rounds. Maximum effort.'
            },
            'Treadmill Sprints': {
                setup: 'Set treadmill to 8-12 mph, 1-3% incline.',
                execution: 'Sprint 20-30 seconds, then rest 60-90 seconds (stand on rails). Repeat 10 times. All-out effort.'
            },
            'Sled Work': {
                setup: 'Load sled with heavy weight. Clear 40m lane.',
                execution: 'Push sled length of lane. Low, driving steps. Walk back during rest. Brutal conditioning.'
            },
            'Assault Bike': {
                setup: 'Seat height so slight knee bend at bottom.',
                execution: '30 seconds max effort (arms AND legs), 30 seconds easy. Repeat 10 rounds. The bike humbles everyone.'
            },

            // === MOBILITY & RECOVERY ===
            'Lower Body Flow': {
                setup: 'Mat or soft surface. No equipment needed.',
                execution: 'Continuous flow: hip circles, leg swings, 90/90 stretch, pigeon pose, deep squat hold. 10 minutes of movement.'
            },
            'Upper Body Flow': {
                setup: 'Mat and optional band or stick.',
                execution: 'Flow through: shoulder dislocations, wall slides, thoracic rotations, cat-cow. Open up upper body.'
            },
            'Full Body Yoga Flow': {
                setup: 'Yoga mat. Quiet space.',
                execution: 'Sun salutations, downward dog, warrior poses, child\'s pose. Follow breath. 10 minutes of gentle movement.'
            },
            'Foam Rolling Session': {
                setup: 'Foam roller. Mat optional.',
                execution: 'Roll calves, quads, IT band, glutes, upper back. 1-2 minutes per area. Pause on tender spots.'
            },
            'Lower Body Stretching': {
                setup: 'Mat for floor stretches.',
                execution: 'Static stretches for hip flexors, hamstrings, glutes, calves. Hold each 30-60 seconds. Breathe into stretch.'
            },
            'Upper Body Stretching': {
                setup: 'Doorway or wall helpful.',
                execution: 'Static stretches for shoulders, chest, lats, triceps. Hold each 30-60 seconds. Don\'t force it.'
            },
            'Yoga Flow': {
                setup: 'Mat. Comfortable clothes.',
                execution: 'Sun salutations and gentle holds. Follow breath. Focus on mobility, not intensity.'
            },
            'Dynamic Mobility': {
                setup: 'Open space. No equipment.',
                execution: 'Leg swings, arm circles, hip circles, world\'s greatest stretch. Movement-based warmup or cooldown.'
            },

            // === SPORT & RECREATION ===
            'Pickup Soccer': {
                setup: 'Field or gym. Ball. Other players.',
                execution: 'Small-sided games. Focus on fun and movement. Great conditioning that doesn\'t feel like work.'
            },
            'Tennis': {
                setup: 'Court, racket, balls, opponent.',
                execution: 'Singles or doubles. Great lateral movement, hand-eye coordination, and cardio.'
            },
            'MMA Training': {
                setup: 'Heavy bag, gloves, open space.',
                execution: 'Bag work, shadowboxing, basic combinations. Great for conditioning and stress relief.'
            },
            'Basketball': {
                setup: 'Court. Ball. Other players helpful.',
                execution: 'Pickup games or shooting around. Sprinting, jumping, lateral movement. Fun conditioning.'
            },
            'Skip Core Today': {
                setup: 'No setup needed.',
                execution: 'Full recovery option. Just do your cardio and stretching. Sometimes rest is the best choice.'
            },
            'Skip Core': {
                setup: 'No setup needed.',
                execution: 'Rest option for core. Focus on main workout recovery. Listen to your body.'
            },

            // === CORE EXERCISES (Individual) ===
            'Plank': {
                setup: 'Forearms on ground, elbows under shoulders. Body in straight line from head to heels.',
                execution: 'Hold position, bracing core tight. Don\'t let hips sag or pike up. Breathe steadily. 45-60 seconds.'
            },
            'Side Plank': {
                setup: 'Lie on side, forearm on ground, elbow under shoulder. Stack feet or stagger.',
                execution: 'Lift hips to create straight line. Hold without letting hips drop. 30 seconds each side.'
            },
            'Hollow Body Hold': {
                setup: 'Lie on back. Arms overhead, legs straight out.',
                execution: 'Press lower back into floor. Lift shoulders and legs off ground. Hold banana shape. 30-45 seconds.'
            },
            'Farmer Carry': {
                setup: 'Stand holding heavy dumbbells or kettlebells at sides.',
                execution: 'Walk with tall posture, shoulders back, core braced. Don\'t let weights swing. 40m.'
            },
            'Russian Twists': {
                setup: 'Sit with knees bent, feet off ground or anchored. Hold weight at chest.',
                execution: 'Rotate torso side to side, touching weight to ground each side. Control the rotation. 15 per side.'
            },
            'Bicycle Crunches': {
                setup: 'Lie on back, hands behind head. Legs off ground.',
                execution: 'Bring opposite elbow to knee while extending other leg. Alternate sides with control. 15 per side.'
            },
            'Suitcase Carry': {
                setup: 'Heavy dumbbell or kettlebell in one hand only at side.',
                execution: 'Walk without leaning toward or away from weight. Fight the lateral pull. 40m each side.'
            },
            'Leg Raises': {
                setup: 'Lie on back, hands under lower back or at sides. Legs straight.',
                execution: 'Raise legs to vertical, keeping them straight. Lower slowly without arching back. 10-15 reps.'
            },
            'V-Ups': {
                setup: 'Lie flat on back. Arms overhead, legs straight.',
                execution: 'Simultaneously raise arms and legs to touch toes at top. Lower with control. 10-15 reps.'
            },
            'Oblique Crunches': {
                setup: 'Lie on side, knees slightly bent. Bottom arm extended, top hand behind head.',
                execution: 'Crunch up, bringing elbow toward hip. Squeeze obliques at top. 12 per side.'
            },
            'Overhead Carry': {
                setup: 'Press dumbbell or kettlebell overhead. Lock arm, bicep by ear.',
                execution: 'Walk while keeping weight stable overhead. Core braced, no rib flare. 40m each arm.'
            },

            // === HIIT EXERCISES ===
            'Burpees': {
                setup: 'Stand with feet shoulder-width apart.',
                execution: 'Squat down, hands to floor. Jump feet back to plank. Optional push-up. Jump feet to hands. Jump up with arms overhead. Repeat.'
            },
            'Treadmill Sprint': {
                setup: 'Set treadmill to 8-12 mph, 1-3% incline. Stand on rails.',
                execution: 'Step onto belt and sprint for 20-30 seconds. Step back to rails for rest. Maximum effort.'
            },
            'Assault Bike Sprint': {
                setup: 'Adjust seat height. Feet on pedals, hands on handles.',
                execution: 'Go all-out for 30 seconds - push AND pull with arms. Legs driving hard. Watch calories climb.'
            },
            'Sled Push': {
                setup: 'Load sled heavy. Hands on high or low handles. Feet behind sled.',
                execution: 'Drive forward with low, powerful steps. Push for 30-40m. Keep chest up, core braced.'
            },
            'Sled Drag': {
                setup: 'Attach straps to sled. Face away from sled, hold straps at hips or over shoulders.',
                execution: 'Walk backward dragging sled. Stay low, take short powerful steps. Keep tension on straps throughout.'
            },
            'Prowler Push': {
                setup: 'Load prowler. Grip low handles. Body at 45-degree angle to ground.',
                execution: 'Drive forward with explosive leg drive. Keep arms locked, core tight. Sprint for distance.'
            },
            'Rowing Sprint': {
                setup: 'Sit on rower. Feet strapped in. Grip handle with arms extended.',
                execution: 'Drive hard with legs, lean back slightly, pull handle to chest. Max effort strokes. Focus on power per stroke.'
            },
            'Row Intervals': {
                setup: 'Sit on rower. Set monitor to 500m intervals. Feet strapped, arms extended.',
                execution: 'Row 500m at max sustainable pace. Rest between intervals. Focus on consistent split times across all sets.'
            },
            'Assault Bike Intervals': {
                setup: 'Sit on assault bike. Set timer for work/rest intervals.',
                execution: 'Go all-out for work period, then easy spin or complete rest. Tabata style - max effort each interval.'
            },
            'Jump Squats': {
                setup: 'Stand with feet shoulder-width. Arms ready.',
                execution: 'Squat down, then explode upward into jump. Land softly with bent knees. Immediately descend into next rep.'
            },
            'Mountain Climbers': {
                setup: 'Start in push-up position. Core tight, body straight.',
                execution: 'Drive knees toward chest alternating legs rapidly. Keep hips down. Go fast while maintaining form.'
            },
            'Battle Ropes': {
                setup: 'Hold rope ends. Athletic stance facing anchor point.',
                execution: 'Create alternating waves by raising and lowering arms rapidly. Keep core tight. Full range of motion.'
            },
            'Push-Up Variations': {
                setup: 'Push-up position. Hands slightly wider than shoulders.',
                execution: 'Standard push-ups, or make explosive by pushing hands off ground. Maintain straight body throughout.'
            },
            'KB Swings': {
                setup: 'Stand with feet wider than shoulders. Kettlebell on ground in front.',
                execution: 'Hike KB back, then drive hips forward explosively to swing KB to shoulder height. Control the descent.'
            },
            'High Knees': {
                setup: 'Stand tall. Arms ready at sides.',
                execution: 'Run in place, driving knees as high as possible. Pump arms. Fast tempo, stay on balls of feet.'
            },
            'Jumping Lunges': {
                setup: 'Start in lunge position. Arms ready.',
                execution: 'Jump and switch legs in mid-air. Land softly in opposite lunge. Alternate continuously.'
            },
            'Ski Erg Sprint': {
                setup: 'Stand facing ski erg. Grip handles overhead.',
                execution: 'Pull handles down explosively while hinging at hips. Drive with lats and core. Maximum effort pulls.'
            },
            'Sprawls': {
                setup: 'Stand with feet shoulder-width apart.',
                execution: 'Drop to ground, kicking legs back (like burpee without push-up). Jump feet back in and stand. Fast tempo.'
            },

            // === NEW UPPER PUSH EXERCISES ===
            'Incline Barbell Press': {
                setup: 'Bench at 30-45 degrees. Grip slightly wider than shoulders. Feet flat.',
                execution: 'Lower bar to upper chest with control. Press up and slightly back. Targets upper chest.'
            },
            'Floor Press': {
                setup: 'Lie on floor with knees bent. Bar at chest level. Grip shoulder-width or slightly wider.',
                execution: 'Lower until triceps touch floor. Pause briefly. Press up. Great for lockout strength.'
            },
            'Spoto Press': {
                setup: 'Same as bench press. Moderate weight.',
                execution: 'Lower bar to 1-2 inches above chest. Pause 2-3 seconds without touching. Press up. Builds chest strength off bottom.'
            },
            'Larsen Press': {
                setup: 'Lie on bench with legs straight and feet off floor or resting lightly.',
                execution: 'Bench press without leg drive. Requires more core stability. Pure upper body press.'
            },
            'Board Press': {
                setup: 'Lie on bench. Partner holds boards on chest or use solo board attachment.',
                execution: 'Lower bar to boards, limiting range of motion. Press up. Overloads lockout portion.'
            },
            'Pin Press': {
                setup: 'Set pins in rack at sticking point height. Bar rests on pins.',
                execution: 'Press bar from dead stop on pins. No stretch reflex. Builds starting strength at weak point.'
            },
            'Z Press': {
                setup: 'Sit on floor with legs straight out. Bar in front rack position.',
                execution: 'Press overhead with no back support. Requires tremendous core stability. Strict pressing.'
            },
            'Seated Barbell OHP': {
                setup: 'Sit on bench with back support. Bar at shoulder level.',
                execution: 'Press bar overhead to lockout. Eliminates leg drive. Pure shoulder pressing.'
            },
            'Flat DB Press': {
                setup: 'Lie on flat bench. Dumbbells at chest level, palms forward.',
                execution: 'Press dumbbells up, bringing them together at top. Lower with control. Greater ROM than barbell.'
            },
            'Decline DB Press': {
                setup: 'Lie on decline bench. Dumbbells at lower chest.',
                execution: 'Press up and together. Lower with control. Targets lower chest.'
            },
            'Seated DB OHP': {
                setup: 'Sit on bench with back support. Dumbbells at shoulders.',
                execution: 'Press both dumbbells overhead. Control the descent. Full lockout at top.'
            },
            'Arnold Press': {
                setup: 'Seated with dumbbells at shoulders, palms facing you.',
                execution: 'Rotate palms outward as you press up. Reverse on the way down. Hits all delt heads.'
            },
            'Single-Arm DB Press': {
                setup: 'Lie on bench with one dumbbell. Other hand on hip or bracing.',
                execution: 'Press single dumbbell up. Core works hard to prevent rotation. Alternate sides.'
            },
            'Neutral Grip DB Press': {
                setup: 'Lie on bench. Dumbbells with palms facing each other.',
                execution: 'Press up keeping neutral grip. Easier on shoulders. Full lockout.'
            },
            'DB Squeeze Press': {
                setup: 'Lie on bench. Press dumbbells together at chest level.',
                execution: 'Keep dumbbells squeezed together throughout press. Constant chest tension.'
            },
            'Incline Machine Press': {
                setup: 'Adjust seat so handles are at upper chest. Back against pad.',
                execution: 'Press handles forward and up. Control return. Constant tension on upper chest.'
            },
            'Smith Machine Bench': {
                setup: 'Lie on bench under Smith machine bar. Grip shoulder-width.',
                execution: 'Unrack and lower to chest. Press up. Fixed bar path for controlled pressing.'
            },
            'Smith Machine Incline': {
                setup: 'Incline bench under Smith machine. Grip shoulder-width.',
                execution: 'Lower to upper chest. Press up along fixed path. Good for targeting upper chest safely.'
            },
            'Hammer Strength Press': {
                setup: 'Adjust seat height. Grip handles at chest level.',
                execution: 'Press handles forward. Independent arms allow each side to work. Control return.'
            },
            'Cable Chest Press': {
                setup: 'Cables at chest height. Step forward for tension. Handles at chest.',
                execution: 'Press handles forward, bringing together at extension. Constant cable tension.'
            },
            'Bench Dips': {
                setup: 'Hands on bench behind you. Feet on floor or elevated bench.',
                execution: 'Lower body by bending elbows. Press up to lockout. Tricep focused.'
            },
            'Korean Dips': {
                setup: 'On parallel bars, hands behind hips. Lean forward significantly.',
                execution: 'Lower and press while maintaining forward lean. Extreme chest and shoulder stretch.'
            },
            'Incline Push-Ups': {
                setup: 'Hands on elevated surface (bench, box). Body straight.',
                execution: 'Lower chest toward surface. Press up. Easier than floor push-ups.'
            },
            'Diamond Push-Ups': {
                setup: 'Push-up position with hands together forming diamond shape.',
                execution: 'Lower chest to hands. Press up. Heavy tricep emphasis.'
            },
            'Wide Push-Ups': {
                setup: 'Push-up position with hands wider than shoulder-width.',
                execution: 'Lower chest to floor. Press up. More chest emphasis, less triceps.'
            },
            'Archer Push-Ups': {
                setup: 'Wide push-up position. Arms straight to sides.',
                execution: 'Shift to one side, bending that arm while other stays straight. Alternate sides.'
            },
            'Pike Push-Ups': {
                setup: 'Hands on floor, hips high in inverted V position.',
                execution: 'Lower head toward floor. Press up. Shoulder focused, progression to handstand push-ups.'
            },
            'Pseudo Planche Push-Ups': {
                setup: 'Push-up position with hands by hips, fingers pointing toward feet.',
                execution: 'Lower and press with hands further back than normal. Builds toward planche.'
            },
            'Hindu Push-Ups': {
                setup: 'Start in downward dog position.',
                execution: 'Swoop down, arching through. Push up to upward dog. Reverse the motion. Flowing movement.'
            },
            'Spiderman Push-Ups': {
                setup: 'Standard push-up position.',
                execution: 'As you lower, bring knee to elbow on same side. Alternate sides. Core and hip mobility.'
            },
            'DB Flyes': {
                setup: 'Lie on flat bench. Dumbbells above chest, slight elbow bend.',
                execution: 'Lower dumbbells in arc until chest stretch. Squeeze back up. Maintain elbow angle.'
            },
            'Incline DB Flyes': {
                setup: 'Incline bench at 30-45 degrees. Dumbbells above chest.',
                execution: 'Lower in arc with slight elbow bend. Feel stretch. Squeeze together at top. Upper chest focus.'
            },
            'Pec Deck': {
                setup: 'Sit at pec deck machine. Arms on pads at shoulder height.',
                execution: 'Squeeze arms together in front. Control the return. Constant tension on chest.'
            },
            'Machine Flyes': {
                setup: 'Sit at fly machine. Handles or pads at chest height.',
                execution: 'Bring handles together in front. Squeeze chest. Control return. Isolated chest work.'
            },
            'Low Cable Flyes': {
                setup: 'Cables set low. Step forward. Handles at sides with arms down.',
                execution: 'Raise arms in arc until hands meet at chest/face height. Squeeze. Lower with control.'
            },

            // === NEW UPPER PULL EXERCISES ===
            'Close Grip Pull-Ups': {
                setup: 'Hands 6-8 inches apart on bar. Overhand or neutral grip.',
                execution: 'Pull chin over bar. Lower with control. More bicep and mid-back emphasis.'
            },
            'Neutral Grip Pull-Ups': {
                setup: 'Grip parallel handles with palms facing each other.',
                execution: 'Pull up until chin clears handles. Lower with control. Easier on shoulders.'
            },
            'Weighted Pull-Ups': {
                setup: 'Weight belt with plates or dumbbell between feet. Grip bar.',
                execution: 'Pull up with added weight. Lower with control. Progressive overload for back.'
            },
            'Weighted Chin-Ups': {
                setup: 'Weight belt with plates. Underhand grip on bar.',
                execution: 'Pull up with added weight. More bicep involvement. Lower with control.'
            },
            'Muscle-Ups': {
                setup: 'Hang from bar or rings. Kip or strict start.',
                execution: 'Pull explosively, transition at top, press to support. Advanced movement combining pull and push.'
            },
            'Archer Pull-Ups': {
                setup: 'Wide grip on bar.',
                execution: 'Pull toward one hand while other arm stays straight. Alternate sides. Progression to one-arm.'
            },
            'Typewriter Pull-Ups': {
                setup: 'Wide grip on bar. Pull up to top position.',
                execution: 'At top, shift side to side while staying up. Moving horizontally at top of pull-up.'
            },
            'L-Sit Pull-Ups': {
                setup: 'Hang with legs straight out in front (L-position).',
                execution: 'Maintain L-sit while pulling up. Extreme core and grip demand.'
            },
            'Commando Pull-Ups': {
                setup: 'Grip bar with hands stacked (one in front of other). Stand under bar.',
                execution: 'Pull up alternating which shoulder goes to bar. Head goes to each side of bar.'
            },
            'Mixed Grip Pull-Ups': {
                setup: 'One hand overhand, one underhand on bar.',
                execution: 'Pull up with mixed grip. Creates slight rotation challenge. Alternate grips between sets.'
            },
            'Yates Row': {
                setup: 'Hinged forward about 70 degrees (more upright than Pendlay). Underhand grip.',
                execution: 'Row to lower stomach. Allows heavier weight. More upright angle.'
            },
            'Underhand Barbell Row': {
                setup: 'Hinged forward 45 degrees. Underhand (supinated) grip.',
                execution: 'Row to lower chest/upper abs. More bicep involvement. Keep elbows close.'
            },
            'Kroc Rows': {
                setup: 'One hand braced. Very heavy dumbbell. Slight body English allowed.',
                execution: 'Row heavy weight with some momentum. High rep, controlled chaos. Named after Matt Kroczaleski.'
            },
            'Incline DB Row': {
                setup: 'Lie face down on incline bench. Dumbbells hanging.',
                execution: 'Row dumbbells to sides. Supported position removes lower back. Focus on squeeze.'
            },
            'Renegade Rows': {
                setup: 'Push-up position with hands on dumbbells or kettlebells.',
                execution: 'Row one weight while balancing on other. Alternate sides. Major core anti-rotation work.'
            },
            'Gorilla Rows': {
                setup: 'Two kettlebells on floor. Hinged over with flat back.',
                execution: 'Row one KB while other stays grounded. Alternate sides in rhythm. Lower back support from grounded KB.'
            },
            'Straight Arm Pulldown': {
                setup: 'Face cable machine. High attachment. Arms straight, grip bar.',
                execution: 'Pull bar down in arc to thighs keeping arms straight. Pure lat isolation.'
            },
            'High Cable Row': {
                setup: 'Cable set high. Rope or handle attachment. Step back for tension.',
                execution: 'Pull toward face/upper chest. Elbows high. Rear delt and upper back focus.'
            },
            'TRX Rows': {
                setup: 'Hold TRX handles. Lean back with straight body. Arms extended.',
                execution: 'Pull chest to handles. Lower with control. Adjust difficulty by changing body angle.'
            },
            'Helms Row': {
                setup: 'Lie face down on incline bench. Dumbbells hanging with neutral grip.',
                execution: 'Row to sides squeezing shoulder blades. Complete back isolation. No momentum.'
            },
            'Wide Grip Pulldown': {
                setup: 'Wide grip on lat pulldown bar. Wider than shoulder width.',
                execution: 'Pull bar to upper chest. Squeeze lats. Control return. Emphasizes lat width.'
            },
            'Close Grip Pulldown': {
                setup: 'V-bar or close grip handle on lat pulldown.',
                execution: 'Pull to chest. Squeeze at bottom. More lower lat and bicep emphasis.'
            },
            'Reverse Grip Pulldown': {
                setup: 'Underhand grip on straight bar. Shoulder width.',
                execution: 'Pull to chest. More bicep involvement. Good lat stretch at top.'
            },
            'Single-Arm Pulldown': {
                setup: 'Single handle on cable. Stand or kneel beside machine.',
                execution: 'Pull handle down and across body. Great lat stretch and contraction.'
            },
            'Behind Neck Pulldown': {
                setup: 'Wide grip. Sit slightly forward.',
                execution: 'Pull bar behind head to upper back. Requires good shoulder mobility. Not for everyone.'
            },
            'V-Bar Pulldown': {
                setup: 'V-handle attachment on lat pulldown.',
                execution: 'Pull to chest with close neutral grip. Squeeze lats at bottom.'
            },
            'Reverse Pec Deck': {
                setup: 'Face pec deck machine. Grip handles with arms extended.',
                execution: 'Pull handles back squeezing rear delts. Control return. Isolated rear delt work.'
            },
            'Cable Rear Delt Fly': {
                setup: 'Cables at face height. Cross-body grip (left hand holds right cable).',
                execution: 'Pull cables apart and back. Squeeze rear delts. Control return.'
            },
            'Barbell Shrugs': {
                setup: 'Hold barbell at thighs with overhand or mixed grip.',
                execution: 'Shrug shoulders straight up toward ears. Squeeze at top. Lower with control.'
            },
            'DB Shrugs': {
                setup: 'Hold dumbbells at sides.',
                execution: 'Shrug shoulders up toward ears. Hold at top. Can rotate slightly for fuller contraction.'
            },
            'Trap Bar Shrugs': {
                setup: 'Stand in trap bar. Grip handles.',
                execution: 'Shrug up squeezing traps. Neutral grip is comfortable. Can use heavier weight.'
            },
            'Cable Shrugs': {
                setup: 'Low cable with bar or handles.',
                execution: 'Shrug against cable resistance. Constant tension. Can lean slightly forward.'
            },
            'Behind Back Shrugs': {
                setup: 'Smith machine or barbell behind body at glute level.',
                execution: 'Shrug up and slightly back. Different trap emphasis. Pinch shoulder blades.'
            },
            'Cable Lateral Raises': {
                setup: 'Low cable with handle. Stand sideways to machine.',
                execution: 'Raise arm out to side against cable. Constant tension. Control descent.'
            },
            'Machine Lateral Raises': {
                setup: 'Sit at lateral raise machine. Arms against pads.',
                execution: 'Raise arms to parallel. Controlled movement. Good for drop sets.'
            },
            'Leaning Lateral Raises': {
                setup: 'Hold something with one hand for support. Lean away.',
                execution: 'Lateral raise with leaning body. Changes angle of resistance for better lateral delt hit.'
            },
            'DB Front Raises': {
                setup: 'Stand with dumbbells at thighs.',
                execution: 'Raise one or both dumbbells to shoulder height in front. Lower with control.'
            },
            'Plate Front Raises': {
                setup: 'Hold weight plate with both hands at thighs.',
                execution: 'Raise plate to shoulder height. Lower with control. Can rotate plate at top.'
            },
            'Lu Raises': {
                setup: 'Light dumbbells. Arms at sides.',
                execution: 'Raise arms to front, then out to sides, then back down. L-U-lateral pattern. Named after Lu Xiaojun.'
            },
            'Prone Y Raises': {
                setup: 'Lie face down on incline bench or floor. Light weights or none.',
                execution: 'Raise arms in Y-shape overhead. Squeeze at top. Lower back and trap work.'
            },
            'Prone I Raises': {
                setup: 'Lie face down on incline bench. Arms hanging.',
                execution: 'Raise arms straight overhead (I-shape). Lower back and posterior shoulder work.'
            },
            'Prone T Raises': {
                setup: 'Lie face down on incline bench. Arms hanging.',
                execution: 'Raise arms out to sides (T-shape). Rear delt and mid-back work.'
            },

            // === NEW QUAD EXERCISES ===
            'Low Bar Back Squat': {
                setup: 'Bar across rear delts (lower than high bar). Feet shoulder-width or wider.',
                execution: 'More forward lean. Break at hips first. More posterior chain involvement. Common in powerlifting.'
            },
            'Goblet Squat': {
                setup: 'Hold dumbbell or kettlebell at chest. Elbows inside knees.',
                execution: 'Squat deep with upright torso. Elbows can touch inside of knees. Great for learning squat pattern.'
            },
            'Box Squat': {
                setup: 'Box behind you at parallel depth or below. Bar on back.',
                execution: 'Squat back to box. Sit briefly, then drive up. Teaches hip hinge and builds power off box.'
            },
            'Pause Squat': {
                setup: 'Barbell on back. Normal squat stance.',
                execution: 'Descend to bottom, pause 2-3 seconds, then drive up. Builds strength in hole.'
            },
            'Pin Squat': {
                setup: 'Set pins at bottom position in rack. Start with bar on pins.',
                execution: 'Squat down to pins, let bar settle, then drive up. Concentric-focused squatting.'
            },
            'Anderson Squat': {
                setup: 'Bar on pins at bottom squat position. Get under bar in squat.',
                execution: 'Drive up from dead stop at bottom. No stretch reflex. Pure concentric strength.'
            },
            'Tempo Squat': {
                setup: 'Normal squat setup. Choose tempo (e.g., 3-1-1).',
                execution: 'Control descent with tempo (e.g., 3 sec down, 1 sec pause, 1 sec up). Time under tension.'
            },
            'Heel Elevated Squat': {
                setup: 'Heels on plates or squat wedge. Bar on back.',
                execution: 'Squat with elevated heels. Allows more upright torso and knee travel. More quad focus.'
            },
            'Hack Squat': {
                setup: 'Back against pad on hack squat machine. Shoulders under pads.',
                execution: 'Lower until thighs parallel or below. Drive up through heels. Quad focused.'
            },
            'Pendulum Squat': {
                setup: 'Step onto pendulum squat machine. Shoulders under pads.',
                execution: 'Squat down with arcing movement. Very quad focused. Deep stretch possible.'
            },
            'Belt Squat': {
                setup: 'Belt around hips attached to weight. Feet on platform.',
                execution: 'Squat without spinal loading. Great for back issues. Pure leg work.'
            },
            'Sissy Squat': {
                setup: 'Hold something for balance. Heels elevated.',
                execution: 'Lean back while bending knees, keeping hips extended. Extreme quad stretch.'
            },
            'Spanish Squat': {
                setup: 'Band behind knees, anchored behind you. Lean back into band.',
                execution: 'Squat while band pulls knees forward. Keeps shins vertical. Intense quad burn.'
            },
            'Cyclist Squat': {
                setup: 'Heels very elevated. Narrow stance. Upright torso.',
                execution: 'Squat straight down with knees traveling far forward. Maximum quad emphasis.'
            },
            'Single-Leg Press': {
                setup: 'One foot on leg press platform. Other foot off to side.',
                execution: 'Press with single leg. Good for addressing imbalances. Full range of motion.'
            },
            'Narrow Stance Leg Press': {
                setup: 'Feet together on platform, placed low.',
                execution: 'Press with narrow stance. More quad emphasis. Deep stretch at bottom.'
            },
            'Wide Stance Leg Press': {
                setup: 'Feet wide on platform with toes pointed out.',
                execution: 'Press with wide stance. More inner thigh and glute involvement.'
            },
            'Feet High Leg Press': {
                setup: 'Feet high on platform.',
                execution: 'Press with high foot placement. More hamstring and glute emphasis.'
            },
            'Single-Leg Extension': {
                setup: 'Sit in leg extension. One leg at a time.',
                execution: 'Extend single leg. Addresses imbalances. Full contraction at top.'
            },
            'Reverse Nordic Curls': {
                setup: 'Kneel on pad. Anchor feet or have partner hold them.',
                execution: 'Lean back slowly keeping hips extended. Extreme quad eccentric. Use hands to push back up.'
            },
            'Forward Lunges': {
                setup: 'Stand with dumbbells or barbell.',
                execution: 'Step forward into lunge. Push back to start. More quad emphasis than reverse lunges.'
            },
            'Lateral Lunges': {
                setup: 'Stand with dumbbells at sides.',
                execution: 'Step to side, bending that knee while other leg stays straight. Push back to center.'
            },
            'Curtsy Lunges': {
                setup: 'Stand with weight.',
                execution: 'Step back and across behind other leg (like curtsy). Lower until back knee nearly touches. Return.'
            },
            'Deficit Lunges': {
                setup: 'Front foot on small platform.',
                execution: 'Lunge with increased range of motion from elevation. More glute stretch.'
            },
            'Split Squats': {
                setup: 'Feet staggered, rear foot flat on ground.',
                execution: 'Lower until rear knee nearly touches ground. Drive through front leg. Similar to static lunge.'
            },
            'Rear Foot Elevated Split Squat': {
                setup: 'Same as Bulgarian split squat. Rear foot on bench.',
                execution: 'Lower until rear knee nearly touches. Drive through front foot. Deep stretch.'
            },
            'Step-Ups': {
                setup: 'Face box or bench. Dumbbells at sides optional.',
                execution: 'Step up driving through elevated leg. Don\'t push off back foot. Step down with control.'
            },
            'Lateral Step-Ups': {
                setup: 'Stand beside box. Dumbbells optional.',
                execution: 'Step up sideways onto box. Drive through that leg. Step down and repeat or alternate.'
            },
            'Crossover Step-Ups': {
                setup: 'Stand beside box.',
                execution: 'Step across body onto box with far leg. Drive up. Step down. Works adductors more.'
            },
            'V-Squat Machine': {
                setup: 'Stand on V-squat platform. Shoulders against pads.',
                execution: 'Squat down with supported back. Deep stretch possible. Push through whole foot.'
            },
            'Hack Squat Machine': {
                setup: 'Back against pad. Shoulders under pads. Feet on platform.',
                execution: 'Lower until thighs parallel or below. Press up. Quad focused with back support.'
            },

            // === NEW HAMSTRING/GLUTE EXERCISES ===
            'Deficit Deadlift': {
                setup: 'Stand on 1-4 inch platform. Bar on floor below you.',
                execution: 'Deadlift from deficit position. Increased range of motion. More challenging off floor.'
            },
            'Block Pull': {
                setup: 'Bar elevated on blocks (2-4 inches). Normal deadlift stance.',
                execution: 'Deadlift from elevated position. Reduced range of motion. Good for lockout work.'
            },
            'Rack Pull': {
                setup: 'Bar on pins at knee height or higher.',
                execution: 'Deadlift from pins. Partial ROM. Can go very heavy. Builds lockout strength.'
            },
            'Pause Deadlift': {
                setup: 'Normal deadlift setup.',
                execution: 'Pull to knee height, pause 2-3 seconds, then complete lift. Builds positional strength.'
            },
            'Snatch Grip Deadlift': {
                setup: 'Very wide grip (snatch width) on bar.',
                execution: 'Deadlift with wide grip. More upper back and hamstring demand. Start position is lower.'
            },
            'Stiff-Leg Deadlift': {
                setup: 'Hold bar or dumbbells. Minimal knee bend.',
                execution: 'Hinge at hips with legs nearly straight. Feel hamstring stretch. Keep back flat.'
            },
            'Dumbbell Deadlift': {
                setup: 'Dumbbells on floor beside feet. Squat down to grip them.',
                execution: 'Drive through floor to stand. Dumbbells at sides. Lower with control.'
            },
            'DB Romanian Deadlift': {
                setup: 'Hold dumbbells at thighs. Slight knee bend.',
                execution: 'Hinge at hips, lowering dumbbells along legs. Feel hamstring stretch. Return by driving hips.'
            },
            'Deficit RDL': {
                setup: 'Stand on small platform. Dumbbells or bar at thighs.',
                execution: 'RDL with increased range of motion from platform. Deep hamstring stretch.'
            },
            'B-Stance RDL': {
                setup: 'One foot slightly behind other, on toes. Most weight on front leg.',
                execution: 'RDL with slight offset stance. Working leg does most work. Kickstand position.'
            },
            'Kickstand RDL': {
                setup: 'Same as B-stance. Back foot for balance only.',
                execution: 'Hinge on single leg with kickstand support. Good single leg RDL progression.'
            },
            'Seated Good Mornings': {
                setup: 'Sit on bench with bar on back. Feet flat on floor.',
                execution: 'Hinge forward from hips. Feel hamstring stretch. Return to upright. Isolates posterior chain.'
            },
            'Cable Pull-Through': {
                setup: 'Rope attachment at low cable. Face away. Rope between legs.',
                execution: 'Hinge at hips against cable tension. Drive hips forward to stand. Great hip hinge practice.'
            },
            'Kettlebell Swing': {
                setup: 'Straddle kettlebell. Hinge and grip handle.',
                execution: 'Hike KB back, snap hips to drive KB to chest height. Arms are just hooks. Hip power.'
            },
            'Lying Leg Curls': {
                setup: 'Lie face down on leg curl machine. Pad behind ankles.',
                execution: 'Curl heels toward glutes. Squeeze hamstrings. Lower with control.'
            },
            'Seated Leg Curls': {
                setup: 'Sit in seated leg curl. Pad on shins, behind calves.',
                execution: 'Curl heels under seat. Different hamstring emphasis than lying. Control return.'
            },
            'Standing Leg Curls': {
                setup: 'Stand at cable machine with ankle strap.',
                execution: 'Curl heel toward glute against resistance. Balance challenge. Alternate legs.'
            },
            'Nordic Curls': {
                setup: 'Kneel with feet anchored. Start upright.',
                execution: 'Lower body forward using hamstring control. Go as low as possible. Use hands to push back up.'
            },
            'Slider Leg Curls': {
                setup: 'Lie on back. Heels on sliders on smooth floor.',
                execution: 'Bridge up, then curl heels toward glutes. Slide back out. Keep hips up throughout.'
            },
            'Physioball Leg Curls': {
                setup: 'Lie on back. Heels on stability ball. Hips up.',
                execution: 'Curl ball toward glutes while keeping hips elevated. Roll back out. Core and hamstring work.'
            },
            'Banded Leg Curls': {
                setup: 'Band anchored low. Band around ankle. Lie face down.',
                execution: 'Curl heel toward glute against band. Good for home workouts. Constant tension.'
            },
            'Hip Thrusts': {
                setup: 'Upper back on bench. Feet flat on floor. Bar or dumbbell on hips.',
                execution: 'Drive hips up squeezing glutes hard at top. Lower with control. Premier glute exercise.'
            },
            'Barbell Hip Thrusts': {
                setup: 'Upper back on bench. Barbell padded on hips.',
                execution: 'Drive hips to lockout. Squeeze glutes 1-2 seconds at top. Heavy loading possible.'
            },
            'Single-Leg Hip Thrust': {
                setup: 'Upper back on bench. One foot planted, other leg extended.',
                execution: 'Drive hips up with single leg. Address imbalances. More glute demand per leg.'
            },
            'Glute Bridge': {
                setup: 'Lie on back. Feet flat on floor. Weight on hips optional.',
                execution: 'Drive hips up squeezing glutes. Easier than hip thrust. Good activation exercise.'
            },
            'Single-Leg Glute Bridge': {
                setup: 'Lie on back. One foot planted, other leg extended up.',
                execution: 'Bridge up with single leg. Hold at top. Lower and repeat.'
            },
            'Frog Pumps': {
                setup: 'Lie on back. Soles of feet together. Knees out to sides.',
                execution: 'Squeeze glutes to lift hips. Short ROM but intense glute contraction. High reps.'
            },
            'B-Stance Hip Thrust': {
                setup: 'Upper back on bench. One foot working, other on toes for balance.',
                execution: 'Hip thrust with offset stance. Working leg does 70-80% of work.'
            },
            'Cable Kickbacks': {
                setup: 'Ankle strap on low cable. Face machine, slight hinge.',
                execution: 'Kick leg straight back against cable. Squeeze glute at top. Keep core tight.'
            },
            'Donkey Kicks': {
                setup: 'On hands and knees. Core braced.',
                execution: 'Kick one leg up and back, keeping knee bent. Squeeze glute at top. Control descent.'
            },
            'Fire Hydrants': {
                setup: 'On hands and knees.',
                execution: 'Lift leg out to side keeping knee bent (like dog at fire hydrant). Works glute medius.'
            },
            'Clamshells': {
                setup: 'Lie on side. Knees bent. Feet together.',
                execution: 'Lift top knee while keeping feet together. Squeeze glute medius. Band optional.'
            },
            '45-Degree Back Extension': {
                setup: 'Position on 45-degree hyperextension. Pad at hips.',
                execution: 'Lower torso toward floor. Rise by squeezing glutes and hamstrings. Can hold weight.'
            },
            'Reverse Hyperextension': {
                setup: 'Lie face down on reverse hyper machine. Hold handles.',
                execution: 'Swing legs up behind you squeezing glutes. Lower with control. Great for lower back and glutes.'
            },
            'GHD Hip Extension': {
                setup: 'Hips on pad of GHD. Face down.',
                execution: 'Lower upper body then raise by hinging at hips. Glute and hamstring focused.'
            },
            'KB Deadlift': {
                setup: 'Kettlebell on floor between feet.',
                execution: 'Hinge and grip KB. Drive through floor to stand. Hinge back down. Good hip hinge practice.'
            },
            'KB Single-Leg Deadlift': {
                setup: 'Hold KB in one or both hands. Stand on one leg.',
                execution: 'Hinge on single leg. Free leg extends behind. Balance challenge plus hamstring work.'
            },
            'Sumo DB Squat': {
                setup: 'Wide stance, toes out. Hold dumbbell between legs.',
                execution: 'Squat down with DB going between legs. Drive up squeezing glutes. Targets inner thighs and glutes.'
            },

            // === NEW CORE EXERCISES ===
            'RKC Plank': {
                setup: 'Plank position but actively pull elbows toward toes (without moving).',
                execution: 'Create maximum tension throughout body. Squeeze glutes, quads, fists. Hold with intensity.'
            },
            'Long Lever Plank': {
                setup: 'Plank with arms extended further forward than normal.',
                execution: 'Longer lever makes core work harder. Keep body straight. More demanding than standard plank.'
            },
            'Body Saw Plank': {
                setup: 'Plank position on sliders or with feet on towel.',
                execution: 'Slide body forward and back while maintaining plank. Don\'t let hips sag.'
            },
            'Plank to Push-Up': {
                setup: 'Start in forearm plank.',
                execution: 'Press up to push-up position one arm at a time. Return to forearm plank. Alternate leading arm.'
            },
            'Plank Shoulder Taps': {
                setup: 'Push-up plank position. Feet slightly wider than normal.',
                execution: 'Tap left hand to right shoulder, then right to left. Minimize hip rotation.'
            },
            'Copenhagen Plank': {
                setup: 'Side plank with top leg on bench, bottom leg hanging.',
                execution: 'Hold side plank using adductor of top leg. Killer inner thigh and oblique work.'
            },
            'Reverse Plank': {
                setup: 'Sit on floor. Place hands behind you. Lift hips.',
                execution: 'Hold reverse plank with body straight from shoulders to feet. Works posterior chain.'
            },
            'Weighted Plank': {
                setup: 'Standard plank with weight plate on back.',
                execution: 'Hold plank with added weight. Partner can place plate on lower back.'
            },
            'Barbell Rollouts': {
                setup: 'Kneel with barbell loaded with round plates in front.',
                execution: 'Roll bar forward extending body. Pull back using abs. Barbell version of ab wheel.'
            },
            'TRX Fallouts': {
                setup: 'Hold TRX handles. Arms extended in front. Body leaning forward.',
                execution: 'Fall forward letting arms go overhead. Pull back to start. TRX ab wheel.'
            },
            'Stability Ball Rollouts': {
                setup: 'Kneel with forearms on stability ball.',
                execution: 'Roll ball forward extending arms and body. Pull back using core.'
            },
            'Body Saw': {
                setup: 'Forearm plank with feet on sliders.',
                execution: 'Rock body backward and forward maintaining plank. Small controlled movements.'
            },
            'Inchworms': {
                setup: 'Stand tall.',
                execution: 'Fold forward, walk hands out to plank. Walk feet to hands. Stand up. Repeat. Dynamic core work.'
            },
            'Hanging Knee Raises': {
                setup: 'Hang from bar. Arms straight.',
                execution: 'Bring knees to chest. Lower with control. Easier than straight leg raises.'
            },
            'Hanging Windshield Wipers': {
                setup: 'Hang from bar. Legs raised straight out.',
                execution: 'Rotate legs side to side like windshield wipers. Advanced oblique exercise.'
            },
            'Hanging L-Sit': {
                setup: 'Hang from bar.',
                execution: 'Raise straight legs until parallel to ground. Hold L-position. Extreme hip flexor and ab work.'
            },
            'Captain Chair Leg Raises': {
                setup: 'Support yourself on captain\'s chair with forearms on pads.',
                execution: 'Raise legs in front. Keep controlled. Can bend knees or keep straight.'
            },
            'Sit-Ups': {
                setup: 'Lie on back. Knees bent. Feet flat.',
                execution: 'Sit all the way up. Hands can be across chest or behind head. Return with control.'
            },
            'Crunches': {
                setup: 'Lie on back. Knees bent. Hands behind head.',
                execution: 'Curl shoulders off ground. Don\'t pull on neck. Small controlled movement.'
            },
            'Reverse Crunches': {
                setup: 'Lie on back. Knees bent 90 degrees. Hands at sides.',
                execution: 'Curl hips off ground bringing knees toward chest. Lower with control.'
            },
            'Toe Touches': {
                setup: 'Lie on back. Legs straight up.',
                execution: 'Crunch up reaching hands toward toes. Lower shoulders. Don\'t let legs drop.'
            },
            'Jackknife Sit-Ups': {
                setup: 'Lie flat. Arms overhead. Legs straight.',
                execution: 'Simultaneously raise legs and torso, reaching hands to toes. V-up variation.'
            },
            'Scissor Kicks': {
                setup: 'Lie on back. Legs straight, slightly elevated.',
                execution: 'Alternate legs up and down in scissor motion. Keep lower back pressed to floor.'
            },
            'Flutter Kicks': {
                setup: 'Lie on back. Legs straight, slightly elevated.',
                execution: 'Small rapid up and down kicks. Keep lower back down. Core endurance.'
            },
            'Bicycle Kicks': {
                setup: 'Lie on back. Hands behind head.',
                execution: 'Alternate bringing elbow to opposite knee while extending other leg. Continuous pedaling motion.'
            },
            'Dead Bug Variations': {
                setup: 'Lie on back. Arms up. Legs at 90 degrees.',
                execution: 'Various patterns: opposite arm/leg, same side, holds. Keep lower back pressed down.'
            },
            'Side Crunches': {
                setup: 'Lie on back. Knees bent. Drop knees to one side.',
                execution: 'Crunch up with oblique focus. Do all reps on one side then switch.'
            },
            'Med Ball Russian Twist': {
                setup: 'Sit with knees bent. Hold med ball at chest. Feet off ground optional.',
                execution: 'Rotate side to side touching ball to ground. Control the movement.'
            },
            'Windmill': {
                setup: 'Stand with one arm overhead holding weight. Feet wider than shoulders.',
                execution: 'Hinge sideways, reaching free hand toward opposite foot. Keep overhead arm straight.'
            },
            'Half-Kneeling Chop': {
                setup: 'Half-kneel beside cable machine. High cable setting.',
                execution: 'Chop cable diagonally from high to low across body. Anti-rotation and oblique work.'
            },
            'Half-Kneeling Lift': {
                setup: 'Half-kneel beside cable machine. Low cable setting.',
                execution: 'Lift cable diagonally from low to high across body. Opposite pattern of chop.'
            },
            'Cross-Body Carry': {
                setup: 'Hold weight at one shoulder with both hands. Or goblet style offset.',
                execution: 'Walk while holding weight asymmetrically. Core works to prevent rotation.'
            },
            'Bottoms-Up Carry': {
                setup: 'Hold kettlebell upside down (bottom up) in rack position.',
                execution: 'Walk while stabilizing inverted kettlebell. Extreme grip and core work.'
            },
            'Waiter Walk': {
                setup: 'Hold kettlebell overhead like carrying a tray.',
                execution: 'Walk with weight overhead. Keep arm locked. Core braced.'
            },
            'Half Turkish Get-Up': {
                setup: 'Start TGU but only go to seated or elbow position.',
                execution: 'Practice bottom half of get-up. Great for learning movement. Build up to full.'
            },
            'Cable Crunch': {
                setup: 'Kneel at high cable. Rope behind head.',
                execution: 'Crunch down bringing elbows to knees. Resist cable on return. Loaded ab work.'
            },
            'Rope Crunch': {
                setup: 'Same as cable crunch with rope attachment.',
                execution: 'Hold rope behind head or at chest. Crunch down against cable.'
            },
            'High Cable Crunch': {
                setup: 'Face away from high cable. Hold rope at shoulders.',
                execution: 'Crunch forward against cable resistance. Different angle than kneeling crunch.'
            },

            // === NEW PLYO EXERCISES ===
            'B-Skips': {
                setup: 'Same as A-skips starting position.',
                execution: 'Skip with high knee, then extend leg out in front before landing. Pawing motion. Sprint specific.'
            },
            'High Skips': {
                setup: 'Stand tall ready to skip.',
                execution: 'Skip for maximum height on each rep. Drive knee high and arm up. Focus on height not speed.'
            },
            'Ladder Drills': {
                setup: 'Agility ladder on ground.',
                execution: 'Various footwork patterns through ladder. Quick feet, ickey shuffle, in-out, etc.'
            },
            'Quick Feet': {
                setup: 'Athletic stance.',
                execution: 'Run in place as fast as possible with minimal ground contact. Quick choppy steps.'
            },
            'Dot Drills': {
                setup: 'Five dots in X pattern on ground.',
                execution: 'Jump between dots in various patterns. Two feet, single leg, etc. Agility and quickness.'
            },
            'Ankle Bounces': {
                setup: 'Stand with knees nearly locked.',
                execution: 'Bounce using only ankles. Minimal knee bend. Develop ankle stiffness for running.'
            },
            'Fast Feet': {
                setup: 'Athletic stance.',
                execution: 'Rapid small steps in place or moving. Keep feet close to ground. Quick turnover.'
            },
            'Seated Box Jumps': {
                setup: 'Sit on box. Another box in front for jumping onto.',
                execution: 'From seated, explode up onto box. No momentum or stretch reflex. Pure power.'
            },
            'Weighted Box Jumps': {
                setup: 'Light dumbbells or weighted vest. Face box.',
                execution: 'Box jump with added weight. Don\'t go too heavy. Focus on explosion.'
            },
            'Step Box Jumps': {
                setup: 'Start one step back from box.',
                execution: 'Take one step into box jump. Converts forward momentum to vertical. Sport specific.'
            },
            'Depth Drop': {
                setup: 'Stand on box 12-18 inches.',
                execution: 'Step off and land, absorbing impact. No jump after. Learn landing mechanics.'
            },
            'Altitude Drop': {
                setup: 'Higher box than depth drop (24-36 inches).',
                execution: 'Step off and land with control. Builds eccentric strength. Advanced landing practice.'
            },
            'Reactive Box Jump': {
                setup: 'Stand in front of box.',
                execution: 'Countermovement jump onto box with minimal ground contact. Quick dip and drive.'
            },
            'Hurdle Jumps': {
                setup: 'Set hurdles 3-4 feet apart.',
                execution: 'Jump over each hurdle with two feet. Continuous movement. Focus on height and quick contacts.'
            },
            'Lateral Hurdle Hops': {
                setup: 'Stand beside hurdle.',
                execution: 'Hop laterally over hurdle. Land and immediately hop back. Quick ground contacts.'
            },
            'Single-Leg Hurdle Hops': {
                setup: 'Stand on one leg beside or facing hurdle.',
                execution: 'Hop over hurdle on single leg. Land and stabilize or continue. Advanced plyometric.'
            },
            'Standing Triple Jump': {
                setup: 'Start line marked. Athletic stance.',
                execution: 'Hop, step, jump pattern (like track triple jump). Cover maximum distance.'
            },
            'Banded Vertical Jumps': {
                setup: 'Band around waist anchored below.',
                execution: 'Jump for height against band resistance. Builds explosive power.'
            },
            'Banded Squat Jumps': {
                setup: 'Band around waist or on shoulders.',
                execution: 'Squat jump against band. Overspeed eccentric when coming down.'
            },
            'Med Ball Scoop Throw': {
                setup: 'Hold med ball low between legs.',
                execution: 'Scoop and throw forward and up. Like underhand shot put. Hip power.'
            },
            'Med Ball Shot Put': {
                setup: 'Hold med ball at shoulder.',
                execution: 'Push throw ball one handed for distance. Rotate through hips. Alternate arms.'
            },
            'Med Ball Granny Throw': {
                setup: 'Hold med ball low between legs.',
                execution: 'Throw ball backward over head for distance. Full body extension.'
            },
            'Med Ball Reverse Throw': {
                setup: 'Stand with back to throw direction. Med ball at chest.',
                execution: 'Rotate and throw over shoulder. Rotational power.'
            },
            'Clap Push-Ups': {
                setup: 'Push-up position.',
                execution: 'Push up explosively, clap hands, land in push-up position. Upper body plyo.'
            },
            'Explosive Push-Ups': {
                setup: 'Push-up position.',
                execution: 'Push up with maximum speed. Hands can leave ground. Focus on speed not height.'
            },
            'Squat Jumps': {
                setup: 'Athletic stance.',
                execution: 'Squat down then jump for maximum height. Land softly. Reset and repeat.'
            },
            'Tuck Jumps': {
                setup: 'Athletic stance.',
                execution: 'Jump and tuck knees to chest at peak. Land softly. Requires height and coordination.'
            },
            'Split Squat Jumps': {
                setup: 'Lunge position.',
                execution: 'Jump and switch legs in air. Land in opposite lunge. Continuous switching.'
            },
            'Lunge Jumps': {
                setup: 'Lunge position.',
                execution: 'Jump explosively from lunge. Can switch legs or keep same. Power and balance.'
            },
            'Vertical Jumps': {
                setup: 'Stand beside wall or vertec.',
                execution: 'Jump for maximum height. Touch highest point. Measure progress over time.'
            },
            'Countermovement Jump': {
                setup: 'Stand tall.',
                execution: 'Quick dip and jump for max height. Standard vertical jump test protocol.'
            },
            'Drop Jump': {
                setup: 'Stand on box.',
                execution: 'Step off, land, immediately jump for max height. Reactive strength. Same as depth jump.'
            },

            // === NEW HIIT/CARDIO EXERCISES ===
            'Tabata': {
                setup: 'Choose exercise. Timer set for 20 sec work, 10 sec rest.',
                execution: '8 rounds of 20 seconds max effort, 10 seconds rest. Total 4 minutes. Any exercise works.'
            },
            'Jumping Jacks': {
                setup: 'Stand with feet together, arms at sides.',
                execution: 'Jump feet out while raising arms overhead. Jump back to start. Classic warm-up/cardio.'
            },
            'Butt Kicks': {
                setup: 'Stand tall.',
                execution: 'Run in place kicking heels to glutes. Quick tempo. Good warm-up.'
            },
            'Speed Skaters': {
                setup: 'Athletic stance.',
                execution: 'Leap side to side landing on one foot. Swing arms across body. Like skating motion.'
            },
            'Plank Jacks': {
                setup: 'Plank position.',
                execution: 'Jump feet out and in like jumping jack while holding plank. Core plus cardio.'
            },
            'Squat Thrusts': {
                setup: 'Stand tall.',
                execution: 'Squat down, hands to floor, jump feet back, jump feet in, stand. Burpee without jump.'
            },
            'Bear Crawls': {
                setup: 'On hands and toes, knees slightly off ground.',
                execution: 'Crawl forward moving opposite hand and foot. Keep hips low. Full body movement.'
            },
            'Frog Jumps': {
                setup: 'Deep squat position.',
                execution: 'Jump forward like a frog. Land in squat. Repeat for distance or reps.'
            },
            'Ice Skaters': {
                setup: 'Athletic stance.',
                execution: 'Same as speed skaters. Lateral leaps landing on single leg.'
            },
            'Pop Squats': {
                setup: 'Athletic stance.',
                execution: 'Jump feet wide into squat, jump back narrow. Continuous popping in and out.'
            },
            'Treadmill Intervals': {
                setup: 'Set treadmill speed and incline for intervals.',
                execution: 'Alternate between fast and slow/rest periods. Various protocols possible.'
            },
            'Hill Sprints': {
                setup: 'Find steep hill.',
                execution: 'Sprint up hill, walk down. Repeat. Builds power and cardio. Easy on joints.'
            },
            'Treadmill Jog': {
                setup: 'Set comfortable jogging pace.',
                execution: 'Steady state jog at conversational pace. Zone 2 cardio.'
            },
            'Spin Bike': {
                setup: 'Adjust seat and handlebars.',
                execution: 'Pedal at desired intensity. Can do intervals or steady state.'
            },
            'HIIT Cycling': {
                setup: 'Bike set up for intervals.',
                execution: 'Alternate between all-out sprints and recovery. Various work:rest ratios.'
            },
            'Bike Sprints': {
                setup: 'High resistance setting.',
                execution: 'Sprint for 10-30 seconds maximum effort. Rest between sprints.'
            },
            'Bike Intervals': {
                setup: 'Bike set for interval training.',
                execution: 'Structured work/rest intervals. Can be short or long intervals.'
            },
            'Airdyne Bike': {
                setup: 'Adjust seat on airdyne/fan bike.',
                execution: 'Push and pull with arms while pedaling. Full body. Resistance increases with speed.'
            },
            'Prowler Sprint': {
                setup: 'Load prowler. Clear lane.',
                execution: 'Sprint pushing prowler for distance. All out effort. Walk back and repeat.'
            },
            'Reverse Sled Drag': {
                setup: 'Face sled. Straps in hands.',
                execution: 'Walk backward dragging sled. Works quads and conditioning differently.'
            },
            'Lateral Sled Drag': {
                setup: 'Stand sideways to sled. Strap in one or both hands.',
                execution: 'Side shuffle dragging sled. Works lateral movement under load.'
            },
            'KB Snatches': {
                setup: 'Kettlebell on ground. Athletic stance.',
                execution: 'Swing KB up and punch overhead in one motion. Explosive full body movement.'
            },
            'Ski Erg Intervals': {
                setup: 'Set ski erg for interval training.',
                execution: 'Alternate between hard pulls and recovery. Upper body dominant cardio.'
            },
            'Versa Climber': {
                setup: 'Adjust foot and hand position.',
                execution: 'Climb continuously. Full body cardio. Very demanding.'
            },
            'Jacob\'s Ladder': {
                setup: 'Step onto ladder machine.',
                execution: 'Climb continuously. Self-paced - goes faster as you climb faster.'
            },
            'Echo Bike': {
                setup: 'Same as assault bike.',
                execution: 'Push/pull arms while pedaling. Fan resistance. Similar to assault bike.'
            },
            'Running': {
                setup: 'Proper running shoes. Safe route.',
                execution: 'Run at desired pace and distance. Can be steady or interval.'
            },
            'Hiking': {
                setup: 'Appropriate footwear. Trail or hilly route.',
                execution: 'Walk on varied terrain. Low impact cardio. Good for active recovery.'
            },
            'Cycling Outdoors': {
                setup: 'Bike properly fitted. Helmet.',
                execution: 'Ride at desired intensity. Explore or follow route. Low impact cardio.'
            },
            'Jump Rope': {
                setup: 'Rope sized correctly (handles reach armpits when standing on rope).',
                execution: 'Jump with both feet. Stay on balls of feet. Various patterns and speeds.'
            },
            'Double Unders': {
                setup: 'Speed rope. Good timing.',
                execution: 'Jump high enough for rope to pass under twice. Requires coordination and power.'
            },
            'Shadow Boxing': {
                setup: 'Open space. No equipment needed.',
                execution: 'Throw punches at air. Move feet. Work combinations. Good active cardio.'
            },
            'Heavy Bag Work': {
                setup: 'Heavy bag properly hung.',
                execution: 'Throw punches and kicks at bag. Work rounds. Great conditioning and stress relief.'
            },
            'Speed Bag': {
                setup: 'Speed bag at correct height (eye level).',
                execution: 'Hit bag with rhythm. Develops timing and shoulder endurance.'
            },
            'Boxing Rounds': {
                setup: 'Timer for rounds (usually 3 min work, 1 min rest).',
                execution: 'Various boxing activities per round. Bag work, mitts, shadow boxing, etc.'
            },

            // === NEW FULL BODY/OLYMPIC EXERCISES ===
            'Power Snatch': {
                setup: 'Bar on floor. Wide (snatch) grip. Athletic stance.',
                execution: 'Pull bar from floor, catch overhead with minimal squat. Power position catch.'
            },
            'Hang Snatch': {
                setup: 'Bar at hips with snatch grip.',
                execution: 'Dip and explode, pulling bar overhead. Catch in squat or power position.'
            },
            'Snatch Pull': {
                setup: 'Bar on floor with snatch grip.',
                execution: 'Pull like snatch but don\'t turn over wrists. Shrug and pull high. Power development.'
            },
            'Clean and Jerk': {
                setup: 'Bar on floor. Clean grip.',
                execution: 'Clean bar to shoulders, then jerk overhead. Two separate movements. Olympic lift.'
            },
            'Clean and Press': {
                setup: 'Bar on floor. Clean grip.',
                execution: 'Clean bar to shoulders, then strict press overhead. No leg drive on press.'
            },
            'Muscle Clean': {
                setup: 'Bar at hang position.',
                execution: 'Pull bar to shoulders without dropping under. Arms pull bar up. Strength movement.'
            },
            'Muscle Snatch': {
                setup: 'Bar at hang position with snatch grip.',
                execution: 'Pull bar overhead without dropping under. Shoulders and arms only. Light weight.'
            },
            'Hang Power Clean': {
                setup: 'Bar at thighs with clean grip.',
                execution: 'Dip, drive, pull to shoulders catching in partial squat. Common variation.'
            },
            'Hang Power Snatch': {
                setup: 'Bar at thighs with snatch grip.',
                execution: 'Dip, drive, pull overhead catching in partial squat. Power position catch.'
            },
            'Man Maker': {
                setup: 'Two dumbbells on floor. Push-up position on them.',
                execution: 'Push-up, row each arm, jump to squat, clean and press. Full body crusher.'
            },
            'Thruster': {
                setup: 'Bar in front rack position.',
                execution: 'Squat down, drive up and press overhead in one motion. Leg power helps press.'
            },
            'DB Thruster': {
                setup: 'Dumbbells at shoulders.',
                execution: 'Squat and press in one fluid motion. Dumbbells finish overhead.'
            },
            'Barbell Thruster': {
                setup: 'Bar in front rack.',
                execution: 'Full squat to overhead press in one movement. CrossFit staple.'
            },
            'Wall Ball': {
                setup: 'Face wall holding med ball at chest. Target on wall.',
                execution: 'Squat down, explode up throwing ball to target. Catch and repeat. Full body cardio.'
            },
            'Squat to Press': {
                setup: 'Dumbbells or bar at shoulders.',
                execution: 'Squat down, on the way up press weight overhead. Similar to thruster.'
            },
            'Burpee Box Jump': {
                setup: 'Box in front of you.',
                execution: 'Perform burpee, then immediately box jump. Land, step down, repeat.'
            },
            'Devil Press': {
                setup: 'Two dumbbells on floor.',
                execution: 'Burpee with dumbbells, swing dumbbells overhead at top. Combines burpee and snatch.'
            },
            'Kettlebell Complex': {
                setup: 'Single or double kettlebells.',
                execution: 'Series of KB movements without putting weight down. Swing, clean, press, squat, etc.'
            },
            'Barbell Complex': {
                setup: 'Barbell loaded moderately.',
                execution: 'Series of barbell movements without rest. Deadlift, row, clean, press, squat, etc.'
            },
            'Clean High Pull': {
                setup: 'Bar on floor with clean grip.',
                execution: 'Pull from floor, shrug and pull elbows high. Don\'t turn over to catch. Power builder.'
            },
            'Snatch High Pull': {
                setup: 'Bar on floor with snatch grip.',
                execution: 'Wide grip high pull. Elbows go high and out. Power movement.'
            },
            'Push Jerk': {
                setup: 'Bar at shoulders.',
                execution: 'Dip and drive bar up, drop under catching with locked arms. Feet may split or stay together.'
            },
            'Split Jerk': {
                setup: 'Bar at shoulders.',
                execution: 'Dip and drive, split feet front and back while pressing under bar. Recover to standing.'
            },

            // === NEW ARM EXERCISES ===
            'EZ Bar Curls': {
                setup: 'Hold EZ curl bar with angled grips.',
                execution: 'Curl bar up squeezing biceps. EZ bar is easier on wrists than straight bar.'
            },
            'DB Curls': {
                setup: 'Hold dumbbells at sides.',
                execution: 'Curl both or alternating. Can supinate (turn) wrist during curl. Basic bicep builder.'
            },
            'Preacher Curls': {
                setup: 'Sit at preacher bench. Upper arms on pad.',
                execution: 'Curl weight up keeping upper arms on pad. Isolated bicep work. Full stretch at bottom.'
            },
            'Incline DB Curls': {
                setup: 'Lie back on incline bench. Dumbbells hanging.',
                execution: 'Curl from stretched position. Great bicep stretch at bottom. Don\'t swing.'
            },
            'Concentration Curls': {
                setup: 'Sit on bench. Elbow braced against inner thigh.',
                execution: 'Curl dumbbell focusing on peak contraction. Isolated single arm work.'
            },
            'Spider Curls': {
                setup: 'Lie face down on incline bench. Arms hanging straight down.',
                execution: 'Curl with gravity working against you throughout. Constant tension.'
            },
            'Reverse Curls': {
                setup: 'Hold bar or dumbbells with overhand (pronated) grip.',
                execution: 'Curl with palms facing down. Works brachioradialis and forearms.'
            },
            'Zottman Curls': {
                setup: 'Hold dumbbells at sides.',
                execution: 'Curl up with supinated grip. Rotate to pronated and lower. Best of both grips.'
            },
            'Cross Body Curls': {
                setup: 'Hold dumbbell at side.',
                execution: 'Curl dumbbell across body toward opposite shoulder. Hits long head of bicep.'
            },
            'Cable Hammer Curls': {
                setup: 'Low cable with rope attachment.',
                execution: 'Hammer curl with rope. Constant cable tension. Great pump.'
            },
            '21s Curls': {
                setup: 'Hold bar or dumbbells.',
                execution: '7 reps bottom half, 7 reps top half, 7 reps full ROM. 21 total reps. Bicep burnout.'
            },
            'Drag Curls': {
                setup: 'Hold bar at thighs.',
                execution: 'Curl bar while keeping it against body. Elbows go back. Different bicep emphasis.'
            },
            'Bayesian Curls': {
                setup: 'Stand facing away from low cable. Handle behind you.',
                execution: 'Curl with arm behind body. Maximum stretch on bicep. Great for long head.'
            },
            'Waiter Curls': {
                setup: 'Hold one dumbbell vertical with both hands under top plate.',
                execution: 'Curl like carrying a tray. Constant bicep tension. Good for inner bicep.'
            },
            'Cable Preacher Curl': {
                setup: 'Low cable with preacher bench or seated.',
                execution: 'Curl against cable on preacher setup. Constant tension version.'
            },
            'High Cable Curl': {
                setup: 'Cable at high position. Stand between two cables.',
                execution: 'Curl handles toward head. Arms at shoulder height. Pose and flex style.'
            },
            'V-Bar Pushdowns': {
                setup: 'V-attachment on high cable.',
                execution: 'Push down extending elbows fully. Keep upper arms still. Squeeze triceps.'
            },
            'Straight Bar Pushdowns': {
                setup: 'Straight bar on high cable.',
                execution: 'Push down to full extension. Pronated grip. Keep elbows pinned.'
            },
            'Single-Arm Pushdown': {
                setup: 'Handle on high cable.',
                execution: 'Push down with single arm. Can do reverse or regular grip. Focus on each side.'
            },
            'Kickbacks': {
                setup: 'Bent over. Upper arm parallel to floor.',
                execution: 'Extend forearm back until arm is straight. Squeeze tricep. Common with dumbbells or cable.'
            },
            'DB Kickbacks': {
                setup: 'Bent over with upper arm parallel to floor. DB in hand.',
                execution: 'Extend elbow fully. Squeeze at top. Light weight, focus on contraction.'
            },
            'Cable Overhead Extension': {
                setup: 'Low cable behind you with rope. Face away.',
                execution: 'Extend arms overhead against cable. Step forward for more stretch.'
            },
            'DB Overhead Extension': {
                setup: 'Hold dumbbell overhead with both hands.',
                execution: 'Lower DB behind head. Extend back up. Long head tricep stretch.'
            },
            'JM Press': {
                setup: 'Lie on bench. Grip narrower than shoulder width.',
                execution: 'Hybrid between close grip bench and skull crusher. Lower toward chin then press.'
            },
            'Tate Press': {
                setup: 'Lie on bench. Dumbbells extended over chest, palms facing feet.',
                execution: 'Lower dumbbells toward chest by flaring elbows. Press back up. Unique tricep angle.'
            },
            'Tricep Dips': {
                setup: 'On dip bars or bench.',
                execution: 'Lower body by bending elbows. Press up to lockout. Keep upright for tricep focus.'
            },
            'Lying Tricep Extension': {
                setup: 'Lie on bench. Bar or dumbbells extended over chest.',
                execution: 'Lower weight toward head/forehead. Extend back up. Classic skull crusher.'
            },
            'French Press': {
                setup: 'Seated or standing. Bar or dumbbells overhead.',
                execution: 'Lower weight behind head. Extend back up. Similar to overhead extension.'
            },
            'Wrist Curls': {
                setup: 'Sit with forearms on thighs. Palms up. Bar or dumbbells.',
                execution: 'Curl wrists up. Lower and repeat. Forearm flexors.'
            },
            'Reverse Wrist Curls': {
                setup: 'Sit with forearms on thighs. Palms down.',
                execution: 'Extend wrists up. Lower and repeat. Forearm extensors.'
            },
            'Farmer Holds': {
                setup: 'Hold heavy dumbbells or kettlebells at sides.',
                execution: 'Just hold for time. Crushing grip work. Traps work too.'
            },
            'Plate Pinch': {
                setup: 'Pinch weight plates together smooth side out.',
                execution: 'Hold for time. Thumb and finger strength. Drop carefully.'
            },
            'Dead Hangs': {
                setup: 'Hang from bar with straight arms.',
                execution: 'Just hang for time. Grip endurance. Good for shoulder health too.'
            },
            'Towel Hangs': {
                setup: 'Drape towel over bar. Grip towel.',
                execution: 'Hang from towel. Killer grip work. Can do pull-ups too.'
            },
            'Fat Grip Curls': {
                setup: 'Fat grips on bar or dumbbells. Or use thick bar.',
                execution: 'Curl with thicker grip. Forces grip and forearm work.'
            },
            'Wrist Roller': {
                setup: 'Wrist roller device or DIY with dowel and rope.',
                execution: 'Roll weight up by rotating wrists. Roll back down. Forearm burn.'
            },

            // === NEW CALF EXERCISES ===
            'Donkey Calf Raises': {
                setup: 'Hinged at hips. Pad on lower back. Weight loaded.',
                execution: 'Calf raise with hips hinged. Old school exercise. Great calf stretch.'
            },
            'Smith Machine Calf Raises': {
                setup: 'Stand in Smith machine on block. Bar on shoulders.',
                execution: 'Calf raise with bar stabilized. Can go heavy safely.'
            },
            'Machine Calf Raises': {
                setup: 'Any calf raise machine. Adjust pad height.',
                execution: 'Raise heels as high as possible. Full stretch at bottom. Control movement.'
            },
            'Deficit Calf Raises': {
                setup: 'Stand on block or step. Heels hanging off.',
                execution: 'Full range calf raise with stretch below parallel.'
            },
            'Bent Knee Calf Raises': {
                setup: 'Seated or with knees bent.',
                execution: 'Calf raise with knees bent. Targets soleus muscle specifically.'
            },
            'Tib Bar Raises': {
                setup: 'Tib bar on top of feet while seated.',
                execution: 'Raise toes toward shins against resistance. Tibialis anterior focus.'
            },
            'Toe Walks': {
                setup: 'Stand on tip toes.',
                execution: 'Walk forward staying on toes. Calf endurance. Don\'t let heels touch.'
            },
            'Heel Walks': {
                setup: 'Stand with toes raised off ground.',
                execution: 'Walk forward on heels only. Tibialis anterior endurance.'
            },

            // === NEW MOBILITY/RECOVERY EXERCISES ===
            'Morning Mobility': {
                setup: 'Mat or clear floor space.',
                execution: 'Light movement routine to start day. Cat-cow, twists, hip circles. 5-10 min.'
            },
            'Pre-Workout Mobility': {
                setup: 'Space for movement.',
                execution: 'Dynamic stretches specific to workout. Hip swings, arm circles, movement prep.'
            },
            'Post-Workout Mobility': {
                setup: 'Mat for stretching.',
                execution: 'Static stretches for worked muscles. Hold each 30-60 seconds. Cool down.'
            },
            'Hip Flow': {
                setup: 'Mat on floor.',
                execution: 'Continuous hip mobility sequence. 90/90s, hip circles, pigeon, frog. Flow between.'
            },
            'Foam Roll Quads': {
                setup: 'Foam roller on floor.',
                execution: 'Roll quads slowly. Pause on tender spots. 1-2 min per leg.'
            },
            'Foam Roll IT Band': {
                setup: 'Foam roller under side of thigh.',
                execution: 'Roll from hip to knee. Notoriously painful. Go slow.'
            },
            'Foam Roll Lats': {
                setup: 'Foam roller under armpit area. Arm extended.',
                execution: 'Roll from armpit to bottom of ribcage. Hit lat tissue.'
            },
            'Lacrosse Ball Work': {
                setup: 'Lacrosse ball against wall or floor.',
                execution: 'Use ball for targeted pressure on trigger points. More precise than foam roller.'
            },
            'Trigger Point Release': {
                setup: 'Ball or roller on target area.',
                execution: 'Find tight spot, apply pressure 30-90 seconds. Wait for release.'
            },
            'Self-Massage': {
                setup: 'Hands, tools, or massage gun.',
                execution: 'Work through muscles manually. Find and release tight spots.'
            },
            'Full Body Stretching': {
                setup: 'Mat and wall or strap.',
                execution: 'Stretch all major muscle groups. Hold each 30-60 seconds.'
            },
            'Hip Flexor Stretch': {
                setup: 'Half kneeling position.',
                execution: 'Drive hips forward stretching front of back leg hip. Hold. Can add twist.'
            },
            'Hamstring Stretch': {
                setup: 'Seated or standing.',
                execution: 'Extend leg and hinge forward. Feel stretch in back of thigh.'
            },
            'Quad Stretch': {
                setup: 'Standing or lying on side.',
                execution: 'Pull heel to glute. Feel front of thigh stretch. Keep knees together.'
            },
            'Calf Stretch': {
                setup: 'Against wall or step.',
                execution: 'Lean forward with straight back leg. Feel calf stretch. Bend knee for soleus.'
            },
            'Chest Stretch': {
                setup: 'Doorway or wall.',
                execution: 'Arm against surface at 90 degrees. Turn body away. Feel pec stretch.'
            },
            'Lat Stretch': {
                setup: 'Hold onto something at arm height.',
                execution: 'Push hips back, lean away from arm. Feel stretch under arm.'
            },
            'Shoulder Stretch': {
                setup: 'Pull arm across body.',
                execution: 'Hold elbow and pull arm across. Feel rear shoulder stretch.'
            },
            'Tricep Stretch': {
                setup: 'Arm overhead, elbow bent.',
                execution: 'Push elbow down with other hand. Feel tricep and lat stretch.'
            },
            '90/90 Stretch': {
                setup: 'Sit with both legs at 90 degrees. Front shin forward, back shin to side.',
                execution: 'Lean forward over front leg. Switch sides. Opens hips.'
            },
            'Pigeon Pose': {
                setup: 'Front leg bent in front, back leg extended.',
                execution: 'Fold forward over front leg. Deep hip stretch. Hold and breathe.'
            },
            'World\'s Greatest Stretch': {
                setup: 'Lunge position.',
                execution: 'Elbow to floor beside front foot. Rotate and reach overhead. Hits everything.'
            },
            'Couch Stretch': {
                setup: 'Back foot up on couch/wall behind you. Lunge position.',
                execution: 'Extreme hip flexor and quad stretch. Keep core tight. Intense.'
            },
            'Frog Stretch': {
                setup: 'Knees wide on ground. Hips between feet.',
                execution: 'Rock forward and back. Adductor stretch. Very deep. Go slowly.'
            },
            'Butterfly Stretch': {
                setup: 'Sit with soles of feet together. Knees out.',
                execution: 'Press knees toward floor. Can lean forward for more. Groin stretch.'
            },
            'Seated Forward Fold': {
                setup: 'Sit with legs extended.',
                execution: 'Fold forward reaching for toes. Hamstring and back stretch.'
            },
            'Cat-Cow': {
                setup: 'Hands and knees position.',
                execution: 'Arch back up (cat), then drop belly and look up (cow). Flow between.'
            },
            'Hip Mobility': {
                setup: 'Standing or on mat.',
                execution: 'Various hip circles, leg swings, and mobility drills. Open up hip joint.'
            },
            'Ankle Mobility': {
                setup: 'Knee against wall or on plate.',
                execution: 'Drive knee forward past toes. Weight on whole foot. Improve dorsiflexion.'
            },
            'Thoracic Mobility': {
                setup: 'Foam roller or floor.',
                execution: 'Extensions and rotations through upper back. Open up T-spine.'
            },
            'Shoulder Mobility': {
                setup: 'PVC pipe or band helpful.',
                execution: 'Pass throughs, dislocations, wall slides. Improve shoulder ROM.'
            },
            'Hip Circles': {
                setup: 'Standing on one leg.',
                execution: 'Circle free leg forward, out, back, around. Opens hip joint.'
            },
            'Arm Circles': {
                setup: 'Standing with arms out.',
                execution: 'Circle arms forward and backward. Gradually increase size. Shoulder warm-up.'
            },
            'Leg Swings': {
                setup: 'Standing beside wall for balance.',
                execution: 'Swing leg forward and back, then side to side. Dynamic hip mobility.'
            },
            'Neck Stretches': {
                setup: 'Seated or standing.',
                execution: 'Gently tilt head each direction. Can use hand for light overpressure.'
            },
            'Active Recovery': {
                setup: 'No heavy equipment.',
                execution: 'Light movement day. Walking, easy bike, gentle stretching. Promote blood flow.'
            },
            'Light Walking': {
                setup: 'Comfortable shoes.',
                execution: 'Easy walking at conversational pace. Active recovery. Clears head.'
            },
            'Breathing Work': {
                setup: 'Comfortable position.',
                execution: 'Deep diaphragmatic breathing. Box breathing, 4-7-8, etc. Recovery and relaxation.'
            },

            // === NEW SPORT EXERCISES ===
            'Soccer Drills': {
                setup: 'Ball, cones, open space.',
                execution: 'Dribbling, passing, shooting drills. Sport-specific skill work.'
            },
            'Volleyball': {
                setup: 'Court and ball. Team.',
                execution: 'Jump-heavy sport. Great for athleticism and conditioning.'
            },
            'Badminton': {
                setup: 'Racket, shuttle, court.',
                execution: 'Fast reflexes and quick direction changes. Good cardio.'
            },
            'Rock Climbing': {
                setup: 'Climbing gym or outdoor routes. Proper gear.',
                execution: 'Full body pulling and grip work. Mental challenge too.'
            },
            'Bouldering': {
                setup: 'Bouldering gym or outdoor boulders. Crash pad.',
                execution: 'Short climbing problems. No rope. Power and technique focused.'
            },
            'Golf': {
                setup: 'Clubs, course or range.',
                execution: 'Rotational sport. Good walking. Low intensity cardiovascular.'
            },
            'Racquetball': {
                setup: 'Racket, ball, court.',
                execution: 'High intensity enclosed court sport. Fast reactions.'
            },
            'Squash': {
                setup: 'Racket, ball, court.',
                execution: 'Similar to racquetball. Great cardio. Quick direction changes.'
            },
            'Ultimate Frisbee': {
                setup: 'Disc, field, players.',
                execution: 'Running, throwing, catching. Sprint intervals built in.'
            },
            'Flag Football': {
                setup: 'Football, flags, field.',
                execution: 'Sprinting, cutting, throwing. Good conditioning.'
            },
            'Martial Arts': {
                setup: 'Dojo or gym. Appropriate attire.',
                execution: 'Various styles available. Combines conditioning, skill, discipline.'
            },
            'Boxing Training': {
                setup: 'Gloves, wraps, bag or mitts.',
                execution: 'Bag work, mitt work, shadow boxing, conditioning. Great full body workout.'
            },
            'Wrestling': {
                setup: 'Mat, wrestling gear.',
                execution: 'Grappling, takedowns, conditioning. Very physically demanding.'
            },
            'Jiu-Jitsu': {
                setup: 'Gi or no-gi attire. Mat.',
                execution: 'Ground-based grappling. Great problem solving and conditioning.'
            },
            'Track Workout': {
                setup: 'Track or measured distance.',
                execution: 'Intervals, tempo runs, speed work. Structured running training.'
            },
            'Sprint Training': {
                setup: 'Open field or track.',
                execution: 'Short bursts at max speed. Build explosiveness. Full recovery between.'
            },
            'Agility Training': {
                setup: 'Cones, ladder, or other equipment.',
                execution: 'Quick feet drills, direction changes, reactive movements.'
            },

            // === NEW MACHINE EXERCISES ===
            'Cable Crossover': {
                setup: 'High cables. Step forward between machines.',
                execution: 'Bring handles together in front in arc. Squeeze chest. Cable fly standing.'
            },
            'Assisted Pull-Up Machine': {
                setup: 'Select counterweight. Knee or foot on pad.',
                execution: 'Pull-up with assistance from machine. Build up to unassisted.'
            },
            'Shoulder Press Machine': {
                setup: 'Adjust seat so handles at shoulder level.',
                execution: 'Press handles overhead. Good for those with stability issues.'
            },
            'Belt Squat Machine': {
                setup: 'Belt around hips. Stand on platform.',
                execution: 'Squat without spinal loading. Great for back issues or extra leg volume.'
            },
            'Leg Extension Machine': {
                setup: 'Sit with back against pad. Ankles behind roller.',
                execution: 'Extend legs fully. Squeeze quads. Control return.'
            },
            'Leg Curl Machine': {
                setup: 'Position in lying or seated leg curl.',
                execution: 'Curl heels toward glutes. Isolated hamstring work.'
            },
            'Calf Raise Machine': {
                setup: 'Shoulders under pads. Balls of feet on platform.',
                execution: 'Raise heels as high as possible. Lower for full stretch.'
            },
            'Preacher Curl Machine': {
                setup: 'Sit at machine with arms on pad.',
                execution: 'Curl against machine resistance. Isolated bicep work.'
            },
            'Torso Rotation Machine': {
                setup: 'Sit in machine with pad against chest.',
                execution: 'Rotate torso against resistance. Works obliques.'
            },
            'Treadmill': {
                setup: 'Set speed and incline as desired.',
                execution: 'Walk, jog, or run. Various programs available.'
            },
            'Elliptical Machine': {
                setup: 'Adjust resistance and incline.',
                execution: 'Smooth elliptical motion. Low impact cardio.'
            },
            'Stair Stepper': {
                setup: 'Adjust intensity/resistance.',
                execution: 'Step continuously. Glute and cardio focus. Don\'t lean on rails.'
            },
            'Rowing Machine': {
                setup: 'Strap feet. Grip handle.',
                execution: 'Drive with legs, lean back, pull to chest. Full body cardio.'
            },
            'Recumbent Bike': {
                setup: 'Adjust seat distance. Sit back.',
                execution: 'Pedal in reclined position. Easier on back than upright.'
            }
        };

        // Exercise categories for filtering in workout editor
        const EXERCISE_CATEGORIES = {
            'Upper Push': [
                // Barbell Pressing
                'Barbell Bench Press', 'Close Grip Bench', 'Pause Bench Press', 'Decline Bench', 'Incline Barbell Press',
                'Floor Press', 'Spoto Press', 'Larsen Press', 'Board Press', 'Pin Press',
                'Overhead Press', 'Push Press', 'Jerk Press', 'Z Press', 'Seated Barbell OHP',
                // Dumbbell Pressing
                'Incline DB Press', 'Flat DB Press', 'Decline DB Press', 'DB Overhead Press', 'Seated DB OHP',
                'Arnold Press', 'Single-Arm DB Press', 'Neutral Grip DB Press', 'DB Squeeze Press',
                // Machine/Cable Pressing
                'Machine Chest Press', 'Incline Machine Press', 'Smith Machine Bench', 'Smith Machine Incline',
                'Hammer Strength Press', 'Cable Chest Press', 'Landmine Press', 'Viking Press (Landmine)',
                // Dips
                'Weighted Dips', 'Ring Dips', 'Dips', 'Bench Dips', 'Korean Dips',
                // Push-Ups
                'Push-Ups', 'Decline Push-Ups', 'Incline Push-Ups', 'Diamond Push-Ups', 'Wide Push-Ups',
                'Plyo Push-Ups', 'Depth Push-Ups', 'Push-Up Variations', 'Archer Push-Ups', 'Pike Push-Ups',
                'Pseudo Planche Push-Ups', 'Hindu Push-Ups', 'Spiderman Push-Ups',
                // Flyes
                'Cable Flyes', 'DB Flyes', 'Incline DB Flyes', 'Pec Deck', 'Machine Flyes', 'Low Cable Flyes'
            ],
            'Upper Pull': [
                // Pull-Ups/Chin-Ups
                'Pull-Ups', 'Chin-Ups', 'Wide Grip Pull-Ups', 'Close Grip Pull-Ups', 'Neutral Grip Pull-Ups',
                'Weighted Pull-Ups', 'Weighted Chin-Ups', 'Clapping Pull-Ups', 'Muscle-Ups', 'Archer Pull-Ups',
                'Typewriter Pull-Ups', 'L-Sit Pull-Ups', 'Commando Pull-Ups', 'Mixed Grip Pull-Ups',
                // Barbell Rows
                'Barbell Rows', 'Pendlay Rows', 'Yates Row', 'Underhand Barbell Row',
                // Dumbbell Rows
                'Single-Arm DB Row', 'Kroc Rows', 'Incline DB Row', 'Renegade Rows', 'Gorilla Rows',
                // Cable/Machine Rows
                'Cable Rows', 'Single-Arm Cable Row', 'Face Pulls', 'Straight Arm Pulldown', 'High Cable Row',
                // Other Rows
                'Meadows Row', 'T-Bar Row', 'Chest-Supported Row', 'Seal Rows',
                'Inverted Rows', 'TRX Rows', 'Helms Row', 'Machine Row', 'Hammer Strength Row',
                // Pulldowns
                'Lat Pulldown', 'Wide Grip Pulldown', 'Close Grip Pulldown', 'Reverse Grip Pulldown',
                'Single-Arm Pulldown', 'Behind Neck Pulldown', 'V-Bar Pulldown',
                // Rear Delts
                'Rear Delt Flyes', 'Band Pull-Aparts', 'Reverse Flyes', 'Reverse Pec Deck', 'Cable Rear Delt Fly',
                // Shrugs
                'Barbell Shrugs', 'DB Shrugs', 'Trap Bar Shrugs', 'Cable Shrugs', 'Behind Back Shrugs',
                // Shoulders (lateral/front)
                'Lateral Raises', 'Cable Lateral Raises', 'Machine Lateral Raises', 'Leaning Lateral Raises',
                'Cable Upright Rows', 'Front Raises', 'DB Front Raises', 'Plate Front Raises',
                'Lu Raises', 'Prone Y Raises', 'Prone I Raises', 'Prone T Raises'
            ],
            'Quads': [
                // Squats
                'High Bar Back Squat', 'Low Bar Back Squat', 'Front Squat', 'Front Squat (Heavy)', 'Safety Bar Squat',
                'Goblet Squat', 'Goblet Squat (Heavy)', 'Zercher Squat', 'Box Squat', 'Pause Squat',
                'Pin Squat', 'Anderson Squat', 'Tempo Squat', 'Heel Elevated Squat',
                'Hack Squat', 'Pendulum Squat', 'Smith Machine Squat', 'Belt Squat',
                'Sissy Squat', 'Spanish Squat', 'Cyclist Squat',
                // Leg Press Variations
                'Leg Press', 'Single-Leg Press', 'Narrow Stance Leg Press', 'Wide Stance Leg Press', 'Feet High Leg Press',
                // Extensions
                'Leg Extensions', 'Single-Leg Extension', 'Reverse Nordic Curls',
                // Lunges/Split Squats
                'Bulgarian Split Squats', 'Skater Squats', 'Walking Lunges', 'Walking Lunges (Light)',
                'Reverse Lunges', 'Forward Lunges', 'Lateral Lunges', 'Curtsy Lunges',
                'Deficit Reverse Lunges', 'Deficit Lunges', 'Split Squats', 'Rear Foot Elevated Split Squat',
                // Step-Ups
                'Step-Ups', 'Step-Ups (Heavy)', 'Lateral Step-Ups', 'Crossover Step-Ups',
                // Machine
                'Leg Press Machine', 'V-Squat Machine', 'Hack Squat Machine'
            ],
            'Hamstrings/Glutes': [
                // Deadlifts
                'Trap Bar Deadlift', 'Conventional Deadlift', 'Sumo Deadlift', 'Deficit Deadlift',
                'Block Pull', 'Rack Pull', 'Pause Deadlift', 'Snatch Grip Deadlift',
                'Stiff-Leg Deadlift', 'Dumbbell Deadlift',
                // Romanian Deadlifts
                'Romanian Deadlift', 'Snatch Grip RDL', 'Single-Leg RDL', 'DB Romanian Deadlift',
                'Deficit RDL', 'B-Stance RDL', 'Kickstand RDL',
                // Hip Hinges
                'Good Mornings', 'Seated Good Mornings', 'Cable Pull-Through', 'Kettlebell Swing',
                // Hamstring Curls
                'Leg Curls', 'Lying Leg Curls', 'Seated Leg Curls', 'Standing Leg Curls',
                'Nordic Curls', 'Slider Leg Curls', 'Physioball Leg Curls', 'Banded Leg Curls',
                // Glute Focused
                'Glute-Ham Raises', 'Hip Thrusts', 'Barbell Hip Thrusts', 'Single-Leg Hip Thrust',
                'Glute Bridge', 'Single-Leg Glute Bridge', 'Frog Pumps', 'B-Stance Hip Thrust',
                'Cable Kickbacks', 'Donkey Kicks', 'Fire Hydrants', 'Clamshells',
                'Glute Kickback Machine', 'Hip Abduction Machine', 'Hip Adduction Machine',
                '45-Degree Back Extension', 'Reverse Hyperextension', 'GHD Hip Extension',
                // KB/DB
                'KB Deadlift', 'KB Swing', 'KB Single-Leg Deadlift', 'Sumo DB Squat'
            ],
            'Core': [
                // Planks
                'Plank', 'Side Plank', 'Plank Variations', 'Plank Circuit', 'RKC Plank',
                'Long Lever Plank', 'Body Saw Plank', 'Plank to Push-Up', 'Plank Shoulder Taps',
                'Copenhagen Plank', 'Reverse Plank', 'Weighted Plank',
                // Hollow/Anti-Extension
                'Hollow Body Hold', 'Dead Bugs', 'Bird Dogs', 'Ab Wheel Rollouts', 'Barbell Rollouts',
                'TRX Fallouts', 'Stability Ball Rollouts', 'Body Saw', 'Inchworms',
                // Hanging
                'Toes to Bar', 'Hanging Leg Raises', 'Hanging Core', 'Hanging Knee Raises',
                'Hanging Windshield Wipers', 'Hanging L-Sit', 'Captain Chair Leg Raises',
                // Floor Abs
                'Dragon Flags', 'Decline Sit-Ups', 'Leg Raises', 'V-Ups', 'Sit-Ups',
                'Crunches', 'Reverse Crunches', 'Toe Touches', 'Jackknife Sit-Ups',
                'Scissor Kicks', 'Flutter Kicks', 'Bicycle Kicks', 'Dead Bug Variations',
                // Rotation/Obliques
                'Russian Twists', 'Bicycle Crunches', 'Oblique Crunches', 'Side Crunches',
                'Pallof Press', 'Landmine Rotations', 'Cable Woodchops', 'Med Ball Russian Twist',
                'Windmill', 'Half-Kneeling Chop', 'Half-Kneeling Lift',
                // Carries
                'Farmer Carry', 'Suitcase Carry', 'Overhead Carry', 'Zercher Carries',
                'Heavy Carries + Plank', 'Loaded Carries', 'Cross-Body Carry', 'Bottoms-Up Carry', 'Waiter Walk',
                // Turkish Get-Up
                'Turkish Get-Up', 'Half Turkish Get-Up',
                // Circuits
                'Anti-Extension Circuit', 'Rotational Core', 'Compression Circuit',
                'Anti-Rotation Circuit', 'Anti-Rotation Complex', 'Explosive Core', 'Isometric Hold Circuit',
                // Cable/Machine
                'Cable Crunch', 'Machine Crunch', 'Rope Crunch', 'High Cable Crunch'
            ],
            'Plyos': [
                // Low-Level Plyos
                'Pogo Hops', 'Lateral Line Hops', 'Single-Leg Hops', 'Banded Lateral Hops',
                'A-Skips', 'B-Skips', 'High Skips', 'Lateral Skater Hops', 'Lateral Bounds',
                'Diagonal Bounds', 'Cone Shuffles', 'Carioca Drill', 'Ladder Drills',
                'Quick Feet', 'Dot Drills', 'Ankle Bounces', 'Fast Feet',
                // Box Jumps
                'Box Jumps', 'Box Jump (Forward)', '180Â° Box Jumps', 'Single-Leg Box Jumps',
                'Seated Box Jumps', 'Weighted Box Jumps', 'Step Box Jumps',
                // Depth/Reactive
                'Depth Jumps', 'Depth Drop', 'Altitude Drop', 'Reactive Box Jump',
                // Hurdles
                'Hurdle Hops', 'Hurdle Jumps', 'Lateral Hurdle Hops', 'Single-Leg Hurdle Hops',
                // Broad Jumps
                'Broad Jumps', 'Single-Leg Broad Jump', 'Banded Broad Jumps', 'Standing Triple Jump',
                // Banded
                'Banded Lateral Jumps', 'Banded Vertical Jumps', 'Banded Squat Jumps',
                // Med Ball Power
                'Med Ball Chest Pass', 'Med Ball Overhead Throws', 'Med Ball Rotational Throws',
                'Med Ball Slams', 'Med Ball Rotational Slams', 'Med Ball Scoop Throw',
                'Med Ball Shot Put', 'Med Ball Granny Throw', 'Med Ball Reverse Throw',
                // Upper Body Plyos
                'Light DB Punch', 'Band Speed Punches', 'Clap Push-Ups', 'Explosive Push-Ups',
                // Jumping
                'Squat Jumps', 'Tuck Jumps', 'Star Jumps', 'Split Squat Jumps', 'Lunge Jumps',
                'Vertical Jumps', 'Countermovement Jump', 'Drop Jump'
            ],
            'HIIT/Cardio': [
                // Circuits
                'Circuit A - Bodyweight HIIT', 'Circuit B - Treadmill Sprints', 'Tabata',
                // Bodyweight HIIT
                'Burpees', 'Jump Squats', 'Mountain Climbers', 'High Knees', 'Jumping Lunges', 'Sprawls',
                'Jumping Jacks', 'Butt Kicks', 'Speed Skaters', 'Plank Jacks', 'Squat Thrusts',
                'Bear Crawls', 'Frog Jumps', 'Ice Skaters', 'Pop Squats', 'Star Jumps',
                // Treadmill
                'Treadmill Sprint', 'Treadmill Sprints', 'Incline Treadmill Walk', 'Incline Treadmill Walk (40min)',
                'Treadmill Intervals', 'Hill Sprints', 'Treadmill Jog',
                // Bike
                'Assault Bike', 'Assault Bike Sprint', 'Assault Bike Intervals',
                'Stationary Bike', 'Stationary Bike (40min)', 'Spin Bike', 'HIIT Cycling',
                'Bike Sprints', 'Bike Intervals', 'Airdyne Bike',
                // Rowing
                'Rowing Sprint', 'Row Intervals', 'Rowing (Easy Pace)', 'Rowing Machine (Easy)',
                // Sled/Prowler
                'Sled Push', 'Sled Drag', 'Sled Work', 'Prowler Push', 'Prowler Sprint',
                'Reverse Sled Drag', 'Lateral Sled Drag',
                // Other Machines
                'Battle Ropes', 'KB Swings', 'Kettlebell Swings (Heavy)', 'KB Snatches',
                'Ski Erg Sprint', 'Ski Erg Intervals', 'Versa Climber', 'Stair Climber',
                'Jacob\'s Ladder', 'Echo Bike',
                // Steady State
                'Bodyweight Circuit', 'Easy Jog', 'Easy Jog (40min)', 'Running',
                'Elliptical', 'Elliptical (40min)', 'Swimming', 'Swim', 'Outdoor Walk',
                'Hiking', 'Cycling Outdoors', 'Jump Rope', 'Double Unders',
                // Boxing
                'Shadow Boxing', 'Heavy Bag Work', 'Speed Bag', 'Boxing Rounds'
            ],
            'Full Body/Olympic': [
                // Olympic Lifts
                'Power Clean', 'Hang Clean', 'Clean Pull', 'Power Snatch', 'Hang Snatch',
                'Snatch Pull', 'Snatch Grip High Pull', 'Clean and Jerk', 'Clean and Press',
                'Muscle Clean', 'Muscle Snatch', 'Hang Power Clean', 'Hang Power Snatch',
                // Full Body
                'Turkish Get-Up', 'Man Maker', 'Thruster', 'DB Thruster', 'Barbell Thruster',
                'Wall Ball', 'Squat to Press', 'Burpee Box Jump', 'Devil Press',
                'Kettlebell Complex', 'Barbell Complex',
                // Throws
                'Clean High Pull', 'Snatch High Pull', 'Push Jerk', 'Split Jerk'
            ],
            'Arms': [
                // Biceps - Curls
                'Hammer Curls', 'Barbell Curls', 'Cable Curls', 'EZ Bar Curls', 'DB Curls',
                'Preacher Curls', 'Incline DB Curls', 'Concentration Curls', 'Spider Curls',
                'Reverse Curls', 'Zottman Curls', 'Cross Body Curls', 'Cable Hammer Curls',
                '21s Curls', 'Drag Curls', 'Bayesian Curls', 'Waiter Curls',
                'Machine Curl', 'Cable Preacher Curl', 'High Cable Curl',
                // Triceps - Extensions
                'Overhead Tricep Extension', 'Skull Crushers', 'Rope Pushdowns', 'V-Bar Pushdowns',
                'Straight Bar Pushdowns', 'Single-Arm Pushdown', 'Kickbacks', 'DB Kickbacks',
                'Cable Overhead Extension', 'DB Overhead Extension', 'JM Press', 'Tate Press',
                'Close Grip Push-Ups', 'Diamond Push-Ups', 'Tricep Dips', 'Bench Dips',
                'Machine Tricep Extension', 'Lying Tricep Extension', 'French Press',
                // Forearms
                'Wrist Curls', 'Reverse Wrist Curls', 'Farmer Holds', 'Plate Pinch',
                'Dead Hangs', 'Towel Hangs', 'Fat Grip Curls', 'Wrist Roller'
            ],
            'Calves': [
                'Standing Calf Raises', 'Seated Calf Raises', 'Calf Press on Leg Press',
                'Single-Leg Calf Raise', 'Donkey Calf Raises', 'Smith Machine Calf Raises',
                'Machine Calf Raises', 'Deficit Calf Raises', 'Bent Knee Calf Raises',
                'Tibialis Raises', 'Tib Bar Raises', 'Toe Walks', 'Heel Walks'
            ],
            'Mobility/Recovery': [
                // Flows
                'Lower Body Flow', 'Upper Body Flow', 'Full Body Yoga Flow', 'Yoga Flow', 'Dynamic Mobility',
                'Morning Mobility', 'Pre-Workout Mobility', 'Post-Workout Mobility', 'Hip Flow',
                // Foam Rolling/Soft Tissue
                'Foam Rolling Session', 'Foam Roll Quads', 'Foam Roll IT Band', 'Foam Roll Lats',
                'Lacrosse Ball Work', 'Trigger Point Release', 'Self-Massage',
                // Stretching
                'Lower Body Stretching', 'Upper Body Stretching', 'Full Body Stretching',
                'Hip Flexor Stretch', 'Hamstring Stretch', 'Quad Stretch', 'Calf Stretch',
                'Chest Stretch', 'Lat Stretch', 'Shoulder Stretch', 'Tricep Stretch',
                '90/90 Stretch', 'Pigeon Pose', 'World\'s Greatest Stretch', 'Couch Stretch',
                'Frog Stretch', 'Butterfly Stretch', 'Seated Forward Fold', 'Cat-Cow',
                // Specific Areas
                'Hip Mobility', 'Ankle Mobility', 'Thoracic Mobility', 'Shoulder Mobility',
                'Hip Circles', 'Arm Circles', 'Leg Swings', 'Neck Stretches',
                // Recovery
                'Skip Core Today', 'Skip Core', 'Active Recovery', 'Light Walking', 'Breathing Work'
            ],
            'Sport': [
                'Pickup Soccer', 'Soccer Drills', 'Tennis', 'MMA Training', 'Basketball',
                'Volleyball', 'Badminton', 'Rock Climbing', 'Bouldering', 'Golf',
                'Racquetball', 'Squash', 'Ultimate Frisbee', 'Flag Football',
                'Martial Arts', 'Boxing Training', 'Wrestling', 'Jiu-Jitsu',
                'Track Workout', 'Sprint Training', 'Agility Training'
            ],
            'Machines': [
                // Chest
                'Machine Chest Press', 'Incline Machine Press', 'Pec Deck', 'Cable Crossover',
                // Back
                'Lat Pulldown', 'Machine Row', 'Hammer Strength Row', 'Assisted Pull-Up Machine',
                // Shoulders
                'Shoulder Press Machine', 'Machine Lateral Raises', 'Reverse Pec Deck',
                // Legs
                'Leg Press Machine', 'Hack Squat Machine', 'Smith Machine Squat', 'Belt Squat Machine',
                'Leg Extension Machine', 'Leg Curl Machine', 'Hip Abduction Machine', 'Hip Adduction Machine',
                'Glute Kickback Machine', 'Calf Raise Machine',
                // Arms
                'Machine Curl', 'Machine Tricep Extension', 'Preacher Curl Machine',
                // Core
                'Machine Crunch', 'Cable Crunch', 'Torso Rotation Machine',
                // Cardio Machines
                'Treadmill', 'Elliptical Machine', 'Stair Stepper', 'Rowing Machine',
                'Assault Bike', 'Spin Bike', 'Recumbent Bike'
            ]
        };

        // Custom workouts storage (user modifications and new workouts)
        let customWorkouts = {};
        let customExercises = {};
        let weightLog = {}; // { 'YYYY-MM-DD': weight }
        let hiddenWorkouts = []; // Array of hidden workout keys

        // Home screen widget configuration
        let homeWidgets = [
            { id: 'weekly', type: 'weekly', enabled: true },
            { id: 'workouts', type: 'workouts', enabled: true },
            { id: 'weight', type: 'weight', enabled: true }
        ];
        let homeEditMode = false;

        // Workouts page widget configuration
        let workoutsPageWidgets = [
            { id: 'wp-workouts', type: 'workouts', enabled: true },
            { id: 'wp-monthly', type: 'monthlyCounter', enabled: true },
            { id: 'wp-streak', type: 'streak', enabled: true }
        ];
        let workoutsPageEditMode = false;

        // Backup of default workouts for reset functionality
        let defaultWorkoutsBackup = null;

        // Editor state
        let editingWorkout = null;
        let editingSection = null;
        let editingSectionIndex = null;

        let workoutLog = {};
        let rotationTracking = {};
        let currentView = 'home';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedCalendarDate = null;

        // Capacitor Haptics for native vibration (works on iOS)
        async function triggerVibration() {
            try {
                // Check if running in Capacitor native app
                if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                    const { Haptics } = window.Capacitor.Plugins;
                    if (Haptics) {
                        // Vibrate 3 times for notification
                        await Haptics.vibrate({ duration: 200 });
                        setTimeout(async () => await Haptics.vibrate({ duration: 200 }), 300);
                        setTimeout(async () => await Haptics.vibrate({ duration: 200 }), 600);
                        return;
                    }
                }
            } catch (e) {
                console.log('Capacitor Haptics not available');
            }

            // Fallback to web vibration API (Android)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        // Workout timer variables
        let workoutStartTime = null;
        let workoutTimer = null;
        let currentWorkoutType = null;
        let isDeloadWorkout = false;

        // Rotation recommendation thresholds (in weeks)
        const ROTATION_THRESHOLDS = {
            plyos: 4,
            mainLifts: 12,
            accessories: 8,
            core: 6
        };

        async function init() {
            await loadData();
            updateHomeScreen();
            updateDate();
            initYearSelect();
            renderCalendar();
        }

        const USER_ID = 'default_user'; // You can add authentication later for multiple users

        async function loadData() {
            // Store backup of default workouts for reset functionality
            if (!defaultWorkoutsBackup) {
                defaultWorkoutsBackup = JSON.parse(JSON.stringify(WORKOUTS));
            }

            try {
                const doc = await db.collection('users').doc(USER_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    workoutLog = data.workoutLog || {};
                    rotationTracking = data.rotationTracking || {};
                    customWorkouts = data.customWorkouts || {};
                    customExercises = data.customExercises || {};
                    customWorkoutIcons = data.customWorkoutIcons || {};
                    weightLog = data.weightLog || {};
                    hiddenWorkouts = data.hiddenWorkouts || [];
                    if (data.homeWidgets) homeWidgets = data.homeWidgets;
                    if (data.workoutsPageWidgets) workoutsPageWidgets = data.workoutsPageWidgets;
                    console.log('Data loaded from Firebase');
                    return;
                }
            } catch (e) {
                console.log('Firebase not available, falling back to localStorage:', e);
            }
            // Fallback to localStorage
            const saved = localStorage.getItem('workoutLog');
            if (saved) {
                workoutLog = JSON.parse(saved);
            }
            const savedRotations = localStorage.getItem('rotationTracking');
            if (savedRotations) {
                rotationTracking = JSON.parse(savedRotations);
            }
            const savedCustomWorkouts = localStorage.getItem('customWorkouts');
            if (savedCustomWorkouts) {
                customWorkouts = JSON.parse(savedCustomWorkouts);
            }
            const savedCustomExercises = localStorage.getItem('customExercises');
            if (savedCustomExercises) {
                customExercises = JSON.parse(savedCustomExercises);
            }
            const savedWeightLog = localStorage.getItem('weightLog');
            if (savedWeightLog) {
                weightLog = JSON.parse(savedWeightLog);
            }
            const savedHiddenWorkouts = localStorage.getItem('hiddenWorkouts');
            if (savedHiddenWorkouts) {
                hiddenWorkouts = JSON.parse(savedHiddenWorkouts);
            }
            const savedHomeWidgets = localStorage.getItem('homeWidgets');
            if (savedHomeWidgets) {
                homeWidgets = JSON.parse(savedHomeWidgets);
            }
            const savedWorkoutsPageWidgets = localStorage.getItem('workoutsPageWidgets');
            if (savedWorkoutsPageWidgets) {
                workoutsPageWidgets = JSON.parse(savedWorkoutsPageWidgets);
            }
            const savedCustomWorkoutIcons = localStorage.getItem('customWorkoutIcons');
            if (savedCustomWorkoutIcons) {
                customWorkoutIcons = JSON.parse(savedCustomWorkoutIcons);
            }
        }

        async function saveData() {
            try {
                await db.collection('users').doc(USER_ID).set({
                    workoutLog,
                    rotationTracking,
                    customWorkouts,
                    customExercises,
                    customWorkoutIcons,
                    weightLog,
                    hiddenWorkouts,
                    homeWidgets,
                    workoutsPageWidgets,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Data saved to Firebase');
            } catch (e) {
                console.log('Firebase not available, falling back to localStorage:', e);
                // Fallback to localStorage
                localStorage.setItem('workoutLog', JSON.stringify(workoutLog));
                localStorage.setItem('rotationTracking', JSON.stringify(rotationTracking));
                localStorage.setItem('customWorkouts', JSON.stringify(customWorkouts));
                localStorage.setItem('customExercises', JSON.stringify(customExercises));
                localStorage.setItem('customWorkoutIcons', JSON.stringify(customWorkoutIcons));
                localStorage.setItem('weightLog', JSON.stringify(weightLog));
                localStorage.setItem('hiddenWorkouts', JSON.stringify(hiddenWorkouts));
                localStorage.setItem('homeWidgets', JSON.stringify(homeWidgets));
                localStorage.setItem('workoutsPageWidgets', JSON.stringify(workoutsPageWidgets));
            }
        }

        // Get effective workouts (merge defaults with custom)
        function getEffectiveWorkouts() {
            const effective = { ...WORKOUTS };
            // Apply custom modifications
            Object.keys(customWorkouts).forEach(key => {
                effective[key] = customWorkouts[key];
            });
            return effective;
        }

        // Get all exercises (default + custom)
        function getAllExercises() {
            return { ...EXERCISE_DB, ...customExercises };
        }

        // Get exercises by category
        function getExercisesByCategory(category) {
            if (category === 'All') {
                return Object.keys(getAllExercises()).sort();
            }
            const defaultExercises = EXERCISE_CATEGORIES[category] || [];
            // Add custom exercises in this category
            const customInCategory = Object.keys(customExercises).filter(name =>
                customExercises[name].category === category
            );
            return [...defaultExercises, ...customInCategory].sort();
        }

        // Check if workout is modified from default
        function isWorkoutModified(workoutKey) {
            return customWorkouts.hasOwnProperty(workoutKey) &&
                   defaultWorkoutsBackup &&
                   defaultWorkoutsBackup.hasOwnProperty(workoutKey);
        }

        // Check if workout is custom (not from defaults)
        function isWorkoutCustom(workoutKey) {
            return customWorkouts.hasOwnProperty(workoutKey) &&
                   (!defaultWorkoutsBackup || !defaultWorkoutsBackup.hasOwnProperty(workoutKey));
        }

        // Reset workout to default
        function resetWorkoutToDefault(workoutKey) {
            if (defaultWorkoutsBackup && defaultWorkoutsBackup[workoutKey]) {
                delete customWorkouts[workoutKey];
                saveData();
                return true;
            }
            return false;
        }

        // ==========================================
        // WEEKLY ACTIVITY TRACKER
        // ==========================================

        function renderWeeklyTracker() {
            const container = document.getElementById('weekDays');
            if (!container) return;

            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + mondayOffset);

            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + i);
                const dateStr = dayDate.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                const hasWorkout = checkWorkoutOnDate(dateStr);

                html += `
                    <div class="day-circle">
                        <div class="day-indicator ${hasWorkout ? 'completed' : ''} ${isToday ? 'today' : ''}">
                            ${dayLabels[i]}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function checkWorkoutOnDate(dateStr) {
            // Check if there's any completed workout on this date
            const sessionKeys = Object.keys(workoutLog).filter(key =>
                key.startsWith(dateStr) && key.includes('_session_')
            );
            return sessionKeys.length > 0;
        }

        // ==========================================
        // WEIGHT TRACKER
        // ==========================================

        function renderWeightTracker() {
            const today = new Date().toISOString().split('T')[0];
            const todayWeight = weightLog[today];
            const inputRow = document.getElementById('weightInputRow');
            const todayDisplay = document.getElementById('weightToday');

            if (todayWeight !== undefined) {
                // Show today's weight, hide input
                inputRow.style.display = 'none';
                todayDisplay.style.display = 'flex';
                document.getElementById('todayWeightDisplay').textContent = `Today: ${todayWeight} lbs`;
            } else {
                // Show input, hide today's display
                inputRow.style.display = 'flex';
                todayDisplay.style.display = 'none';
            }

            renderWeightChart();
            renderWeightStats();
        }

        function saveWeight() {
            const input = document.getElementById('weightInput');
            const weight = parseFloat(input.value);

            if (isNaN(weight) || weight <= 0) {
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            weightLog[today] = weight;
            saveData();
            input.value = '';
            renderWeightTracker();
        }

        function editTodayWeight() {
            const today = new Date().toISOString().split('T')[0];
            const currentWeight = weightLog[today];

            document.getElementById('weightInputRow').style.display = 'flex';
            document.getElementById('weightToday').style.display = 'none';
            document.getElementById('weightInput').value = currentWeight || '';
            document.getElementById('weightInput').focus();
        }

        function renderWeightChart() {
            const canvas = document.getElementById('weightChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Set canvas size for retina displays
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);

            // Get last 30 days of data
            const entries = getLast30DaysWeight();

            if (entries.length === 0) {
                ctx.fillStyle = '#8e8e93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No weight data yet', width / 2, height / 2);
                return;
            }

            // Calculate chart dimensions
            const padding = { top: 20, right: 15, bottom: 25, left: 45 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Find min/max weight
            const weights = entries.map(e => e.weight);
            const minWeight = Math.min(...weights) - 2;
            const maxWeight = Math.max(...weights) + 2;
            const weightRange = maxWeight - minWeight || 1;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Draw grid lines
            ctx.strokeStyle = '#38383a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                // Y-axis labels
                const weightVal = maxWeight - (weightRange / 4) * i;
                ctx.fillStyle = '#8e8e93';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(weightVal.toFixed(0), padding.left - 8, y + 3);
            }

            // Draw line chart
            if (entries.length > 1) {
                ctx.strokeStyle = '#0a84ff';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.beginPath();

                entries.forEach((entry, i) => {
                    const x = padding.left + (i / (entries.length - 1)) * chartWidth;
                    const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Draw gradient fill under line
                const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
                gradient.addColorStop(0, 'rgba(10, 132, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(10, 132, 255, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                entries.forEach((entry, i) => {
                    const x = padding.left + (i / (entries.length - 1)) * chartWidth;
                    const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.lineTo(padding.left + chartWidth, height - padding.bottom);
                ctx.lineTo(padding.left, height - padding.bottom);
                ctx.closePath();
                ctx.fill();
            }

            // Draw data points
            ctx.fillStyle = '#0a84ff';
            entries.forEach((entry, i) => {
                const x = padding.left + (entries.length > 1 ? (i / (entries.length - 1)) * chartWidth : chartWidth / 2);
                const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;

                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function getLast30DaysWeight() {
            const entries = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                if (weightLog[dateStr] !== undefined) {
                    entries.push({
                        date: dateStr,
                        weight: weightLog[dateStr]
                    });
                }
            }
            return entries;
        }

        function renderWeightStats() {
            const container = document.getElementById('weightStats');
            if (!container) return;

            const entries = getLast30DaysWeight();

            if (entries.length === 0) {
                container.innerHTML = '';
                return;
            }

            const currentWeight = entries[entries.length - 1].weight;
            const startWeight = entries[0].weight;
            const change = currentWeight - startWeight;
            const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
            const changePrefix = change > 0 ? '+' : '';

            let avgWeight = 0;
            if (entries.length > 0) {
                avgWeight = entries.reduce((sum, e) => sum + e.weight, 0) / entries.length;
            }

            container.innerHTML = `
                <div class="weight-stat">
                    <div class="weight-stat-value">${currentWeight.toFixed(1)}</div>
                    <div class="weight-stat-label">Current</div>
                </div>
                <div class="weight-stat">
                    <div class="weight-stat-value ${changeClass}">${changePrefix}${change.toFixed(1)}</div>
                    <div class="weight-stat-label">30 Day Change</div>
                </div>
                <div class="weight-stat">
                    <div class="weight-stat-value">${avgWeight.toFixed(1)}</div>
                    <div class="weight-stat-label">Avg (30d)</div>
                </div>
            `;
        }

        // ==========================================
        // WORKOUT MANAGEMENT FUNCTIONS
        // ==========================================

        // Render the Manage Workouts screen
        function renderManageWorkouts() {
            const container = document.getElementById('manageContent');
            const effectiveWorkouts = getEffectiveWorkouts();

            let html = `
                <div class="manage-section">
                    <div class="manage-section-title">Your Workouts</div>
            `;

            // List all workouts
            Object.keys(effectiveWorkouts).forEach(key => {
                const workout = effectiveWorkouts[key];
                const isCustom = isWorkoutCustom(key);
                const isModified = isWorkoutModified(key);
                const isHidden = hiddenWorkouts.includes(key);

                let statusBadge = '';
                if (isCustom) {
                    statusBadge = '<span class="workout-badge custom">Custom</span>';
                } else if (isModified) {
                    statusBadge = '<span class="workout-badge modified">Modified</span>';
                }
                if (isHidden) {
                    statusBadge += '<span class="workout-badge hidden">Hidden</span>';
                }

                html += `
                    <div class="manage-workout-item ${isHidden ? 'hidden-workout' : ''}">
                        <div class="manage-workout-info">
                            <div class="manage-workout-name">${workout.title}</div>
                            ${statusBadge}
                        </div>
                        <div class="manage-workout-actions">
                            <button class="manage-btn ${isHidden ? 'show' : 'hide'}" onclick="toggleWorkoutVisibility('${key}')">${isHidden ? 'Show' : 'Hide'}</button>
                            <button class="manage-btn edit" onclick="openWorkoutEditor('${key}')">Edit</button>
                            ${isModified ? `<button class="manage-btn reset" onclick="confirmResetWorkout('${key}')">Reset</button>` : ''}
                            ${isCustom ? `<button class="manage-btn delete" onclick="confirmDeleteWorkout('${key}')">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <button class="create-workout-btn" onclick="createNewWorkout()">+ Create New Workout</button>
            `;

            container.innerHTML = html;
        }

        // Toggle workout visibility
        function toggleWorkoutVisibility(workoutKey) {
            const index = hiddenWorkouts.indexOf(workoutKey);
            if (index > -1) {
                hiddenWorkouts.splice(index, 1);
            } else {
                hiddenWorkouts.push(workoutKey);
            }
            saveData();
            renderManageWorkouts();
            renderWorkoutGrid();
        }

        // Confirm reset workout to default
        function confirmResetWorkout(workoutKey) {
            if (confirm(`Reset "${workoutKey}" to its original default state? This will undo all your changes.`)) {
                resetWorkoutToDefault(workoutKey);
                renderManageWorkouts();
                renderWorkoutGrid();
            }
        }

        // Confirm delete custom workout
        function confirmDeleteWorkout(workoutKey) {
            if (confirm(`Delete "${workoutKey}"? This cannot be undone.`)) {
                delete customWorkouts[workoutKey];
                saveData();
                renderManageWorkouts();
                renderWorkoutGrid();
            }
        }

        // Create a new workout
        function createNewWorkout() {
            const baseName = 'New Workout';
            let name = baseName;
            let counter = 1;
            const effectiveWorkouts = getEffectiveWorkouts();

            // Find unique name
            while (effectiveWorkouts[name]) {
                name = `${baseName} ${counter}`;
                counter++;
            }

            // Create new workout structure
            editingWorkout = {
                key: name,
                isNew: true,
                data: {
                    title: name,
                    duration: '45-60 min',
                    focus: '',
                    isCustom: true,
                    sections: []
                }
            };

            showScreen('workoutEditor');
            renderWorkoutEditor();
        }

        // Open workout editor for existing workout
        function openWorkoutEditor(workoutKey) {
            const effectiveWorkouts = getEffectiveWorkouts();
            const workout = effectiveWorkouts[workoutKey];

            if (!workout) return;

            editingWorkout = {
                key: workoutKey,
                originalKey: workoutKey,
                isNew: false,
                data: JSON.parse(JSON.stringify(workout)) // Deep copy
            };

            showScreen('workoutEditor');
            renderWorkoutEditor();
        }

        // Render the workout editor screen
        function renderWorkoutEditor() {
            if (!editingWorkout) return;

            const workout = editingWorkout.data;
            const title = editingWorkout.isNew ? 'Create Workout' : `Edit: ${editingWorkout.originalKey}`;
            document.getElementById('workoutEditorTitle').textContent = title;

            let sectionsHtml = '';
            if (workout.sections && workout.sections.length > 0) {
                workout.sections.forEach((section, idx) => {
                    const sectionType = getSectionTypeLabel(section);
                    const exerciseCount = getSectionExerciseCount(section);

                    sectionsHtml += `
                        <div class="section-list-item" draggable="true" data-idx="${idx}">
                            <div class="section-drag-handle">â‰¡</div>
                            <div class="section-list-info">
                                <div class="section-list-name">${section.title || 'Untitled Section'}</div>
                                <div class="section-list-meta">Type: ${sectionType} â€¢ ${exerciseCount}</div>
                            </div>
                            <div class="section-list-actions">
                                <button class="manage-btn edit" onclick="openSectionEditor(${idx})">Edit</button>
                                <button class="manage-btn delete" onclick="deleteSection(${idx})">âœ•</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                sectionsHtml = '<div class="empty-state">No sections yet. Add a section to get started.</div>';
            }

            // Get current icon for this workout
            const workoutKey = editingWorkout.originalKey || editingWorkout.key;
            const currentIconKey = customWorkoutIcons[workoutKey] || editingWorkout.data.iconKey || '';
            const defaultIcon = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6" y2="14"/><line x1="18" y1="10" x2="18" y2="14"/></svg>';
            const currentIcon = currentIconKey ? AVAILABLE_WORKOUT_ICONS[currentIconKey] : (workoutIcons[workoutKey] || defaultIcon);

            const html = `
                <div class="editor-form">
                    <div class="editor-field">
                        <label class="editor-label">Workout Icon</label>
                        <div class="icon-picker-preview" onclick="openIconPicker()">
                            <div class="icon-picker-current" id="currentWorkoutIcon">${currentIcon}</div>
                            <span>Tap to change</span>
                        </div>
                        <input type="hidden" id="workoutIconInput" value="${escapeHtml(currentIconKey)}">
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Workout Name</label>
                        <input type="text" class="editor-input" id="workoutNameInput" value="${escapeHtml(workout.title)}" placeholder="e.g., Upper Body Push">
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Duration</label>
                        <input type="text" class="editor-input" id="workoutDurationInput" value="${escapeHtml(workout.duration || '')}" placeholder="e.g., 60-75 min">
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Focus (optional)</label>
                        <textarea class="editor-textarea" id="workoutFocusInput" placeholder="Brief description of workout focus">${escapeHtml(workout.focus || '')}</textarea>
                    </div>
                </div>

                <div class="manage-section" style="margin-top: 24px;">
                    <div class="manage-section-title">Sections</div>
                    <div class="section-list" id="sectionList">
                        ${sectionsHtml}
                    </div>
                    <button class="create-workout-btn" onclick="addNewSection()" style="margin-top: 16px;">+ Add Section</button>
                </div>
            `;

            document.getElementById('workoutEditorContent').innerHTML = html;
        }

        // Get section type label
        function getSectionTypeLabel(section) {
            if (section.supersets && section.supersets.length > 0) return 'Superset';
            if (section.circuitOptions && section.circuitOptions.length > 0) return 'Circuit (Options)';
            if (section.exercises && section.exercises.length > 0) {
                if (section.exercises.some(ex => ex.options && ex.options.length > 0)) return 'Options';
            }
            return 'Regular';
        }

        // Get section exercise count
        function getSectionExerciseCount(section) {
            if (section.supersets && section.supersets.length > 0) {
                return `${section.supersets.length} superset(s)`;
            }
            if (section.exercises) {
                return `${section.exercises.length} exercise(s)`;
            }
            return '0 exercises';
        }

        // Get local date string in YYYY-MM-DD format (avoids timezone issues with toISOString)
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cancel workout editor
        function cancelWorkoutEditor() {
            editingWorkout = null;
            showScreen('manage');
            renderManageWorkouts();
        }

        // Save workout editor
        function saveWorkoutEditor() {
            if (!editingWorkout) return;

            // Get values from form
            const name = document.getElementById('workoutNameInput').value.trim();
            const duration = document.getElementById('workoutDurationInput').value.trim();
            const focus = document.getElementById('workoutFocusInput').value.trim();

            if (!name) {
                alert('Please enter a workout name.');
                return;
            }

            // Check for name conflicts
            const effectiveWorkouts = getEffectiveWorkouts();
            if (name !== editingWorkout.key && effectiveWorkouts[name]) {
                alert('A workout with this name already exists. Please choose a different name.');
                return;
            }

            // Get icon selection
            const iconKey = document.getElementById('workoutIconInput').value;

            // Update workout data
            editingWorkout.data.title = name;
            editingWorkout.data.duration = duration;
            editingWorkout.data.focus = focus;
            editingWorkout.data.iconKey = iconKey;

            // If name changed and it's an existing workout
            if (editingWorkout.originalKey && name !== editingWorkout.originalKey) {
                // Delete old key if it was in customWorkouts
                if (customWorkouts[editingWorkout.originalKey]) {
                    delete customWorkouts[editingWorkout.originalKey];
                }
                // Also move custom icon to new key
                if (customWorkoutIcons[editingWorkout.originalKey]) {
                    delete customWorkoutIcons[editingWorkout.originalKey];
                }
            }

            // Save custom icon
            if (iconKey) {
                customWorkoutIcons[name] = iconKey;
            } else {
                delete customWorkoutIcons[name];
            }

            // Mark as modified or custom
            if (!editingWorkout.isNew && defaultWorkoutsBackup[editingWorkout.originalKey]) {
                editingWorkout.data.isModified = true;
                editingWorkout.data.originalKey = editingWorkout.originalKey;
            } else {
                editingWorkout.data.isCustom = true;
            }

            // Save to customWorkouts
            customWorkouts[name] = editingWorkout.data;
            saveData();

            editingWorkout = null;
            showScreen('manage');
            renderManageWorkouts();
            renderWorkoutGrid();
        }

        // Open icon picker modal
        function openIconPicker() {
            const currentIconKey = document.getElementById('workoutIconInput').value;

            let modal = document.getElementById('iconPickerModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'iconPickerModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            let iconsHtml = '';
            Object.keys(AVAILABLE_WORKOUT_ICONS).forEach(key => {
                const isSelected = key === currentIconKey;
                iconsHtml += `
                    <div class="icon-picker-item ${isSelected ? 'selected' : ''}" onclick="selectWorkoutIcon('${key}')">
                        ${AVAILABLE_WORKOUT_ICONS[key]}
                    </div>
                `;
            });

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px;">
                    <div class="modal-header">
                        <h3>Choose Icon</h3>
                        <button class="modal-close" onclick="document.getElementById('iconPickerModal').classList.remove('active')">&times;</button>
                    </div>
                    <div class="icon-picker-grid">
                        ${iconsHtml}
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        // Select workout icon
        function selectWorkoutIcon(iconKey) {
            document.getElementById('workoutIconInput').value = iconKey;
            document.getElementById('currentWorkoutIcon').innerHTML = AVAILABLE_WORKOUT_ICONS[iconKey];
            document.getElementById('iconPickerModal').classList.remove('active');
        }

        // Delete a section from the editing workout
        function deleteSection(idx) {
            if (!editingWorkout || !editingWorkout.data.sections) return;

            if (confirm('Delete this section?')) {
                editingWorkout.data.sections.splice(idx, 1);
                renderWorkoutEditor();
            }
        }

        // Add new section
        function addNewSection() {
            if (!editingWorkout) return;

            if (!editingWorkout.data.sections) {
                editingWorkout.data.sections = [];
            }

            const newSection = {
                title: 'New Section',
                exercises: []
            };

            editingSectionIndex = editingWorkout.data.sections.length;
            editingSection = JSON.parse(JSON.stringify(newSection));
            editingWorkout.data.sections.push(newSection);

            showScreen('sectionEditor');
            renderSectionEditor();
        }

        // Open section editor
        function openSectionEditor(idx) {
            if (!editingWorkout || !editingWorkout.data.sections[idx]) return;

            editingSectionIndex = idx;
            editingSection = JSON.parse(JSON.stringify(editingWorkout.data.sections[idx]));

            showScreen('sectionEditor');
            renderSectionEditor();
        }

        // Render section editor
        function renderSectionEditor() {
            if (!editingSection) return;

            const section = editingSection;
            const title = section.title ? `Edit: ${section.title}` : 'Edit Section';
            document.getElementById('sectionEditorTitle').textContent = title;

            // Determine section type
            let sectionType = 'regular';
            if (section.supersets && section.supersets.length > 0) {
                sectionType = 'superset';
            } else if (section.circuitOptions && section.circuitOptions.length > 0) {
                sectionType = 'circuit';
            } else if (section.exercises && section.exercises.some(ex => ex.options && ex.options.length > 0)) {
                sectionType = 'options';
            }

            // Build exercises list HTML
            let exercisesHtml = '';
            if (sectionType === 'superset' && section.supersets) {
                section.supersets.forEach((ss, ssIdx) => {
                    const ex1 = ss.exercises ? ss.exercises[0] : ss.exercise1;
                    const ex2 = ss.exercises ? ss.exercises[1] : ss.exercise2;
                    exercisesHtml += `
                        <div class="exercise-list-item superset-item">
                            <div class="exercise-list-info">
                                <div class="exercise-list-name">${ex1?.name || 'Exercise 1'} + ${ex2?.name || 'Exercise 2'}</div>
                                <div class="exercise-list-meta">Superset ${ssIdx + 1}</div>
                            </div>
                            <div class="exercise-list-actions">
                                <button class="manage-btn edit" onclick="editSuperset(${ssIdx})">Edit</button>
                                <button class="manage-btn delete" onclick="deleteSuperset(${ssIdx})">âœ•</button>
                            </div>
                        </div>
                    `;
                });
            } else if (section.exercises && section.exercises.length > 0) {
                section.exercises.forEach((ex, exIdx) => {
                    const rotationCount = ex.options ? ex.options.length : (ex.rotations ? ex.rotations.length : 0);
                    const rotationText = rotationCount > 0 ? `â€¢ ${rotationCount} rotation(s)` : '';

                    exercisesHtml += `
                        <div class="exercise-list-item" draggable="true" data-idx="${exIdx}">
                            <div class="exercise-drag-handle">â‰¡</div>
                            <div class="exercise-list-info">
                                <div class="exercise-list-name">${ex.name}</div>
                                <div class="exercise-list-meta">${ex.sets || 3} sets Ã— ${ex.reps || '8-12'} ${rotationText}</div>
                            </div>
                            <div class="exercise-list-actions">
                                <button class="manage-btn edit" onclick="openExerciseEditor(${exIdx})">Edit</button>
                                <button class="manage-btn delete" onclick="deleteExercise(${exIdx})">âœ•</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                exercisesHtml = '<div class="empty-state">No exercises yet. Add an exercise to get started.</div>';
            }

            // Type descriptions
            const typeDescriptions = {
                'regular': 'Do all exercises in order',
                'options': 'Pick one exercise each session (rotates)',
                'superset': 'Pair exercises to do back-to-back',
                'circuit': 'Do all exercises in sequence with minimal rest'
            };

            // Build add button based on type
            let addButtonHtml = '';
            let sectionTitle = 'Exercises';
            if (sectionType === 'superset') {
                sectionTitle = 'Superset Pairs';
                addButtonHtml = `<button class="create-workout-btn" onclick="addNewSuperset()" style="margin-top: 16px;">+ Add Superset Pair</button>`;
            } else if (sectionType === 'circuit') {
                sectionTitle = 'Circuit Exercises';
                addButtonHtml = `
                    <button class="create-workout-btn" onclick="openAddExerciseModal()" style="margin-top: 16px;">+ Add Exercise to Circuit</button>
                `;
            } else {
                addButtonHtml = `<button class="create-workout-btn" onclick="openAddExerciseModal()" style="margin-top: 16px;">+ Add Exercise</button>`;
            }

            const html = `
                <div class="editor-form">
                    <div class="editor-field">
                        <label class="editor-label">Section Name</label>
                        <input type="text" class="editor-input" id="sectionNameInput" value="${escapeHtml(section.title)}" placeholder="e.g., Main Lifts, Accessories">
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Section Type</label>
                        <select class="editor-select" id="sectionTypeSelect" onchange="onSectionTypeChange()">
                            <option value="regular" ${sectionType === 'regular' ? 'selected' : ''}>Regular</option>
                            <option value="options" ${sectionType === 'options' ? 'selected' : ''}>Options (pick one)</option>
                            <option value="superset" ${sectionType === 'superset' ? 'selected' : ''}>Superset</option>
                            <option value="circuit" ${sectionType === 'circuit' ? 'selected' : ''}>Circuit</option>
                        </select>
                        <div class="type-description">${typeDescriptions[sectionType]}</div>
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Section Notes (optional)</label>
                        <textarea class="editor-textarea" id="sectionNotesInput" placeholder="Brief notes about this section">${escapeHtml(section.notes || '')}</textarea>
                    </div>
                </div>

                <div class="manage-section" style="margin-top: 24px;">
                    <div class="manage-section-title">${sectionTitle}</div>
                    <div class="exercise-list" id="exerciseList">
                        ${exercisesHtml}
                    </div>
                    ${addButtonHtml}
                </div>
            `;

            document.getElementById('sectionEditorContent').innerHTML = html;
        }

        // Handle section type change
        function onSectionTypeChange() {
            const newType = document.getElementById('sectionTypeSelect').value;

            // Convert section data based on type change
            if (newType === 'superset' && !editingSection.supersets) {
                editingSection.supersets = [];
                // If there were exercises, try to pair them into supersets
                if (editingSection.exercises && editingSection.exercises.length >= 2) {
                    for (let i = 0; i < editingSection.exercises.length - 1; i += 2) {
                        editingSection.supersets.push({
                            exercises: [editingSection.exercises[i], editingSection.exercises[i + 1]]
                        });
                    }
                }
                editingSection.exercises = [];
            } else if (newType !== 'superset' && editingSection.supersets && editingSection.supersets.length > 0) {
                // Convert supersets back to exercises
                if (!editingSection.exercises) editingSection.exercises = [];
                editingSection.supersets.forEach(ss => {
                    if (ss.exercises) {
                        editingSection.exercises.push(...ss.exercises);
                    }
                });
                editingSection.supersets = [];
            }

            // Mark as circuit if needed
            if (newType === 'circuit') {
                editingSection.isCircuit = true;
            } else {
                delete editingSection.isCircuit;
            }

            renderSectionEditor();
        }

        // Cancel section editor
        function cancelSectionEditor() {
            // Revert changes
            if (editingSectionIndex !== null && editingWorkout) {
                // If it was a new section that we added, remove it
                if (editingWorkout.data.sections[editingSectionIndex] &&
                    editingWorkout.data.sections[editingSectionIndex].title === 'New Section' &&
                    (!editingWorkout.data.sections[editingSectionIndex].exercises ||
                     editingWorkout.data.sections[editingSectionIndex].exercises.length === 0)) {
                    editingWorkout.data.sections.splice(editingSectionIndex, 1);
                }
            }

            editingSection = null;
            editingSectionIndex = null;
            showScreen('workoutEditor');
            renderWorkoutEditor();
        }

        // Save section editor
        function saveSectionEditor() {
            if (!editingSection || editingSectionIndex === null || !editingWorkout) return;

            // Get values from form
            const name = document.getElementById('sectionNameInput').value.trim();
            const notes = document.getElementById('sectionNotesInput').value.trim();

            if (!name) {
                alert('Please enter a section name.');
                return;
            }

            editingSection.title = name;
            editingSection.notes = notes || undefined;

            // Save back to workout
            editingWorkout.data.sections[editingSectionIndex] = editingSection;

            editingSection = null;
            editingSectionIndex = null;
            showScreen('workoutEditor');
            renderWorkoutEditor();
        }

        // Delete exercise from section
        function deleteExercise(idx) {
            if (!editingSection || !editingSection.exercises) return;

            if (confirm('Delete this exercise?')) {
                editingSection.exercises.splice(idx, 1);
                renderSectionEditor();
            }
        }

        // Variables for exercise editing
        let editingExerciseIndex = null;
        let editingExercise = null;
        let addExerciseCallback = null;

        // Open exercise editor modal
        function openExerciseEditor(idx) {
            if (!editingSection || !editingSection.exercises || !editingSection.exercises[idx]) return;

            editingExerciseIndex = idx;
            editingExercise = JSON.parse(JSON.stringify(editingSection.exercises[idx]));

            renderExerciseEditorModal();
            document.getElementById('exerciseEditorModal').classList.add('active');
        }

        // Track which category groups are shown in the rotation editor
        let rotationCategoryGroups = [];

        // Render exercise editor modal content
        function renderExerciseEditorModal() {
            if (!editingExercise) return;

            const ex = editingExercise;
            document.getElementById('exerciseEditorTitle').textContent = `Edit: ${ex.name}`;

            // Get rotations (could be in 'options' or 'rotations' array)
            const rotations = ex.options || ex.rotations || [];

            // Initialize category groups with the primary exercise's category
            const primaryCategory = getExerciseCategory(ex.name);

            // Find categories of existing rotations
            const existingCategories = new Set([primaryCategory]);
            rotations.forEach(r => {
                const rotName = r.name || r;
                const cat = getExerciseCategory(rotName);
                existingCategories.add(cat);
            });

            rotationCategoryGroups = Array.from(existingCategories);

            const html = `
                <div class="editor-form">
                    <div class="editor-field">
                        <label class="editor-label">Exercise Name</label>
                        <input type="text" class="editor-input" id="exerciseNameInput" value="${escapeHtml(ex.name)}" readonly>
                    </div>
                    <div class="editor-row">
                        <div class="editor-field half">
                            <label class="editor-label">Sets</label>
                            <input type="number" class="editor-input" id="exerciseSetsInput" value="${ex.sets || 3}" min="1" max="20">
                        </div>
                        <div class="editor-field half">
                            <label class="editor-label">Reps</label>
                            <input type="text" class="editor-input" id="exerciseRepsInput" value="${escapeHtml(ex.reps || '8-12')}" placeholder="e.g., 8-12, AMRAP">
                        </div>
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Rest</label>
                        <input type="text" class="editor-input" id="exerciseRestInput" value="${escapeHtml(ex.rest || '90s')}" placeholder="e.g., 90s, 2-3 min">
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Notes (shown on card)</label>
                        <textarea class="editor-textarea" id="exerciseNotesInput" placeholder="Brief notes about this exercise">${escapeHtml(ex.notes || '')}</textarea>
                    </div>

                    <div class="editor-field">
                        <label class="editor-label">Rotation Options</label>
                        <div id="rotationGroupsContainer">
                            <!-- Category groups rendered here -->
                        </div>
                        <button type="button" class="add-category-btn" onclick="showAddCategoryDropdown()">+ Add Another Category</button>
                        <div id="addCategoryDropdown" class="add-category-dropdown" style="display: none;">
                            <select class="editor-select" id="newCategorySelect">
                                ${Object.keys(EXERCISE_CATEGORIES).map(c =>
                                    `<option value="${c}">${c}</option>`
                                ).join('')}
                            </select>
                            <button type="button" class="add-category-confirm" onclick="addRotationCategoryGroup()">Add</button>
                            <button type="button" class="add-category-cancel" onclick="hideAddCategoryDropdown()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('exerciseEditorBody').innerHTML = html;
            renderRotationGroups();
        }

        // Render all rotation category groups
        function renderRotationGroups() {
            if (!editingExercise) return;

            const ex = editingExercise;
            const rotations = ex.options || ex.rotations || [];
            const container = document.getElementById('rotationGroupsContainer');

            let html = '';
            rotationCategoryGroups.forEach((category, groupIdx) => {
                const categoryExercises = getExercisesByCategory(category);
                const isPrimaryCategory = groupIdx === 0;

                html += `
                    <div class="rotation-category-group" data-category="${escapeHtml(category)}">
                        <div class="rotation-category-header">
                            <span class="rotation-category-title">${category}</span>
                            ${!isPrimaryCategory ? `<button type="button" class="remove-category-btn" onclick="removeRotationCategoryGroup(${groupIdx})">âœ•</button>` : ''}
                        </div>
                        <div class="rotation-list">
                `;

                categoryExercises.forEach(exName => {
                    const isSelected = exName === ex.name || rotations.some(r => (r.name || r) === exName);
                    const isPrimary = exName === ex.name;
                    html += `
                        <label class="rotation-checkbox">
                            <input type="checkbox" value="${escapeHtml(exName)}" ${isSelected ? 'checked' : ''} ${isPrimary ? 'disabled' : ''}>
                            <span>${exName}${isPrimary ? ' (primary)' : ''}</span>
                        </label>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show the add category dropdown
        function showAddCategoryDropdown() {
            document.getElementById('addCategoryDropdown').style.display = 'flex';
            // Filter out already-added categories
            const select = document.getElementById('newCategorySelect');
            const options = Object.keys(EXERCISE_CATEGORIES)
                .filter(c => !rotationCategoryGroups.includes(c))
                .map(c => `<option value="${c}">${c}</option>`)
                .join('');
            select.innerHTML = options || '<option value="">All categories added</option>';
        }

        // Hide the add category dropdown
        function hideAddCategoryDropdown() {
            document.getElementById('addCategoryDropdown').style.display = 'none';
        }

        // Add a new category group
        function addRotationCategoryGroup() {
            const select = document.getElementById('newCategorySelect');
            const category = select.value;

            if (category && !rotationCategoryGroups.includes(category)) {
                rotationCategoryGroups.push(category);
                renderRotationGroups();
            }

            hideAddCategoryDropdown();
        }

        // Remove a category group
        function removeRotationCategoryGroup(groupIdx) {
            if (groupIdx > 0) { // Can't remove the primary category
                rotationCategoryGroups.splice(groupIdx, 1);
                renderRotationGroups();
            }
        }

        // Get category for an exercise
        function getExerciseCategory(exerciseName) {
            for (const [category, exercises] of Object.entries(EXERCISE_CATEGORIES)) {
                if (exercises.includes(exerciseName)) {
                    return category;
                }
            }
            // Check custom exercises
            if (customExercises[exerciseName]) {
                return customExercises[exerciseName].category || 'Full Body';
            }
            return 'Full Body';
        }

        // Close exercise editor modal
        function closeExerciseEditor() {
            document.getElementById('exerciseEditorModal').classList.remove('active');
            editingExercise = null;
            editingExerciseIndex = null;
        }

        // Save exercise editor
        function saveExerciseEditor() {
            if (!editingExercise || editingExerciseIndex === null || !editingSection) return;

            // Get values
            const sets = parseInt(document.getElementById('exerciseSetsInput').value) || 3;
            const reps = document.getElementById('exerciseRepsInput').value.trim() || '8-12';
            const rest = document.getElementById('exerciseRestInput').value.trim() || '90s';
            const notes = document.getElementById('exerciseNotesInput').value.trim();

            // Get selected rotations from ALL category groups
            const checkboxes = document.querySelectorAll('#rotationGroupsContainer input[type="checkbox"]:checked');
            const selectedRotations = Array.from(checkboxes)
                .map(cb => cb.value)
                .filter(name => name !== editingExercise.name);

            // Update exercise
            editingExercise.sets = sets;
            editingExercise.reps = reps;
            editingExercise.rest = rest;
            editingExercise.notes = notes || undefined;

            // Store rotations as options array
            if (selectedRotations.length > 0) {
                editingExercise.options = selectedRotations.map(name => ({ name }));
            } else {
                delete editingExercise.options;
            }

            // Save back to section
            editingSection.exercises[editingExerciseIndex] = editingExercise;

            closeExerciseEditor();
            renderSectionEditor();
        }

        // Open add exercise modal
        function openAddExerciseModal() {
            renderAddExerciseModal('Upper Push');
            document.getElementById('addExerciseModal').classList.add('active');
        }

        // Render add exercise modal
        function renderAddExerciseModal(category) {
            const exercises = getExercisesByCategory(category);

            let exerciseListHtml = '<div class="exercise-picker-list">';
            exercises.forEach(exName => {
                exerciseListHtml += `
                    <label class="exercise-picker-item">
                        <input type="checkbox" value="${escapeHtml(exName)}">
                        <span>${exName}</span>
                    </label>
                `;
            });
            exerciseListHtml += '</div>';

            const html = `
                <div class="editor-form">
                    <div class="editor-field">
                        <label class="editor-label">Category</label>
                        <select class="editor-select" id="addExerciseCategorySelect" onchange="onAddExerciseCategoryChange()">
                            ${Object.keys(EXERCISE_CATEGORIES).map(c =>
                                `<option value="${c}" ${c === category ? 'selected' : ''}>${c}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="editor-field">
                        <label class="editor-label">Select Exercises</label>
                        <div id="addExerciseList">
                            ${exerciseListHtml}
                        </div>
                    </div>

                    <div class="editor-row">
                        <div class="editor-field half">
                            <label class="editor-label">Sets</label>
                            <input type="number" class="editor-input" id="addExerciseSets" value="3" min="1" max="20">
                        </div>
                        <div class="editor-field half">
                            <label class="editor-label">Reps</label>
                            <input type="text" class="editor-input" id="addExerciseReps" value="8-12" placeholder="e.g., 8-12">
                        </div>
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Rest</label>
                        <input type="text" class="editor-input" id="addExerciseRest" value="90s" placeholder="e.g., 90s">
                    </div>
                </div>
            `;

            document.getElementById('addExerciseBody').innerHTML = html;
        }

        // Handle category change in add exercise modal
        function onAddExerciseCategoryChange() {
            const category = document.getElementById('addExerciseCategorySelect').value;
            const exercises = getExercisesByCategory(category);

            let exerciseListHtml = '<div class="exercise-picker-list">';
            exercises.forEach(exName => {
                exerciseListHtml += `
                    <label class="exercise-picker-item">
                        <input type="checkbox" value="${escapeHtml(exName)}">
                        <span>${exName}</span>
                    </label>
                `;
            });
            exerciseListHtml += '</div>';

            document.getElementById('addExerciseList').innerHTML = exerciseListHtml;
        }

        // Close add exercise modal
        function closeAddExerciseModal() {
            document.getElementById('addExerciseModal').classList.remove('active');
        }

        // Confirm add exercise
        function confirmAddExercise() {
            if (!editingSection) return;

            const checkboxes = document.querySelectorAll('#addExerciseList input[type="checkbox"]:checked');
            const selectedExercises = Array.from(checkboxes).map(cb => cb.value);

            if (selectedExercises.length === 0) {
                alert('Please select at least one exercise.');
                return;
            }

            const sets = parseInt(document.getElementById('addExerciseSets').value) || 3;
            const reps = document.getElementById('addExerciseReps').value.trim() || '8-12';
            const rest = document.getElementById('addExerciseRest').value.trim() || '90s';

            if (!editingSection.exercises) {
                editingSection.exercises = [];
            }

            // If multiple exercises selected, first one is primary, rest are rotations
            if (selectedExercises.length === 1) {
                editingSection.exercises.push({
                    name: selectedExercises[0],
                    sets,
                    reps,
                    rest
                });
            } else {
                // First is primary, rest are options
                const primary = selectedExercises[0];
                const options = selectedExercises.slice(1).map(name => ({ name }));
                editingSection.exercises.push({
                    name: primary,
                    sets,
                    reps,
                    rest,
                    options
                });
            }

            closeAddExerciseModal();
            renderSectionEditor();
        }

        // Add new superset
        function addNewSuperset() {
            if (!editingSection) return;

            if (!editingSection.supersets) {
                editingSection.supersets = [];
            }

            // Add empty superset placeholder
            editingSection.supersets.push({
                exercises: [
                    { name: 'Select Exercise 1', sets: 3, reps: '10-12' },
                    { name: 'Select Exercise 2', sets: 3, reps: '10-12' }
                ]
            });

            renderSectionEditor();
        }

        // Delete superset
        function deleteSuperset(idx) {
            if (!editingSection || !editingSection.supersets) return;

            if (confirm('Delete this superset?')) {
                editingSection.supersets.splice(idx, 1);
                renderSectionEditor();
            }
        }

        // Edit superset (opens a simplified superset editor)
        // Variables for superset editing
        let editingSupersetIndex = null;
        let editingSuperset = null;

        function editSuperset(idx) {
            if (!editingSection || !editingSection.supersets || !editingSection.supersets[idx]) return;

            editingSupersetIndex = idx;
            editingSuperset = JSON.parse(JSON.stringify(editingSection.supersets[idx]));

            renderSupersetEditorModal();
            document.getElementById('supersetEditorModal').classList.add('active');
        }

        function renderSupersetEditorModal() {
            if (!editingSuperset) return;

            const ss = editingSuperset;
            const ex1 = ss.exercises ? ss.exercises[0] : { name: '', sets: 3, reps: '10-12' };
            const ex2 = ss.exercises ? ss.exercises[1] : { name: '', sets: 3, reps: '10-12' };

            document.getElementById('supersetEditorTitle').textContent = `Edit Superset ${editingSupersetIndex + 1}`;

            // Get all exercises grouped by category
            const allCategories = Object.keys(EXERCISE_CATEGORIES);

            const buildExerciseOptions = (selectedName) => {
                let options = '<option value="">Select Exercise</option>';
                allCategories.forEach(cat => {
                    const exercises = getExercisesByCategory(cat);
                    options += `<optgroup label="${cat}">`;
                    exercises.forEach(ex => {
                        options += `<option value="${escapeHtml(ex)}" ${ex === selectedName ? 'selected' : ''}>${ex}</option>`;
                    });
                    options += '</optgroup>';
                });
                return options;
            };

            const html = `
                <div class="editor-form">
                    <div class="superset-exercise-section">
                        <div class="superset-exercise-label">Exercise 1</div>
                        <div class="editor-field">
                            <select class="editor-select" id="superset_ex1_name">
                                ${buildExerciseOptions(ex1.name)}
                            </select>
                        </div>
                        <div class="editor-row">
                            <div class="editor-field half">
                                <label class="editor-label">Sets</label>
                                <input type="number" class="editor-input" id="superset_ex1_sets" value="${ex1.sets || 3}" min="1" max="20">
                            </div>
                            <div class="editor-field half">
                                <label class="editor-label">Reps</label>
                                <input type="text" class="editor-input" id="superset_ex1_reps" value="${escapeHtml(ex1.reps || '10-12')}" placeholder="e.g., 10-12">
                            </div>
                        </div>
                    </div>

                    <div class="superset-divider">
                        <span>SUPERSET WITH</span>
                    </div>

                    <div class="superset-exercise-section">
                        <div class="superset-exercise-label">Exercise 2</div>
                        <div class="editor-field">
                            <select class="editor-select" id="superset_ex2_name">
                                ${buildExerciseOptions(ex2.name)}
                            </select>
                        </div>
                        <div class="editor-row">
                            <div class="editor-field half">
                                <label class="editor-label">Sets</label>
                                <input type="number" class="editor-input" id="superset_ex2_sets" value="${ex2.sets || 3}" min="1" max="20">
                            </div>
                            <div class="editor-field half">
                                <label class="editor-label">Reps</label>
                                <input type="text" class="editor-input" id="superset_ex2_reps" value="${escapeHtml(ex2.reps || '10-12')}" placeholder="e.g., 10-12">
                            </div>
                        </div>
                    </div>

                    <div class="editor-field" style="margin-top: 16px;">
                        <label class="editor-label">Rest (after superset)</label>
                        <input type="text" class="editor-input" id="superset_rest" value="${escapeHtml(ss.rest || ex1.rest || '90s')}" placeholder="e.g., 90s">
                    </div>
                </div>
            `;

            document.getElementById('supersetEditorBody').innerHTML = html;
        }

        function closeSupersetEditor() {
            document.getElementById('supersetEditorModal').classList.remove('active');
            editingSuperset = null;
            editingSupersetIndex = null;
        }

        function saveSupersetEditor() {
            if (!editingSuperset || editingSupersetIndex === null || !editingSection) return;

            const ex1Name = document.getElementById('superset_ex1_name').value;
            const ex1Sets = parseInt(document.getElementById('superset_ex1_sets').value) || 3;
            const ex1Reps = document.getElementById('superset_ex1_reps').value.trim() || '10-12';

            const ex2Name = document.getElementById('superset_ex2_name').value;
            const ex2Sets = parseInt(document.getElementById('superset_ex2_sets').value) || 3;
            const ex2Reps = document.getElementById('superset_ex2_reps').value.trim() || '10-12';

            const rest = document.getElementById('superset_rest').value.trim() || '90s';

            if (!ex1Name || !ex2Name) {
                alert('Please select both exercises for the superset.');
                return;
            }

            editingSuperset.exercises = [
                { name: ex1Name, sets: ex1Sets, reps: ex1Reps, rest: rest },
                { name: ex2Name, sets: ex2Sets, reps: ex2Reps }
            ];
            editingSuperset.rest = rest;

            editingSection.supersets[editingSupersetIndex] = editingSuperset;

            closeSupersetEditor();
            renderSectionEditor();
        }

        // ==========================================
        // EXERCISES TAB (Main Navigation)
        // ==========================================

        let exercisesTabSearchQuery = '';
        let exercisesTabCategory = 'All';

        function renderExercisesTab() {
            // Populate category dropdown
            const categorySelect = document.getElementById('exercisesCategorySelect');
            if (categorySelect) {
                let options = '<option value="All">All Categories</option>';
                Object.keys(EXERCISE_CATEGORIES).forEach(cat => {
                    options += `<option value="${cat}" ${exercisesTabCategory === cat ? 'selected' : ''}>${cat}</option>`;
                });
                categorySelect.innerHTML = options;
            }

            filterExercisesTab();
        }

        function filterExercisesTab() {
            const searchInput = document.getElementById('exercisesSearchInput');
            const categorySelect = document.getElementById('exercisesCategorySelect');
            const container = document.getElementById('exercisesTabList');

            exercisesTabSearchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            exercisesTabCategory = categorySelect ? categorySelect.value : 'All';

            const allExercises = getAllExercises();
            let exerciseList = [];

            // Build exercise list with categories
            Object.keys(EXERCISE_CATEGORIES).forEach(originalCategory => {
                EXERCISE_CATEGORIES[originalCategory].forEach(exerciseName => {
                    // Get display name and custom category if set
                    const customData = customExercises[exerciseName] || {};
                    const displayName = customData.displayName || exerciseName;
                    const effectiveCategory = customData.category || originalCategory;

                    // Filter by category
                    if (exercisesTabCategory !== 'All' && exercisesTabCategory !== effectiveCategory) return;

                    // Search by both original and display name
                    if (exercisesTabSearchQuery &&
                        !exerciseName.toLowerCase().includes(exercisesTabSearchQuery) &&
                        !displayName.toLowerCase().includes(exercisesTabSearchQuery)) return;
                    exerciseList.push({ name: exerciseName, displayName: displayName, category: effectiveCategory, isCustom: false });
                });
            });

            // Add custom exercises (only truly custom ones, not overrides)
            Object.keys(customExercises).forEach(exerciseName => {
                const exercise = customExercises[exerciseName];
                if (!exercise.isCustom) return; // Skip override entries
                if (exercisesTabCategory !== 'All' && exercisesTabCategory !== exercise.category) return;
                if (exercisesTabSearchQuery && !exerciseName.toLowerCase().includes(exercisesTabSearchQuery)) return;
                exerciseList.push({ name: exerciseName, displayName: exerciseName, category: exercise.category, isCustom: true });
            });

            // Sort alphabetically by display name
            exerciseList.sort((a, b) => a.displayName.localeCompare(b.displayName));

            let html = '';
            if (exerciseList.length === 0) {
                html = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No exercises found</div>';
            } else {
                exerciseList.forEach(exercise => {
                    const exerciseData = allExercises[exercise.name] || {};
                    const measureType = getExerciseMeasureType(exercise.name);
                    const measureLabel = measureType === 'time' ? 'Time' : measureType === 'distance' ? 'Distance' : 'Reps';
                    const measureColor = measureType === 'time' ? '#ff9500' : measureType === 'distance' ? '#5856d6' : '#34c759';
                    const isModified = customExercises[exercise.name] && !exercise.isCustom;
                    const hasDisplayName = exercise.displayName !== exercise.name;
                    html += `
                        <div class="exercise-list-item">
                            <div class="exercise-list-info">
                                <div class="exercise-list-name">
                                    ${exercise.displayName}
                                    ${exercise.isCustom ? '<span class="exercise-list-badge">Custom</span>' : ''}
                                    ${isModified ? '<span class="exercise-list-badge" style="background: #ff9500;">Modified</span>' : ''}
                                    ${hasDisplayName ? '<span class="exercise-list-badge" style="background: #5856d6;">Renamed</span>' : ''}
                                </div>
                                <div class="exercise-list-category">
                                    ${exercise.category}
                                    <span class="exercise-measure-badge" style="background: ${measureColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px; cursor: pointer;" onclick="editExerciseMeasureType('${escapeHtml(exercise.name)}')">${measureLabel}</span>
                                </div>
                            </div>
                            <div class="exercise-list-actions">
                                ${(exerciseData.setup || exerciseData.execution || exerciseData.notes) ? `
                                <button class="exercise-info-btn" onclick="showExerciseInfo('${escapeHtml(exercise.name)}')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                </button>
                                ` : ''}
                                <button class="exercise-info-btn" onclick="openExerciseEditor('${escapeHtml(exercise.name)}', ${exercise.isCustom})" style="color: var(--text-secondary);">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                ${exercise.isCustom ? `
                                    <button class="exercise-info-btn" onclick="deleteCustomExerciseFromTab('${escapeHtml(exercise.name)}')" style="color: #ff3b30;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function showExerciseInfo(exerciseName) {
            const allExercises = getAllExercises();
            const exercise = allExercises[exerciseName];
            if (!exercise) return;

            // Build info message from available fields
            let info = '';
            if (exercise.setup) {
                info += 'SETUP:\n' + exercise.setup + '\n\n';
            }
            if (exercise.execution) {
                info += 'EXECUTION:\n' + exercise.execution;
            }
            if (exercise.notes && !exercise.setup && !exercise.execution) {
                info = exercise.notes;
            }

            if (info.trim()) {
                // Show in a custom modal for better formatting
                const displayName = getExerciseDisplayName(exerciseName);
                showExerciseInfoModal(displayName, info);
            }
        }

        function showExerciseInfoModal(title, content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('exerciseInfoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'exerciseInfoModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 350px;">
                        <div class="modal-header">
                            <h3 id="exerciseInfoTitle"></h3>
                            <button class="modal-close" onclick="document.getElementById('exerciseInfoModal').classList.remove('active')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="exerciseInfoContent" style="white-space: pre-wrap; font-size: 14px; line-height: 1.5; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('exerciseInfoTitle').textContent = title;
            document.getElementById('exerciseInfoContent').textContent = content;
            modal.classList.add('active');
        }

        function editExerciseMeasureType(exerciseName) {
            const currentType = getExerciseMeasureType(exerciseName);

            // Create modal if it doesn't exist
            let modal = document.getElementById('measureTypeModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'measureTypeModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 320px;">
                        <div class="modal-header">
                            <h3 id="measureTypeTitle">Measurement Type</h3>
                            <button class="modal-close" onclick="document.getElementById('measureTypeModal').classList.remove('active')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 16px;">
                            <p id="measureTypeExercise" style="color: var(--text); font-weight: 600; margin-bottom: 16px;"></p>
                            <div id="measureTypeOptions" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('measureTypeExercise').textContent = exerciseName;

            const optionsHtml = `
                <button class="measure-type-option ${currentType === 'reps' ? 'active' : ''}" onclick="selectMeasureType('${escapeHtml(exerciseName)}', 'reps')" style="padding: 12px 16px; border-radius: 10px; border: 2px solid ${currentType === 'reps' ? '#34c759' : 'var(--separator)'}; background: ${currentType === 'reps' ? 'rgba(52, 199, 89, 0.15)' : 'var(--surface-elevated)'}; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; text-align: left;">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: #34c759; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700;">R</span>
                        <span>
                            <div>Reps</div>
                            <div style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">10 reps, 8-12 reps, 5/side</div>
                        </span>
                    </span>
                </button>
                <button class="measure-type-option ${currentType === 'time' ? 'active' : ''}" onclick="selectMeasureType('${escapeHtml(exerciseName)}', 'time')" style="padding: 12px 16px; border-radius: 10px; border: 2px solid ${currentType === 'time' ? '#ff9500' : 'var(--separator)'}; background: ${currentType === 'time' ? 'rgba(255, 149, 0, 0.15)' : 'var(--surface-elevated)'}; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; text-align: left;">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: #ff9500; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700;">T</span>
                        <span>
                            <div>Time</div>
                            <div style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">30s, 1min, 45 seconds</div>
                        </span>
                    </span>
                </button>
                <button class="measure-type-option ${currentType === 'distance' ? 'active' : ''}" onclick="selectMeasureType('${escapeHtml(exerciseName)}', 'distance')" style="padding: 12px 16px; border-radius: 10px; border: 2px solid ${currentType === 'distance' ? '#5856d6' : 'var(--separator)'}; background: ${currentType === 'distance' ? 'rgba(88, 86, 214, 0.15)' : 'var(--surface-elevated)'}; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; text-align: left;">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: #5856d6; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700;">D</span>
                        <span>
                            <div>Distance</div>
                            <div style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">40m, 20 yds, 100 meters</div>
                        </span>
                    </span>
                </button>
            `;
            document.getElementById('measureTypeOptions').innerHTML = optionsHtml;
            modal.classList.add('active');
        }

        function selectMeasureType(exerciseName, measureType) {
            setExerciseMeasureType(exerciseName, measureType);
            document.getElementById('measureTypeModal').classList.remove('active');
            filterExercisesTab(); // Refresh the list
        }

        function openExerciseEditor(exerciseName, isCustom) {
            const allExercises = getAllExercises();
            const baseExercise = EXERCISE_DB[exerciseName] || {};
            const customData = customExercises[exerciseName] || {};

            // Merge base and custom data (custom overrides base)
            const exercise = {
                setup: customData.setup !== undefined ? customData.setup : (baseExercise.setup || ''),
                execution: customData.execution !== undefined ? customData.execution : (baseExercise.execution || ''),
                notes: customData.notes !== undefined ? customData.notes : (baseExercise.notes || ''),
                category: customData.category || ''
            };

            const measureType = getExerciseMeasureType(exerciseName);

            // Find the category for this exercise
            let exerciseCategory = exercise.category;
            if (!exerciseCategory) {
                for (const [cat, exercises] of Object.entries(EXERCISE_CATEGORIES)) {
                    if (exercises.includes(exerciseName)) {
                        exerciseCategory = cat;
                        break;
                    }
                }
            }

            // Create modal if it doesn't exist
            let modal = document.getElementById('exerciseEditorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'exerciseEditorModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            // Build category options
            let categoryOptions = Object.keys(EXERCISE_CATEGORIES).map(cat =>
                `<option value="${cat}" ${cat === exerciseCategory ? 'selected' : ''}>${cat}</option>`
            ).join('');

            modal.innerHTML = `
                <div class="exercise-editor-sheet">
                    <div class="exercise-editor-header">
                        <button class="exercise-editor-cancel" onclick="document.getElementById('exerciseEditorModal').classList.remove('active')">Cancel</button>
                        <h3>Edit Exercise</h3>
                        <button class="exercise-editor-save" onclick="saveExerciseEdits('${escapeHtml(exerciseName)}', ${isCustom})">Save</button>
                    </div>
                    <div class="exercise-editor-body">
                        <div class="exercise-editor-field">
                            <label>Exercise Name</label>
                            <input type="text" id="editExerciseName" value="${escapeHtml(customData.displayName || exerciseName)}">
                            <input type="hidden" id="editExerciseOriginalName" value="${escapeHtml(exerciseName)}">
                            ${!isCustom ? `<div class="exercise-editor-hint">Renaming creates a personal alias for this exercise</div>` : ''}
                        </div>

                        <div class="exercise-editor-field">
                            <label>Category</label>
                            <select id="editExerciseCategory">
                                ${categoryOptions}
                            </select>
                            ${!isCustom ? `<div class="exercise-editor-hint">Changing category creates a personal override</div>` : ''}
                        </div>

                        <div class="exercise-editor-field">
                            <label>Measurement Type</label>
                            <select id="editExerciseMeasure">
                                <option value="reps" ${measureType === 'reps' ? 'selected' : ''}>Reps</option>
                                <option value="time" ${measureType === 'time' ? 'selected' : ''}>Time</option>
                                <option value="distance" ${measureType === 'distance' ? 'selected' : ''}>Distance</option>
                            </select>
                        </div>

                        <div class="exercise-editor-field">
                            <label>Setup Instructions</label>
                            <textarea id="editExerciseSetup" rows="3" placeholder="How to set up for the exercise...">${escapeHtml(exercise.setup)}</textarea>
                        </div>

                        <div class="exercise-editor-field">
                            <label>Execution Instructions</label>
                            <textarea id="editExerciseExecution" rows="3" placeholder="How to perform the exercise...">${escapeHtml(exercise.execution)}</textarea>
                        </div>

                        <div class="exercise-editor-field">
                            <label>Notes (optional)</label>
                            <textarea id="editExerciseNotes" rows="2" placeholder="Additional notes...">${escapeHtml(exercise.notes)}</textarea>
                        </div>

                        ${!isCustom && customExercises[exerciseName] ? `
                        <button class="exercise-editor-reset" onclick="resetExerciseToDefault('${escapeHtml(exerciseName)}')">
                            Reset to Default
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function saveExerciseEdits(originalName, isCustom) {
            const newName = document.getElementById('editExerciseName').value.trim();
            const measureType = document.getElementById('editExerciseMeasure').value;
            const setup = document.getElementById('editExerciseSetup').value.trim();
            const execution = document.getElementById('editExerciseExecution').value.trim();
            const notes = document.getElementById('editExerciseNotes').value.trim();

            if (!newName) {
                alert('Exercise name is required');
                return;
            }

            if (isCustom) {
                // For custom exercises, we can rename and change category
                const category = document.getElementById('editExerciseCategory').value;

                if (newName !== originalName) {
                    delete customExercises[originalName];
                }

                customExercises[newName] = {
                    category: category,
                    setup: setup,
                    execution: execution,
                    notes: notes,
                    measureType: measureType,
                    isCustom: true
                };
            } else {
                // For built-in exercises, store overrides in customExercises
                const category = document.getElementById('editExerciseCategory').value;

                if (!customExercises[originalName]) {
                    customExercises[originalName] = {};
                }

                // Store display name if different from original
                if (newName !== originalName) {
                    customExercises[originalName].displayName = newName;
                } else {
                    delete customExercises[originalName].displayName;
                }

                // Store category override
                customExercises[originalName].category = category;

                // Only store values that differ from defaults or are explicitly set
                customExercises[originalName].setup = setup;
                customExercises[originalName].execution = execution;
                customExercises[originalName].notes = notes;
                customExercises[originalName].measureType = measureType;
            }

            saveData();
            document.getElementById('exerciseEditorModal').classList.remove('active');
            filterExercisesTab();
        }

        function resetExerciseToDefault(exerciseName) {
            if (confirm(`Reset "${exerciseName}" to default settings?`)) {
                delete customExercises[exerciseName];
                saveData();
                document.getElementById('exerciseEditorModal').classList.remove('active');
                filterExercisesTab();
            }
        }

        function editCustomExerciseFromTab(exerciseName) {
            // Open edit modal for custom exercise
            const exercise = customExercises[exerciseName];
            if (!exercise) return;

            const newName = prompt('Exercise name:', exerciseName);
            if (newName === null) return;

            const newCategory = prompt('Category (e.g., Upper Push, Upper Pull, Quads, etc.):', exercise.category);
            if (newCategory === null) return;

            const newNotes = prompt('Notes (optional):', exercise.notes || '');
            if (newNotes === null) return;

            // Update exercise
            if (newName !== exerciseName) {
                delete customExercises[exerciseName];
            }
            customExercises[newName] = {
                category: newCategory,
                notes: newNotes
            };

            saveData();
            filterExercisesTab();
        }

        function deleteCustomExerciseFromTab(exerciseName) {
            if (confirm(`Delete custom exercise "${exerciseName}"?`)) {
                delete customExercises[exerciseName];
                saveData();
                filterExercisesTab();
            }
        }

        function showAddCustomExerciseModal() {
            const name = prompt('Exercise name:');
            if (!name || name.trim() === '') return;

            const categories = Object.keys(EXERCISE_CATEGORIES);
            const categoryList = categories.map((c, i) => `${i + 1}. ${c}`).join('\n');
            const categoryIndex = prompt(`Select category (enter number):\n${categoryList}`);
            if (categoryIndex === null) return;

            const selectedCategory = categories[parseInt(categoryIndex) - 1];
            if (!selectedCategory) {
                alert('Invalid category selection');
                return;
            }

            const notes = prompt('Notes (optional):');

            customExercises[name.trim()] = {
                category: selectedCategory,
                notes: notes || ''
            };

            saveData();
            filterExercisesTab();
        }

        // ==========================================
        // EXERCISE BANK MANAGEMENT
        // ==========================================

        // Render exercise bank screen
        function renderExerciseBank() {
            const container = document.getElementById('exerciseBankContent');

            let html = `
                <div class="editor-field" style="margin-bottom: 20px;">
                    <select class="editor-select" id="exerciseBankCategoryFilter" onchange="renderExerciseBank()">
                        <option value="All">All Categories</option>
                        ${Object.keys(EXERCISE_CATEGORIES).map(c =>
                            `<option value="${c}">${c}</option>`
                        ).join('')}
                    </select>
                </div>
            `;

            const selectedCategory = document.getElementById('exerciseBankCategoryFilter')?.value || 'All';
            const categories = selectedCategory === 'All' ? Object.keys(EXERCISE_CATEGORIES) : [selectedCategory];

            categories.forEach(category => {
                const exercises = EXERCISE_CATEGORIES[category] || [];
                const customInCategory = Object.keys(customExercises).filter(name =>
                    customExercises[name].category === category
                );

                if (exercises.length === 0 && customInCategory.length === 0) return;

                html += `
                    <div class="manage-section">
                        <div class="manage-section-title">${category} (${exercises.length + customInCategory.length})</div>
                `;

                // Default exercises
                exercises.forEach(exName => {
                    html += `
                        <div class="manage-workout-item exercise-bank-item">
                            <div class="manage-workout-name">${exName}</div>
                            <button class="manage-btn info" onclick="showExerciseInfo('${escapeHtml(exName)}')">â„¹</button>
                        </div>
                    `;
                });

                // Custom exercises
                customInCategory.forEach(exName => {
                    html += `
                        <div class="manage-workout-item exercise-bank-item">
                            <div class="manage-workout-info">
                                <div class="manage-workout-name">${exName}</div>
                                <span class="workout-badge custom">Custom</span>
                            </div>
                            <div class="manage-workout-actions">
                                <button class="manage-btn edit" onclick="openCustomExerciseModal('${escapeHtml(exName)}')">Edit</button>
                                <button class="manage-btn delete" onclick="deleteCustomExercise('${escapeHtml(exName)}')">âœ•</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            html += `
                <button class="create-workout-btn" onclick="openCustomExerciseModal()" style="margin-top: 24px;">+ Add Custom Exercise</button>
            `;

            container.innerHTML = html;
        }

        // Show exercise info
        function showExerciseInfo(exerciseName) {
            const exerciseData = EXERCISE_DB[exerciseName] || customExercises[exerciseName];
            if (exerciseData) {
                document.getElementById('exerciseName').textContent = exerciseName;
                document.getElementById('exerciseInfo').innerHTML = exerciseData.instructions || 'No detailed instructions available.';
                document.getElementById('exerciseModal').classList.add('active');
            }
        }

        // Open custom exercise modal
        let editingCustomExercise = null;

        function openCustomExerciseModal(exerciseName = null) {
            if (exerciseName && customExercises[exerciseName]) {
                editingCustomExercise = exerciseName;
                document.getElementById('customExerciseTitle').textContent = 'Edit Custom Exercise';
            } else {
                editingCustomExercise = null;
                document.getElementById('customExerciseTitle').textContent = 'Add Custom Exercise';
            }

            renderCustomExerciseModal();
            document.getElementById('customExerciseModal').classList.add('active');
        }

        // Render custom exercise modal
        function renderCustomExerciseModal() {
            const ex = editingCustomExercise ? customExercises[editingCustomExercise] : null;

            const html = `
                <div class="editor-form">
                    <div class="editor-field">
                        <label class="editor-label">Exercise Name</label>
                        <input type="text" class="editor-input" id="customExerciseNameInput"
                            value="${ex ? escapeHtml(editingCustomExercise) : ''}"
                            placeholder="e.g., Cable Crossover"
                            ${editingCustomExercise ? 'readonly' : ''}>
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Category</label>
                        <select class="editor-select" id="customExerciseCategorySelect">
                            ${Object.keys(EXERCISE_CATEGORIES).map(c =>
                                `<option value="${c}" ${ex && ex.category === c ? 'selected' : ''}>${c}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Instructions (optional)</label>
                        <textarea class="editor-textarea" id="customExerciseInstructionsInput"
                            placeholder="How to perform this exercise..."
                            rows="4">${ex && ex.instructions ? escapeHtml(ex.instructions) : ''}</textarea>
                    </div>
                </div>
            `;

            document.getElementById('customExerciseBody').innerHTML = html;
        }

        // Close custom exercise modal
        function closeCustomExerciseModal() {
            document.getElementById('customExerciseModal').classList.remove('active');
            editingCustomExercise = null;
        }

        // Save custom exercise
        function saveCustomExercise() {
            const name = document.getElementById('customExerciseNameInput').value.trim();
            const category = document.getElementById('customExerciseCategorySelect').value;
            const instructions = document.getElementById('customExerciseInstructionsInput').value.trim();

            if (!name) {
                alert('Please enter an exercise name.');
                return;
            }

            // Check for conflicts with default exercises
            const allDefaultExercises = Object.values(EXERCISE_CATEGORIES).flat();
            if (!editingCustomExercise && allDefaultExercises.includes(name)) {
                alert('An exercise with this name already exists in the default exercise bank.');
                return;
            }

            // Check for conflicts with other custom exercises
            if (!editingCustomExercise && customExercises[name]) {
                alert('A custom exercise with this name already exists.');
                return;
            }

            customExercises[name] = {
                category,
                instructions: instructions || undefined
            };

            saveData();
            closeCustomExerciseModal();
            renderExerciseBank();
        }

        // Delete custom exercise
        function deleteCustomExercise(exerciseName) {
            if (confirm(`Delete custom exercise "${exerciseName}"? This cannot be undone.`)) {
                delete customExercises[exerciseName];
                saveData();
                renderExerciseBank();
            }
        }

        // Rest timer variables
        let restTimerInterval = null;
        let restTimeRemaining = 0;
        let currentRestSetId = null;

        function parseRestTime(restString) {
            // Parse rest time like "90s", "2 min", "60-90s"
            const match = restString.match(/(\d+)/);
            if (match) {
                const value = parseInt(match[1]);
                if (restString.includes('min')) {
                    return value * 60;
                }
                return value;
            }
            return 60; // default 60 seconds
        }

        function startRestTimer(setId, restSeconds) {
            currentRestSetId = setId;
            restTimeRemaining = restSeconds;

            const overlay = document.getElementById('restTimerOverlay');
            const display = document.getElementById('restTimerDisplay');

            overlay.classList.add('active');
            updateRestDisplay();

            // Mark the button as resting
            const btn = document.getElementById(setId);
            if (btn) {
                btn.classList.add('resting');
            }

            restTimerInterval = setInterval(() => {
                restTimeRemaining--;
                updateRestDisplay();

                // Update the button countdown
                if (btn) {
                    const mins = Math.floor(restTimeRemaining / 60);
                    const secs = restTimeRemaining % 60;
                    btn.textContent = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : secs;
                }

                if (restTimeRemaining <= 0) {
                    endRestTimer(true);
                }
            }, 1000);
        }

        function updateRestDisplay() {
            const display = document.getElementById('restTimerDisplay');
            const mins = Math.floor(restTimeRemaining / 60);
            const secs = restTimeRemaining % 60;
            display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function endRestTimer(playAlert) {
            clearInterval(restTimerInterval);
            restTimerInterval = null;

            const overlay = document.getElementById('restTimerOverlay');
            overlay.classList.remove('active');

            // Mark the button as checked (not resting anymore)
            if (currentRestSetId) {
                const btn = document.getElementById(currentRestSetId);
                if (btn) {
                    btn.classList.remove('resting');
                    btn.classList.add('checked');
                    btn.textContent = 'âœ“';
                }
            }

            if (playAlert) {
                // Play alert sound and vibrate
                triggerVibration();
                // Try to play a sound
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not available');
                }
            }

            currentRestSetId = null;
        }

        function skipRestTimer() {
            endRestTimer(false);
        }

        function toggleSetComplete(setId, restString) {
            const btn = document.getElementById(setId);
            if (!btn) return;

            if (btn.classList.contains('checked') || btn.classList.contains('resting')) {
                // Already checked or resting, uncheck it
                if (restTimerInterval && currentRestSetId === setId) {
                    endRestTimer(false);
                }
                btn.classList.remove('checked', 'resting');
                btn.textContent = '';
            } else {
                // Start rest timer
                const restSeconds = parseRestTime(restString);
                startRestTimer(setId, restSeconds);
            }
        }

        function updateDate() {
            const today = new Date();
            const formatted = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('currentDate').textContent = formatted;
            document.getElementById('workoutDate').textContent = formatted;
            const workoutsPageDateEl = document.getElementById('workoutsPageDate');
            if (workoutsPageDateEl) workoutsPageDateEl.textContent = formatted;
        }

        const workoutIcons = {
            'Lower Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><path d="M12 8v4"/><path d="M9 12l-3 8"/><path d="M15 12l3 8"/><path d="M7 20h2"/><path d="M15 20h2"/></svg>',
            'Upper Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12"/><path d="M4 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><path d="M20 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><rect x="6" y="9" width="12" height="6" rx="1"/></svg>',
            'Recovery': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12c0-4 4-8 8-8"/><path d="M12 4c4 0 8 4 8 8"/><path d="M12 4v8l4 4"/><circle cx="12" cy="12" r="9"/></svg>',
            'Full Body': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v4"/><path d="M8 10h8"/><path d="M8 10l-2 10"/><path d="M16 10l2 10"/><path d="M10 14l-1 6"/><path d="M14 14l1 6"/></svg>',
            'Upper Volume': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h1"/><path d="M19 12h1"/><rect x="5" y="8" width="3" height="8" rx="1"/><rect x="16" y="8" width="3" height="8" rx="1"/><rect x="8" y="5" width="8" height="14" rx="1"/></svg>',
            'HIIT': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
        };

        // Available icons for workout selection
        const AVAILABLE_WORKOUT_ICONS = {
            // Weights & Gym
            'dumbbell': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12"/><path d="M4 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><path d="M20 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/><rect x="6" y="9" width="12" height="6" rx="1"/></svg>',
            'barbell': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h1"/><path d="M19 12h1"/><rect x="5" y="8" width="3" height="8" rx="1"/><rect x="16" y="8" width="3" height="8" rx="1"/><rect x="8" y="5" width="8" height="14" rx="1"/></svg>',
            'kettlebell': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 4a3 3 0 0 1 6 0"/><circle cx="12" cy="14" r="6"/><path d="M12 8v2"/></svg>',
            'weightPlate': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><circle cx="12" cy="12" r="1"/></svg>',
            // Body Parts
            'legs': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><path d="M12 8v4"/><path d="M9 12l-3 8"/><path d="M15 12l3 8"/><path d="M7 20h2"/><path d="M15 20h2"/></svg>',
            'fullbody': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v4"/><path d="M8 10h8"/><path d="M8 10l-2 10"/><path d="M16 10l2 10"/><path d="M10 14l-1 6"/><path d="M14 14l1 6"/></svg>',
            'muscle': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 11c.9-1.9 2.5-3 4.2-3h1.6c1.7 0 3.3 1.1 4.2 3"/><path d="M7 11v3c0 2.8 2.2 5 5 5s5-2.2 5-5v-3"/><path d="M5 11a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M19 11a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M12 19v2"/></svg>',
            'bicep': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15c0-3 2-6 6-6"/><path d="M10 9c1-2 3-4 6-4"/><path d="M16 5c2 0 4 2 4 5s-1 5-3 7"/><path d="M17 17c-2 2-5 3-8 2"/><path d="M9 19c-3-1-5-4-5-7"/></svg>',
            // Cardio & Running
            'running': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="14" cy="4" r="2"/><path d="M6 20l3-7"/><path d="M9 13l3-1 4 3 3-2"/><path d="M17 14l1 6"/><path d="M6 13l4 1"/></svg>',
            'sprint': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="17" cy="4" r="2"/><path d="M3 20l5-8"/><path d="M8 12l4-1 3 4 4-3"/><path d="M19 13l2 7"/><path d="M3 12l5 1"/><path d="M1 16h4"/><path d="M1 12h2"/></svg>',
            'walking': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v5"/><path d="M9 20l1-5 2-2"/><path d="M15 20l-1-5-2-2"/><path d="M8 11l4 2 4-2"/></svg>',
            'treadmill': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="14" width="20" height="6" rx="1"/><path d="M6 14V8a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v6"/><circle cx="6" cy="17" r="1"/><circle cx="18" cy="17" r="1"/><path d="M10 14v-2"/><path d="M14 14v-2"/></svg>',
            // Sports
            'boxing': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 8c0-2 1-4 4-4h4c3 0 4 2 4 4v8c0 2-1 4-4 4H8c-3 0-4-2-4-4V8z"/><path d="M8 4v2"/><path d="M12 4v2"/><path d="M16 10h2c1 0 2 1 2 2v0c0 1-1 2-2 2h-2"/></svg>',
            'basketball': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15 15 0 0 1 0 20"/><path d="M12 2a15 15 0 0 0 0 20"/><path d="M2 12h20"/></svg>',
            'football': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="10" ry="6"/><path d="M12 6v12"/><path d="M8 9l8 6"/><path d="M8 15l8-6"/></svg>',
            'tennis': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="7"/><path d="M12 3c-2 2-3 5-3 7s1 5 3 7"/><path d="M12 3c2 2 3 5 3 7s-1 5-3 7"/><path d="M5 10h14"/><path d="M12 17v5"/><path d="M10 22h4"/></svg>',
            'soccer': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2l3 6h-6l3-6z"/><path d="M12 22l-3-6h6l-3 6z"/><path d="M2 12l6-3v6l-6-3z"/><path d="M22 12l-6 3v-6l6 3z"/></svg>',
            'golf': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v16"/><path d="M12 2l8 4-8 4"/><circle cx="12" cy="22" r="2"/></svg>',
            // Flexibility & Recovery
            'yoga': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v4"/><path d="M4 14l8-4 8 4"/><path d="M12 10v10"/></svg>',
            'stretch': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M12 6v6"/><path d="M6 10l6 2 6-2"/><path d="M12 12l-4 8"/><path d="M12 12l4 8"/></svg>',
            'meditation': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="6" r="3"/><path d="M12 9v3"/><path d="M6 18c0-3 2-6 6-6s6 3 6 6"/><path d="M4 18h16"/><path d="M8 15c-2 0-3 2-3 3"/><path d="M16 15c2 0 3 2 3 3"/></svg>',
            'recovery': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12c0-4 4-8 8-8"/><path d="M12 4c4 0 8 4 8 8"/><path d="M12 4v8l4 4"/><circle cx="12" cy="12" r="9"/></svg>',
            // Cardio Equipment
            'bike': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="17" r="3"/><circle cx="19" cy="17" r="3"/><path d="M12 17V5l4 4"/><path d="M5 17l7-5 7 5"/></svg>',
            'swim': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18c1.5-1.5 3.5-1.5 5 0s3.5 1.5 5 0 3.5-1.5 5 0 3.5 1.5 5 0"/><circle cx="10" cy="6" r="2"/><path d="M10 8v4l4-2"/></svg>',
            'rowing': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 18l8-8 8 8"/><path d="M12 10V4"/><circle cx="12" cy="4" r="2"/><path d="M4 18h16"/></svg>',
            'jumprope': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4c0 8 4 12 8 12s8-4 8-12"/><path d="M4 4v4"/><path d="M20 4v4"/><circle cx="12" cy="20" r="2"/></svg>',
            // Energy & Performance
            'lightning': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            'flame': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
            'rocket': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
            'power': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.4 6.6a9 9 0 1 1-12.77.04"/></svg>',
            // Health & Stats
            'heart': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
            'heartbeat': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h4l3-9 4 18 3-9h4"/></svg>',
            'timer': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 6v6l4 2"/></svg>',
            'stopwatch': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M10 2h4"/><path d="M12 2v3"/></svg>',
            // Goals & Achievement
            'target': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
            'trophy': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
            'medal': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/><path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.12"/><path d="M15 7l3-6"/><path d="M9 7L6 1"/></svg>',
            'star': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'crown': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 17l3-8 5 5 2-9 2 9 5-5 3 8z"/><path d="M2 17h20v4H2z"/></svg>',
            // Misc
            'calendar': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            'clipboard': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg>',
            'mountain': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>',
            'sunrise': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="M4.93 10.93l2.83 2.83"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="M19.07 10.93l-2.83 2.83"/><path d="M12 18a6 6 0 0 0 0-12v12z"/><path d="M2 22h20"/></svg>'
        };

        // Custom workout icons storage
        let customWorkoutIcons = {};

        function updateHomeScreen() {
            renderHomeWidgets();
        }

        // ==========================================
        // HOME WIDGET SYSTEM
        // ==========================================

        const WIDGET_TYPES = {
            weekly: { name: 'This Week', description: 'Track workouts completed this week', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' },
            workouts: { name: 'Workouts', description: 'Quick access to start workouts', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5a2 2 0 0 1 3 0v11a2 2 0 0 1-3 0V15H5a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h1.5V6.5z"/><path d="M17.5 6.5a2 2 0 0 0-3 0v11a2 2 0 0 0 3 0V15H19a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-1.5V6.5z"/><line x1="9.5" y1="12" x2="14.5" y2="12"/></svg>' },
            weight: { name: 'Body Weight', description: 'Track your daily weight', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M6.5 8a6.5 6.5 0 0 0 11 0"/><rect x="5" y="11" width="14" height="10" rx="2"/><line x1="12" y1="14" x2="12" y2="18"/><line x1="10" y1="16" x2="14" y2="16"/></svg>' },
            exerciseProgress: { name: 'Exercise Progress', description: 'Track weight progress for an exercise with estimated 1RM', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>' },
            monthlyCounter: { name: 'Monthly Workout Count', description: 'See workouts per week for each month', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>' },
            streak: { name: 'Current Streak', description: 'Track your consecutive workout weeks', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>' },
            totalWorkouts: { name: 'Total Workouts', description: 'All-time workout statistics', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>' },
            recentPRs: { name: 'Recent PRs', description: 'Your latest personal records', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>' },
            muscleBalance: { name: 'Muscle Balance', description: 'See which muscle groups need attention', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v3"/><path d="M6.5 11c-1.5 0-2.5 1-2.5 2.5s1 2.5 2.5 2.5"/><path d="M17.5 11c1.5 0 2.5 1 2.5 2.5s-1 2.5-2.5 2.5"/><path d="M12 11v11"/><path d="M9 22h6"/></svg>' },
            restDays: { name: 'Rest Days', description: 'Track days since last workout', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>' },
            volumeTracker: { name: 'Weekly Volume', description: 'Total sets and reps this week', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>' }
        };

        let configuringWidgetId = null;

        function toggleHomeEditMode() {
            homeEditMode = !homeEditMode;
            const btn = document.getElementById('editHomeBtn');
            if (homeEditMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            renderHomeWidgets();
        }

        function renderHomeWidgets() {
            const container = document.getElementById('homeWidgetsContainer');
            if (!container) return;

            let html = '';

            // Render each enabled widget
            homeWidgets.filter(w => w.enabled).forEach(widget => {
                html += renderWidget(widget);
            });

            // Add "Add Widget" button (only visible in edit mode)
            html += `<button class="add-widget-btn ${homeEditMode ? 'visible' : ''}" onclick="openAddWidgetModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Widget
            </button>`;

            container.innerHTML = html;

            // Render widget contents after DOM is updated
            homeWidgets.filter(w => w.enabled).forEach(widget => {
                renderWidgetContent(widget);
            });

            // Set up drag-and-drop if in edit mode
            if (homeEditMode) {
                setupWidgetDragDrop('home');
            }
        }

        function renderWidget(widget) {
            const widgetInfo = WIDGET_TYPES[widget.type] || { name: widget.type };
            const editClass = homeEditMode ? 'edit-mode' : '';

            return `
                <div class="widget ${editClass}" id="widget-${widget.id}" data-widget-id="${widget.id}">
                    <div class="widget-header">
                        <div class="widget-header-left">
                            <div class="widget-reorder-btns">
                                <button class="widget-reorder-btn" onclick="event.stopPropagation(); moveWidgetUp('${widget.id}', 'home')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>
                                </button>
                                <button class="widget-reorder-btn" onclick="event.stopPropagation(); moveWidgetDown('${widget.id}', 'home')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                            </div>
                            <span class="widget-title">${widgetInfo.name}</span>
                        </div>
                        <div class="widget-header-actions">
                            ${widget.type === 'workouts' ? `<button class="widget-settings-btn" onclick="event.stopPropagation(); showManageWorkouts()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>` : ''}
                            <button class="widget-remove-btn" onclick="removeWidget('${widget.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="widget-content" id="widget-content-${widget.id}">
                        <!-- Content rendered by renderWidgetContent -->
                    </div>
                </div>
            `;
        }

        function renderWidgetContent(widget) {
            const container = document.getElementById(`widget-content-${widget.id}`);
            if (!container) return;

            switch (widget.type) {
                case 'weekly':
                    renderWeeklyWidgetContent(container);
                    break;
                case 'workouts':
                    renderWorkoutsWidgetContent(container);
                    break;
                case 'weight':
                    renderWeightWidgetContent(container, widget.id);
                    break;
                case 'exerciseProgress':
                    renderExerciseProgressWidgetContent(container, widget);
                    break;
                case 'monthlyCounter':
                    renderMonthlyCounterWidgetContent(container);
                    break;
                case 'streak':
                    renderStreakWidgetContent(container);
                    break;
                case 'totalWorkouts':
                    renderTotalWorkoutsWidgetContent(container);
                    break;
                case 'recentPRs':
                    renderRecentPRsWidgetContent(container);
                    break;
                case 'muscleBalance':
                    renderMuscleBalanceWidgetContent(container);
                    break;
                case 'restDays':
                    renderRestDaysWidgetContent(container);
                    break;
                case 'volumeTracker':
                    renderVolumeTrackerWidgetContent(container);
                    break;
            }
        }

        function renderWeeklyWidgetContent(container) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + mondayOffset);

            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            let html = '<div class="week-days">';

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + i);
                const dateStr = dayDate.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                const hasWorkout = checkWorkoutOnDate(dateStr);

                html += `
                    <div class="day-circle">
                        <div class="day-indicator ${hasWorkout ? 'completed' : ''} ${isToday ? 'today' : ''}">
                            ${dayLabels[i]}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderWorkoutsWidgetContent(container) {
            const effectiveWorkouts = getEffectiveWorkouts();
            const defaultIcon = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6" y2="14"/><line x1="18" y1="10" x2="18" y2="14"/></svg>';

            let html = '<div class="workout-grid">';
            Object.keys(effectiveWorkouts).forEach(key => {
                if (hiddenWorkouts.includes(key)) return;

                const workout = effectiveWorkouts[key];
                const lastWorkout = getLastWorkoutDate(key);
                const icon = customWorkoutIcons[key] ? AVAILABLE_WORKOUT_ICONS[customWorkoutIcons[key]] : (workoutIcons[key] || defaultIcon);
                const isCustom = isWorkoutCustom(key);
                const isModified = isWorkoutModified(key);

                let badgeHtml = '';
                if (isCustom) {
                    badgeHtml = '<span class="card-badge custom">Custom</span>';
                }
                // Note: Modified badge only shown in manage/edit screen, not here

                html += `
                    <div class="workout-card" onclick="startWorkout('${escapeHtml(key)}')">
                        <div class="workout-card-header">
                            <div class="workout-icon">${icon}</div>
                            <div class="workout-card-title-wrapper">
                                <span class="workout-title">${workout.title}</span>
                                ${badgeHtml}
                            </div>
                        </div>
                        <div class="workout-meta">${workout.duration}${workout.focus ? ' â€¢ ' + workout.focus : ''}</div>
                        ${lastWorkout ? `<div class="last-workout">Last: ${lastWorkout}</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderWeightWidgetContent(container, widgetId) {
            const today = new Date().toISOString().split('T')[0];
            const todayWeight = weightLog[today];

            let html = '';
            if (todayWeight !== undefined) {
                html += `
                    <div class="weight-today" style="display: flex;">
                        <span id="todayWeightDisplay-${widgetId}">Today: ${todayWeight} lbs</span>
                        <button class="weight-edit-btn" onclick="editTodayWeightWidget('${widgetId}')">Edit</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="weight-input-row" id="weightInputRow-${widgetId}">
                        <input type="number" class="weight-input" id="weightInput-${widgetId}" placeholder="Enter weight" step="0.1">
                        <span class="weight-unit">lbs</span>
                        <button class="weight-submit" onclick="saveWeightWidget('${widgetId}')">Add</button>
                    </div>
                `;
            }

            html += `
                <div class="weight-chart-container">
                    <canvas id="weightChart-${widgetId}"></canvas>
                </div>
                <div class="weight-stats" id="weightStats-${widgetId}"></div>
            `;

            container.innerHTML = html;

            // Render chart and stats after DOM update
            setTimeout(() => {
                renderWeightChartWidget(widgetId);
                renderWeightStatsWidget(widgetId);
            }, 10);
        }

        function saveWeightWidget(widgetId) {
            const input = document.getElementById(`weightInput-${widgetId}`);
            const weight = parseFloat(input.value);
            if (isNaN(weight) || weight <= 0) return;

            const today = new Date().toISOString().split('T')[0];
            weightLog[today] = weight;
            saveData();
            renderHomeWidgets();
        }

        function editTodayWeightWidget(widgetId) {
            const today = new Date().toISOString().split('T')[0];
            const currentWeight = weightLog[today];
            const newWeight = prompt('Enter weight (lbs):', currentWeight);
            if (newWeight !== null) {
                const weight = parseFloat(newWeight);
                if (!isNaN(weight) && weight > 0) {
                    weightLog[today] = weight;
                    saveData();
                    renderHomeWidgets();
                }
            }
        }

        function renderWeightChartWidget(widgetId) {
            const canvas = document.getElementById(`weightChart-${widgetId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;

            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);

            const entries = getLast30DaysWeight();

            if (entries.length === 0) {
                ctx.fillStyle = '#8e8e93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No weight data yet', width / 2, height / 2);
                return;
            }

            const padding = { top: 20, right: 15, bottom: 25, left: 45 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const weights = entries.map(e => e.weight);
            const minWeight = Math.min(...weights) - 2;
            const maxWeight = Math.max(...weights) + 2;
            const weightRange = maxWeight - minWeight || 1;

            ctx.clearRect(0, 0, width, height);

            ctx.strokeStyle = '#38383a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                const weightVal = maxWeight - (weightRange / 4) * i;
                ctx.fillStyle = '#8e8e93';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(weightVal.toFixed(0), padding.left - 8, y + 3);
            }

            if (entries.length > 1) {
                ctx.strokeStyle = '#0a84ff';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.beginPath();

                entries.forEach((entry, i) => {
                    const x = padding.left + (i / (entries.length - 1)) * chartWidth;
                    const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
                gradient.addColorStop(0, 'rgba(10, 132, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(10, 132, 255, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                entries.forEach((entry, i) => {
                    const x = padding.left + (i / (entries.length - 1)) * chartWidth;
                    const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.lineTo(padding.left + chartWidth, height - padding.bottom);
                ctx.lineTo(padding.left, height - padding.bottom);
                ctx.closePath();
                ctx.fill();
            }

            ctx.fillStyle = '#0a84ff';
            entries.forEach((entry, i) => {
                const x = padding.left + (entries.length > 1 ? (i / (entries.length - 1)) * chartWidth : chartWidth / 2);
                const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function renderWeightStatsWidget(widgetId) {
            const container = document.getElementById(`weightStats-${widgetId}`);
            if (!container) return;

            const entries = getLast30DaysWeight();
            if (entries.length === 0) {
                container.innerHTML = '';
                return;
            }

            const currentWeight = entries[entries.length - 1].weight;
            const startWeight = entries[0].weight;
            const change = currentWeight - startWeight;
            const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
            const changePrefix = change > 0 ? '+' : '';

            let avgWeight = entries.reduce((sum, e) => sum + e.weight, 0) / entries.length;

            container.innerHTML = `
                <div class="weight-stat">
                    <div class="weight-stat-value">${currentWeight.toFixed(1)}</div>
                    <div class="weight-stat-label">Current</div>
                </div>
                <div class="weight-stat">
                    <div class="weight-stat-value ${changeClass}">${changePrefix}${change.toFixed(1)}</div>
                    <div class="weight-stat-label">30 Day Change</div>
                </div>
                <div class="weight-stat">
                    <div class="weight-stat-value">${avgWeight.toFixed(1)}</div>
                    <div class="weight-stat-label">Avg (30d)</div>
                </div>
            `;
        }

        // Exercise Progress Widget
        function renderExerciseProgressWidgetContent(container, widget) {
            const exerciseName = widget.exercise || null;

            if (!exerciseName) {
                container.innerHTML = `
                    <div class="no-data-message" style="padding: 20px 16px;">
                        <p style="margin-bottom: 12px;">Track progress for an exercise</p>
                        <button class="exercise-progress-select-btn" onclick="openExerciseProgressConfig('${widget.id}')">Select Exercise</button>
                    </div>
                `;
                return;
            }

            const progressData = getExerciseProgressData(exerciseName);

            if (progressData.entries.length === 0) {
                container.innerHTML = `
                    <div class="exercise-progress-header">
                        <span style="font-weight: 600; color: var(--text);">${exerciseName}</span>
                        <button class="exercise-progress-select" onclick="openExerciseProgressConfig('${widget.id}')">Change</button>
                    </div>
                    <div class="no-data-message">No data recorded yet for this exercise</div>
                `;
                return;
            }

            const latest = progressData.entries[progressData.entries.length - 1];
            const estimated1RM = calculateEpley1RM(latest.weight, latest.reps);

            container.innerHTML = `
                <div class="exercise-progress-header">
                    <span style="font-weight: 600; color: var(--text);">${exerciseName}</span>
                    <button class="exercise-progress-select" onclick="openExerciseProgressConfig('${widget.id}')">Change</button>
                </div>
                <div class="exercise-progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value">${latest.weight}</div>
                        <div class="progress-stat-label">Last Weight</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">${latest.reps}</div>
                        <div class="progress-stat-label">Last Reps</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value estimated">${estimated1RM}</div>
                        <div class="progress-stat-label">Est. 1RM</div>
                    </div>
                </div>
                <div class="exercise-progress-chart">
                    <canvas id="exerciseChart-${widget.id}"></canvas>
                </div>
            `;

            setTimeout(() => renderExerciseProgressChart(widget.id, progressData), 10);
        }

        function calculateEpley1RM(weight, reps) {
            if (reps <= 0) return weight;
            if (reps === 1) return weight;
            // Epley formula: 1RM = weight Ã— (1 + reps/30)
            return Math.round(weight * (1 + reps / 30));
        }

        function getExerciseProgressData(exerciseName) {
            const entries = [];

            // Scan workout log for this exercise
            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_')) {
                    const session = workoutLog[key];
                    if (session && session.exercises) {
                        Object.keys(session.exercises).forEach(exName => {
                            if (exName.toLowerCase() === exerciseName.toLowerCase()) {
                                const exerciseData = session.exercises[exName];
                                // Get the heaviest set from this session
                                let maxWeight = 0;
                                let repsAtMax = 0;
                                Object.keys(exerciseData).forEach(setKey => {
                                    const setData = exerciseData[setKey];
                                    if (setData && setData.weight > maxWeight) {
                                        maxWeight = setData.weight;
                                        repsAtMax = setData.reps || 0;
                                    }
                                });
                                if (maxWeight > 0) {
                                    const dateStr = key.split('_')[0];
                                    entries.push({
                                        date: dateStr,
                                        weight: maxWeight,
                                        reps: repsAtMax
                                    });
                                }
                            }
                        });
                    }
                }
            });

            // Sort by date
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Keep last 30 entries max
            return { entries: entries.slice(-30) };
        }

        function renderExerciseProgressChart(widgetId, progressData) {
            const canvas = document.getElementById(`exerciseChart-${widgetId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;

            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);

            const entries = progressData.entries;

            if (entries.length === 0) {
                ctx.fillStyle = '#8e8e93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data yet', width / 2, height / 2);
                return;
            }

            const padding = { top: 15, right: 15, bottom: 20, left: 40 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const weights = entries.map(e => e.weight);
            const minWeight = Math.min(...weights) - 10;
            const maxWeight = Math.max(...weights) + 10;
            const weightRange = maxWeight - minWeight || 1;

            ctx.clearRect(0, 0, width, height);

            // Grid lines
            ctx.strokeStyle = '#38383a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 3; i++) {
                const y = padding.top + (chartHeight / 3) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                const weightVal = maxWeight - (weightRange / 3) * i;
                ctx.fillStyle = '#8e8e93';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(weightVal.toFixed(0), padding.left - 5, y + 3);
            }

            // Line
            if (entries.length > 1) {
                ctx.strokeStyle = '#30d158';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.beginPath();

                entries.forEach((entry, i) => {
                    const x = padding.left + (i / (entries.length - 1)) * chartWidth;
                    const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Points
            ctx.fillStyle = '#30d158';
            entries.forEach((entry, i) => {
                const x = padding.left + (entries.length > 1 ? (i / (entries.length - 1)) * chartWidth : chartWidth / 2);
                const y = padding.top + ((maxWeight - entry.weight) / weightRange) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function openExerciseProgressConfig(widgetId) {
            configuringWidgetId = widgetId;
            document.getElementById('progressExerciseSearch').value = '';
            renderProgressExerciseList();
            document.getElementById('exerciseProgressModal').classList.add('active');
        }

        function closeExerciseProgressModal() {
            document.getElementById('exerciseProgressModal').classList.remove('active');
            configuringWidgetId = null;
        }

        function filterProgressExercises() {
            renderProgressExerciseList();
        }

        function renderProgressExerciseList() {
            const container = document.getElementById('progressExerciseList');
            const searchQuery = document.getElementById('progressExerciseSearch').value.toLowerCase();

            // Get exercises that have logged data
            const exercisesWithData = new Set();
            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_')) {
                    const session = workoutLog[key];
                    if (session && session.exercises) {
                        Object.keys(session.exercises).forEach(exName => {
                            exercisesWithData.add(exName);
                        });
                    }
                }
            });

            // Also add all exercises from the database
            const allExercises = new Set([...exercisesWithData]);
            Object.values(EXERCISE_CATEGORIES).forEach(exercises => {
                exercises.forEach(ex => allExercises.add(ex));
            });

            let exerciseList = Array.from(allExercises).sort();
            if (searchQuery) {
                exerciseList = exerciseList.filter(ex => ex.toLowerCase().includes(searchQuery));
            }

            let html = '';
            exerciseList.forEach(exercise => {
                const hasData = exercisesWithData.has(exercise);
                html += `
                    <div class="exercise-progress-item" onclick="selectProgressExercise('${escapeHtml(exercise)}')">
                        <div>
                            <div class="exercise-progress-item-name">${exercise}</div>
                            ${hasData ? '<div class="exercise-progress-item-category" style="color: var(--success);">Has logged data</div>' : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="no-data-message">No exercises found</div>';
        }

        function selectProgressExercise(exerciseName) {
            if (!configuringWidgetId) return;

            const widgetIndex = homeWidgets.findIndex(w => w.id === configuringWidgetId);
            if (widgetIndex !== -1) {
                homeWidgets[widgetIndex].exercise = exerciseName;
                saveData();
            }

            closeExerciseProgressModal();
            renderHomeWidgets();
        }

        // Widget Management
        function openAddWidgetModal() {
            const container = document.getElementById('addWidgetList');
            const existingTypes = homeWidgets.filter(w => w.enabled).map(w => w.type);

            let html = '';
            Object.keys(WIDGET_TYPES).forEach(type => {
                const widget = WIDGET_TYPES[type];
                // Allow multiple exercise progress widgets
                const isAdded = type !== 'exerciseProgress' && existingTypes.includes(type);

                html += `
                    <div class="widget-option ${isAdded ? 'disabled' : ''}" onclick="${isAdded ? '' : `addWidget('${type}')`}" style="${isAdded ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <div class="widget-option-icon">${widget.icon}</div>
                        <div class="widget-option-info">
                            <div class="widget-option-name">${widget.name}</div>
                            <div class="widget-option-desc">${widget.description}</div>
                        </div>
                        ${isAdded ? '<span style="color: var(--text-secondary); font-size: 12px;">Added</span>' : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('addWidgetModal').classList.add('active');
        }

        function closeAddWidgetModal() {
            document.getElementById('addWidgetModal').classList.remove('active');
        }

        function addWidget(type) {
            const newWidget = {
                id: type + '_' + Date.now(),
                type: type,
                enabled: true
            };

            homeWidgets.push(newWidget);
            saveData();
            closeAddWidgetModal();
            renderHomeWidgets();

            // If it's an exercise progress widget, open config
            if (type === 'exerciseProgress') {
                setTimeout(() => openExerciseProgressConfig(newWidget.id), 100);
            }
        }

        function removeWidget(widgetId) {
            const index = homeWidgets.findIndex(w => w.id === widgetId);
            if (index !== -1) {
                homeWidgets.splice(index, 1);
                saveData();
                renderHomeWidgets();
            }
        }

        // Widget reordering with up/down buttons (mobile-friendly)
        function moveWidgetUp(widgetId, page) {
            const widgetArray = page === 'home' ? homeWidgets : workoutsPageWidgets;
            const index = widgetArray.findIndex(w => w.id === widgetId);

            if (index > 0) {
                // Swap with previous widget
                [widgetArray[index - 1], widgetArray[index]] = [widgetArray[index], widgetArray[index - 1]];
                saveData();

                if (page === 'home') {
                    renderHomeWidgets();
                } else {
                    renderWorkoutsPageWidgets();
                }
            }
        }

        function moveWidgetDown(widgetId, page) {
            const widgetArray = page === 'home' ? homeWidgets : workoutsPageWidgets;
            const index = widgetArray.findIndex(w => w.id === widgetId);
            const enabledWidgets = widgetArray.filter(w => w.enabled);

            if (index < enabledWidgets.length - 1) {
                // Swap with next widget
                [widgetArray[index], widgetArray[index + 1]] = [widgetArray[index + 1], widgetArray[index]];
                saveData();

                if (page === 'home') {
                    renderHomeWidgets();
                } else {
                    renderWorkoutsPageWidgets();
                }
            }
        }

        // ==========================================
        // WORKOUTS PAGE WIDGET SYSTEM
        // ==========================================

        function toggleWorkoutsEditMode() {
            workoutsPageEditMode = !workoutsPageEditMode;
            const btn = document.getElementById('editWorkoutsBtn');
            if (workoutsPageEditMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            renderWorkoutsPageWidgets();
        }

        function renderWorkoutsPageWidgets() {
            const container = document.getElementById('workoutsPageWidgetsContainer');
            if (!container) return;

            let html = '';

            // Render each enabled widget
            workoutsPageWidgets.filter(w => w.enabled).forEach(widget => {
                html += renderWorkoutsPageWidget(widget);
            });

            // Add "Add Widget" button (only visible in edit mode)
            html += `<button class="add-widget-btn ${workoutsPageEditMode ? 'visible' : ''}" onclick="openAddWorkoutsWidgetModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Widget
            </button>`;

            container.innerHTML = html;

            // Render widget contents after DOM is updated
            workoutsPageWidgets.filter(w => w.enabled).forEach(widget => {
                renderWorkoutsPageWidgetContent(widget);
            });

            // Set up drag-and-drop if in edit mode
            if (workoutsPageEditMode) {
                setupWidgetDragDrop('workoutsPage');
            }
        }

        function renderWorkoutsPageWidget(widget) {
            const widgetInfo = WIDGET_TYPES[widget.type] || { name: widget.type };
            const editClass = workoutsPageEditMode ? 'edit-mode' : '';

            return `
                <div class="widget ${editClass}" id="wp-widget-${widget.id}" data-widget-id="${widget.id}">
                    <div class="widget-header">
                        <div class="widget-header-left">
                            <div class="widget-reorder-btns">
                                <button class="widget-reorder-btn" onclick="event.stopPropagation(); moveWidgetUp('${widget.id}', 'workoutsPage')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>
                                </button>
                                <button class="widget-reorder-btn" onclick="event.stopPropagation(); moveWidgetDown('${widget.id}', 'workoutsPage')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                            </div>
                            <span class="widget-title">${widgetInfo.name}</span>
                        </div>
                        <div class="widget-header-actions">
                            ${widget.type === 'workouts' ? `<button class="widget-settings-btn" onclick="event.stopPropagation(); showManageWorkouts()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>` : ''}
                            <button class="widget-remove-btn" onclick="removeWorkoutsPageWidget('${widget.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="widget-content" id="wp-widget-content-${widget.id}">
                        <!-- Content rendered by renderWorkoutsPageWidgetContent -->
                    </div>
                </div>
            `;
        }

        function renderWorkoutsPageWidgetContent(widget) {
            const container = document.getElementById(`wp-widget-content-${widget.id}`);
            if (!container) return;

            switch (widget.type) {
                case 'workouts':
                    renderWorkoutsWidgetContent(container);
                    break;
                case 'monthlyCounter':
                    renderMonthlyCounterWidgetContent(container);
                    break;
                case 'streak':
                    renderStreakWidgetContent(container);
                    break;
                case 'totalWorkouts':
                    renderTotalWorkoutsWidgetContent(container);
                    break;
                case 'recentPRs':
                    renderRecentPRsWidgetContent(container);
                    break;
                case 'weekly':
                    renderWeeklyWidgetContent(container);
                    break;
                case 'weight':
                    renderWeightWidgetContent(container, widget.id);
                    break;
                case 'exerciseProgress':
                    renderExerciseProgressWidgetContent(container, widget);
                    break;
                case 'muscleBalance':
                    renderMuscleBalanceWidgetContent(container);
                    break;
                case 'restDays':
                    renderRestDaysWidgetContent(container);
                    break;
                case 'volumeTracker':
                    renderVolumeTrackerWidgetContent(container);
                    break;
            }
        }

        // Monthly Counter Widget
        function renderMonthlyCounterWidgetContent(container) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            let html = '<div class="monthly-counter-grid">';

            // Show last 4 months including current
            for (let i = 3; i >= 0; i--) {
                let targetMonth = currentMonth - i;
                let targetYear = currentYear;
                if (targetMonth < 0) {
                    targetMonth += 12;
                    targetYear--;
                }

                const stats = getMonthlyWorkoutStats(targetYear, targetMonth);
                const isCurrent = targetMonth === currentMonth && targetYear === currentYear;

                html += `
                    <div class="month-counter-item ${isCurrent ? 'current' : ''}">
                        <div class="month-counter-label">${months[targetMonth]}</div>
                        <div class="month-counter-value">${stats.total}</div>
                        <div class="month-counter-weeks">${stats.avgPerWeek}/wk</div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getMonthlyWorkoutStats(year, month) {
            let count = 0;
            const sessions = Object.keys(workoutLog).filter(key => key.includes('_session_'));

            sessions.forEach(key => {
                const dateStr = key.split('_')[0];
                const date = new Date(dateStr);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    count++;
                }
            });

            // Calculate weeks in month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            // For current month, count only elapsed weeks
            const now = new Date();
            let weeksElapsed;
            if (year === now.getFullYear() && month === now.getMonth()) {
                weeksElapsed = Math.max(1, Math.ceil(now.getDate() / 7));
            } else {
                weeksElapsed = Math.ceil(daysInMonth / 7);
            }

            const avgPerWeek = weeksElapsed > 0 ? (count / weeksElapsed).toFixed(1) : 0;

            return { total: count, avgPerWeek };
        }

        // Streak Widget
        function renderStreakWidgetContent(container) {
            const streak = calculateWorkoutStreak();

            container.innerHTML = `
                <div class="streak-display">
                    <div class="streak-number">${streak.current}</div>
                    <div class="streak-info">
                        <div class="streak-label">week${streak.current !== 1 ? 's' : ''} in a row</div>
                        <div class="streak-record">Best: ${streak.best} week${streak.best !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            `;
        }

        function calculateWorkoutStreak() {
            const sessions = Object.keys(workoutLog).filter(key => key.includes('_session_'));
            if (sessions.length === 0) return { current: 0, best: 0 };

            const MIN_WORKOUTS_FOR_STREAK = 4; // Require at least 4 workouts per week

            // Group workouts by week (count unique days, not sessions)
            const weekDayMap = new Map();
            sessions.forEach(key => {
                const dateStr = key.split('_')[0];
                const date = new Date(dateStr);
                const weekStart = getWeekStart(date);
                const weekKey = weekStart.toISOString().split('T')[0];

                if (!weekDayMap.has(weekKey)) {
                    weekDayMap.set(weekKey, new Set());
                }
                weekDayMap.get(weekKey).add(dateStr);
            });

            // Filter to only weeks with 4+ workout days
            const qualifyingWeeks = new Map();
            weekDayMap.forEach((days, weekKey) => {
                if (days.size >= MIN_WORKOUTS_FOR_STREAK) {
                    qualifyingWeeks.set(weekKey, days.size);
                }
            });

            // Sort weeks
            const weeks = Array.from(qualifyingWeeks.keys()).sort().reverse();
            if (weeks.length === 0) return { current: 0, best: 0 };

            // Check if current week qualifies
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            const currentWeekKey = currentWeekStart.toISOString().split('T')[0];

            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            // Calculate current streak (must include current or last week)
            const lastWeekStart = new Date(currentWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekKey = lastWeekStart.toISOString().split('T')[0];

            // Start from current week or last week (only if they qualify)
            let checkDate = qualifyingWeeks.has(currentWeekKey) ? new Date(currentWeekKey) :
                           qualifyingWeeks.has(lastWeekKey) ? new Date(lastWeekKey) : null;

            if (checkDate) {
                while (true) {
                    const weekKey = checkDate.toISOString().split('T')[0];
                    if (qualifyingWeeks.has(weekKey)) {
                        currentStreak++;
                        checkDate.setDate(checkDate.getDate() - 7);
                    } else {
                        break;
                    }
                }
            }

            // Calculate best streak (going through all qualifying weeks)
            for (let i = 0; i < weeks.length; i++) {
                const weekDate = new Date(weeks[i]);
                const prevWeekDate = new Date(weekDate);
                prevWeekDate.setDate(prevWeekDate.getDate() - 7);
                const prevWeekKey = prevWeekDate.toISOString().split('T')[0];

                if (i === 0 || weeks[i - 1] === prevWeekKey ||
                    new Date(weeks[i - 1]).getTime() === prevWeekDate.getTime()) {
                    tempStreak++;
                } else {
                    bestStreak = Math.max(bestStreak, tempStreak);
                    tempStreak = 1;
                }
            }
            bestStreak = Math.max(bestStreak, tempStreak, currentStreak);

            return { current: currentStreak, best: bestStreak };
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Total Workouts Widget
        function renderTotalWorkoutsWidgetContent(container) {
            const stats = calculateTotalWorkoutStats();

            container.innerHTML = `
                <div class="total-workouts-display">
                    <div class="total-stat">
                        <div class="total-stat-value">${stats.total}</div>
                        <div class="total-stat-label">Total</div>
                    </div>
                    <div class="total-stat">
                        <div class="total-stat-value">${stats.thisMonth}</div>
                        <div class="total-stat-label">This Month</div>
                    </div>
                    <div class="total-stat">
                        <div class="total-stat-value">${stats.thisYear}</div>
                        <div class="total-stat-label">This Year</div>
                    </div>
                </div>
            `;
        }

        function calculateTotalWorkoutStats() {
            const sessions = Object.keys(workoutLog).filter(key => key.includes('_session_'));
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let thisMonth = 0;
            let thisYear = 0;

            sessions.forEach(key => {
                const dateStr = key.split('_')[0];
                const date = new Date(dateStr);
                if (date.getFullYear() === currentYear) {
                    thisYear++;
                    if (date.getMonth() === currentMonth) {
                        thisMonth++;
                    }
                }
            });

            return { total: sessions.length, thisMonth, thisYear };
        }

        // Recent PRs Widget
        function renderRecentPRsWidgetContent(container) {
            const prs = getRecentPRs();

            if (prs.length === 0) {
                container.innerHTML = '<div class="no-data-message" style="text-align: center; color: var(--text-secondary); padding: 20px;">No PRs recorded yet</div>';
                return;
            }

            let html = '<div class="recent-prs-list">';
            prs.slice(0, 3).forEach(pr => {
                html += `
                    <div class="pr-item">
                        <div class="pr-trophy">ðŸ†</div>
                        <div class="pr-details">
                            <div class="pr-exercise">${pr.exercise}</div>
                            <div class="pr-value">${pr.weight} lbs Ã— ${pr.reps}</div>
                        </div>
                        <div class="pr-date">${formatPRDate(pr.date)}</div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function getRecentPRs() {
            const prs = [];
            const exerciseBests = {};

            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_')) {
                    const session = workoutLog[key];
                    const dateStr = key.split('_')[0];

                    if (session && session.exercises) {
                        Object.entries(session.exercises).forEach(([exerciseName, sets]) => {
                            if (Array.isArray(sets)) {
                                sets.forEach(set => {
                                    if (set.weight && set.reps) {
                                        const weight = parseFloat(set.weight);
                                        const reps = parseInt(set.reps);
                                        const estimated1RM = weight * (1 + reps / 30);

                                        if (!exerciseBests[exerciseName] || estimated1RM > exerciseBests[exerciseName].estimated1RM) {
                                            exerciseBests[exerciseName] = {
                                                exercise: exerciseName,
                                                weight: weight,
                                                reps: reps,
                                                estimated1RM: estimated1RM,
                                                date: dateStr
                                            };
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            });

            // Sort by date (most recent first)
            return Object.values(exerciseBests).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function formatPRDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Muscle Balance Widget
        function renderMuscleBalanceWidgetContent(container) {
            const muscleGroups = calculateMuscleGroupVolume();
            const maxCount = Math.max(...Object.values(muscleGroups), 1);

            let html = '<div class="muscle-balance-display">';

            const groupOrder = ['Upper Push', 'Upper Pull', 'Quads', 'Hamstrings', 'Core'];
            groupOrder.forEach(group => {
                const count = muscleGroups[group] || 0;
                const percentage = (count / maxCount) * 100;
                let barClass = 'good';
                if (percentage < 30) barClass = 'low';
                else if (percentage < 60) barClass = 'medium';

                html += `
                    <div class="muscle-balance-item">
                        <div class="muscle-balance-label">${group}</div>
                        <div class="muscle-balance-bar-bg">
                            <div class="muscle-balance-bar ${barClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="muscle-balance-count">${count}</div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function calculateMuscleGroupVolume() {
            const groups = {
                'Upper Push': 0,
                'Upper Pull': 0,
                'Quads': 0,
                'Hamstrings': 0,
                'Core': 0
            };

            // Map exercises to muscle groups
            const exerciseToGroup = {
                'Barbell Bench Press': 'Upper Push',
                'Incline DB Press': 'Upper Push',
                'Close Grip Bench': 'Upper Push',
                'OHP': 'Upper Push',
                'Dumbbell Shoulder Press': 'Upper Push',
                'Arnold Press': 'Upper Push',
                'Push Press': 'Upper Push',
                'Dips': 'Upper Push',
                'DB Lateral Raise': 'Upper Push',
                'Cable Lateral Raise': 'Upper Push',
                'Pull-Ups': 'Upper Pull',
                'Chin-Ups': 'Upper Pull',
                'Lat Pulldown': 'Upper Pull',
                'Barbell Rows': 'Upper Pull',
                'DB Rows': 'Upper Pull',
                'Pendlay Rows': 'Upper Pull',
                'Cable Rows': 'Upper Pull',
                'Face Pulls': 'Upper Pull',
                'Rear Delt Fly': 'Upper Pull',
                'High Bar Back Squat': 'Quads',
                'Low Bar Back Squat': 'Quads',
                'Front Squat': 'Quads',
                'Leg Press': 'Quads',
                'Hack Squat': 'Quads',
                'Leg Extensions': 'Quads',
                'Bulgarian Split Squats': 'Quads',
                'Walking Lunges': 'Quads',
                'RDL': 'Hamstrings',
                'Conventional Deadlift': 'Hamstrings',
                'Sumo Deadlift': 'Hamstrings',
                'Good Mornings': 'Hamstrings',
                'Leg Curls': 'Hamstrings',
                'Hip Thrusts': 'Hamstrings',
                'Glute Bridges': 'Hamstrings',
                'Planks': 'Core',
                'Dead Bugs': 'Core',
                'Pallof Press': 'Core',
                'Ab Wheel Rollouts': 'Core',
                'Hanging Leg Raises': 'Core',
                'Cable Crunches': 'Core'
            };

            // Count sets from last 7 days
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_')) {
                    const dateStr = key.split('_')[0];
                    const date = new Date(dateStr);
                    if (date >= weekAgo && date <= today) {
                        const session = workoutLog[key];
                        if (session && session.exercises) {
                            Object.entries(session.exercises).forEach(([exerciseName, sets]) => {
                                const group = exerciseToGroup[exerciseName];
                                if (group && Array.isArray(sets)) {
                                    groups[group] += sets.length;
                                }
                            });
                        }
                    }
                }
            });

            return groups;
        }

        // Rest Days Widget
        function renderRestDaysWidgetContent(container) {
            const daysSinceWorkout = calculateDaysSinceLastWorkout();

            let statusClass = 'recovered';
            let statusText = 'Well rested';

            if (daysSinceWorkout === 0) {
                statusClass = 'recovered';
                statusText = 'Trained today';
            } else if (daysSinceWorkout === 1) {
                statusClass = 'recovered';
                statusText = 'Recovery day';
            } else if (daysSinceWorkout <= 3) {
                statusClass = 'warning';
                statusText = 'Time to train';
            } else {
                statusClass = 'overdue';
                statusText = 'Overdue';
            }

            container.innerHTML = `
                <div class="rest-days-display">
                    <div class="rest-days-number ${statusClass}">${daysSinceWorkout}</div>
                    <div class="rest-days-info">
                        <div class="rest-days-label">day${daysSinceWorkout !== 1 ? 's' : ''} since workout</div>
                        <div class="rest-days-status ${statusClass}">${statusText}</div>
                    </div>
                </div>
            `;
        }

        function calculateDaysSinceLastWorkout() {
            const sessions = Object.keys(workoutLog).filter(key => key.includes('_session_'));
            if (sessions.length === 0) return 999;

            const dates = sessions.map(key => new Date(key.split('_')[0]));
            const lastDate = new Date(Math.max(...dates));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            lastDate.setHours(0, 0, 0, 0);

            return Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        }

        // Volume Tracker Widget
        function renderVolumeTrackerWidgetContent(container) {
            const thisWeek = calculateWeeklyVolume(0);
            const lastWeek = calculateWeeklyVolume(1);

            const setsChange = thisWeek.sets - lastWeek.sets;
            const repsChange = thisWeek.reps - lastWeek.reps;

            const setsChangeClass = setsChange >= 0 ? 'positive' : 'negative';
            const repsChangeClass = repsChange >= 0 ? 'positive' : 'negative';
            const setsChangePrefix = setsChange >= 0 ? '+' : '';
            const repsChangePrefix = repsChange >= 0 ? '+' : '';

            container.innerHTML = `
                <div class="volume-tracker-display">
                    <div class="volume-stat">
                        <div class="volume-stat-value">${thisWeek.workouts}</div>
                        <div class="volume-stat-label">Workouts</div>
                    </div>
                    <div class="volume-stat">
                        <div class="volume-stat-value">${thisWeek.sets}</div>
                        <div class="volume-stat-label">Total Sets</div>
                        ${lastWeek.sets > 0 ? `<div class="volume-change ${setsChangeClass}">${setsChangePrefix}${setsChange} vs last wk</div>` : ''}
                    </div>
                    <div class="volume-stat">
                        <div class="volume-stat-value">${thisWeek.reps}</div>
                        <div class="volume-stat-label">Total Reps</div>
                        ${lastWeek.reps > 0 ? `<div class="volume-change ${repsChangeClass}">${repsChangePrefix}${repsChange} vs last wk</div>` : ''}
                    </div>
                </div>
            `;
        }

        function calculateWeeklyVolume(weeksAgo = 0) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

            const monday = new Date(today);
            monday.setDate(today.getDate() + mondayOffset - (weeksAgo * 7));
            monday.setHours(0, 0, 0, 0);

            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);

            let workouts = 0;
            let sets = 0;
            let reps = 0;

            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_')) {
                    const dateStr = key.split('_')[0];
                    const date = new Date(dateStr);
                    if (date >= monday && date <= sunday) {
                        workouts++;
                        const session = workoutLog[key];
                        if (session && session.exercises) {
                            Object.values(session.exercises).forEach(exerciseSets => {
                                if (Array.isArray(exerciseSets)) {
                                    sets += exerciseSets.length;
                                    exerciseSets.forEach(set => {
                                        if (set.reps) {
                                            reps += parseInt(set.reps) || 0;
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            });

            return { workouts, sets, reps };
        }

        // Workouts Page Widget Management
        function openAddWorkoutsWidgetModal() {
            const container = document.getElementById('addWorkoutsWidgetList');
            const existingTypes = workoutsPageWidgets.filter(w => w.enabled).map(w => w.type);

            let html = '';
            Object.keys(WIDGET_TYPES).forEach(type => {
                const widget = WIDGET_TYPES[type];
                const isAdded = type !== 'exerciseProgress' && existingTypes.includes(type);

                html += `
                    <div class="widget-option ${isAdded ? 'disabled' : ''}" onclick="${isAdded ? '' : `addWorkoutsPageWidget('${type}')`}" style="${isAdded ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <div class="widget-option-icon">${widget.icon}</div>
                        <div class="widget-option-info">
                            <div class="widget-option-name">${widget.name}</div>
                            <div class="widget-option-desc">${widget.description}</div>
                        </div>
                        ${isAdded ? '<span style="color: var(--text-secondary); font-size: 12px;">Added</span>' : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('addWorkoutsWidgetModal').classList.add('active');
        }

        function closeAddWorkoutsWidgetModal() {
            document.getElementById('addWorkoutsWidgetModal').classList.remove('active');
        }

        function addWorkoutsPageWidget(type) {
            const newWidget = {
                id: 'wp-' + type + '_' + Date.now(),
                type: type,
                enabled: true
            };

            workoutsPageWidgets.push(newWidget);
            saveData();
            closeAddWorkoutsWidgetModal();
            renderWorkoutsPageWidgets();

            if (type === 'exerciseProgress') {
                setTimeout(() => openExerciseProgressConfig(newWidget.id), 100);
            }
        }

        function removeWorkoutsPageWidget(widgetId) {
            const index = workoutsPageWidgets.findIndex(w => w.id === widgetId);
            if (index !== -1) {
                workoutsPageWidgets.splice(index, 1);
                saveData();
                renderWorkoutsPageWidgets();
            }
        }

        // Keep legacy functions for compatibility
        function renderWeeklyTracker() {
            // Now handled by widget system
        }

        function renderWeightTracker() {
            // Now handled by widget system
        }

        function renderWorkoutGrid() {
            // Now handled by widget system - kept for compatibility with other code that calls it
            renderHomeWidgets();
        }

        function getLastWorkoutDate(workoutType) {
            const sessions = Object.keys(workoutLog).filter(key => 
                key.includes('_session_') && key.includes(workoutType)
            );
            if (sessions.length === 0) return null;

            const dates = sessions.map(key => key.split('_')[0]);
            const latestDate = new Date(Math.max(...dates.map(d => new Date(d))));
            const today = new Date();
            const diffDays = Math.floor((today - latestDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return latestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
                btn.classList.remove('active');
                if ((screen === 'home' && idx === 0) ||
                    (screen === 'workoutsPage' && idx === 1) ||
                    (screen === 'calendar' && idx === 2) ||
                    (screen === 'exercises' && idx === 3)) {
                    btn.classList.add('active');
                }
            });

            // Hide workout bottom controls when not on workout screen
            if (screen !== 'workout') {
                hideWorkoutBottomControls();
            }

            // Show/hide active workout banner when not on workout screen
            updateActiveWorkoutBanner(screen);

            currentView = screen;

            if (screen === 'calendar') {
                // Auto-select today's date (use local date to avoid timezone issues)
                const today = getLocalDateString();
                selectedCalendarDate = today;
                renderCalendar();
                showDayWorkouts(today);
            }

            if (screen === 'manage') {
                renderManageWorkouts();
            }
        }

        function showManageWorkouts() {
            showScreen('manage');
        }

        function updateActiveWorkoutBanner(currentScreen) {
            const banner = document.getElementById('activeWorkoutBanner');
            const hasActiveWorkout = workoutStartTime !== null && currentWorkoutType !== null;

            if (hasActiveWorkout && currentScreen !== 'workout') {
                // Show banner on non-workout screens
                banner.style.display = 'flex';
                document.getElementById('bannerWorkoutName').textContent = currentWorkoutType;
                document.getElementById('bannerWorkoutTime').textContent = getElapsedTime();
                document.body.classList.add('has-active-banner');
            } else {
                // Hide banner
                banner.style.display = 'none';
                document.body.classList.remove('has-active-banner');
            }
        }

        function returnToActiveWorkout() {
            if (currentWorkoutType && workoutStartTime) {
                // Return to active workout without restarting
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('workoutScreen').classList.add('active');

                // Hide banner since we're back in workout
                document.getElementById('activeWorkoutBanner').style.display = 'none';
                document.body.classList.remove('has-active-banner');

                // Show header timer
                document.getElementById('headerTimer').style.display = 'flex';
                document.getElementById('headerTimerDisplay').textContent = getElapsedTime();

                // Render content without restarting timer
                renderWorkoutContent(currentWorkoutType);

                // Ensure timer update is running
                if (!workoutTimer) {
                    startTimerUpdate();
                }

                currentView = 'workout';
            }
        }

        function goHome() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('homeScreen').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
            hideWorkoutBottomControls();
            updateActiveWorkoutBanner('home');
            currentView = 'home';
            updateHomeScreen();
        }

        function hideWorkoutBottomControls() {
            const bottomControls = document.getElementById('workoutBottomControls');
            if (bottomControls) {
                bottomControls.style.display = 'none';
            }
        }

        function getExerciseType(sectionTitle) {
            const title = sectionTitle.toLowerCase();
            if (title.includes('plyo')) return 'plyos';
            if (title.includes('main lift')) return 'mainLifts';
            if (title.includes('core') || title.includes('abs')) return 'core';
            if (title.includes('accessor') || title.includes('volume') || title.includes('superset')) return 'accessories';
            return 'accessories';
        }

        function getExerciseDaysSinceReset(workoutType, exerciseName, baseExerciseName) {
            // Get the reset date for this exercise (when another variant completed a cycle)
            const resetKey = `${workoutType}_${baseExerciseName}_resetDate`;
            const resetDate = rotationTracking[resetKey] ? new Date(rotationTracking[resetKey]) : null;

            const workoutDays = Object.keys(workoutLog).filter(key => {
                if (!key.includes(workoutType) || !key.includes(exerciseName) || !key.includes('_1')) {
                    return false;
                }
                // Only count days after the reset date
                if (resetDate) {
                    const dayDate = new Date(key.split('_')[0]);
                    return dayDate >= resetDate;
                }
                return true;
            });

            return new Set(workoutDays.map(key => key.split('_')[0])).size;
        }

        function shouldRecommendRotation(workoutType, exerciseName, exerciseType, baseExerciseName) {
            const uniqueDays = getExerciseDaysSinceReset(workoutType, exerciseName, baseExerciseName);

            const threshold = ROTATION_THRESHOLDS[exerciseType] || 8;
            const daysThreshold = threshold * 2;

            const trackingKey = `${workoutType}_${exerciseName}`;
            if (rotationTracking[trackingKey] && rotationTracking[trackingKey].lastRecommendation) {
                const lastRecDate = new Date(rotationTracking[trackingKey].lastRecommendation);
                const now = new Date();
                const daysSinceRec = Math.floor((now - lastRecDate) / (24 * 60 * 60 * 1000));

                if (daysSinceRec < (daysThreshold * 3.5)) {
                    return false;
                }
            }

            return uniqueDays >= daysThreshold;
        }

        function markRotationRecommended(workoutType, exerciseName) {
            const trackingKey = `${workoutType}_${exerciseName}`;
            if (!rotationTracking[trackingKey]) {
                rotationTracking[trackingKey] = {};
            }
            rotationTracking[trackingKey].lastRecommendation = new Date().toISOString();
            saveData();
        }

        function markCycleCompleted(workoutType, baseExerciseName) {
            // When an exercise completes a full cycle (24 days), reset the counter for all variants
            const resetKey = `${workoutType}_${baseExerciseName}_resetDate`;
            rotationTracking[resetKey] = new Date().toISOString();
            saveData();
        }

        function startWorkoutTimer() {
            if (workoutStartTime) return;
            
            workoutStartTime = new Date();
            startTimerUpdate();
            
            const startBtn = document.getElementById('startBtn');
            const endBtn = document.getElementById('endBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.textContent = 'Started';
            }
            if (endBtn) {
                endBtn.disabled = false;
            }
        }

        function startTimerUpdate() {
            if (workoutTimer) clearInterval(workoutTimer);

            workoutTimer = setInterval(() => {
                if (!workoutStartTime) {
                    clearInterval(workoutTimer);
                    workoutTimer = null;
                    return;
                }

                const elapsed = getElapsedTime();

                // Update header timer
                const headerTimerDisplay = document.getElementById('headerTimerDisplay');
                if (headerTimerDisplay) {
                    headerTimerDisplay.textContent = elapsed;
                }

                // Update banner timer if visible
                const bannerTime = document.getElementById('bannerWorkoutTime');
                if (bannerTime) {
                    bannerTime.textContent = elapsed;
                }
            }, 1000);
        }

        function getElapsedTime() {
            if (!workoutStartTime) return '0:00';
            
            const now = new Date();
            const elapsed = Math.floor((now - workoutStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endWorkoutSession() {
            if (!workoutStartTime || !currentWorkoutType) return;

            const endTime = new Date();
            const durationMs = endTime - workoutStartTime;
            const durationMinutes = Math.round(durationMs / 60000);
            const today = new Date().toISOString().split('T')[0];

            const timestamp = workoutStartTime.getTime();
            const sessionKey = `${today}_session_${timestamp}_${currentWorkoutType}`;
            const exercises = {};
            const setKeysToRemove = [];

            Object.keys(workoutLog).forEach(key => {
                if (key.startsWith(today + '_' + currentWorkoutType)) {
                    const parts = key.split('_');
                    if (parts.length >= 4 && !key.includes('_session_')) {
                        const exerciseName = parts.slice(2, -1).join('_');
                        const setNum = parts[parts.length - 1];

                        if (!exercises[exerciseName]) {
                            exercises[exerciseName] = {};
                        }
                        exercises[exerciseName][`set${setNum}`] = workoutLog[key];

                        // If deload mode, mark this key for removal
                        if (isDeloadWorkout) {
                            setKeysToRemove.push(key);
                        }
                    }
                }
            });

            // Save session info (for calendar) even in deload mode
            workoutLog[sessionKey] = {
                workoutType: currentWorkoutType,
                date: today,
                startTime: workoutStartTime.toISOString(),
                endTime: endTime.toISOString(),
                durationMinutes: durationMinutes,
                exercises: exercises,
                isDeload: isDeloadWorkout
            };

            // If deload mode, remove the individual set logs so they won't pre-fill next workout
            if (isDeloadWorkout) {
                setKeysToRemove.forEach(key => {
                    delete workoutLog[key];
                });
            }

            saveData();

            clearInterval(workoutTimer);
            workoutTimer = null;
            workoutStartTime = null;
            document.getElementById('headerTimer').style.display = 'none';
            hideWorkoutBottomControls();

            const exerciseCount = Object.keys(exercises).length;
            const deloadMsg = isDeloadWorkout ? '\n(Deload - weights not saved for next session)' : '';
            alert(`Workout Complete!\n\n${currentWorkoutType}\nDuration: ${durationMinutes} minutes\nExercises logged: ${exerciseCount}${deloadMsg}\n\nGreat work!`);

            currentWorkoutType = null;
            isDeloadWorkout = false;
            goHome();
        }

        function startWorkout(workoutType) {
            // Check if there's an active workout and it's a different workout
            if (workoutStartTime && currentWorkoutType && currentWorkoutType !== workoutType) {
                if (!confirm(`You have an active "${currentWorkoutType}" workout. Cancel it and start "${workoutType}"?`)) {
                    return;
                }
                // Cancel the current workout
                clearInterval(workoutTimer);
                workoutTimer = null;
                workoutStartTime = null;
                document.getElementById('headerTimer').style.display = 'none';
                hideWorkoutBottomControls();
            }

            currentWorkoutType = workoutType;

            // Reset to first section tab when starting a new workout
            currentSectionIdx = 0;

            // Reset deload mode for new workout
            isDeloadWorkout = false;

            // Show the workout screen
            showScreen('workout');

            // Auto-start the workout timer if not already active
            if (!workoutStartTime) {
                startWorkoutTimer();
            }

            // Show timer in header
            document.getElementById('headerTimer').style.display = 'flex';
            document.getElementById('headerTimerDisplay').textContent = getElapsedTime();

            // Render workout content
            renderWorkoutContent(workoutType);

            // Ensure timer is running
            if (!workoutTimer) {
                startTimerUpdate();
            }
        }

        let currentSectionIdx = 0;

        function renderWorkoutContent(workoutType) {
            const effectiveWorkouts = getEffectiveWorkouts();
            const workout = effectiveWorkouts[workoutType];
            const container = document.getElementById('workoutContent');
            const tabsContainer = document.getElementById('workoutTabs');

            // Set workout name in header (add deload indicator)
            const deloadIndicator = isDeloadWorkout ? ' (Deload)' : '';
            document.getElementById('workoutHeaderTitle').textContent = workout.title + deloadIndicator;

            // Filter sections - skip Finisher in deload mode
            const filteredSections = workout.sections.filter(section => {
                if (isDeloadWorkout && section.title.toLowerCase() === 'finisher') {
                    return false;
                }
                return true;
            });

            // Adjust currentSectionIdx if it's out of bounds
            if (currentSectionIdx >= filteredSections.length) {
                currentSectionIdx = 0;
            }

            // Build tabs (in separate fixed container)
            let tabsHtml = '';
            filteredSections.forEach((section, sectionIdx) => {
                tabsHtml += `<button class="workout-tab ${sectionIdx === currentSectionIdx ? 'active' : ''}" onclick="switchWorkoutSection('${workoutType}', ${sectionIdx})">${section.title}</button>`;
            });
            tabsContainer.innerHTML = tabsHtml;

            // Build section content
            let sectionsHtml = '';
            filteredSections.forEach((section, sectionIdx) => {
                sectionsHtml += `<div class="workout-section ${sectionIdx === currentSectionIdx ? 'active' : ''}" id="workoutSection_${sectionIdx}">`;

                if (section.isOptions) {
                    sectionsHtml += renderOptions(section, workoutType, sectionIdx);
                } else if (section.isSupersets) {
                    sectionsHtml += renderSupersets(section, workoutType, sectionIdx);
                } else if (section.isCircuit) {
                    sectionsHtml += renderCircuit(section, workoutType, sectionIdx);
                } else {
                    section.exercises.forEach(ex => {
                        sectionsHtml += renderExercise(ex, workoutType, section.title);
                    });
                }

                sectionsHtml += '</div>';
            });

            container.innerHTML = sectionsHtml;

            // Show bottom controls and update deload UI
            const bottomControls = document.getElementById('workoutBottomControls');
            if (bottomControls) {
                bottomControls.style.display = 'block';
            }
            updateDeloadUI();
        }

        function switchWorkoutSection(workoutType, sectionIdx) {
            currentSectionIdx = sectionIdx;

            // Update tab active states
            document.querySelectorAll('.workout-tab').forEach((tab, idx) => {
                tab.classList.toggle('active', idx === sectionIdx);
            });

            // Update section visibility
            document.querySelectorAll('.workout-section').forEach((section, idx) => {
                section.classList.toggle('active', idx === sectionIdx);
            });

            // Scroll to top of content
            document.getElementById('workoutContent').scrollTop = 0;
        }

        function cancelWorkout() {
            if (workoutStartTime) {
                if (!confirm('Are you sure you want to cancel this workout? Your progress will not be saved.')) {
                    return;
                }
            }
            clearInterval(workoutTimer);
            workoutTimer = null;
            workoutStartTime = null;
            currentWorkoutType = null;
            isDeloadWorkout = false;
            document.getElementById('headerTimer').style.display = 'none';
            hideWorkoutBottomControls();
            goHome();
        }

        function toggleDeload() {
            isDeloadWorkout = !isDeloadWorkout;
            updateDeloadUI();
            // Re-render workout to apply deload modifications
            if (currentWorkoutType) {
                renderWorkoutContent(currentWorkoutType);
            }
        }

        function updateDeloadUI() {
            const toggle = document.getElementById('deloadToggle');
            const label = document.getElementById('deloadLabel');
            if (toggle && label) {
                toggle.classList.toggle('active', isDeloadWorkout);
                label.classList.toggle('active', isDeloadWorkout);
            }
        }

        function getDeloadSets(originalSets) {
            // Reduce by 1 set, minimum 1
            return isDeloadWorkout ? Math.max(1, originalSets - 1) : originalSets;
        }

        function getDeloadWeight(weight) {
            // Apply 75% and round to nearest 5
            if (!isDeloadWorkout || !weight || weight === 'BW' || weight === '') return weight;
            const numWeight = parseFloat(weight);
            if (isNaN(numWeight)) return weight;
            const deloadWeight = Math.round((numWeight * 0.75) / 5) * 5;
            return Math.max(5, deloadWeight); // Minimum 5 lbs
        }

        function handleWorkoutBack() {
            // Just go back to home - don't cancel the workout
            // The active workout banner will show if a workout is still in progress
            goHome();
        }

        function renderOptions(section, workoutType, sectionIdx) {
            const selectionKey = `${workoutType}_section${sectionIdx}`;
            const selected = workoutLog[selectionKey] || 0;
            const selectedEx = section.exercises[selected];

            // Render the selected exercise with a dropdown in its header
            return renderExerciseWithDropdown(selectedEx, workoutType, section.title, section.exercises, sectionIdx, selected);
        }

        function renderExerciseWithDropdown(ex, workoutType, sectionTitle, allOptions, sectionIdx, selectedIdx) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            // Get measure type for this exercise
            const measureType = getExerciseMeasureType(ex.name);
            const measureLabel = measureType === 'time' ? 'time' : measureType === 'distance' ? 'dist' : 'reps';

            // Build dropdown options with display names
            let dropdownOptions = '';
            allOptions.forEach((opt, idx) => {
                const optDisplayName = getExerciseDisplayName(opt.name);
                dropdownOptions += `<option value="${idx}" ${idx === selectedIdx ? 'selected' : ''}>${optDisplayName}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectOption('${workoutType}', ${sectionIdx}, this.value)">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} ${measureLabel}</span>
                            <span class="exercise-meta-item">â€¢</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                // Generate appropriate options based on measure type
                let measureOptions = '';
                let measurePlaceholder = 'Reps';
                if (measureType === 'time') {
                    measurePlaceholder = 'Time';
                    measureOptions = generateTimeOptions(defaultReps);
                } else if (measureType === 'distance') {
                    measurePlaceholder = 'Distance';
                    measureOptions = generateDistanceOptions(defaultReps);
                } else {
                    measureOptions = generateRepsOptions(defaultReps);
                }

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">${measurePlaceholder}</option>
                                ${measureOptions}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function selectOption(workoutType, sectionIdx, optionIdx) {
            workoutLog[`${workoutType}_section${sectionIdx}`] = parseInt(optionIdx);
            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSupersets(section, workoutType, sectionIdx) {
            let html = '';

            section.supersets.forEach((superset, supersetIdx) => {
                if (superset.isOptions) {
                    // Build preset dropdown for THIS superset only
                    const presetKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}_preset`;
                    const currentPreset = workoutLog[presetKey] !== undefined ? workoutLog[presetKey] : -1;
                    const numPresets = superset.options.length;

                    // Build preset options based on exercises in this superset
                    let presetOptions = '<option value="-1"' + (currentPreset === -1 ? ' selected' : '') + '>Custom</option>';
                    for (let i = 0; i < numPresets; i++) {
                        const presetName = getIndividualSupersetPresetName(superset, i);
                        presetOptions += `<option value="${i}"${currentPreset === i ? ' selected' : ''}>${presetName}</option>`;
                    }

                    html += `
                        <div class="superset-container">
                            <div class="superset-badge">SUPERSET ${supersetIdx + 1}</div>
                            <div class="superset-preset-selector" style="margin-bottom: 10px;">
                                <label class="superset-preset-label">Preset:</label>
                                <select class="superset-preset-select" onchange="selectIndividualSupersetPreset('${workoutType}', ${sectionIdx}, ${supersetIdx}, this.value)">
                                    ${presetOptions}
                                </select>
                            </div>
                    `;

                    // Render each exercise position with its own independent dropdown
                    const numExercisesInPair = superset.options[0].length;
                    for (let exIdx = 0; exIdx < numExercisesInPair; exIdx++) {
                        // Each exercise position has its own selection key
                        const selectionKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}_ex${exIdx}`;
                        const selectedOptionIdx = workoutLog[selectionKey] || 0;
                        const selectedExercise = superset.options[selectedOptionIdx][exIdx];

                        html += renderSupersetExerciseWithDropdown(selectedExercise, workoutType, section.title, superset.options, sectionIdx, supersetIdx, selectedOptionIdx, exIdx);
                        if (exIdx < numExercisesInPair - 1) {
                            html += '<div class="superset-arrow">â†“</div>';
                        }
                    }

                    html += '</div>';
                } else {
                    html += `
                        <div class="superset-container">
                            <div class="superset-badge">SUPERSET ${supersetIdx + 1}</div>
                    `;
                    superset.forEach((ex, exIdx) => {
                        html += renderSingleExercise(ex, workoutType);
                        if (exIdx < superset.length - 1) {
                            html += '<div class="superset-arrow">â†“</div>';
                        }
                    });
                    html += '</div>';
                }
            });

            return html;
        }

        function selectSupersetOption(workoutType, sectionIdx, supersetIdx, optionIdx, exIdx) {
            // Save selection for this specific exercise position within the superset
            workoutLog[`${workoutType}_section${sectionIdx}_superset${supersetIdx}_ex${exIdx}`] = parseInt(optionIdx);

            // Set this superset's preset to Custom (-1) when individual exercise is changed
            const presetKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}_preset`;
            workoutLog[presetKey] = -1;

            saveData();
            renderWorkoutContent(workoutType);
        }

        function getIndividualSupersetPresetName(superset, presetIdx) {
            // Build a name from the exercises in this preset option
            const exercises = superset.options[presetIdx];
            if (!exercises || exercises.length === 0) return `Option ${presetIdx + 1}`;

            const names = exercises.map(ex => {
                let name = ex.name;
                if (name.length > 20) {
                    name = name.substring(0, 17) + '...';
                }
                return name;
            });
            return `${names.join(' + ')}`;
        }

        function selectIndividualSupersetPreset(workoutType, sectionIdx, supersetIdx, presetIdx) {
            presetIdx = parseInt(presetIdx);
            const presetKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}_preset`;
            workoutLog[presetKey] = presetIdx;

            if (presetIdx >= 0) {
                // Get the workout and section
                const effectiveWorkouts = getEffectiveWorkouts();
                const workout = effectiveWorkouts[workoutType];
                const section = workout?.sections?.[sectionIdx];
                const superset = section?.supersets?.[supersetIdx];

                if (superset && superset.isOptions && superset.options.length > presetIdx) {
                    // Set all exercise positions in THIS superset to the preset index
                    const numExercisesInPair = superset.options[0].length;
                    for (let exIdx = 0; exIdx < numExercisesInPair; exIdx++) {
                        const selectionKey = `${workoutType}_section${sectionIdx}_superset${supersetIdx}_ex${exIdx}`;
                        workoutLog[selectionKey] = presetIdx;
                    }
                }
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSupersetExerciseWithDropdown(ex, workoutType, sectionTitle, allSupersetOptions, sectionIdx, supersetIdx, selectedIdx, exerciseIdxInPair) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            // Get measure type for this exercise
            const measureType = getExerciseMeasureType(ex.name);
            const measureLabel = measureType === 'time' ? 'time' : measureType === 'distance' ? 'dist' : 'reps';

            // Build dropdown options showing first exercise of each superset option with display names
            let dropdownOptions = '';
            allSupersetOptions.forEach((opt, idx) => {
                const optExercise = opt[exerciseIdxInPair];
                const optDisplayName = getExerciseDisplayName(optExercise.name);
                dropdownOptions += `<option value="${idx}" ${idx === selectedIdx ? 'selected' : ''}>${optDisplayName}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectSupersetOption('${workoutType}', ${sectionIdx}, ${supersetIdx}, this.value, ${exerciseIdxInPair})">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} ${measureLabel}</span>
                            <span class="exercise-meta-item">â€¢</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                // Generate appropriate options based on measure type
                let measureOptions = '';
                let measurePlaceholder = 'Reps';
                if (measureType === 'time') {
                    measurePlaceholder = 'Time';
                    measureOptions = generateTimeOptions(defaultReps);
                } else if (measureType === 'distance') {
                    measurePlaceholder = 'Distance';
                    measureOptions = generateDistanceOptions(defaultReps);
                } else {
                    measureOptions = generateRepsOptions(defaultReps);
                }

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">${measurePlaceholder}</option>
                                ${measureOptions}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function renderCircuit(section, workoutType, sectionIdx) {
            // Build circuit presets based on rotation indices
            const circuitKey = `${workoutType}_circuit_${section.title.replace(/\s+/g, '_')}`;
            const currentPreset = workoutLog[circuitKey] !== undefined ? workoutLog[circuitKey] : -1; // -1 means custom

            // Get the number of rotation options (assume all exercises have same number)
            const numPresets = section.exercises[0]?.rotations?.length || 0;

            // Build preset names from first exercise of each rotation index
            let presetOptions = '<option value="-1"' + (currentPreset === -1 ? ' selected' : '') + '>Custom</option>';
            for (let i = 0; i < numPresets; i++) {
                const shortName = getCircuitPresetName(section, i);
                presetOptions += `<option value="${i}"${currentPreset === i ? ' selected' : ''}>${shortName}</option>`;
            }

            const safeSectionTitle = section.title.replace(/'/g, "\\'");

            let html = `
                <div class="circuit-preset-selector">
                    <label class="circuit-preset-label">Circuit Preset:</label>
                    <select class="circuit-preset-select" onchange="selectCircuitPreset('${workoutType}', '${safeSectionTitle}', this.value)">
                        ${presetOptions}
                    </select>
                </div>
            `;

            // Render circuit exercises individually
            section.exercises.forEach(ex => {
                html += renderExercise(ex, workoutType, section.title);
            });
            return html;
        }

        function getCircuitPresetName(section, presetIdx) {
            // Create a short descriptive name for the preset
            const names = section.exercises.map(ex => {
                const name = ex.rotations?.[presetIdx]?.name || '';
                // Shorten common words
                return name.replace(' Carry', '').replace(' Hold', '').replace(' Crunches', '').replace('Bicycle', 'Bike').replace('Russian ', 'Rus. ');
            });
            return names.join(', ');
        }

        function selectCircuitPreset(workoutType, sectionTitle, presetIdx) {
            presetIdx = parseInt(presetIdx);
            const circuitKey = `${workoutType}_circuit_${sectionTitle.replace(/\s+/g, '_')}`;
            workoutLog[circuitKey] = presetIdx;

            if (presetIdx >= 0) {
                // Get the workout and section
                const effectiveWorkouts = getEffectiveWorkouts();
                const workout = effectiveWorkouts[workoutType];
                const section = workout.sections.find(s => s.title === sectionTitle);

                if (section) {
                    // Set all exercise rotations to the preset index
                    section.exercises.forEach(ex => {
                        if (ex.rotations && ex.rotations.length > presetIdx) {
                            const rotationKey = `${workoutType}_rotation_${ex.name}`;
                            workoutLog[rotationKey] = presetIdx;
                        }
                    });
                }
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderExercise(ex, workoutType, sectionTitle = '') {
            const today = new Date().toISOString().split('T')[0];
            const baseExerciseName = ex.name; // The base exercise name for tracking rotation cycles

            if (ex.rotations && ex.rotations.length > 1) {
                const rotationKey = `${workoutType}_rotation_${ex.name}`;
                const selectedRotation = workoutLog[rotationKey] || 0;
                const currentEx = ex.rotations[selectedRotation];

                const exerciseType = getExerciseType(sectionTitle);
                const uniqueDays = getExerciseDaysSinceReset(workoutType, currentEx.name, baseExerciseName);
                const shouldRotate = shouldRecommendRotation(workoutType, currentEx.name, exerciseType, baseExerciseName);
                const threshold = ROTATION_THRESHOLDS[exerciseType];
                const daysThreshold = threshold * 2;

                // Check if this exercise just completed a cycle (hit 24 days)
                if (uniqueDays >= daysThreshold) {
                    markCycleCompleted(workoutType, baseExerciseName);
                }

                let html = '';

                if (shouldRotate) {
                    html += `
                        <div style="background: linear-gradient(135deg, #ff9f0a 0%, #ff6b35 100%);
                                    color: white;
                                    padding: 12px 16px;
                                    border-radius: 12px;
                                    margin-bottom: 12px;
                                    font-size: 14px;
                                    font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 20px;">âŸ³</span>
                                <span>Time to Switch It Up!</span>
                            </div>
                            <div style="font-size: 13px; font-weight: 400; opacity: 0.95;">
                                You've done ${currentEx.name} for ${uniqueDays} workout days (${daysThreshold}+ recommended). Try a different variation!
                            </div>
                        </div>
                    `;
                    markRotationRecommended(workoutType, currentEx.name);
                }

                // Render exercise with rotation dropdown in header
                html += renderRotationExerciseWithDropdown(ex, workoutType, sectionTitle, selectedRotation);

                return html;
            } else {
                return renderSingleExercise(ex, workoutType);
            }
        }

        function renderRotationExerciseWithDropdown(ex, workoutType, sectionTitle, selectedRotation) {
            const today = new Date().toISOString().split('T')[0];
            const currentEx = ex.rotations[selectedRotation];
            const safeExName = currentEx.name.replace(/'/g, "\\'");
            const safeBaseExName = ex.name.replace(/'/g, "\\'");
            const lastLog = getLastLog(workoutType, currentEx.name);
            const setCountKey = `${workoutType}_${currentEx.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const baseExerciseName = ex.name;
            const restTime = ex.rest || '60s';

            // Build dropdown options with day counts
            let dropdownOptions = '';
            ex.rotations.forEach((rotation, idx) => {
                const variantUniqueDays = getExerciseDaysSinceReset(workoutType, rotation.name, baseExerciseName);
                const dayLabel = variantUniqueDays > 0 ? ` (${variantUniqueDays}d)` : '';
                dropdownOptions += `<option value="${idx}" ${idx === selectedRotation ? 'selected' : ''}>${rotation.name}${dayLabel}</option>`;
            });

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <select class="exercise-name-select" onchange="selectRotation('${workoutType}', '${safeBaseExName}', this.value, '${sectionTitle}')">
                            ${dropdownOptions}
                        </select>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} reps</span>
                            <span class="exercise-meta-item">â€¢</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${currentEx.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${currentEx.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${currentEx.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">Reps</option>
                                ${generateRepsOptions(defaultReps)}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function selectRotation(workoutType, exerciseName, rotationIdx, sectionTitle) {
            const rotationKey = `${workoutType}_rotation_${exerciseName}`;
            workoutLog[rotationKey] = parseInt(rotationIdx);

            // If this is a circuit section, set preset to Custom (-1)
            const effectiveWorkouts = getEffectiveWorkouts();
            const workout = effectiveWorkouts[workoutType];
            const section = workout?.sections?.find(s => s.title === sectionTitle);
            if (section?.isCircuit) {
                const circuitKey = `${workoutType}_circuit_${sectionTitle.replace(/\s+/g, '_')}`;
                workoutLog[circuitKey] = -1; // Custom
            }

            saveData();
            renderWorkoutContent(workoutType);
        }

        function renderSingleExercise(ex, workoutType) {
            const today = new Date().toISOString().split('T')[0];
            const lastLog = getLastLog(workoutType, ex.name);
            const safeExName = ex.name.replace(/'/g, "\\'");
            const setCountKey = `${workoutType}_${ex.name}_setCount`;
            // Use current session's set count, or last workout's set count, or default
            let baseSets = workoutLog[setCountKey] !== undefined
                ? workoutLog[setCountKey]
                : (lastLog && lastLog.setCount ? lastLog.setCount : ex.sets);
            // Apply deload reduction
            const currentSets = getDeloadSets(baseSets);
            const restTime = ex.rest || '60s';

            // Get measure type for this exercise
            const measureType = getExerciseMeasureType(ex.name);
            const measureLabel = measureType === 'time' ? 'time' : measureType === 'distance' ? 'dist' : 'reps';

            // Get display name (custom name if set)
            const displayName = getExerciseDisplayName(ex.name);

            let html = `
                <div class="exercise-card" id="card_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="exercise-header">
                        <div class="exercise-name">${displayName}</div>
                        <div class="exercise-meta">
                            <span class="exercise-meta-item">${ex.reps} ${measureLabel}</span>
                            <span class="exercise-meta-item">â€¢</span>
                            <span class="exercise-meta-item">${restTime} rest</span>
                            <button class="info-btn" onclick="showExerciseInfo('${safeExName}')">i</button>
                        </div>
                    </div>
                    ${ex.notes ? `<div style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-bottom: 12px;">${ex.notes}</div>` : ''}
                    <div class="set-tracker" id="tracker_${safeExName.replace(/[^a-zA-Z0-9]/g, '_')}">
            `;

            for (let i = 1; i <= currentSets; i++) {
                const logKey = `${today}_${workoutType}_${ex.name}_${i}`;
                const saved = workoutLog[logKey];
                let defaultWeight = saved ? saved.weight : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].weight : '');
                // Apply deload weight reduction
                defaultWeight = getDeloadWeight(defaultWeight);
                const defaultReps = saved ? saved.reps : (lastLog && lastLog[`set${i}`] ? lastLog[`set${i}`].reps : '');
                const setId = `set_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const rowId = `row_${workoutType}_${safeExName}_${i}`.replace(/[^a-zA-Z0-9_]/g, '_');

                // Generate appropriate options based on measure type
                let measureOptions = '';
                let measurePlaceholder = 'Reps';
                if (measureType === 'time') {
                    measurePlaceholder = 'Time';
                    measureOptions = generateTimeOptions(defaultReps);
                } else if (measureType === 'distance') {
                    measurePlaceholder = 'Distance';
                    measureOptions = generateDistanceOptions(defaultReps);
                } else {
                    measureOptions = generateRepsOptions(defaultReps);
                }

                html += `
                    <div class="set-row-container">
                        <div class="set-row-delete" onclick="deleteSet('${workoutType}', '${safeExName}', ${i}, ${ex.sets})">Delete</div>
                        <div class="set-row" id="${rowId}" ontouchstart="handleSetTouchStart(event)" ontouchmove="handleSetTouchMove(event, '${rowId}')" ontouchend="handleSetTouchEnd(event, '${rowId}')">
                            <div class="set-label">${i}</div>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'weight', this.value)">
                                <option value="">Weight</option>
                                <option value="BW" ${defaultWeight === 'BW' ? 'selected' : ''}>BW</option>
                                ${generateWeightOptions(defaultWeight)}
                            </select>
                            <select class="tracking-select ${saved ? 'filled' : ''}"
                                    onchange="logSet('${workoutType}', '${safeExName}', ${i}, 'reps', this.value)">
                                <option value="">${measurePlaceholder}</option>
                                ${measureOptions}
                            </select>
                            <button class="set-check" id="${setId}" onclick="toggleSetComplete('${setId}', '${restTime}')"></button>
                        </div>
                    </div>
                `;
            }

            // Add set button below all sets
            html += `
                        <div class="add-set-btn" onclick="addSet('${workoutType}', '${safeExName}', ${ex.sets})">
                            + Add Set
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function generateWeightOptions(defaultValue) {
            let options = '';
            for (let w = 5; w <= 500; w += 5) {
                options += `<option value="${w}" ${w == defaultValue ? 'selected' : ''}>${w} lbs</option>`;
            }
            return options;
        }

        function generateRepsOptions(defaultValue) {
            let options = '';
            for (let r = 1; r <= 50; r++) {
                options += `<option value="${r}" ${r == defaultValue ? 'selected' : ''}>${r}</option>`;
            }
            return options;
        }

        function generateTimeOptions(defaultValue) {
            let options = '';
            // Common time increments for exercises
            const timeOptions = [
                { value: '10s', label: '10 sec' },
                { value: '15s', label: '15 sec' },
                { value: '20s', label: '20 sec' },
                { value: '30s', label: '30 sec' },
                { value: '45s', label: '45 sec' },
                { value: '1min', label: '1 min' },
                { value: '90s', label: '90 sec' },
                { value: '2min', label: '2 min' },
                { value: '3min', label: '3 min' },
                { value: '5min', label: '5 min' },
                { value: '10min', label: '10 min' },
                { value: '15min', label: '15 min' },
                { value: '20min', label: '20 min' },
                { value: '25min', label: '25 min' },
                { value: '30min', label: '30 min' },
                { value: '40min', label: '40 min' },
                { value: '45min', label: '45 min' },
                { value: '60min', label: '60 min' }
            ];
            timeOptions.forEach(opt => {
                options += `<option value="${opt.value}" ${opt.value == defaultValue ? 'selected' : ''}>${opt.label}</option>`;
            });
            return options;
        }

        function generateDistanceOptions(defaultValue) {
            let options = '';
            // Common distance increments for exercises
            const distanceOptions = [
                { value: '10m', label: '10m' },
                { value: '20m', label: '20m' },
                { value: '25m', label: '25m' },
                { value: '30m', label: '30m' },
                { value: '40m', label: '40m' },
                { value: '50m', label: '50m' },
                { value: '100m', label: '100m' },
                { value: '200m', label: '200m' },
                { value: '400m', label: '400m' },
                { value: '800m', label: '800m' },
                { value: '1km', label: '1 km' },
                { value: '2km', label: '2 km' },
                { value: '5km', label: '5 km' },
                { value: '10yds', label: '10 yds' },
                { value: '20yds', label: '20 yds' },
                { value: '25yds', label: '25 yds' },
                { value: '40yds', label: '40 yds' },
                { value: '50yds', label: '50 yds' },
                { value: '100yds', label: '100 yds' }
            ];
            distanceOptions.forEach(opt => {
                options += `<option value="${opt.value}" ${opt.value == defaultValue ? 'selected' : ''}>${opt.label}</option>`;
            });
            return options;
        }

        function addSet(workoutType, exerciseName, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;
            const newSets = currentSets + 1;

            workoutLog[setCountKey] = newSets;
            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        function removeSet(workoutType, exerciseName, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;

            if (currentSets <= 1) return; // Don't go below 1 set

            const newSets = currentSets - 1;
            workoutLog[setCountKey] = newSets;

            // Also remove the logged data for the removed set
            const today = new Date().toISOString().split('T')[0];
            const removedSetKey = `${today}_${workoutType}_${exerciseName}_${currentSets}`;
            delete workoutLog[removedSetKey];

            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        function deleteSet(workoutType, exerciseName, setNum, defaultSets) {
            const setCountKey = `${workoutType}_${exerciseName}_setCount`;
            const currentSets = workoutLog[setCountKey] !== undefined ? workoutLog[setCountKey] : defaultSets;

            if (currentSets <= 1) return; // Don't go below 1 set

            const today = new Date().toISOString().split('T')[0];

            // Shift all sets after the deleted one down by 1
            for (let i = setNum; i < currentSets; i++) {
                const currentKey = `${today}_${workoutType}_${exerciseName}_${i + 1}`;
                const newKey = `${today}_${workoutType}_${exerciseName}_${i}`;
                if (workoutLog[currentKey]) {
                    workoutLog[newKey] = workoutLog[currentKey];
                } else {
                    delete workoutLog[newKey];
                }
            }

            // Remove the last set key
            const lastSetKey = `${today}_${workoutType}_${exerciseName}_${currentSets}`;
            delete workoutLog[lastSetKey];

            // Update set count
            workoutLog[setCountKey] = currentSets - 1;
            saveData();

            // Re-render the workout to update the UI
            renderWorkoutContent(workoutType);
        }

        // Touch handlers for swipe-to-delete
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;

        function handleSetTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchCurrentX = touchStartX;
            isSwiping = true;
        }

        function handleSetTouchMove(event, rowId) {
            if (!isSwiping) return;
            touchCurrentX = event.touches[0].clientX;
            const diff = touchStartX - touchCurrentX;
            const row = document.getElementById(rowId);

            if (diff > 0) {
                // Swiping left
                const translateX = Math.min(diff, 80);
                row.style.transform = `translateX(-${translateX}px)`;
                row.style.transition = 'none';
            } else {
                // Swiping right (to close)
                row.style.transform = 'translateX(0)';
            }
        }

        function handleSetTouchEnd(event, rowId) {
            if (!isSwiping) return;
            isSwiping = false;
            const diff = touchStartX - touchCurrentX;
            const row = document.getElementById(rowId);

            row.style.transition = 'transform 0.2s ease';

            if (diff > 40) {
                // Swiped enough to show delete
                row.classList.add('swiped');
                row.style.transform = 'translateX(-80px)';
            } else {
                // Not enough swipe, snap back
                row.classList.remove('swiped');
                row.style.transform = 'translateX(0)';
            }
        }

        // Close any open swipe actions when tapping elsewhere
        document.addEventListener('touchstart', function(event) {
            if (!event.target.closest('.set-row') && !event.target.closest('.set-row-delete')) {
                document.querySelectorAll('.set-row.swiped').forEach(row => {
                    row.classList.remove('swiped');
                    row.style.transform = 'translateX(0)';
                });
            }
        });

        function getLastLog(workoutType, exerciseName) {
            const today = new Date().toISOString().split('T')[0];
            // Filter for set logs (format: date_workoutType_exerciseName_setNum)
            // Must match exact workout type to be workout-specific
            const keys = Object.keys(workoutLog).filter(key => {
                // Check if key starts with a date pattern and matches the exact format
                const dateMatch = key.match(/^(\d{4}-\d{2}-\d{2})_(.+)_(\d+)$/);
                if (!dateMatch) return false;

                const [, date, middle, setNum] = dateMatch;
                // The middle part should be "workoutType_exerciseName"
                const expectedPrefix = `${workoutType}_${exerciseName}`;
                return middle === expectedPrefix && date !== today;
            }).sort().reverse();

            if (keys.length === 0) return null;

            const lastDate = keys[0].split('_')[0];
            const lastSets = {};
            let maxSetNum = 0;

            keys.forEach(key => {
                if (key.startsWith(lastDate)) {
                    const setNum = parseInt(key.split('_').pop());
                    if (!isNaN(setNum)) {
                        lastSets[`set${setNum}`] = workoutLog[key];
                        if (setNum > maxSetNum) maxSetNum = setNum;
                    }
                }
            });

            lastSets.setCount = maxSetNum;
            return lastSets;
        }

        function logSet(workoutType, exerciseName, setNum, field, value) {
            const today = new Date().toISOString().split('T')[0];
            const logKey = `${today}_${workoutType}_${exerciseName}_${setNum}`;
            
            if (!workoutLog[logKey]) {
                workoutLog[logKey] = { weight: '', reps: '' };
            }
            workoutLog[logKey][field] = value;
            
            const historyKey = `${today}_${workoutType}`;
            if (!workoutLog[historyKey]) {
                workoutLog[historyKey] = { date: today, type: workoutType, exercises: {} };
            }
            if (!workoutLog[historyKey].exercises[exerciseName]) {
                workoutLog[historyKey].exercises[exerciseName] = {};
            }
            workoutLog[historyKey].exercises[exerciseName][`set${setNum}`] = workoutLog[logKey];

            saveData();

            const selects = document.querySelectorAll('.tracking-select');
            selects.forEach(s => {
                if (s.value) s.classList.add('filled');
            });
        }

        function showExerciseInfo(exerciseName) {
            const info = EXERCISE_DB[exerciseName];
            document.getElementById('exerciseName').textContent = exerciseName;
            if (info) {
                document.getElementById('exerciseInfo').innerHTML = `
                    <p><strong>Setup:</strong> ${info.setup}</p>
                    <p><strong>Execution:</strong> ${info.execution}</p>
                `;
            } else {
                // Generate a generic description based on exercise name
                const genericInfo = generateExerciseInfo(exerciseName);
                document.getElementById('exerciseInfo').innerHTML = `
                    <p><strong>Setup:</strong> ${genericInfo.setup}</p>
                    <p><strong>Execution:</strong> ${genericInfo.execution}</p>
                `;
            }
            document.getElementById('exerciseModal').classList.add('active');
        }

        function generateExerciseInfo(exerciseName) {
            const name = exerciseName.toLowerCase();

            // Common exercise patterns
            if (name.includes('squat')) {
                return {
                    setup: 'Position feet shoulder-width apart. Brace your core and maintain a neutral spine.',
                    execution: 'Descend by pushing hips back and bending knees. Keep chest up and knees tracking over toes. Drive through feet to return to standing.'
                };
            } else if (name.includes('deadlift') || name.includes('rdl')) {
                return {
                    setup: 'Stand with feet hip-width apart. Grip the bar just outside your legs. Shoulders back, chest up.',
                    execution: 'Hinge at hips while maintaining flat back. Drive through heels and extend hips to stand. Control the descent.'
                };
            } else if (name.includes('press') || name.includes('bench')) {
                return {
                    setup: 'Set up with stable base. Grip the weight firmly. Engage core and set shoulders.',
                    execution: 'Control the weight down, then press up powerfully. Maintain proper elbow position throughout.'
                };
            } else if (name.includes('row')) {
                return {
                    setup: 'Hinge forward with flat back. Grip the weight with arms extended.',
                    execution: 'Pull weight toward torso, squeezing shoulder blades. Lower with control. Avoid momentum.'
                };
            } else if (name.includes('curl')) {
                return {
                    setup: 'Stand tall with weight at sides. Elbows close to body.',
                    execution: 'Curl weight up by bending elbows. Squeeze at top. Lower with control. Avoid swinging.'
                };
            } else if (name.includes('extension') || name.includes('pushdown')) {
                return {
                    setup: 'Set up with stable stance. Grip firmly with proper hand position.',
                    execution: 'Extend through full range of motion. Control the negative. Keep tension on target muscle.'
                };
            } else if (name.includes('lunge') || name.includes('split')) {
                return {
                    setup: 'Stand tall with feet hip-width apart. Core engaged.',
                    execution: 'Step into lunge position. Lower until rear knee nearly touches ground. Drive through front foot to return.'
                };
            } else if (name.includes('pull-up') || name.includes('chin')) {
                return {
                    setup: 'Grip bar with chosen hand position. Hang with arms fully extended.',
                    execution: 'Pull body up until chin clears bar. Lower with control. Avoid swinging.'
                };
            } else if (name.includes('jump') || name.includes('hop') || name.includes('bound')) {
                return {
                    setup: 'Athletic stance with soft knees. Arms ready to drive.',
                    execution: 'Explode upward/forward with full extension. Land softly with bent knees. Reset and repeat.'
                };
            } else if (name.includes('plank') || name.includes('hold')) {
                return {
                    setup: 'Set up in position with core engaged. Maintain neutral spine alignment.',
                    execution: 'Hold position while breathing steadily. Avoid sagging or piking. Focus on tension throughout core.'
                };
            } else if (name.includes('raise') || name.includes('fly')) {
                return {
                    setup: 'Position body appropriately for the movement. Light grip on weight.',
                    execution: 'Raise weight through controlled arc. Pause at top. Lower with control. Maintain slight elbow bend.'
                };
            } else if (name.includes('calf')) {
                return {
                    setup: 'Position feet on edge of platform. Hold support for balance if needed.',
                    execution: 'Rise onto toes through full range. Squeeze at top. Lower slowly below platform level. Full stretch at bottom.'
                };
            } else if (name.includes('carry') || name.includes('walk')) {
                return {
                    setup: 'Pick up weight with proper deadlift form. Stand tall with shoulders back.',
                    execution: 'Walk with controlled steps. Maintain upright posture. Breathe steadily. Keep core braced throughout.'
                };
            } else if (name.includes('med ball') || name.includes('slam')) {
                return {
                    setup: 'Hold med ball at chest or overhead. Athletic stance.',
                    execution: 'Generate power from hips and core. Release or slam with full body effort. Reset and repeat.'
                };
            } else if (name.includes('circuit') || name.includes('combo')) {
                return {
                    setup: 'Prepare all equipment needed. Plan transitions between exercises.',
                    execution: 'Perform each exercise with good form. Minimize rest between movements. Complete all rounds as prescribed.'
                };
            } else {
                return {
                    setup: 'Set up in proper starting position. Engage core and maintain good posture.',
                    execution: 'Perform the movement with controlled tempo. Focus on mind-muscle connection. Complete all reps with good form.'
                };
            }
        }

        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        let deleteClickCount = 0;
        let deleteClickTimer = null;
        
        window.deleteCurrentWorkout = function() {
            console.log('Delete button clicked!');
            const container = document.getElementById('dayWorkouts');
            const dateStr = container.getAttribute('data-current-date');
            const sessionKey = container.getAttribute('data-current-session');
            
            if (!dateStr || !sessionKey) {
                alert('Error: Cannot find workout to delete.');
                return;
            }
            
            deleteClickCount++;
            
            if (deleteClickCount === 1) {
                const btn = event.target;
                btn.textContent = 'âš ï¸ Click Again to Confirm';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';
                
                deleteClickTimer = setTimeout(() => {
                    btn.textContent = 'âœ• Delete';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    deleteClickCount = 0;
                }, 3000);
            } else if (deleteClickCount === 2) {
                clearTimeout(deleteClickTimer);
                deleteClickCount = 0;
                console.log('Deleting workout...');
                deleteWorkout(dateStr, sessionKey);
            }
        };

        function clearAllData() {
            if (confirm('âš ï¸ DELETE ALL WORKOUTS?\n\nThis will permanently delete:\n- All workout sessions\n- All exercise logs\n- All rotation tracking\n\nThis CANNOT be undone!\n\nAre you absolutely sure?')) {
                localStorage.clear();
                workoutLog = {};
                rotationTracking = {};
                workoutSessions = {};
                currentSession = null;
                workoutStartTime = null;
                currentWorkoutType = null;
                alert('âœ“ All workout data has been deleted.');
                location.reload();
            }
        }

        // Data clearing code removed - using server-based storage now

        function deleteWorkout(dateStr, sessionKey) {
            console.log('deleteWorkout called with:', dateStr, sessionKey);
            
            const session = workoutLog[sessionKey];
            console.log('Session data:', session);
            
            if (!session) {
                alert('Workout not found');
                console.log('Session not found in workoutLog');
                return;
            }
            
            const workoutType = session.workoutType;
            console.log('Workout type:', workoutType);
            
            const keysToDelete = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_')
            );
            console.log('Deleting ALL keys for date:', keysToDelete);
            keysToDelete.forEach(key => delete workoutLog[key]);
            
            saveData();
            console.log('Data saved');
            
            const remainingKeys = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_')
            );
            console.log('Remaining keys for date (should be empty):', remainingKeys);
            
            selectedCalendarDate = null;
            
            renderCalendar();
            document.getElementById('dayWorkouts').innerHTML = '<div style="color: var(--success); text-align: center; padding: 20px; font-size: 18px; font-weight: 600;">âœ“ Workout Deleted</div>';
            
            setTimeout(() => {
                document.getElementById('dayWorkouts').innerHTML = '';
            }, 2000);
        }

        function initYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYearNow = new Date().getFullYear();
            let html = '';
            for (let year = currentYearNow - 5; year <= currentYearNow + 5; year++) {
                html += `<option value="${year}">${year}</option>`;
            }
            yearSelect.innerHTML = html;
        }

        function updateMonthYearSelects() {
            document.getElementById('monthSelect').value = currentMonth;

            // Populate year selector if empty
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect.options.length === 0) {
                const currentYearNow = new Date().getFullYear();
                for (let y = currentYearNow - 5; y <= currentYearNow + 5; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    yearSelect.appendChild(option);
                }
            }
            yearSelect.value = currentYear;
        }

        function setMonth(month) {
            currentMonth = parseInt(month);
            renderCalendar();
        }

        function setYear(year) {
            currentYear = parseInt(year);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            updateMonthYearSelects();

            let html = '';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }

            const today = new Date();
            const todayStr = getLocalDateString(today);
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = getLocalDateString(date);
                const dayWorkouts = getDayWorkoutNames(dateStr);
                const hasWorkout = dayWorkouts.length > 0;
                const isToday = dateStr === todayStr;
                const isSelected = selectedCalendarDate === dateStr;

                html += `
                    <div class="calendar-day ${hasWorkout ? 'has-workout' : ''} ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="selectCalendarDay('${dateStr}')">
                        <div class="calendar-day-number">${day}</div>
                        ${hasWorkout ? '<div class="calendar-dot"></div>' : ''}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function getDayWorkoutNames(dateStr) {
            const workoutNames = [];
            Object.keys(workoutLog).forEach(key => {
                if (key.includes('_session_') && key.startsWith(dateStr)) {
                    const session = workoutLog[key];
                    if (session && session.workoutType && !workoutNames.includes(session.workoutType)) {
                        workoutNames.push(session.workoutType);
                    }
                }
            });
            return workoutNames;
        }

        function selectCalendarDay(dateStr) {
            selectedCalendarDate = dateStr;
            renderCalendar();
            showDayWorkouts(dateStr);
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function showDayWorkouts(dateStr) {
            const container = document.getElementById('dayWorkouts');
            
            const sessionKeys = Object.keys(workoutLog).filter(key => 
                key.startsWith(dateStr + '_session_')
            );
            
            if (sessionKeys.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No workouts on this day</div>';
                return;
            }
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            let html = `<div class="section-header">Workouts on ${formatted}</div>`;
            
            sessionKeys.sort((a, b) => {
                const timeA = parseInt(a.split('_session_')[1].split('_')[0]);
                const timeB = parseInt(b.split('_session_')[1].split('_')[0]);
                return timeB - timeA;
            });
            
            sessionKeys.forEach((sessionKey, index) => {
                const session = workoutLog[sessionKey];
                if (!session) return;

                const exerciseCount = Object.keys(session.exercises || {}).length;
                const startTime = new Date(session.startTime);
                const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const safeSessionKey = sessionKey.replace(/'/g, "\\'");

                html += `
                    <div class="workout-summary-card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1; cursor: pointer;" onclick="openWorkoutDetailModal('${dateStr}', '${safeSessionKey}')">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${session.workoutType}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    ${timeStr} â€¢ ${exerciseCount} exercises â€¢ ${session.durationMinutes}m
                                </div>
                            </div>
                            <button onclick="deleteSingleWorkout('${safeSessionKey}', '${dateStr}'); event.stopPropagation();"
                                    id="delete_${index}"
                                    style="background: rgba(255, 59, 48, 0.15);
                                           border: 1px solid #ff3b30;
                                           color: #ff3b30;
                                           border-radius: 8px;
                                           padding: 8px 12px;
                                           font-size: 13px;
                                           font-weight: 600;
                                           cursor: pointer;
                                           margin-left: 12px;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        let singleDeleteState = {};

        function deleteSingleWorkout(sessionKey, dateStr) {
            if (!singleDeleteState[sessionKey]) {
                singleDeleteState[sessionKey] = { clicks: 0, timer: null };
            }

            singleDeleteState[sessionKey].clicks++;
            const btn = event.target;

            if (singleDeleteState[sessionKey].clicks === 1) {
                btn.textContent = 'Confirm';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';

                singleDeleteState[sessionKey].timer = setTimeout(() => {
                    btn.textContent = 'Delete';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    singleDeleteState[sessionKey].clicks = 0;
                }, 3000);
            } else if (singleDeleteState[sessionKey].clicks === 2) {
                clearTimeout(singleDeleteState[sessionKey].timer);
                singleDeleteState[sessionKey].clicks = 0;

                // Delete the session
                delete workoutLog[sessionKey];
                saveData();

                renderCalendar();
                showDayWorkouts(dateStr);
            }
        }

        function openWorkoutDetailModal(dateStr, sessionKey) {
            const session = workoutLog[sessionKey];
            if (!session) return;
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const startTime = new Date(session.startTime);
            const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            document.getElementById('modalWorkoutType').textContent = session.workoutType;
            document.getElementById('modalWorkoutDate').textContent = formatted + ' â€¢ ' + timeStr + ' â€¢ ' + session.durationMinutes + 'm';
            
            let html = '';
            const exercises = session.exercises || {};
            
            if (Object.keys(exercises).length > 0) {
                Object.entries(exercises).forEach(([exerciseName, sets]) => {
                    html += `
                        <div style="margin-bottom: 24px; background: var(--card-bg); border-radius: 12px; padding: 16px;">
                            <div style="font-weight: 600; font-size: 17px; margin-bottom: 12px;">${exerciseName}</div>
                    `;
                    
                    Object.entries(sets).forEach(([setKey, data]) => {
                        if (data && data.weight && data.reps) {
                            const setNum = setKey.replace('set', '');
                            html += `
                                <div style="display: flex; gap: 12px; font-size: 15px; color: var(--text-secondary); margin-bottom: 8px;">
                                    <span style="width: 60px; color: var(--text);">Set ${setNum}</span>
                                    <span style="color: var(--primary); font-weight: 600;">${data.weight}${data.weight === 'BW' ? '' : ' lbs'}</span>
                                    <span>Ã—</span>
                                    <span style="color: var(--primary); font-weight: 600;">${data.reps} reps</span>
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                });
                
                html += `
                    <button onclick="deleteWorkoutFromModal('${sessionKey}', '${dateStr}')"
                            id="modalDeleteBtn"
                            style="width: 100%;
                                   background: rgba(255, 59, 48, 0.15);
                                   border: 1px solid #ff3b30;
                                   color: #ff3b30;
                                   border-radius: 12px;
                                   padding: 14px;
                                   font-size: 15px;
                                   font-weight: 600;
                                   cursor: pointer;
                                   margin-top: 8px;">
                        Delete This Workout
                    </button>
                `;
            } else {
                html = '<div style="color: var(--text-secondary); text-align: center; padding: 40px;">No exercise data logged</div>';
            }
            
            document.getElementById('workoutDetailBody').innerHTML = html;
            
            document.getElementById('workoutDetailModal').classList.add('active');
        }

        let modalDeleteClicks = 0;
        let modalDeleteTimer = null;

        function deleteWorkoutFromModal(sessionKey, dateStr) {
            modalDeleteClicks++;
            const btn = document.getElementById('modalDeleteBtn');

            if (modalDeleteClicks === 1) {
                btn.textContent = 'Confirm Delete';
                btn.style.background = '#ff3b30';
                btn.style.color = 'white';

                modalDeleteTimer = setTimeout(() => {
                    btn.textContent = 'Delete This Workout';
                    btn.style.background = 'rgba(255, 59, 48, 0.15)';
                    btn.style.color = '#ff3b30';
                    modalDeleteClicks = 0;
                }, 3000);
            } else if (modalDeleteClicks === 2) {
                clearTimeout(modalDeleteTimer);
                modalDeleteClicks = 0;

                const session = workoutLog[sessionKey];
                if (!session) return;

                const workoutType = session.workoutType;

                // Delete related exercise data
                const keysToDelete = Object.keys(workoutLog).filter(key =>
                    key.startsWith(dateStr + '_' + workoutType + '_') && !key.includes('_session_')
                );
                keysToDelete.forEach(key => delete workoutLog[key]);

                // Delete the session
                delete workoutLog[sessionKey];

                saveData();

                closeWorkoutDetailModal();
                showDayWorkouts(dateStr);
                renderCalendar();
                renderWorkoutGrid(); // Update "Last" dates on home screen
                renderWeeklyTracker(); // Update weekly activity tracker
            }
        }

        function closeWorkoutDetailModal() {
            document.getElementById('workoutDetailModal').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('workoutDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWorkoutDetailModal();
                }
            });

            // Prevent pinch zoom
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });
            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });

            // Prevent double-tap zoom
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });

        document.getElementById('exerciseModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        init();
    </script>
</body>
</html>